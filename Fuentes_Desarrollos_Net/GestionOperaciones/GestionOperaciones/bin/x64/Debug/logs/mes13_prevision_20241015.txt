15/10/2024 11:57:22 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410
15/10/2024 11:57:43 - gbenavides - delete from ff_facturas_all where factoring = 202410
15/10/2024 11:57:51 - gbenavides - delete from ff_estimacion where factoring = 202410
15/10/2024 11:57:51 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 0
15/10/2024 11:57:51 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2023-10-01' and f.fh_fin_fact <= '2023-10-31' and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 12:00:24 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 12:01:03 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2023-10-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2023-10-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2023-11-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2023-11-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 12:01:09 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2023-10-01' and FFACTHAS <= '2023-10-31') AND (FFACTURA >= '2023-11-01' and FFACTURA <= '2023-11-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:01:56 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2023-11-01' and FFACTURA <= '2023-11-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:01:57 - gbenavides - replace into ff_facturas_all_tmp select  202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2023-10-01' and f.FFACTURA <= '2023-10-31') and (f.FFACTDES >= '2023-10-01' and f.FFACTHAS <= '2023-10-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:02:04 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2023-10-01' and FFACTHAS <= '2023-10-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:07:26 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 12:07:31 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 0
15/10/2024 12:07:31 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 0
15/10/2024 12:07:31 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2023-10-01' and factoring = 202410 and bloque = 0
15/10/2024 12:07:32 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:08:23 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:08:24 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 0 and TESTFACT = 'A';
15/10/2024 12:08:24 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 0 and TESTFACT = 'S';
15/10/2024 12:08:24 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 12:08:24 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2023-10-31' and f.factoring = 202410 and f.bloque = 0
15/10/2024 12:08:25 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2023-10-01' and f.factoring = 202410 and f.bloque = 0
15/10/2024 12:08:27 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 0
15/10/2024 12:08:34 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 0
15/10/2024 12:08:35 - gbenavides - delete from ff_nif_tmp;
15/10/2024 12:08:35 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 0 group by f.CNIFDNIC < 20000
15/10/2024 12:08:35 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 0
15/10/2024 12:08:40 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 1
15/10/2024 12:08:40 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-06-01' and f.fh_fin_fact <= '2024-06-30' and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 12:12:33 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 12:13:12 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-06-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-06-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 12:13:17 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-06-01' and FFACTHAS <= '2024-06-30') AND (FFACTURA >= '2024-07-01' and FFACTURA <= '2024-07-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:13:22 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-07-01' and FFACTURA <= '2024-07-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:13:23 - gbenavides - replace into ff_facturas_all_tmp select  202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-06-01' and f.FFACTURA <= '2024-06-30') and (f.FFACTDES >= '2024-06-01' and f.FFACTHAS <= '2024-06-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:13:24 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-06-01' and FFACTHAS <= '2024-06-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:13:24 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 12:13:25 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 1
15/10/2024 12:13:25 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 1
15/10/2024 12:13:25 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-06-01' and factoring = 202410 and bloque = 1
15/10/2024 12:13:26 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:14:04 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:14:04 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 1 and TESTFACT = 'A';
15/10/2024 12:14:04 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 1 and TESTFACT = 'S';
15/10/2024 12:14:04 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 12:14:05 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-06-30' and f.factoring = 202410 and f.bloque = 1
15/10/2024 12:14:05 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-06-01' and f.factoring = 202410 and f.bloque = 1
15/10/2024 12:14:08 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 1
15/10/2024 12:14:10 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 1
15/10/2024 12:14:12 - gbenavides - delete from ff_nif_tmp;
15/10/2024 12:14:12 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 1 group by f.CNIFDNIC < 20000
15/10/2024 12:14:12 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 1
15/10/2024 12:14:15 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 2
15/10/2024 12:14:15 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-07-01' and f.fh_fin_fact <= '2024-07-31' and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 12:17:10 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 12:17:50 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 12:17:55 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') AND (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:17:56 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:17:58 - gbenavides - replace into ff_facturas_all_tmp select  202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-07-01' and f.FFACTURA <= '2024-07-31') and (f.FFACTDES >= '2024-07-01' and f.FFACTHAS <= '2024-07-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:17:58 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:17:58 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 12:17:59 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 2
15/10/2024 12:17:59 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 2
15/10/2024 12:18:00 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-07-01' and factoring = 202410 and bloque = 2
15/10/2024 12:18:00 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:18:36 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:18:36 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 2 and TESTFACT = 'A';
15/10/2024 12:18:37 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 2 and TESTFACT = 'S';
15/10/2024 12:18:37 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 12:18:37 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-07-31' and f.factoring = 202410 and f.bloque = 2
15/10/2024 12:18:37 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-07-01' and f.factoring = 202410 and f.bloque = 2
15/10/2024 12:18:39 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 2
15/10/2024 12:18:40 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 2
15/10/2024 12:18:41 - gbenavides - delete from ff_nif_tmp;
15/10/2024 12:18:41 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 2 group by f.CNIFDNIC < 20000
15/10/2024 12:18:41 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 2
15/10/2024 12:18:43 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 3
15/10/2024 12:18:43 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-08-01' and f.fh_fin_fact <= '2024-08-31' and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 12:21:58 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 12:22:29 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 12:22:34 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') AND (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:22:34 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:22:36 - gbenavides - replace into ff_facturas_all_tmp select  202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-08-01' and f.FFACTURA <= '2024-08-31') and (f.FFACTDES >= '2024-08-01' and f.FFACTHAS <= '2024-08-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:22:37 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:22:37 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 12:22:38 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 3
15/10/2024 12:22:38 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 3
15/10/2024 12:22:38 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-08-01' and factoring = 202410 and bloque = 3
15/10/2024 12:22:39 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:23:07 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:23:07 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 3 and TESTFACT = 'A';
15/10/2024 12:23:08 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 3 and TESTFACT = 'S';
15/10/2024 12:23:08 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 12:23:08 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-08-31' and f.factoring = 202410 and f.bloque = 3
15/10/2024 12:23:08 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-08-01' and f.factoring = 202410 and f.bloque = 3
15/10/2024 12:23:10 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 3
15/10/2024 12:23:10 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 3
15/10/2024 12:23:11 - gbenavides - delete from ff_nif_tmp;
15/10/2024 12:23:11 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 3 group by f.CNIFDNIC < 20000
15/10/2024 12:23:11 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 3
15/10/2024 12:49:31 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410
15/10/2024 12:49:32 - gbenavides - delete from ff_facturas_all where factoring = 202410
15/10/2024 12:49:33 - gbenavides - delete from ff_estimacion where factoring = 202410
15/10/2024 12:49:33 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 0
15/10/2024 12:49:33 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2023-10-01' and f.fh_fin_fact <= '2023-10-31' and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 12:53:14 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 12:53:31 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2023-10-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2023-10-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2023-11-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2023-11-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 12:53:36 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2023-10-01' and FFACTHAS <= '2023-10-31') AND (FFACTURA >= '2023-11-01' and FFACTURA <= '2023-11-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:53:40 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2023-11-01' and FFACTURA <= '2023-11-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:53:41 - gbenavides - replace into ff_facturas_all_tmp select  202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2023-10-01' and f.FFACTURA <= '2023-10-31') and (f.FFACTDES >= '2023-10-01' and f.FFACTHAS <= '2023-10-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:53:43 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2023-10-01' and FFACTHAS <= '2023-10-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 12:57:41 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 12:57:44 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 0
15/10/2024 12:57:44 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 0
15/10/2024 12:57:44 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2023-10-01' and factoring = 202410 and bloque = 0
15/10/2024 12:57:44 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:58:31 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 12:58:31 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 0 and TESTFACT = 'A';
15/10/2024 12:58:31 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 0 and TESTFACT = 'S';
15/10/2024 12:58:31 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 12:58:32 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2023-10-31' and f.factoring = 202410 and f.bloque = 0
15/10/2024 12:58:32 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2023-10-01' and f.factoring = 202410 and f.bloque = 0
15/10/2024 12:58:34 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 0
15/10/2024 12:58:36 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 0
15/10/2024 12:58:37 - gbenavides - delete from ff_nif_tmp;
15/10/2024 12:58:37 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 0 group by f.CNIFDNIC < 20000
15/10/2024 12:58:37 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 0
15/10/2024 12:58:41 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 1
15/10/2024 12:58:42 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-06-01' and f.fh_fin_fact <= '2024-06-30' and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 13:03:08 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 13:03:15 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-06-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-06-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 13:03:20 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-06-01' and FFACTHAS <= '2024-06-30') AND (FFACTURA >= '2024-07-01' and FFACTURA <= '2024-07-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:03:28 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-07-01' and FFACTURA <= '2024-07-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:03:29 - gbenavides - replace into ff_facturas_all_tmp select  202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-06-01' and f.FFACTURA <= '2024-06-30') and (f.FFACTDES >= '2024-06-01' and f.FFACTHAS <= '2024-06-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:03:30 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-06-01' and FFACTHAS <= '2024-06-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:03:30 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 13:03:31 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 1
15/10/2024 13:03:31 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 1
15/10/2024 13:03:31 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-06-01' and factoring = 202410 and bloque = 1
15/10/2024 13:03:32 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 13:04:10 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 13:04:10 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 1 and TESTFACT = 'A';
15/10/2024 13:04:10 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 1 and TESTFACT = 'S';
15/10/2024 13:04:11 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 13:04:11 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-06-30' and f.factoring = 202410 and f.bloque = 1
15/10/2024 13:04:11 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-06-01' and f.factoring = 202410 and f.bloque = 1
15/10/2024 13:04:15 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 1
15/10/2024 13:04:16 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 1
15/10/2024 13:04:17 - gbenavides - delete from ff_nif_tmp;
15/10/2024 13:04:17 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 1 group by f.CNIFDNIC < 20000
15/10/2024 13:04:18 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 1
15/10/2024 13:04:19 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 2
15/10/2024 13:04:19 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-07-01' and f.fh_fin_fact <= '2024-07-31' and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 13:07:10 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 13:07:31 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 13:07:36 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') AND (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:07:37 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:07:39 - gbenavides - replace into ff_facturas_all_tmp select  202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-07-01' and f.FFACTURA <= '2024-07-31') and (f.FFACTDES >= '2024-07-01' and f.FFACTHAS <= '2024-07-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:07:40 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:07:40 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 13:07:41 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 2
15/10/2024 13:07:41 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 2
15/10/2024 13:07:41 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-07-01' and factoring = 202410 and bloque = 2
15/10/2024 13:07:41 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 13:08:20 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 13:08:20 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 2 and TESTFACT = 'A';
15/10/2024 13:08:20 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 2 and TESTFACT = 'S';
15/10/2024 13:08:21 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 13:08:21 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-07-31' and f.factoring = 202410 and f.bloque = 2
15/10/2024 13:08:21 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-07-01' and f.factoring = 202410 and f.bloque = 2
15/10/2024 13:08:23 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 2
15/10/2024 13:08:24 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 2
15/10/2024 13:08:24 - gbenavides - delete from ff_nif_tmp;
15/10/2024 13:08:25 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 2 group by f.CNIFDNIC < 20000
15/10/2024 13:08:25 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 2
15/10/2024 13:08:26 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 3
15/10/2024 13:08:27 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-08-01' and f.fh_fin_fact <= '2024-08-31' and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 13:11:01 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 13:11:17 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 13:11:21 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') AND (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:11:22 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:11:23 - gbenavides - replace into ff_facturas_all_tmp select  202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-08-01' and f.FFACTURA <= '2024-08-31') and (f.FFACTDES >= '2024-08-01' and f.FFACTHAS <= '2024-08-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:11:25 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:11:25 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 13:11:26 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 3
15/10/2024 13:11:26 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 3
15/10/2024 13:11:26 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-08-01' and factoring = 202410 and bloque = 3
15/10/2024 13:11:26 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 13:11:58 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 13:11:58 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 3 and TESTFACT = 'A';
15/10/2024 13:11:58 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 3 and TESTFACT = 'S';
15/10/2024 13:11:58 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 13:11:59 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-08-31' and f.factoring = 202410 and f.bloque = 3
15/10/2024 13:11:59 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-08-01' and f.factoring = 202410 and f.bloque = 3
15/10/2024 13:12:00 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 3
15/10/2024 13:12:01 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 3
15/10/2024 13:12:02 - gbenavides - delete from ff_nif_tmp;
15/10/2024 13:12:02 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 3 group by f.CNIFDNIC < 20000
15/10/2024 13:12:02 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 3
15/10/2024 13:46:39 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410
15/10/2024 13:46:40 - gbenavides - delete from ff_facturas_all where factoring = 202410
15/10/2024 13:46:41 - gbenavides - delete from ff_estimacion where factoring = 202410
15/10/2024 13:46:41 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 0
15/10/2024 13:46:41 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2023-10-01' and f.fh_fin_fact <= '2023-10-31' and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 13:49:03 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 13:49:20 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 13:50:09 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2023-10-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2023-10-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2023-11-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2023-11-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 13:50:14 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2023-10-01' and FFACTHAS <= '2023-10-31') AND (FFACTURA >= '2023-11-01' and FFACTURA <= '2023-11-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:50:23 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2023-11-01' and FFACTURA <= '2023-11-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:50:23 - gbenavides - replace into ff_facturas_all_tmp select  202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2023-10-01' and f.FFACTURA <= '2023-10-31') and (f.FFACTDES >= '2023-10-01' and f.FFACTHAS <= '2023-10-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:50:28 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2023-10-01' and FFACTHAS <= '2023-10-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 13:54:56 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 13:54:57 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 0
15/10/2024 13:54:58 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 0
15/10/2024 13:54:59 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2023-10-01' and factoring = 202410 and bloque = 0
15/10/2024 13:55:00 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 13:59:05 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 13:59:05 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 0 and TESTFACT = 'A';
15/10/2024 13:59:06 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 0 and TESTFACT = 'S';
15/10/2024 13:59:07 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 13:59:07 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2023-10-31' and f.factoring = 202410 and f.bloque = 0
15/10/2024 13:59:07 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2023-10-01' and f.factoring = 202410 and f.bloque = 0
15/10/2024 13:59:11 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 0
15/10/2024 13:59:17 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 0
15/10/2024 13:59:20 - gbenavides - delete from ff_nif_tmp;
15/10/2024 13:59:20 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 0 group by f.CNIFDNIC < 20000
15/10/2024 13:59:20 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 0
15/10/2024 13:59:26 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 1
15/10/2024 13:59:26 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-06-01' and f.fh_fin_fact <= '2024-06-30' and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 14:03:05 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 14:03:12 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 14:03:40 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-06-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-06-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 14:03:45 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-06-01' and FFACTHAS <= '2024-06-30') AND (FFACTURA >= '2024-07-01' and FFACTURA <= '2024-07-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:03:47 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-07-01' and FFACTURA <= '2024-07-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:03:48 - gbenavides - replace into ff_facturas_all_tmp select  202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-06-01' and f.FFACTURA <= '2024-06-30') and (f.FFACTDES >= '2024-06-01' and f.FFACTHAS <= '2024-06-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:03:48 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-06-01' and FFACTHAS <= '2024-06-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:03:49 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 14:03:50 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 1
15/10/2024 14:03:50 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 1
15/10/2024 14:03:50 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-06-01' and factoring = 202410 and bloque = 1
15/10/2024 14:03:50 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 14:05:13 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 14:05:13 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 1 and TESTFACT = 'A';
15/10/2024 14:05:14 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 1 and TESTFACT = 'S';
15/10/2024 14:05:14 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 14:05:14 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-06-30' and f.factoring = 202410 and f.bloque = 1
15/10/2024 14:05:15 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-06-01' and f.factoring = 202410 and f.bloque = 1
15/10/2024 14:05:18 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 1
15/10/2024 14:05:21 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 1
15/10/2024 14:05:22 - gbenavides - delete from ff_nif_tmp;
15/10/2024 14:05:22 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 1 group by f.CNIFDNIC < 20000
15/10/2024 14:05:22 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 1
15/10/2024 14:05:24 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 2
15/10/2024 14:05:24 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-07-01' and f.fh_fin_fact <= '2024-07-31' and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 14:08:12 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 14:08:33 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 14:09:31 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 14:09:36 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') AND (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:09:37 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:09:39 - gbenavides - replace into ff_facturas_all_tmp select  202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-07-01' and f.FFACTURA <= '2024-07-31') and (f.FFACTDES >= '2024-07-01' and f.FFACTHAS <= '2024-07-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:09:39 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:09:40 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 14:09:41 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 2
15/10/2024 14:09:41 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 2
15/10/2024 14:09:41 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-07-01' and factoring = 202410 and bloque = 2
15/10/2024 14:09:42 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 14:12:21 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 14:12:22 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 2 and TESTFACT = 'A';
15/10/2024 14:12:22 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 2 and TESTFACT = 'S';
15/10/2024 14:12:22 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 14:12:22 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-07-31' and f.factoring = 202410 and f.bloque = 2
15/10/2024 14:12:23 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-07-01' and f.factoring = 202410 and f.bloque = 2
15/10/2024 14:12:25 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 2
15/10/2024 14:12:26 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 2
15/10/2024 14:12:26 - gbenavides - delete from ff_nif_tmp;
15/10/2024 14:12:27 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 2 group by f.CNIFDNIC < 20000
15/10/2024 14:12:27 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 2
15/10/2024 14:12:29 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 3
15/10/2024 14:12:29 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-08-01' and f.fh_fin_fact <= '2024-08-31' and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 14:15:12 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 14:15:27 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 14:16:01 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 14:16:05 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') AND (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:16:06 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:16:07 - gbenavides - replace into ff_facturas_all_tmp select  202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-08-01' and f.FFACTURA <= '2024-08-31') and (f.FFACTDES >= '2024-08-01' and f.FFACTHAS <= '2024-08-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:16:09 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 14:16:09 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 14:16:10 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 3
15/10/2024 14:16:10 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 3
15/10/2024 14:16:10 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-08-01' and factoring = 202410 and bloque = 3
15/10/2024 14:16:11 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 14:18:19 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 14:18:19 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 3 and TESTFACT = 'A';
15/10/2024 14:18:19 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 3 and TESTFACT = 'S';
15/10/2024 14:18:20 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 14:18:20 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-08-31' and f.factoring = 202410 and f.bloque = 3
15/10/2024 14:18:20 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-08-01' and f.factoring = 202410 and f.bloque = 3
15/10/2024 14:18:21 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 3
15/10/2024 14:18:22 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 3
15/10/2024 14:18:23 - gbenavides - delete from ff_nif_tmp;
15/10/2024 14:18:23 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 3 group by f.CNIFDNIC < 20000
15/10/2024 14:18:23 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 3
15/10/2024 15:37:44 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410
15/10/2024 15:37:45 - gbenavides - delete from ff_facturas_all where factoring = 202410
15/10/2024 15:37:46 - gbenavides - delete from ff_estimacion where factoring = 202410
15/10/2024 15:37:46 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 0
15/10/2024 15:37:46 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2023-10-01' and f.fh_fin_fact <= '2023-10-31' and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 15:39:59 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2023-11-01' and f.fh_contab <= '2023-11-30' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:40:23 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:40:39 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-11-01' and f.fh_fact <= '2023-11-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:41:08 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2023-10-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2023-10-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2023-11-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2023-11-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 15:41:12 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2023-10-01' and FFACTHAS <= '2023-10-31') AND (FFACTURA >= '2023-11-01' and FFACTURA <= '2023-11-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:41:14 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2023-11-01' and FFACTURA <= '2023-11-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:41:15 - gbenavides - replace into ff_facturas_all_tmp select  202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2023-10-01' and f.FFACTURA <= '2023-10-31') and (f.FFACTDES >= '2023-10-01' and f.FFACTHAS <= '2023-10-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:41:16 - gbenavides - replace into ff_facturas_all_tmp select 202410, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2023-10-01' and FFACTHAS <= '2023-10-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:44:10 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 15:44:13 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 0
15/10/2024 15:44:13 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 0
15/10/2024 15:44:14 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2023-10-01' and factoring = 202410 and bloque = 0
15/10/2024 15:44:14 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 15:48:18 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 15:48:19 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 0 and TESTFACT = 'A';
15/10/2024 15:48:19 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 0 and TESTFACT = 'S';
15/10/2024 15:48:19 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 15:48:20 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2023-10-31' and f.factoring = 202410 and f.bloque = 0
15/10/2024 15:48:20 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2023-10-01' and f.factoring = 202410 and f.bloque = 0
15/10/2024 15:48:23 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 0
15/10/2024 15:48:25 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 0
15/10/2024 15:48:26 - gbenavides - delete from ff_nif_tmp;
15/10/2024 15:48:27 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 0 group by f.CNIFDNIC < 20000
15/10/2024 15:48:27 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 0
15/10/2024 15:48:30 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 1
15/10/2024 15:48:30 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-06-01' and f.fh_fin_fact <= '2024-06-30' and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 15:52:04 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-07-01' and f.fh_contab <= '2024-07-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:52:08 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:52:15 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-07-01' and f.fh_fact <= '2024-07-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:52:25 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-06-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-06-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 15:52:30 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-06-01' and FFACTHAS <= '2024-06-30') AND (FFACTURA >= '2024-07-01' and FFACTURA <= '2024-07-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:52:31 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-07-01' and FFACTURA <= '2024-07-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:52:32 - gbenavides - replace into ff_facturas_all_tmp select  202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-06-01' and f.FFACTURA <= '2024-06-30') and (f.FFACTDES >= '2024-06-01' and f.FFACTHAS <= '2024-06-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:52:32 - gbenavides - replace into ff_facturas_all_tmp select 202410, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-06-01' and FFACTHAS <= '2024-06-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:52:33 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 15:52:34 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 1
15/10/2024 15:52:34 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 1
15/10/2024 15:52:34 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-06-01' and factoring = 202410 and bloque = 1
15/10/2024 15:52:34 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 15:53:55 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 15:53:55 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 1 and TESTFACT = 'A';
15/10/2024 15:53:55 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 1 and TESTFACT = 'S';
15/10/2024 15:53:56 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 15:53:56 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-06-30' and f.factoring = 202410 and f.bloque = 1
15/10/2024 15:53:56 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-06-01' and f.factoring = 202410 and f.bloque = 1
15/10/2024 15:54:01 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 1
15/10/2024 15:54:02 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 1
15/10/2024 15:54:03 - gbenavides - delete from ff_nif_tmp;
15/10/2024 15:54:03 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 1 group by f.CNIFDNIC < 20000
15/10/2024 15:54:03 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 1
15/10/2024 15:54:05 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 2
15/10/2024 15:54:05 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-07-01' and f.fh_fin_fact <= '2024-07-31' and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 15:56:38 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-08-01' and f.fh_contab <= '2024-08-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:56:51 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:57:10 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 15:57:34 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 15:57:38 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') AND (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:57:39 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:57:40 - gbenavides - replace into ff_facturas_all_tmp select  202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-07-01' and f.FFACTURA <= '2024-07-31') and (f.FFACTDES >= '2024-07-01' and f.FFACTHAS <= '2024-07-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:57:41 - gbenavides - replace into ff_facturas_all_tmp select 202410, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 15:57:41 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 15:57:42 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 2
15/10/2024 15:57:42 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 2
15/10/2024 15:57:42 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-07-01' and factoring = 202410 and bloque = 2
15/10/2024 15:57:42 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 16:00:13 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 16:00:14 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 2 and TESTFACT = 'A';
15/10/2024 16:00:14 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 2 and TESTFACT = 'S';
15/10/2024 16:00:14 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 16:00:14 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-07-31' and f.factoring = 202410 and f.bloque = 2
15/10/2024 16:00:15 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-07-01' and f.factoring = 202410 and f.bloque = 2
15/10/2024 16:00:17 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 2
15/10/2024 16:00:17 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 2
15/10/2024 16:00:18 - gbenavides - delete from ff_nif_tmp;
15/10/2024 16:00:18 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 2 group by f.CNIFDNIC < 20000
15/10/2024 16:00:18 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 2
15/10/2024 16:00:20 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202410 and bloque = 3
15/10/2024 16:00:20 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-08-01' and f.fh_fin_fact <= '2024-08-31' and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 16:02:44 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-09-01' and f.fh_contab <= '2024-09-30' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 16:02:47 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 16:03:01 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 16:03:23 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 16:03:28 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') AND (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 16:03:28 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 16:03:30 - gbenavides - replace into ff_facturas_all_tmp select  202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-08-01' and f.FFACTURA <= '2024-08-31') and (f.FFACTDES >= '2024-08-01' and f.FFACTHAS <= '2024-08-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 16:03:31 - gbenavides - replace into ff_facturas_all_tmp select 202410, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202410 and t.CFACTURA IS NOT NULL);
15/10/2024 16:03:31 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 16:03:32 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202410 and bloque = 3
15/10/2024 16:03:32 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202410 and bloque = 3
15/10/2024 16:03:33 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-08-01' and factoring = 202410 and bloque = 3
15/10/2024 16:03:33 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202410 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 16:05:37 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202410 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 16:05:37 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 3 and TESTFACT = 'A';
15/10/2024 16:05:38 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202410 and bloque = 3 and TESTFACT = 'S';
15/10/2024 16:05:38 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 16:05:38 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-08-31' and f.factoring = 202410 and f.bloque = 3
15/10/2024 16:05:38 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-08-01' and f.factoring = 202410 and f.bloque = 3
15/10/2024 16:05:40 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202410 and f.bloque = 3
15/10/2024 16:05:41 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202410 and bloque = 3
15/10/2024 16:05:41 - gbenavides - delete from ff_nif_tmp;
15/10/2024 16:05:41 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202410 and f.bloque = 3 group by f.CNIFDNIC < 20000
15/10/2024 16:05:42 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202410 and f.bloque = 3
15/10/2024 17:12:40 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411
15/10/2024 17:12:42 - gbenavides - delete from ff_facturas_all where factoring = 202411
15/10/2024 17:12:43 - gbenavides - delete from ff_estimacion where factoring = 202411
15/10/2024 17:12:43 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411 and bloque = 0
15/10/2024 17:12:43 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2023-11-01' and f.fh_fin_fact <= '2023-11-30' and f.fh_fact >='2023-12-01' and f.fh_fact <= '2023-12-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 17:15:26 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2023-12-01' and f.fh_contab <= '2023-12-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:15:30 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-12-01' and f.fh_fact <= '2023-12-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:15:55 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-12-01' and f.fh_fact <= '2023-12-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:16:27 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2023-11-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2023-11-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2023-12-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2023-12-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 17:16:31 - gbenavides - replace into ff_facturas_all_tmp select 202411, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2023-11-01' and FFACTHAS <= '2023-11-30') AND (FFACTURA >= '2023-12-01' and FFACTURA <= '2023-12-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:16:35 - gbenavides - replace into ff_facturas_all_tmp select 202411, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2023-12-01' and FFACTURA <= '2023-12-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:16:36 - gbenavides - replace into ff_facturas_all_tmp select  202411, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2023-11-01' and f.FFACTURA <= '2023-11-30') and (f.FFACTDES >= '2023-11-01' and f.FFACTHAS <= '2023-11-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:16:37 - gbenavides - replace into ff_facturas_all_tmp select 202411, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2023-11-01' and FFACTHAS <= '2023-11-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:19:18 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 17:19:19 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202411 and bloque = 0
15/10/2024 17:19:19 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202411 and bloque = 0
15/10/2024 17:19:19 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2023-11-01' and factoring = 202411 and bloque = 0
15/10/2024 17:19:19 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202411 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:23:00 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202411 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:23:00 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 0 and TESTFACT = 'A';
15/10/2024 17:23:01 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 0 and TESTFACT = 'S';
15/10/2024 17:23:01 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 17:23:01 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2023-11-30' and f.factoring = 202411 and f.bloque = 0
15/10/2024 17:23:02 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2023-11-01' and f.factoring = 202411 and f.bloque = 0
15/10/2024 17:23:04 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202411 and f.bloque = 0
15/10/2024 17:23:06 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202411 and bloque = 0
15/10/2024 17:23:07 - gbenavides - delete from ff_nif_tmp;
15/10/2024 17:23:07 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202411 and f.bloque = 0 group by f.CNIFDNIC < 20000
15/10/2024 17:23:07 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202411 and f.bloque = 0
15/10/2024 17:23:10 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411 and bloque = 1
15/10/2024 17:23:10 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-07-01' and f.fh_fin_fact <= '2024-07-31' and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 17:25:51 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-08-01' and f.fh_contab <= '2024-08-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:25:52 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:26:11 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:26:35 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 17:26:40 - gbenavides - replace into ff_facturas_all_tmp select 202411, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') AND (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:26:40 - gbenavides - replace into ff_facturas_all_tmp select 202411, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:26:41 - gbenavides - replace into ff_facturas_all_tmp select  202411, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-07-01' and f.FFACTURA <= '2024-07-31') and (f.FFACTDES >= '2024-07-01' and f.FFACTHAS <= '2024-07-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:26:42 - gbenavides - replace into ff_facturas_all_tmp select 202411, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:26:42 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 17:26:43 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202411 and bloque = 1
15/10/2024 17:26:43 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202411 and bloque = 1
15/10/2024 17:26:43 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-07-01' and factoring = 202411 and bloque = 1
15/10/2024 17:26:43 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202411 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:29:13 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202411 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:29:13 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 1 and TESTFACT = 'A';
15/10/2024 17:29:13 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 1 and TESTFACT = 'S';
15/10/2024 17:29:14 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 17:29:14 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-07-31' and f.factoring = 202411 and f.bloque = 1
15/10/2024 17:29:14 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-07-01' and f.factoring = 202411 and f.bloque = 1
15/10/2024 17:29:17 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202411 and f.bloque = 1
15/10/2024 17:29:17 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202411 and bloque = 1
15/10/2024 17:29:18 - gbenavides - delete from ff_nif_tmp;
15/10/2024 17:29:18 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202411 and f.bloque = 1 group by f.CNIFDNIC < 20000
15/10/2024 17:29:18 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202411 and f.bloque = 1
15/10/2024 17:29:20 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411 and bloque = 2
15/10/2024 17:29:20 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-08-01' and f.fh_fin_fact <= '2024-08-31' and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 17:31:39 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-09-01' and f.fh_contab <= '2024-09-30' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:31:40 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:31:55 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:32:17 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 17:32:21 - gbenavides - replace into ff_facturas_all_tmp select 202411, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') AND (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:32:21 - gbenavides - replace into ff_facturas_all_tmp select 202411, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:32:22 - gbenavides - replace into ff_facturas_all_tmp select  202411, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-08-01' and f.FFACTURA <= '2024-08-31') and (f.FFACTDES >= '2024-08-01' and f.FFACTHAS <= '2024-08-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:32:24 - gbenavides - replace into ff_facturas_all_tmp select 202411, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:32:24 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 17:32:24 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202411 and bloque = 2
15/10/2024 17:32:25 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202411 and bloque = 2
15/10/2024 17:32:25 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-08-01' and factoring = 202411 and bloque = 2
15/10/2024 17:32:25 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202411 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:34:29 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202411 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:34:29 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 2 and TESTFACT = 'A';
15/10/2024 17:34:29 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 2 and TESTFACT = 'S';
15/10/2024 17:34:29 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 17:34:30 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-08-31' and f.factoring = 202411 and f.bloque = 2
15/10/2024 17:34:30 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-08-01' and f.factoring = 202411 and f.bloque = 2
15/10/2024 17:34:32 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202411 and f.bloque = 2
15/10/2024 17:34:33 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202411 and bloque = 2
15/10/2024 17:34:33 - gbenavides - delete from ff_nif_tmp;
15/10/2024 17:34:33 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202411 and f.bloque = 2 group by f.CNIFDNIC < 20000
15/10/2024 17:34:33 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202411 and f.bloque = 2
15/10/2024 17:34:35 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411 and bloque = 3
15/10/2024 17:34:35 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-09-01' and f.fh_fin_fact <= '2024-09-30' and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 17:37:11 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-10-01' and f.fh_contab <= '2024-10-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:37:20 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:37:37 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:38:00 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-10-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-10-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 17:38:04 - gbenavides - replace into ff_facturas_all_tmp select 202411, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-09-01' and FFACTHAS <= '2024-09-30') AND (FFACTURA >= '2024-10-01' and FFACTURA <= '2024-10-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:38:04 - gbenavides - replace into ff_facturas_all_tmp select 202411, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-10-01' and FFACTURA <= '2024-10-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:38:04 - gbenavides - replace into ff_facturas_all_tmp select  202411, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-09-01' and f.FFACTURA <= '2024-09-30') and (f.FFACTDES >= '2024-09-01' and f.FFACTHAS <= '2024-09-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:38:04 - gbenavides - replace into ff_facturas_all_tmp select 202411, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-09-01' and FFACTHAS <= '2024-09-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 17:38:05 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 17:38:05 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202411 and bloque = 3
15/10/2024 17:38:05 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202411 and bloque = 3
15/10/2024 17:38:06 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-09-01' and factoring = 202411 and bloque = 3
15/10/2024 17:38:06 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202411 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:40:06 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202411 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:40:06 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 3 and TESTFACT = 'A';
15/10/2024 17:40:06 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 3 and TESTFACT = 'S';
15/10/2024 17:40:06 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 17:40:07 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-09-30' and f.factoring = 202411 and f.bloque = 3
15/10/2024 17:40:07 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-09-01' and f.factoring = 202411 and f.bloque = 3
15/10/2024 17:40:09 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202411 and f.bloque = 3
15/10/2024 17:40:10 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202411 and bloque = 3
15/10/2024 17:40:11 - gbenavides - delete from ff_nif_tmp;
15/10/2024 17:40:11 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202411 and f.bloque = 3 group by f.CNIFDNIC < 20000
15/10/2024 17:40:11 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202411 and f.bloque = 3
15/10/2024 17:51:20 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412
15/10/2024 17:51:21 - gbenavides - delete from ff_facturas_all where factoring = 202412
15/10/2024 17:51:22 - gbenavides - delete from ff_estimacion where factoring = 202412
15/10/2024 17:51:22 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412 and bloque = 0
15/10/2024 17:51:22 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2023-12-01' and f.fh_fin_fact <= '2023-12-31' and f.fh_fact >='2024-01-01' and f.fh_fact <= '2024-01-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 17:53:38 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-01-01' and f.fh_contab <= '2024-01-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:53:41 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-01-01' and f.fh_fact <= '2024-01-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:53:50 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-01-01' and f.fh_fact <= '2024-01-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:54:05 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2023-12-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2023-12-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-01-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-01-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 17:54:10 - gbenavides - replace into ff_facturas_all_tmp select 202412, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2023-12-01' and FFACTHAS <= '2023-12-31') AND (FFACTURA >= '2024-01-01' and FFACTURA <= '2024-01-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 17:54:12 - gbenavides - replace into ff_facturas_all_tmp select 202412, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-01-01' and FFACTURA <= '2024-01-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 17:54:13 - gbenavides - replace into ff_facturas_all_tmp select  202412, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2023-12-01' and f.FFACTURA <= '2023-12-31') and (f.FFACTDES >= '2023-12-01' and f.FFACTHAS <= '2023-12-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 17:54:13 - gbenavides - replace into ff_facturas_all_tmp select 202412, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2023-12-01' and FFACTHAS <= '2023-12-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 17:54:26 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 17:54:27 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202412 and bloque = 0
15/10/2024 17:54:27 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202412 and bloque = 0
15/10/2024 17:54:27 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2023-12-01' and factoring = 202412 and bloque = 0
15/10/2024 17:54:27 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202412 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:56:20 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202412 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 17:56:20 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 0 and TESTFACT = 'A';
15/10/2024 17:56:20 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 0 and TESTFACT = 'S';
15/10/2024 17:56:21 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 17:56:21 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2023-12-31' and f.factoring = 202412 and f.bloque = 0
15/10/2024 17:56:21 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2023-12-01' and f.factoring = 202412 and f.bloque = 0
15/10/2024 17:56:23 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202412 and f.bloque = 0
15/10/2024 17:56:24 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202412 and bloque = 0
15/10/2024 17:56:24 - gbenavides - delete from ff_nif_tmp;
15/10/2024 17:56:25 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202412 and f.bloque = 0 group by f.CNIFDNIC < 20000
15/10/2024 17:56:25 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202412 and f.bloque = 0
15/10/2024 17:56:27 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412 and bloque = 1
15/10/2024 17:56:27 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-08-01' and f.fh_fin_fact <= '2024-08-31' and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 17:58:44 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-09-01' and f.fh_contab <= '2024-09-30' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:58:45 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:59:00 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 17:59:21 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 17:59:25 - gbenavides - replace into ff_facturas_all_tmp select 202412, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') AND (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 17:59:26 - gbenavides - replace into ff_facturas_all_tmp select 202412, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 17:59:26 - gbenavides - replace into ff_facturas_all_tmp select  202412, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-08-01' and f.FFACTURA <= '2024-08-31') and (f.FFACTDES >= '2024-08-01' and f.FFACTHAS <= '2024-08-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 17:59:27 - gbenavides - replace into ff_facturas_all_tmp select 202412, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 17:59:27 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 17:59:28 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202412 and bloque = 1
15/10/2024 17:59:28 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202412 and bloque = 1
15/10/2024 17:59:29 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-08-01' and factoring = 202412 and bloque = 1
15/10/2024 17:59:29 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202412 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:01:34 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202412 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:01:35 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 1 and TESTFACT = 'A';
15/10/2024 18:01:35 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 1 and TESTFACT = 'S';
15/10/2024 18:01:35 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:01:35 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-08-31' and f.factoring = 202412 and f.bloque = 1
15/10/2024 18:01:35 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-08-01' and f.factoring = 202412 and f.bloque = 1
15/10/2024 18:01:37 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202412 and f.bloque = 1
15/10/2024 18:01:38 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202412 and bloque = 1
15/10/2024 18:01:38 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:01:38 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202412 and f.bloque = 1 group by f.CNIFDNIC < 20000
15/10/2024 18:01:39 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202412 and f.bloque = 1
15/10/2024 18:01:40 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412 and bloque = 2
15/10/2024 18:01:40 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-09-01' and f.fh_fin_fact <= '2024-09-30' and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:06:28 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411
15/10/2024 18:06:30 - gbenavides - delete from ff_facturas_all where factoring = 202411
15/10/2024 18:06:31 - gbenavides - delete from ff_estimacion where factoring = 202411
15/10/2024 18:06:31 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411 and bloque = 0
15/10/2024 18:06:31 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2023-11-01' and f.fh_fin_fact <= '2023-11-30' and f.fh_fact >='2023-12-01' and f.fh_fact <= '2023-12-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:09:20 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2023-12-01' and f.fh_contab <= '2023-12-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:14:21 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-12-01' and f.fh_fact <= '2023-12-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:14:39 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2023-12-01' and f.fh_fact <= '2023-12-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:15:05 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2023-11-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2023-11-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2023-12-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2023-12-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 18:15:10 - gbenavides - replace into ff_facturas_all_tmp select 202411, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2023-11-01' and FFACTHAS <= '2023-11-30') AND (FFACTURA >= '2023-12-01' and FFACTURA <= '2023-12-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:15:11 - gbenavides - replace into ff_facturas_all_tmp select 202411, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2023-12-01' and FFACTURA <= '2023-12-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:15:12 - gbenavides - replace into ff_facturas_all_tmp select  202411, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2023-11-01' and f.FFACTURA <= '2023-11-30') and (f.FFACTDES >= '2023-11-01' and f.FFACTHAS <= '2023-11-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:15:12 - gbenavides - replace into ff_facturas_all_tmp select 202411, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2023-11-01' and FFACTHAS <= '2023-11-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:15:22 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 18:15:23 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202411 and bloque = 0
15/10/2024 18:15:23 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202411 and bloque = 0
15/10/2024 18:15:24 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2023-11-01' and factoring = 202411 and bloque = 0
15/10/2024 18:15:24 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202411 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:19:10 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202411 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:19:10 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 0 and TESTFACT = 'A';
15/10/2024 18:19:11 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 0 and TESTFACT = 'S';
15/10/2024 18:19:11 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:19:11 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2023-11-30' and f.factoring = 202411 and f.bloque = 0
15/10/2024 18:19:11 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2023-11-01' and f.factoring = 202411 and f.bloque = 0
15/10/2024 18:19:13 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202411 and f.bloque = 0
15/10/2024 18:19:14 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202411 and bloque = 0
15/10/2024 18:19:15 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:19:15 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202411 and f.bloque = 0 group by f.CNIFDNIC < 20000
15/10/2024 18:19:15 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202411 and f.bloque = 0
15/10/2024 18:19:17 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411 and bloque = 1
15/10/2024 18:19:17 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-07-01' and f.fh_fin_fact <= '2024-07-31' and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:22:29 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-08-01' and f.fh_contab <= '2024-08-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:22:30 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:22:50 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-08-01' and f.fh_fact <= '2024-08-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:23:15 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-07-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-07-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 18:23:20 - gbenavides - replace into ff_facturas_all_tmp select 202411, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') AND (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:23:21 - gbenavides - replace into ff_facturas_all_tmp select 202411, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-08-01' and FFACTURA <= '2024-08-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:23:21 - gbenavides - replace into ff_facturas_all_tmp select  202411, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-07-01' and f.FFACTURA <= '2024-07-31') and (f.FFACTDES >= '2024-07-01' and f.FFACTHAS <= '2024-07-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:23:22 - gbenavides - replace into ff_facturas_all_tmp select 202411, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-07-01' and FFACTHAS <= '2024-07-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:23:22 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 18:23:23 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202411 and bloque = 1
15/10/2024 18:23:23 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202411 and bloque = 1
15/10/2024 18:23:23 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-07-01' and factoring = 202411 and bloque = 1
15/10/2024 18:23:23 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202411 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:25:56 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202411 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:25:56 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 1 and TESTFACT = 'A';
15/10/2024 18:25:57 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 1 and TESTFACT = 'S';
15/10/2024 18:25:57 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:25:57 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-07-31' and f.factoring = 202411 and f.bloque = 1
15/10/2024 18:25:57 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-07-01' and f.factoring = 202411 and f.bloque = 1
15/10/2024 18:25:59 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202411 and f.bloque = 1
15/10/2024 18:26:00 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202411 and bloque = 1
15/10/2024 18:26:00 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:26:01 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202411 and f.bloque = 1 group by f.CNIFDNIC < 20000
15/10/2024 18:26:01 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202411 and f.bloque = 1
15/10/2024 18:26:02 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411 and bloque = 2
15/10/2024 18:26:02 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-08-01' and f.fh_fin_fact <= '2024-08-31' and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:28:30 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-09-01' and f.fh_contab <= '2024-09-30' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:28:30 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:28:46 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:29:08 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 18:29:13 - gbenavides - replace into ff_facturas_all_tmp select 202411, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') AND (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:29:13 - gbenavides - replace into ff_facturas_all_tmp select 202411, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:29:14 - gbenavides - replace into ff_facturas_all_tmp select  202411, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-08-01' and f.FFACTURA <= '2024-08-31') and (f.FFACTDES >= '2024-08-01' and f.FFACTHAS <= '2024-08-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:29:15 - gbenavides - replace into ff_facturas_all_tmp select 202411, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:29:15 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 18:29:16 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202411 and bloque = 2
15/10/2024 18:29:16 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202411 and bloque = 2
15/10/2024 18:29:16 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-08-01' and factoring = 202411 and bloque = 2
15/10/2024 18:29:16 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202411 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:31:23 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202411 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:31:23 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 2 and TESTFACT = 'A';
15/10/2024 18:31:23 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 2 and TESTFACT = 'S';
15/10/2024 18:31:23 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:31:24 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-08-31' and f.factoring = 202411 and f.bloque = 2
15/10/2024 18:31:24 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-08-01' and f.factoring = 202411 and f.bloque = 2
15/10/2024 18:31:25 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202411 and f.bloque = 2
15/10/2024 18:31:26 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202411 and bloque = 2
15/10/2024 18:31:26 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:31:26 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202411 and f.bloque = 2 group by f.CNIFDNIC < 20000
15/10/2024 18:31:27 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202411 and f.bloque = 2
15/10/2024 18:31:28 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202411 and bloque = 3
15/10/2024 18:31:28 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-09-01' and f.fh_fin_fact <= '2024-09-30' and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:34:00 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-10-01' and f.fh_contab <= '2024-10-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:34:01 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:34:15 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:34:36 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-10-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-10-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 18:34:40 - gbenavides - replace into ff_facturas_all_tmp select 202411, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-09-01' and FFACTHAS <= '2024-09-30') AND (FFACTURA >= '2024-10-01' and FFACTURA <= '2024-10-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:34:40 - gbenavides - replace into ff_facturas_all_tmp select 202411, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-10-01' and FFACTURA <= '2024-10-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:34:40 - gbenavides - replace into ff_facturas_all_tmp select  202411, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-09-01' and f.FFACTURA <= '2024-09-30') and (f.FFACTDES >= '2024-09-01' and f.FFACTHAS <= '2024-09-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:34:40 - gbenavides - replace into ff_facturas_all_tmp select 202411, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-09-01' and FFACTHAS <= '2024-09-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202411 and t.CFACTURA IS NOT NULL);
15/10/2024 18:34:41 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 18:34:41 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202411 and bloque = 3
15/10/2024 18:34:42 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202411 and bloque = 3
15/10/2024 18:34:42 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-09-01' and factoring = 202411 and bloque = 3
15/10/2024 18:34:42 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202411 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:36:45 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202411 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:36:46 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 3 and TESTFACT = 'A';
15/10/2024 18:36:46 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202411 and bloque = 3 and TESTFACT = 'S';
15/10/2024 18:36:46 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:36:46 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-09-30' and f.factoring = 202411 and f.bloque = 3
15/10/2024 18:36:47 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-09-01' and f.factoring = 202411 and f.bloque = 3
15/10/2024 18:36:48 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202411 and f.bloque = 3
15/10/2024 18:36:49 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202411 and bloque = 3
15/10/2024 18:36:49 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:36:49 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202411 and f.bloque = 3 group by f.CNIFDNIC < 20000
15/10/2024 18:36:50 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202411 and f.bloque = 3
15/10/2024 18:42:26 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412
15/10/2024 18:42:27 - gbenavides - delete from ff_facturas_all where factoring = 202412
15/10/2024 18:42:27 - gbenavides - delete from ff_estimacion where factoring = 202412
15/10/2024 18:42:27 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412 and bloque = 0
15/10/2024 18:42:28 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2023-12-01' and f.fh_fin_fact <= '2023-12-31' and f.fh_fact >='2024-01-01' and f.fh_fact <= '2024-01-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:44:46 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-01-01' and f.fh_contab <= '2024-01-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:44:47 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-01-01' and f.fh_fact <= '2024-01-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:44:53 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-01-01' and f.fh_fact <= '2024-01-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:45:06 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2023-12-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2023-12-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-01-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-01-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 18:45:11 - gbenavides - replace into ff_facturas_all_tmp select 202412, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2023-12-01' and FFACTHAS <= '2023-12-31') AND (FFACTURA >= '2024-01-01' and FFACTURA <= '2024-01-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:45:12 - gbenavides - replace into ff_facturas_all_tmp select 202412, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-01-01' and FFACTURA <= '2024-01-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:45:13 - gbenavides - replace into ff_facturas_all_tmp select  202412, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2023-12-01' and f.FFACTURA <= '2023-12-31') and (f.FFACTDES >= '2023-12-01' and f.FFACTHAS <= '2023-12-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:45:13 - gbenavides - replace into ff_facturas_all_tmp select 202412, 0, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2023-12-01' and FFACTHAS <= '2023-12-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:45:24 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 18:45:25 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202412 and bloque = 0
15/10/2024 18:45:25 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202412 and bloque = 0
15/10/2024 18:45:25 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2023-12-01' and factoring = 202412 and bloque = 0
15/10/2024 18:45:25 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202412 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:47:17 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202412 and f.bloque = 0 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:47:17 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 0 and TESTFACT = 'A';
15/10/2024 18:47:17 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 0 and TESTFACT = 'S';
15/10/2024 18:47:18 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:47:18 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2023-12-31' and f.factoring = 202412 and f.bloque = 0
15/10/2024 18:47:18 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2023-12-01' and f.factoring = 202412 and f.bloque = 0
15/10/2024 18:47:20 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202412 and f.bloque = 0
15/10/2024 18:47:20 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202412 and bloque = 0
15/10/2024 18:47:21 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:47:21 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202412 and f.bloque = 0 group by f.CNIFDNIC < 20000
15/10/2024 18:47:21 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202412 and f.bloque = 0
15/10/2024 18:47:23 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412 and bloque = 1
15/10/2024 18:47:23 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-08-01' and f.fh_fin_fact <= '2024-08-31' and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:49:47 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-09-01' and f.fh_contab <= '2024-09-30' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:49:47 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:50:03 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-09-01' and f.fh_fact <= '2024-09-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:50:26 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-08-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-08-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 18:50:30 - gbenavides - replace into ff_facturas_all_tmp select 202412, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') AND (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:50:31 - gbenavides - replace into ff_facturas_all_tmp select 202412, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-09-01' and FFACTURA <= '2024-09-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:50:32 - gbenavides - replace into ff_facturas_all_tmp select  202412, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-08-01' and f.FFACTURA <= '2024-08-31') and (f.FFACTDES >= '2024-08-01' and f.FFACTHAS <= '2024-08-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:50:32 - gbenavides - replace into ff_facturas_all_tmp select 202412, 1, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-08-01' and FFACTHAS <= '2024-08-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:50:33 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 18:50:33 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202412 and bloque = 1
15/10/2024 18:50:34 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202412 and bloque = 1
15/10/2024 18:50:34 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-08-01' and factoring = 202412 and bloque = 1
15/10/2024 18:50:34 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202412 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:52:38 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202412 and f.bloque = 1 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:52:38 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 1 and TESTFACT = 'A';
15/10/2024 18:52:38 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 1 and TESTFACT = 'S';
15/10/2024 18:52:38 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:52:38 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-08-31' and f.factoring = 202412 and f.bloque = 1
15/10/2024 18:52:39 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-08-01' and f.factoring = 202412 and f.bloque = 1
15/10/2024 18:52:40 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202412 and f.bloque = 1
15/10/2024 18:52:41 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202412 and bloque = 1
15/10/2024 18:52:41 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:52:41 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202412 and f.bloque = 1 group by f.CNIFDNIC < 20000
15/10/2024 18:52:42 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202412 and f.bloque = 1
15/10/2024 18:52:43 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412 and bloque = 2
15/10/2024 18:52:43 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-09-01' and f.fh_fin_fact <= '2024-09-30' and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:55:07 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-10-01' and f.fh_contab <= '2024-10-31' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:55:30 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:55:43 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-10-01' and f.fh_fact <= '2024-10-31' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:56:04 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-09-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-09-30' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-10-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-10-31' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 18:56:09 - gbenavides - replace into ff_facturas_all_tmp select 202412, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-09-01' and FFACTHAS <= '2024-09-30') AND (FFACTURA >= '2024-10-01' and FFACTURA <= '2024-10-31') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:56:09 - gbenavides - replace into ff_facturas_all_tmp select 202412, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-10-01' and FFACTURA <= '2024-10-31') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:56:09 - gbenavides - replace into ff_facturas_all_tmp select  202412, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-09-01' and f.FFACTURA <= '2024-09-30') and (f.FFACTDES >= '2024-09-01' and f.FFACTHAS <= '2024-09-30') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:56:09 - gbenavides - replace into ff_facturas_all_tmp select 202412, 2, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-09-01' and FFACTHAS <= '2024-09-30') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:56:09 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 18:56:10 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202412 and bloque = 2
15/10/2024 18:56:10 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202412 and bloque = 2
15/10/2024 18:56:10 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-09-01' and factoring = 202412 and bloque = 2
15/10/2024 18:56:11 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202412 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:58:11 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202412 and f.bloque = 2 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:58:12 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 2 and TESTFACT = 'A';
15/10/2024 18:58:12 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 2 and TESTFACT = 'S';
15/10/2024 18:58:12 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:58:12 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-09-30' and f.factoring = 202412 and f.bloque = 2
15/10/2024 18:58:12 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-09-01' and f.factoring = 202412 and f.bloque = 2
15/10/2024 18:58:14 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202412 and f.bloque = 2
15/10/2024 18:58:15 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202412 and bloque = 2
15/10/2024 18:58:15 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:58:15 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202412 and f.bloque = 2 group by f.CNIFDNIC < 20000
15/10/2024 18:58:16 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202412 and f.bloque = 2
15/10/2024 18:58:17 - gbenavides - delete from ff_facturas_all_tmp where factoring = 202412 and bloque = 3
15/10/2024 18:58:17 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'CO' then '1'	when 'MC' then '2' else '1'end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, dc.cd_cups_ext as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS,  o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact >='2024-10-01' and f.fh_fin_fact <= '2024-10-31' and f.fh_fact >='2024-11-01' and f.fh_fact <= '2024-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') )
15/10/2024 18:58:19 - gbenavides - select 'SAP_N0_SD' as CCOUNIPS, case f.cd_sociedad when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.nm_doc_oficial as CFACTURA, f.fh_contab as FFACTURA, f.fh_desde_fact as FFACTDES, f.fh_hasta_fact as FFACTHAS, f.im_factura as IFACTURA, f.im_impuesto1 as IVA, f.im_impuesto2 as IIMPUES2, f.im_impuesto3 as IIMPUES3, f.nm_base_ise as IBASEISE, f.im_base_ise as ISE, '5' as TFACTURA, case f.cd_estado_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_estado_fact end as TESTFACT, case when c.tx_apell_cli is null then f.de_nom_apell else c.tx_apell_cli end as DAPERSOC, f.nm_id as CNIFDNIC, f.cd_ind_cef_ope as INDEMPRE, null as CUPSREE, null as CFACTREC, '001' as CLINNEG, f1.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, 'L' as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.sap_tfactura_n0 f inner join ed_owner.t_ed_h_sap_facts f1 on f.cd_di=f1.cd_di	left join ed_owner.t_ed_f_clis c on f1.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.nm_doc_oficial = o.cd_fiscal_fact where f.im_factura > 0 and f.fh_desde_fact is null and f.fh_hasta_fact is null and f.fh_contab >='2024-11-01' and f.fh_contab <= '2024-11-30' and f.tp_fact in ('ZCLI','ZCOM','ZDEV','ZGAM','ZGAP','ZINT','ZLIQ','ZACL','ZAGA') and f.nm_doc_oficial is not null group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:58:20 - gbenavides - select 'SAP' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di inner join ed_owner.t_ed_h_ps ps on ps.cd_cups_ext = dc.cd_cups_ext	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-11-01' and f.fh_fact <= '2024-11-30' and f.cl_empr = '006' and ( (dc.cd_empr ='PT1Q' and ps.cd_tp_tension in ('MT','AT','MAT')) or (dc.cd_empr='ES21') ) group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:58:21 - gbenavides - select 'SAP_no_PS' as CCOUNIPS, case dc.cd_empr when 'ES21' then '20' when 'ES22' then '70' when 'PT1Q' then '80' else '0' end as CEMPTITU, f.cd_di as CREFEREN, 0 as SECFACTU, f.id_fact as CFACTURA, f.fh_fact as FFACTURA, f.fh_ini_fact as FFACTDES, f.fh_fin_fact as FFACTHAS, f.im_factdo_con_iva as IFACTURA, case when f.nm_total_iva is null then (f.im_factdo_con_iva-f.im_factdo_sin_iva) else f.nm_total_iva end as IVA, f.im_impuesto_2 as IIMPUES2, f.im_impuesto_3 as IIMPUES3, (f.im_factdo_sin_iva - f.im_impto_elect) as IBASEISE, f.im_impto_elect as ISE, case f.cd_tp_fact when 'AG' then '6' when 'SD' then '5' when 'ZCLI' then '5' when 'ZCOM' then '5' when 'ZDEV' then '5' when 'ZGAM' then '5' when 'ZGAP' then '5' when 'ZINT' then '5' when 'ZLIQ' then '5' when 'ZACL' then '5' when 'ZAGA' then '5' when 'CO' then '1' when 'MC' then '2' else '1' end as TFACTURA, case f.cd_est_fact when 'A' then 'Y' when 'X' then 'A' else f.cd_est_fact end as TESTFACT, c.tx_apell_cli as DAPERSOC, c.cd_nif_cif_cli as CNIFDNIC, 'OPERACIONES' as INDEMPRE, null as CUPSREE, null as CFACTREC, case dc.cd_linea_negocio when '001' then '1' when '002' then '2' else '1' end as CLINNEG, f.cd_tp_cli as CSEGMERC, 0 as NUMLABOR, case dc.cd_linea_negocio when '001' then 'L' when '002' then 'G' else 'L' end as TIPONEGOCIO, null as COMENTARIOS, o.fh_ini_vencimiento as FLIMPAGO, o.fh_puesta_cobro as FPTACOBR  from ed_owner.t_ed_h_sap_facts f inner join ed_owner.t_ed_h_sap_dc dc on f.cd_di=dc.cd_di	left join ed_owner.t_ed_f_clis c on f.cl_cli = c.cl_cli	left join ed_owner.t_ed_h_obligaciones o on f.id_fact = o.cd_fiscal_fact where f.fh_ini_fact is null and f.fh_fin_fact is null and f.fh_fact >='2024-11-01' and f.fh_fact <= '2024-11-30' and f.cl_empr = '006' and dc.cd_empr='ES21' group by ccounips,cemptitu,creferen,secfactu,cfactura,ffactura,ffactdes,ffacthas,ifactura,iva,iimpues2,iimpues3,ibaseise,ise,tfactura,testfact,dapersoc,cnifdnic,indempre,cupsree,cfactrec,clinneg,csegmerc,numlabor,tiponegocio,flimpago,fptacobr
15/10/2024 18:58:22 - gbenavides - select 'SIGAME' as CCOUNIPS, case T_SGM_G_PS.CD_PAIS when 'ESP' then '20' when 'POR' then '80' else '0' end as CEMPTITU, CONCAT(T_SGM_M_FACTURAS_REALES_PS.ID_FACTURA,T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS) as CREFEREN, '0' as SECFACTU, T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS as CFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA as FFACTURA, T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION as FFACTDES, T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION as FFACTHAS, T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO as IFACTURA, T_SGM_M_FACTURAS_REALES_PS.NM_IEH_IMPORTE + T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_IVA as IVA, '0' as IIMPUES2, '0' as IIMPUES3, '0' as IBASEISE, '0' as ISE, '1' as TFACTURA, T_SGM_M_FACTURAS_REALES_PS.CD_TESTFACT as TESTFACT, T_SGM_M_CLIENTES.DE_NOMBRE_CLIENTE as DAPERSOC, T_SGM_M_CLIENTES.CD_CIF as CNIFDNIC, 'OPERACIONES' as INDEMPRE, T_SGM_G_PS.CD_CUPS as CUPSREE, null as CFACTREC, '2' as CLINNEG, 'N' as CSEGMERC, 0 as NUMLABOR, 'G' as TIPONEGOCIO, null as COMENTARIOS, null as FLIMPAGO, null as FPTACOBR  from T_SGM_G_PS inner join T_SGM_G_CONTRATOS_PS on T_SGM_G_PS.ID_PS = T_SGM_G_CONTRATOS_PS.ID_PS inner join T_SGM_M_CLIENTES on T_SGM_G_PS.ID_CLIENTE = T_SGM_M_CLIENTES.ID_CLIENTE inner join dbo.T_SGM_M_FACTURAS_REALES_PS on T_SGM_G_CONTRATOS_PS.ID_CTO_PS = T_SGM_M_FACTURAS_REALES_PS.ID_CTO_PS WHERE T_SGM_M_FACTURAS_REALES_PS.NM_IMPORTE_BRUTO > 0  AND T_SGM_M_FACTURAS_REALES_PS.FH_INI_FACTURACION >= '2024-10-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FIN_FACTURACION <= '2024-10-31' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA >= '2024-11-01' AND T_SGM_M_FACTURAS_REALES_PS.FH_FACTURA <= '2024-11-30' AND T_SGM_M_FACTURAS_REALES_PS.CD_NFACTURA_REALES_PS IS NOT null
15/10/2024 18:58:23 - gbenavides - replace into ff_facturas_all_tmp select 202412, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTDES >= '2024-10-01' and FFACTHAS <= '2024-10-31') AND (FFACTURA >= '2024-11-01' and FFACTURA <= '2024-11-30') and TFACTURA in (1,2) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:58:23 - gbenavides - replace into ff_facturas_all_tmp select 202412, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo where (FFACTURA >= '2024-11-01' and FFACTURA <= '2024-11-30') and TFACTURA in (5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:58:23 - gbenavides - replace into ff_facturas_all_tmp select  202412, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where (f.FFACTURA >= '2024-10-01' and f.FFACTURA <= '2024-10-31') and (f.FFACTDES >= '2024-10-01' and f.FFACTHAS <= '2024-10-31') and f.TFACTURA in (1,2,5,6) and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:58:23 - gbenavides - replace into ff_facturas_all_tmp select 202412, 3, CCOUNIPS, CEMPTITU, CREFEREN, SECFACTU, CFACTURA, FFACTURA, FFACTDES, FFACTHAS, IFACTURA, IVA, IIMPUES2, IIMPUES3, IBASEISE, ISE, TFACTURA, TESTFACT, DAPERSOC, CNIFDNIC, INDEMPRE, CUPSREE, CFACTREC, CLINNEG, CSEGMERC, NUMLABOR, TIPONEGOCIO, null from fo f where f.CEMPTITU <> 70 and (FFACTDES >= '2024-10-01' and FFACTHAS <= '2024-10-31') and f.TIPONEGOCIO = 'G' and CFACTURA NOT IN (select t.CFACTURA from ff_facturas_all_tmp t where t.factoring=202412 and t.CFACTURA IS NOT NULL);
15/10/2024 18:58:23 - gbenavides - update ff_facturas_all_tmp set tfactura = 1 where TIPONEGOCIO = 'G';
15/10/2024 18:58:24 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 70 and factoring = 202412 and bloque = 3
15/10/2024 18:58:24 - gbenavides - delete from ff_facturas_all_tmp where CEMPTITU = 20 and INDEMPRE = 'CEFACO' and factoring = 202412 and bloque = 3
15/10/2024 18:58:24 - gbenavides - delete from ff_facturas_all_tmp where ffacthas < '2024-10-01' and factoring = 202412 and bloque = 3
15/10/2024 18:58:24 - gbenavides - update ff_facturas_all_tmp f left outer join fo_s s on s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU left outer join cm_inventario_gas i on i.ID_PS = s.ID_PS and (i.FINICIO <= f.FFACTDES and (i.FFIN >= f.FFACTHAS or i.FFIN is null)) and i.Grupo = 'Cisterna' set f.CUPSREE = concat('Cisterna_', i.ID_PS), f.CCOUNIPS = concat('Cisterna_', i.ID_PS) where f.factoring = 202412 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:58:25 - gbenavides - update ff_facturas_all_tmp f left outer join fo s on s.CEMPTITU = f.CEMPTITU and s.CREFEREN = f.CREFEREN and s.SECFACTU = f.SECFACTU set f.CUPSREE = s.CUPSREE, f.CCOUNIPS = s.CCOUNIPS where f.factoring = 202412 and f.bloque = 3 and f.TIPONEGOCIO = 'G' and (f.CUPSREE is null or LENGTH(f.CUPSREE) < 20);
15/10/2024 18:58:25 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 3 and TESTFACT = 'A';
15/10/2024 18:58:25 - gbenavides - delete from fact.ff_facturas_all_tmp where factoring = 202412 and bloque = 3 and TESTFACT = 'S';
15/10/2024 18:58:25 - gbenavides - delete from ff_facturas_pp_tmp;
15/10/2024 18:58:25 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTHAS < '2024-10-31' and f.factoring = 202412 and f.bloque = 3
15/10/2024 18:58:25 - gbenavides - select f.factoring, f.bloque, f.CCOUNIPS, f.CEMPTITU, f.CREFEREN, f.SECFACTU, f.CFACTURA, f.FFACTURA, f.FFACTDES, f.FFACTHAS, f.IFACTURA, f.IVA, f.IIMPUES2, f.IIMPUES3, f.IBASEISE, f.ISE, f.TFACTURA, f.TESTFACT, f.DAPERSOC, f.CNIFDNIC, f.INDEMPRE, f.CUPSREE, f.CFACTREC, f.CLINNEG, f.CSEGMERC, f.NUMLABOR, f.TIPONEGOCIO, f.COMENTARIOS from ff_facturas_all_tmp f where f.FFACTDES > '2024-10-01' and f.factoring = 202412 and f.bloque = 3
15/10/2024 18:58:26 - gbenavides - replace into ff_facturas_all_tmp_eliminadas select f.*, 'Importe inferior a 5000' from ff_facturas_all_tmp f where f.IFACTURA < 5000 and f.factoring = 202412 and f.bloque = 3
15/10/2024 18:58:26 - gbenavides - delete from ff_facturas_all_tmp where IFACTURA < 5000 and factoring = 202412 and bloque = 3
15/10/2024 18:58:26 - gbenavides - delete from ff_nif_tmp;
15/10/2024 18:58:26 - gbenavides - replace into ff_nif_tmp select f.CNIFDNIC, f.TIPONEGOCIO, sum(f.IFACTURA) as total from ff_facturas_all_tmp f where f.factoring = 202412 and f.bloque = 3 group by f.CNIFDNIC < 20000
15/10/2024 18:58:26 - gbenavides - delete f from ff_facturas_all_tmp f inner join ff_nif_tmp r on r.CNIFDNIC = f.CNIFDNIC where f.factoring = 202412 and f.bloque = 3
