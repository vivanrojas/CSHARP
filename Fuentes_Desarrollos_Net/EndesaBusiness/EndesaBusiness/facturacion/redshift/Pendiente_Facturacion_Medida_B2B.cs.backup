using EndesaBusiness.utilidades;
using MySql.Data.MySqlClient;
using OfficeOpenXml.Style;
using OfficeOpenXml;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using EndesaBusiness.servidores;

namespace EndesaBusiness.facturacion.redshift
{
    public class Pendiente_Facturacion_Medida_B2B
    {
        utilidades.Param param;
        utilidades.Seguimiento_Procesos ss_pp;
        logs.Log ficheroLog;

        Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> dic_pendiente_hist_fecha;
        Dictionary<string, DateTime> dic_dias_estado;

        EndesaBusiness.facturacion.redshift.Pendiente_Subestados subestados_sap;
        EndesaBusiness.medida.pendiente.PendienteWeb_B2B pendienteWeb_B2B;
        EndesaBusiness.medida.EstadosSubestadosKronos subestadosKronos;
        


        public Pendiente_Facturacion_Medida_B2B()
        {
            param = new utilidades.Param("t_ed_h_pendiente_sap_kronos_param", servidores.MySQLDB.Esquemas.FAC);
            ss_pp = new utilidades.Seguimiento_Procesos();
            ficheroLog = new logs.Log(Environment.CurrentDirectory, "logs", "FAC_MED_Pendiente_Facturacion_Medida_B2B");
            subestados_sap = new Pendiente_Subestados();
            subestadosKronos = new medida.EstadosSubestadosKronos();
            pendienteWeb_B2B = new medida.pendiente.PendienteWeb_B2B();

        }

        private DateTime UltimaActualizacionMySQL()
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            DateTime fecha = new DateTime(2022, 01, 01);

            strSql = "SELECT max(fh_envio) AS fh_envio FROM t_ed_h_sap_pendiente_facturar";
            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
                if (r["fh_envio"] != System.DBNull.Value)
                    fecha = Convert.ToDateTime(r["fh_envio"]);
            db.CloseConnection();
            Console.WriteLine("Última fecha de copiado MySQL: " + fecha.ToString("dd/MM/yyyy"));
            ficheroLog.Add("Última fecha de copiado MySQL: " + fecha.ToString("dd/MM/yyyy"));

            return fecha;
        }

        public void GeneraInformePendSAP(bool automatico)
        {
            FileInfo file;
            string ruta_salida_archivo = "";

            string[] listaArchivos = System.IO.Directory.GetFiles(automatico ? param.GetValue("ruta_salida_informe") : @"c:\Temp\",
                    param.GetValue("prefijo_informe") + "*.xlsx");

            for (int i = 0; i < listaArchivos.Length; i++)
            {
                file = new FileInfo(listaArchivos[i]);
                file.Delete();
            }

            if (automatico)
                ruta_salida_archivo = param.GetValue("ruta_salida_informe")
                    + param.GetValue("prefijo_informe")
                    + DateTime.Now.ToString("yyyyMMdd")
                    + param.GetValue("sufijo_informe");
            else
                ruta_salida_archivo = @"c:\Temp\"
                   + param.GetValue("prefijo_informe")
                   + DateTime.Now.ToString("yyyyMMdd")
                   + param.GetValue("sufijo_informe");

            InformePendiente_BI_Facturacion(ruta_salida_archivo, automatico);
        }

        private Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> CargaPendienteHist_DesdeFecha(DateTime f, List<string> lista_empresas)
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";

            Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> d
                = new Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>>();

            DateTime fecha_actual = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            DateTime fecha_registro = new DateTime();
            int meses_pdtes = 0;
            int aniomes = 0;
            int num_dias_informe = 0;
            bool firstOnly = true;

            try
            {




                //sof.Contruye_Sofisticados();
                //agoraManual = CargaAgoraManual(DateTime.Now, DateTime.Now);
                //agoraPortugal = new contratacion.Agora_Portugal();

                strSql = " SELECT fecha_informe, pend.empresa_titular AS EMPRESA,"
                    + " pend.cups13, "
                    + " pend.mes as aaaammPdte, pend.estado, pend.subestado, pend.tam"
                    + " FROM fact. pend where "
                    + " fecha_informe >= '" + f.ToString("yyyy-MM-dd") + "'"
                    + " ORDER BY pend.fecha_informe, pend.empresa_titular, "
                    + " pend.cups13, pend.mes ASC";

                strSql = "SELECT p.cd_empr_titular, ps.cd_empr, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                        + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, ps.cups20, ps.cd_tarifa_c,"
                        + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre, p.cd_estado, p.cd_subestado,"
                        + " de.de_estado, ds.de_subestado, p.fh_periodo, p.agora, p.TAM,"
                        + " p.lg_multimedida, p.fec_act"
                        + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p"
                        + " LEFT OUTER JOIN cont.t_ed_h_ps ps ON"
                        + " ps.cups20 = p.cd_cups"
                        + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                        + " de.cd_estado = p.cd_estado"
                        + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                        + " ds.cd_subestado = p.cd_subestado"
                        + " where p.fec_act >= '" + DateTime.Now.AddDays(-10).ToString("yyyy-MM-dd") + "'";

                foreach (string p in lista_empresas)
                {
                    if (firstOnly)
                    {
                        strSql += " and cd_empr_titular in ("
                            + "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";
                }



                strSql += ") ORDER BY p.fec_act desc, ps.cd_empr, "
                     + " ps.cups20, p.fh_periodo ASC";


                Console.WriteLine(strSql);
                ficheroLog.Add(strSql);
                db = new MySQLDB(MySQLDB.Esquemas.GBL);
                command = new MySqlCommand(strSql, db.con);
                r = command.ExecuteReader();
                while (r.Read())
                {
                    EndesaEntity.medida.Pendiente c = new EndesaEntity.medida.Pendiente();
                    c.cod_empresaTitular = r["cd_empr_titular"].ToString();
                    c.empresaTitular = r["cd_empr"].ToString();
                    c.cups20 = r["cups20"].ToString();
                    c.aaaammPdte = Convert.ToInt32(r["fh_periodo"]);
                    c.cod_estado = r["cd_estado"].ToString();
                    c.cod_subestado = r["cd_subestado"].ToString();
                    c.estado = r["de_estado"].ToString();
                    c.subsEstado = r["de_subestado"].ToString();
                    c.fecha_informe = Convert.ToDateTime(r["fec_act"]).Date;


                    if (r["tam"] != System.DBNull.Value)
                    {
                        if (c.aaaammPdte != 0)
                        {
                            aniomes = Convert.ToInt32(c.aaaammPdte);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);

                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12)
                                + fecha_actual.Month - fecha_registro.Month;
                            c.tam = Convert.ToDouble(r["tam"]) * meses_pdtes;
                        }
                        else
                            c.tam = Convert.ToDouble(r["tam"]);

                    }

                    if (r["agora"] != System.DBNull.Value)
                        if (r["agora"].ToString() != "N")
                            c.agora = true;
                        else
                            c.agora = false;
                    else
                        c.agora = false;

                    if (r["lg_multimedida"] != System.DBNull.Value)
                        c.multimedida = r["lg_multimedida"].ToString() == "S";
                    else
                        c.multimedida = false;


                    // Sólo necesitamos los últimos 5 días para el informe                    


                    List<EndesaEntity.medida.Pendiente> o;
                    if (!d.TryGetValue(c.fecha_informe, out o))
                    {

                        o = new List<EndesaEntity.medida.Pendiente>();
                        o.Add(c);
                        d.Add(c.fecha_informe, o);
                    }
                    else
                        o.Add(c);






                }
                db.CloseConnection();

                return d;
            }
            catch (Exception e)
            {
                ficheroLog.addError("CargaPendiente: " + e.Message);
                return null;
            }
        }
        private Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> CargaPendienteHist_PT_DesdeFecha(DateTime f, List<string> lista_empresas, List<string> lista_segmentos)
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";

            Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> d
                = new Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>>();

            DateTime fecha_actual = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            DateTime fecha_registro = new DateTime();
            int meses_pdtes = 0;
            int aniomes = 0;
            int num_dias_informe = 0;
            bool firstOnly = true;

            try
            {

                //sof.Contruye_Sofisticados();
                //agoraManual = CargaAgoraManual(DateTime.Now, DateTime.Now);
                //agoraPortugal = new contratacion.Agora_Portugal();


                strSql = "SELECT p.cd_empr_titular, ps.cd_empr, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                        + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, ps.cups20, ps.cd_tarifa_c, ps.cd_tp_tension,"
                        + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre, p.cd_estado, p.cd_subestado,"
                        + " de.de_estado, ds.de_subestado, p.fh_periodo, p.agora, p.TAM,"
                        + " p.lg_multimedida, p.fec_act"
                        + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p"
                        + " LEFT OUTER JOIN cont.t_ed_h_ps_pt ps ON"
                        + " ps.cups20 = p.cd_cups"
                        + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                        + " de.cd_estado = p.cd_estado"
                        + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                        + " ds.cd_subestado = p.cd_subestado"
                        + " where p.fec_act >= '" + DateTime.Now.AddDays(-10).ToString("yyyy-MM-dd") + "'";

                foreach (string p in lista_empresas)
                {
                    if (firstOnly)
                    {
                        strSql += " and cd_empr_titular in ("
                            + "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";
                }

                firstOnly = true;
                foreach (string p in lista_segmentos)
                {
                    if (firstOnly)
                    {
                        strSql += ") and cd_tp_tension in ("
                            + "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";
                }



                strSql += ") ORDER BY p.fec_act desc, ps.cd_empr, "
                     + " ps.cups20, p.fh_periodo ASC";


                Console.WriteLine(strSql);
                ficheroLog.Add(strSql);
                db = new MySQLDB(MySQLDB.Esquemas.GBL);
                command = new MySqlCommand(strSql, db.con);
                r = command.ExecuteReader();
                while (r.Read())
                {
                    EndesaEntity.medida.Pendiente c = new EndesaEntity.medida.Pendiente();
                    c.cod_empresaTitular = r["cd_empr_titular"].ToString();
                    c.empresaTitular = r["cd_empr"].ToString();
                    c.cups20 = r["cups20"].ToString();
                    c.aaaammPdte = Convert.ToInt32(r["fh_periodo"]);
                    c.cod_estado = r["cd_estado"].ToString();
                    c.cod_subestado = r["cd_subestado"].ToString();
                    c.estado = r["de_estado"].ToString();
                    c.subsEstado = r["de_subestado"].ToString();
                    c.fecha_informe = Convert.ToDateTime(r["fec_act"]).Date;

                    if (r["cd_tp_tension"] != System.DBNull.Value)
                        c.segmento = r["cd_tp_tension"].ToString();


                    if (r["tam"] != System.DBNull.Value)
                    {
                        if (c.aaaammPdte != 0)
                        {
                            aniomes = Convert.ToInt32(c.aaaammPdte);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);

                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12)
                                + fecha_actual.Month - fecha_registro.Month;
                            c.tam = Convert.ToDouble(r["tam"]) * meses_pdtes;
                        }
                        else
                            c.tam = Convert.ToDouble(r["tam"]);

                    }

                    if (r["agora"] != System.DBNull.Value)
                        if (r["agora"].ToString() != "N")
                            c.agora = true;
                        else
                            c.agora = false;
                    else
                        c.agora = false;

                    //if (r["lg_multimedida"] != System.DBNull.Value)
                    //    c.multimedida = r["lg_multimedida"].ToString() == "S";
                    //else
                    //    c.multimedida = false;



                    // Sólo necesitamos los últimos 5 días para el informe                    


                    List<EndesaEntity.medida.Pendiente> o;
                    if (!d.TryGetValue(c.fecha_informe, out o))
                    {

                        o = new List<EndesaEntity.medida.Pendiente>();
                        o.Add(c);
                        d.Add(c.fecha_informe, o);
                    }
                    else
                        o.Add(c);
                }
                db.CloseConnection();

                return d;
            }
            catch (Exception e)
            {
                ficheroLog.addError("CargaPendiente: " + e.Message);
                return null;
            }
        }
        private void InformePendiente_BI_Facturacion(string ruta_salida_archivo, bool automatico)
        {


            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";


            int c = 1;
            int f = 1;

            DateTime fecha_actual = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            DateTime fecha_registro = new DateTime();
            int meses_pdtes = 0;
            int aniomes = 0;

            bool tiene_complemento_a01 = false;
            bool sacar_portugal = true;


            DateTime fd = new DateTime();
            DateTime fd_tam = new DateTime();
            DateTime udh = new DateTime();

            string cups20 = "";

            utilidades.Fechas utilfecha = new Fechas();

            try
            {

                if (!automatico || (UltimaActualizacionMySQL().Date >
                    ss_pp.GetFecha_FinProceso("Facturación", "Informe Pendiente KRONOS SAP BI", "Informe Pendiente KRONOS SAP BI").Date))
                {

                    if (automatico)
                        ss_pp.Update_Fecha_Inicio("Facturación", "Informe Pendiente KRONOS SAP BI", "Informe Pendiente KRONOS SAP BI");


                    FileInfo plantillaExcel =
                        new FileInfo(System.Environment.CurrentDirectory +
                        param.GetValue("plantilla_informe_pendiente"));

                    FileInfo fileInfo = new FileInfo(ruta_salida_archivo);
                    ExcelPackage.LicenseContext = OfficeOpenXml.LicenseContext.Commercial;
                    ExcelPackage excelPackage = new ExcelPackage(plantillaExcel);

                    var workSheet = excelPackage.Workbook.Worksheets["Resumen ES"];
                    var headerCells = workSheet.Cells[1, 1, 1, 17];
                    var headerFont = headerCells.Style.Font;

                    List<string> lista_empresas_ES = new List<string>();
                    lista_empresas_ES.Add("ES21");
                    lista_empresas_ES.Add("ES22");

                    List<string> lista_empresas_PT = new List<string>();
                    lista_empresas_PT.Add("PT1Q");

                    List<string> lista_segmentos_MT_BTE = new List<string>();
                    lista_segmentos_MT_BTE.Add("MT");
                    lista_segmentos_MT_BTE.Add("BTE");

                    List<string> lista_segmentos_BTN = new List<string>();
                    lista_segmentos_BTN.Add("BTN");

                    // Tomamos lo últimos 5 días hábiles
                    // Si se lanza el listado en día fin de semana
                    // hay que quitar un día más porque el viernes todavía no se ha procesado



                    if (!utilfecha.EsLaborable())
                    {
                        fd = utilfecha.UltimoDiaHabilAnterior(
                               utilfecha.UltimoDiaHabilAnterior(
                                   utilfecha.UltimoDiaHabilAnterior(
                                       utilfecha.UltimoDiaHabilAnterior(
                                           utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil())))));

                        udh = utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil());
                    }
                    else
                    {
                        fd = utilfecha.UltimoDiaHabilAnterior(
                                utilfecha.UltimoDiaHabilAnterior(
                                    utilfecha.UltimoDiaHabilAnterior(
                                        utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil()))));

                        udh = utilfecha.UltimoDiaHabil();
                    }

                    dic_pendiente_hist_fecha = CargaPendienteHist_DesdeFecha(CalculaFechaDesdeinforme(), lista_empresas_ES);

                    fd_tam = utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil());





                    int totales_dia = 0;
                    double totales_dia_tam = 0;

                    bool noAgora = false;
                    bool siAgora = true;



                    // Nuevos Totales

                    int totales_noagora_01 = 0;
                    double totales_noagora_tam_01 = 0;

                    int totales_noagora_02 = 0;
                    double totales_noagora_tam_02 = 0;

                    int totales_noagora_03 = 0;
                    double totales_noagora_tam_03 = 0;

                    int totales_noagora_04 = 0;
                    double totales_noagora_tam_04 = 0;

                    int totales_agora_01 = 0;
                    double totales_agora_tam_01 = 0;

                    int totales_agora_02 = 0;
                    double totales_agora_tam_02 = 0;

                    int totales_agora_03 = 0;
                    double totales_agora_tam_03 = 0;

                    int totales_agora_04 = 0;
                    double totales_agora_tam_04 = 0;



                    Dictionary<DateTime, int> dic_Totales_cups = new Dictionary<DateTime, int>();
                    Dictionary<DateTime, double> dic_Totales_tam = new Dictionary<DateTime, double>();


                    dic_dias_estado = CargaDiasEstado();


                    int dia = 0;
                    int dia_tam = 0;


                    //c = 3;
                    c = 9;

                    // NO ÁGORA ES
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia++;

                        if (dia < 6)
                        {

                            Console.WriteLine("Totales ES noAgora dia: " + p.Key.ToString("dd/MM/yyyy"));

                            f = 4;
                            //c++;
                            c--;

                            workSheet.Cells[f, c].Value = p.Key;
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_01 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "01", null);

                            workSheet.Cells[f, c].Value = totales_noagora_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_02 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "02", null);

                            workSheet.Cells[f, c].Value = totales_noagora_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_03 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "03", null);

                            workSheet.Cells[f, c].Value = totales_noagora_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_04 =
                                 Total_Pendiente(noAgora, p.Key, lista_empresas_ES, null, "04", null);

                            workSheet.Cells[f, c].Value = totales_noagora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_noagora_01
                                + totales_noagora_02
                                + totales_noagora_03
                                + totales_noagora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            int o;
                            if (!dic_Totales_cups.TryGetValue(p.Key, out o))
                                dic_Totales_cups.Add(p.Key, totales_noagora_01
                                + totales_noagora_02
                                + totales_noagora_03
                                + totales_noagora_04);

                        }
                    }

                    //c = 8;
                    c = 14;


                    // NO ÁGORA TAM ES
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {



                        Console.WriteLine("Totales TAM ES noAgora dia: " + p.Key.ToString("dd/MM/yyyy"));

                        dia_tam++;

                        if (dia_tam < 6)
                        {

                            f = 4;
                            //c++;
                            c--;

                            workSheet.Cells[f, c].Value = p.Key;
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;


                            totales_noagora_tam_01 = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "01", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_02 =
                                  Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "02", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_03 =
                                  Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "03", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_04 =
                                 Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_ES, null, "04", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_noagora_tam_01
                                + totales_noagora_tam_02
                                + totales_noagora_tam_03
                                + totales_noagora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            double o;
                            if (!dic_Totales_tam.TryGetValue(p.Key, out o))
                                dic_Totales_tam.Add(p.Key, totales_noagora_tam_01
                                + totales_noagora_tam_02
                                + totales_noagora_tam_03
                                + totales_noagora_tam_04);

                        }
                    }


                    //c = 3;
                    c = 9;
                    dia = 0;

                    // ÁGORA ES
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia++;

                        if (dia < 6)
                        {

                            f = 54;

                            //c++;
                            c--;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_01 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "01", null);


                            workSheet.Cells[f, c].Value = totales_agora_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_02 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "02", null);


                            workSheet.Cells[f, c].Value = totales_agora_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_03 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "03", null);


                            workSheet.Cells[f, c].Value = totales_agora_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_04 =
                                 Total_Pendiente(siAgora, p.Key, lista_empresas_ES, null, "04", null);

                            workSheet.Cells[f, c].Value = totales_agora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_agora_01
                                + totales_agora_02
                                + totales_agora_03
                                + totales_agora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            int o;
                            if (dic_Totales_cups.TryGetValue(p.Key, out o))
                            {
                                workSheet.Cells[f, c].Value = o +
                               totales_agora_01
                                + totales_agora_02
                                + totales_agora_03
                                + totales_agora_04;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                            }

                        }

                    }
                    //c = 8;
                    c = 14;

                    dia_tam = 0;
                    // ÁGORA TAM ES
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia_tam++;

                        if (dia_tam < 6)
                        {

                            f = 54;
                            //c++;
                            c--;

                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_01 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "01", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_02 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "02", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_03 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "03", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_04 =
                                 Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_ES, null, "04", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_agora_tam_01
                                + totales_agora_tam_02
                                + totales_agora_tam_03
                                + totales_agora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;



                            double o;
                            if (dic_Totales_tam.TryGetValue(p.Key, out o))
                            {
                                workSheet.Cells[105, c].Value = o +
                                totales_agora_tam_01
                                + totales_agora_tam_02
                                + totales_agora_tam_03
                                + totales_agora_tam_04;
                                workSheet.Cells[105, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[105, c].Style.Font.Bold = true;
                            }

                        }
                    }


                    workSheet = excelPackage.Workbook.Worksheets["Resumen POR MT-BTE"];
                    headerCells = workSheet.Cells[1, 1, 1, 17];
                    headerFont = headerCells.Style.Font;

                    dic_Totales_cups.Clear();
                    dic_Totales_tam.Clear();

                    dic_pendiente_hist_fecha = CargaPendienteHist_PT_DesdeFecha(CalculaFechaDesdeinforme(), lista_empresas_PT, lista_segmentos_MT_BTE);

                    dia = 0;
                    dia_tam = 0;


                    c = 9;

                    // NO ÁGORA PT MT-BTE
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia++;

                        if (dia < 6)
                        {

                            Console.WriteLine("Totales PT MT-BTE noAgora dia: " + p.Key.ToString("dd/MM/yyyy"));

                            f = 4;
                            //c++;
                            c--;

                            workSheet.Cells[f, c].Value = p.Key;
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_01 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", null);

                            workSheet.Cells[f, c].Value = totales_noagora_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_02 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", null);

                            workSheet.Cells[f, c].Value = totales_noagora_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_03 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", null);

                            workSheet.Cells[f, c].Value = totales_noagora_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_04 =
                                 Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", null);

                            workSheet.Cells[f, c].Value = totales_noagora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_noagora_01
                                + totales_noagora_02
                                + totales_noagora_03
                                + totales_noagora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            int o;
                            if (!dic_Totales_cups.TryGetValue(p.Key, out o))
                                dic_Totales_cups.Add(p.Key, totales_noagora_01
                                + totales_noagora_02
                                + totales_noagora_03
                                + totales_noagora_04);

                        }
                    }

                    //c = 8;
                    c = 14;


                    // NO ÁGORA TAM PT MT-BTE
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {



                        Console.WriteLine("Totales TAM PT MT-BTE noAgora dia: " + p.Key.ToString("dd/MM/yyyy"));

                        dia_tam++;

                        if (dia_tam < 6)
                        {

                            f = 4;
                            //c++;
                            c--;

                            workSheet.Cells[f, c].Value = p.Key;
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;


                            totales_noagora_tam_01 = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_02 =
                                  Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_03 =
                                  Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_04 =
                                 Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_noagora_tam_01
                                + totales_noagora_tam_02
                                + totales_noagora_tam_03
                                + totales_noagora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            double o;
                            if (!dic_Totales_tam.TryGetValue(p.Key, out o))
                                dic_Totales_tam.Add(p.Key, totales_noagora_tam_01
                                + totales_noagora_tam_02
                                + totales_noagora_tam_03
                                + totales_noagora_tam_04);

                        }
                    }


                    //c = 3;
                    c = 9;
                    dia = 0;

                    // ÁGORA PT MT-BTE
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia++;

                        if (dia < 6)
                        {

                            f = 54;

                            //c++;
                            c--;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_01 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", null);


                            workSheet.Cells[f, c].Value = totales_agora_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_02 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", null);


                            workSheet.Cells[f, c].Value = totales_agora_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_03 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", null);


                            workSheet.Cells[f, c].Value = totales_agora_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_04 =
                                 Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", null);

                            workSheet.Cells[f, c].Value = totales_agora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_agora_01
                                + totales_agora_02
                                + totales_agora_03
                                + totales_agora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            int o;
                            if (dic_Totales_cups.TryGetValue(p.Key, out o))
                            {
                                workSheet.Cells[f, c].Value = o +
                               totales_agora_01
                                + totales_agora_02
                                + totales_agora_03
                                + totales_agora_04;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                            }

                        }

                    }
                    //c = 8;
                    c = 14;

                    dia_tam = 0;
                    // ÁGORA TAM PT MT-BTE
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia_tam++;

                        if (dia_tam < 6)
                        {

                            f = 54;
                            //c++;
                            c--;

                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_01 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "01", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_02 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "02", null);

                            workSheet.Cells[f, c].Value = totales_agora_tam_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_03 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "03", null);

                            workSheet.Cells[f, c].Value = totales_agora_tam_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_04 =
                                 Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_MT_BTE, "04", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_agora_tam_01
                                + totales_agora_tam_02
                                + totales_agora_tam_03
                                + totales_agora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;



                            double o;
                            if (dic_Totales_tam.TryGetValue(p.Key, out o))
                            {
                                workSheet.Cells[105, c].Value = o +
                                totales_agora_tam_01
                                + totales_agora_tam_02
                                + totales_agora_tam_03
                                + totales_agora_tam_04;
                                workSheet.Cells[105, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[105, c].Style.Font.Bold = true;
                            }


                        }
                    }

                    workSheet = excelPackage.Workbook.Worksheets["Resumen POR BTN"];
                    headerCells = workSheet.Cells[1, 1, 1, 17];
                    headerFont = headerCells.Style.Font;

                    dic_Totales_cups.Clear();
                    dic_Totales_tam.Clear();

                    dic_pendiente_hist_fecha = CargaPendienteHist_PT_DesdeFecha(CalculaFechaDesdeinforme(), lista_empresas_PT, lista_segmentos_BTN);

                    dia = 0;
                    dia_tam = 0;


                    c = 9;

                    // NO ÁGORA PT BTN
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia++;

                        if (dia < 6)
                        {

                            Console.WriteLine("Totales PT BTN noAgora dia: " + p.Key.ToString("dd/MM/yyyy"));

                            f = 4;
                            //c++;
                            c--;

                            workSheet.Cells[f, c].Value = p.Key;
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_01 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", null);

                            workSheet.Cells[f, c].Value = totales_noagora_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_02 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", null);

                            workSheet.Cells[f, c].Value = totales_noagora_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_03 =
                                  Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", null);

                            workSheet.Cells[f, c].Value = totales_noagora_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_noagora_04 =
                                 Total_Pendiente(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", null);

                            workSheet.Cells[f, c].Value = totales_noagora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_noagora_01
                                + totales_noagora_02
                                + totales_noagora_03
                                + totales_noagora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            int o;
                            if (!dic_Totales_cups.TryGetValue(p.Key, out o))
                                dic_Totales_cups.Add(p.Key, totales_noagora_01
                                + totales_noagora_02
                                + totales_noagora_03
                                + totales_noagora_04);

                        }
                    }

                    //c = 8;
                    c = 14;


                    // NO ÁGORA TAM PT BTN
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {



                        Console.WriteLine("Totales TAM PT BTN noAgora dia: " + p.Key.ToString("dd/MM/yyyy"));

                        dia_tam++;

                        if (dia_tam < 6)
                        {

                            f = 4;
                            //c++;
                            c--;

                            workSheet.Cells[f, c].Value = p.Key;
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;


                            totales_noagora_tam_01 = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_02 =
                                  Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_03 =
                                  Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_noagora_tam_04 =
                                 Total_Pendiente_TAM(noAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", null);

                            workSheet.Cells[f, c].Value = totales_noagora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_noagora_tam_01
                                + totales_noagora_tam_02
                                + totales_noagora_tam_03
                                + totales_noagora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            double o;
                            if (!dic_Totales_tam.TryGetValue(p.Key, out o))
                                dic_Totales_tam.Add(p.Key, totales_noagora_tam_01
                                + totales_noagora_tam_02
                                + totales_noagora_tam_03
                                + totales_noagora_tam_04);

                        }
                    }


                    //c = 3;
                    c = 9;
                    dia = 0;

                    // ÁGORA PT BTN
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia++;

                        if (dia < 6)
                        {

                            f = 54;

                            //c++;
                            c--;
                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_01 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", null);


                            workSheet.Cells[f, c].Value = totales_agora_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_02 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", null);


                            workSheet.Cells[f, c].Value = totales_agora_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_03 =
                                  Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", null);


                            workSheet.Cells[f, c].Value = totales_agora_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0"; f++;

                            totales_agora_04 =
                                 Total_Pendiente(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", null);

                            workSheet.Cells[f, c].Value = totales_agora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_agora_01
                                + totales_agora_02
                                + totales_agora_03
                                + totales_agora_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            int o;
                            if (dic_Totales_cups.TryGetValue(p.Key, out o))
                            {
                                workSheet.Cells[f, c].Value = o +
                               totales_agora_01
                                + totales_agora_02
                                + totales_agora_03
                                + totales_agora_04;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                            }

                        }

                    }
                    //c = 8;
                    c = 14;

                    dia_tam = 0;
                    // ÁGORA TAM PT BTN
                    foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                    {


                        dia_tam++;

                        if (dia_tam < 6)
                        {

                            f = 54;
                            //c++;
                            c--;

                            f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.K");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", "01.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_01 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "01", null);

                            workSheet.Cells[f, c].Value = totales_agora_tam_01;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", "02.B06");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_02 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "02", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_02;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B15");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.C");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.D");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.E");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.F");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.G");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.H");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.I");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.J");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.L");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", "03.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_03 =
                                  Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "03", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_03;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;

                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.A");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B01");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B02");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B03");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B04");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B05");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.B0Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;
                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", "04.Z");
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; f++;

                            totales_agora_tam_04 =
                                 Total_Pendiente_TAM(siAgora, p.Key, lista_empresas_PT, lista_segmentos_BTN, "04", null);


                            workSheet.Cells[f, c].Value = totales_agora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;


                            workSheet.Cells[f, c].Value = totales_agora_tam_01
                                + totales_agora_tam_02
                                + totales_agora_tam_03
                                + totales_agora_tam_04;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            workSheet.Cells[f, c].Style.Font.Bold = true;
                            f++;



                            double o;
                            if (dic_Totales_tam.TryGetValue(p.Key, out o))
                            {
                                workSheet.Cells[105, c].Value = o +
                                totales_agora_tam_01
                                + totales_agora_tam_02
                                + totales_agora_tam_03
                                + totales_agora_tam_04;
                                workSheet.Cells[105, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[105, c].Style.Font.Bold = true;
                            }


                        }
                    }

                    #region Detalle ES

                    f = 1;
                    c = 1;

                    workSheet = excelPackage.Workbook.Worksheets["Detalle ES"];
                    headerCells = workSheet.Cells[1, 1, 1, 17];
                    headerFont = headerCells.Style.Font;


                    headerCells = workSheet.Cells[1, 1, 1, 30];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;
                    var allCells = workSheet.Cells[1, 1, 50, 50];

                    workSheet.View.FreezePanes(2, 1);

                    //headerFont.Bold = true;
                    //workSheet.Cells[f, c].Value = "EMPRESA"; c++;
                    //workSheet.Cells[f, c].Value = "TIPO CLIENTE"; c++;
                    //workSheet.Cells[f, c].Value = "NIF"; c++;
                    //workSheet.Cells[f, c].Value = "CLIENTE"; c++;
                    //workSheet.Cells[f, c].Value = "FALTACONT"; c++;
                    //workSheet.Cells[f, c].Value = "FPSERCON"; c++;
                    //workSheet.Cells[f, c].Value = "CUPS20"; c++;
                    //workSheet.Cells[f, c].Value = "TARIFA"; c++;
                    //workSheet.Cells[f, c].Value = "CONTRATO"; c++;
                    //workSheet.Cells[f, c].Value = "MES"; c++;
                    //workSheet.Cells[f, c].Value = "DISTRIBUIDORA"; c++;
                    //workSheet.Cells[f, c].Value = "ESTADO"; c++;
                    //workSheet.Cells[f, c].Value = "SUBESTADO"; c++;
                    //workSheet.Cells[f, c].Value = "MULTIMEDIDA"; c++;
                    //workSheet.Cells[f, c].Value = "TAM"; c++;
                    //workSheet.Cells[f, c].Value = "MESES PDTES FACTURAR"; c++;
                    //workSheet.Cells[f, c].Value = "IMPORTE PDTE FACTURAR"; c++;
                    //workSheet.Cells[f, c].Value = "ÁGORA";


                    //for (int i = 1; i <= c; i++)
                    //{
                    //    workSheet.Cells[f, i].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    //    workSheet.Cells[f, i].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                    //}

                    DateTime fecha_informe = CalculaFechaDetalle();

                    strSql = "SELECT ps.cd_empr, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                        + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, p.cd_cups as cups20, p.id_instalacion, ps.cd_tarifa_c,"
                        + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre, p.lg_multimedida, p.cd_subestado,"
                        + " concat(p.cd_estado,' ',de.de_estado) as de_estado, concat(p.cd_subestado,' ',if (ds.de_subestado is null,'', ds.de_subestado)) as de_subestado, p.fh_periodo as mes, p.agora, p.TAM"
                        + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p"
                        + " LEFT OUTER JOIN cont.t_ed_h_ps ps ON"
                        + " ps.cups20 = p.cd_cups"
                        + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                        + " de.cd_estado = p.cd_estado"
                        + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                        + " ds.cd_subestado = p.cd_subestado"
                        + " where p.fh_envio = '" + fecha_informe.Date.ToString("yyyy-MM-dd") + "' and"
                        + " p.cd_empr_titular in ('ES21','ES22')";


                    strSql = DetalleExcel(fecha_informe, lista_empresas_ES, null);


                    db = new MySQLDB(MySQLDB.Esquemas.GBL);
                    command = new MySqlCommand(strSql, db.con);
                    r = command.ExecuteReader();
                    while (r.Read())
                    {
                        f++;
                        c = 1;

                        if (r["cd_empr"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_empr"].ToString();
                        c++;

                        if (r["de_tp_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_tp_cli"].ToString();
                        c++;

                        if (r["cd_nif_cif_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_nif_cif_cli"].ToString();
                        c++;

                        if (r["tx_apell_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["tx_apell_cli"].ToString();
                        c++;

                        if (r["fh_alta_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["fh_inicio_vers_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_inicio_vers_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["cups20"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = r["cups20"].ToString();
                            cups20 = r["cups20"].ToString();
                        }
                            
                        c++;

                        if (r["id_instalacion"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["id_instalacion"].ToString();
                        c++;

                        if (r["cd_tarifa_c"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_tarifa_c"].ToString();
                        c++;

                        if (r["cd_crto_comercial"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_crto_comercial"].ToString();
                        c++;

                        if (r["mes"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToInt32(r["mes"]);
                            aniomes = Convert.ToInt32(r["mes"]);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);
                        }
                        c++;

                        if (r["de_empr_distdora_nombre"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_empr_distdora_nombre"].ToString();
                        c++;

                        if (r["de_estado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_estado"].ToString();
                        c++;

                        if (r["de_subestado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_subestado"].ToString();
                        c++;

                        if (r["cups20"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());
                            workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        }                        
                        c++;

                        if (r["TAM"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["TAM"]);
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                        }
                        c++;


                        if (r["mes"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = meses_pdtes;
                            workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        }
                        c++;


                        if (r["mes"] != System.DBNull.Value && r["TAM"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["tam"]) * meses_pdtes;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; c++;
                        }
                        else
                        {
                            c++;
                        }

                        if (r["agora"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["agora"].ToString();

                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                        {
                            subestadosKronos.GetEstadoKEE(pendienteWeb_B2B.GetCups(r["cups20"].ToString(),
                                Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"])));

                            if (subestadosKronos.existe)
                            {
                                workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.descripcion_estado; c++;
                            }
                        }


                    }
                    db.CloseConnection();

                    headerCells = workSheet.Cells[1, 1, 1, c];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;
                    allCells = workSheet.Cells[1, 1, f, c];

                    allCells.AutoFitColumns();

                    //workSheet.View.FreezePanes(2, 1);
                    //workSheet.Cells["A1:S1"].AutoFilter = true;
                    //allCells.AutoFitColumns();

                    #endregion

                    #region Detalle POR MT-BTE
                    f = 1;
                    c = 1;

                    workSheet = excelPackage.Workbook.Worksheets["Detalle POR MT-BTE"];
                    headerCells = workSheet.Cells[1, 1, 1, 17];
                    headerFont = headerCells.Style.Font;


                    headerCells = workSheet.Cells[1, 1, 1, 30];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;
                    allCells = workSheet.Cells[1, 1, 50, 50];




                    //for (int i = 1; i <= c; i++)
                    //{
                    //    workSheet.Cells[f, i].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    //    workSheet.Cells[f, i].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                    //}




                    strSql = "SELECT ps.cd_empr, ps.cd_tp_tension, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                        + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, p.cd_cups as cups20, p.id_instalacion, ps.cd_tarifa_c,"
                        + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre,  p.lg_multimedida,"
                        + " concat(p.cd_estado,' ',de.de_estado) as de_estado, concat(p.cd_subestado,' ',ds.de_subestado) as de_subestado, p.fh_periodo as mes, p.agora, p.TAM"
                        + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p"
                        + " LEFT OUTER JOIN cont.t_ed_h_ps_pt ps ON"
                        + " ps.cups20 = p.cd_cups"
                        + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                        + " de.cd_estado = p.cd_estado"
                        + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                        + " ds.cd_subestado = p.cd_subestado"
                        + " where p.fh_envio = '" + fecha_informe.Date.ToString("yyyy-MM-dd") + "' and"
                        + " p.cd_empr_titular = 'PT1Q' and ps.cd_tp_tension in ('MT','BTE')";


                    strSql = DetalleExcel(fecha_informe, lista_empresas_PT, lista_segmentos_MT_BTE);

                    db = new MySQLDB(MySQLDB.Esquemas.GBL);
                    command = new MySqlCommand(strSql, db.con);
                    r = command.ExecuteReader();
                    while (r.Read())
                    {
                        f++;
                        c = 1;

                        if (r["cd_empr"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_empr"].ToString();
                        c++;

                        if (r["cd_tp_tension"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_tp_tension"].ToString();
                        c++;

                        if (r["de_tp_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_tp_cli"].ToString();
                        c++;

                        if (r["cd_nif_cif_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_nif_cif_cli"].ToString();
                        c++;

                        if (r["tx_apell_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["tx_apell_cli"].ToString();
                        c++;

                        if (r["fh_alta_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["fh_inicio_vers_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_inicio_vers_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["cups20"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cups20"].ToString();
                        c++;

                        if (r["id_instalacion"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["id_instalacion"].ToString();
                        c++;

                        if (r["cd_tarifa_c"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_tarifa_c"].ToString();
                        c++;

                        if (r["cd_crto_comercial"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_crto_comercial"].ToString();
                        c++;

                        if (r["mes"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToInt32(r["mes"]);
                            aniomes = Convert.ToInt32(r["mes"]);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);
                        }
                        c++;

                        if (r["de_empr_distdora_nombre"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_empr_distdora_nombre"].ToString();
                        c++;

                        if (r["de_estado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_estado"].ToString();
                        c++;

                        if (r["de_subestado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_subestado"].ToString();
                        c++;

                        //if (r["lg_multimedida"] != System.DBNull.Value)
                        //{
                        //    workSheet.Cells[f, c].Value = r["lg_multimedida"].ToString();

                        //}
                        //else
                        //{
                        //    workSheet.Cells[f, c].Value = "N";
                        //}

                        workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());

                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        if (r["TAM"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["TAM"]);
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                        }
                        c++;


                        if (r["mes"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = meses_pdtes;
                            workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        }
                        c++;


                        if (r["mes"] != System.DBNull.Value && r["TAM"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["tam"]) * meses_pdtes;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; c++;
                        }
                        else
                        {
                            c++;
                        }

                        if (r["agora"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["agora"].ToString();

                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                        {
                            subestadosKronos.GetEstadoKEE(pendienteWeb_B2B.GetCups(r["cups20"].ToString(),
                                Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"])));

                            if (subestadosKronos.existe)
                            {
                                workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.descripcion_estado; c++;
                            }
                        }


                    }
                    db.CloseConnection();


                    allCells = workSheet.Cells[1, 1, f, c];
                    allCells.AutoFitColumns();

                    #endregion

                    #region Detalle POR BTN

                    f = 1;
                    c = 1;

                    workSheet = excelPackage.Workbook.Worksheets["Detalle POR BTN"];
                    headerCells = workSheet.Cells[1, 1, 1, 17];
                    headerFont = headerCells.Style.Font;


                    headerCells = workSheet.Cells[1, 1, 1, 30];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;
                    allCells = workSheet.Cells[1, 1, 50, 50];




                    //for (int i = 1; i <= c; i++)
                    //{
                    //    workSheet.Cells[f, i].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    //    workSheet.Cells[f, i].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                    //}

                    strSql = "SELECT ps.cd_empr, ps.cd_tp_tension, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                        + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, p.cd_cups as cups20, p.id_instalacion, ps.cd_tarifa_c,"
                        + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre,  p.lg_multimedida,"
                        + " concat(p.cd_estado,' ',de.de_estado) as de_estado, concat(p.cd_subestado,' ',ds.de_subestado) as de_subestado, p.fh_periodo as mes, p.agora, p.TAM"
                        + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p"
                        + " LEFT OUTER JOIN cont.t_ed_h_ps_pt ps ON"
                        + " ps.cups20 = p.cd_cups"
                        + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                        + " de.cd_estado = p.cd_estado"
                        + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                        + " ds.cd_subestado = p.cd_subestado"
                        + " where p.fh_envio = '" + fecha_informe.Date.ToString("yyyy-MM-dd") + "' and"
                        + " p.cd_empr_titular = 'PT1Q' and ps.cd_tp_tension = 'BTN'";


                    strSql = DetalleExcel(fecha_informe, lista_empresas_PT, lista_segmentos_BTN);


                    db = new MySQLDB(MySQLDB.Esquemas.GBL);
                    command = new MySqlCommand(strSql, db.con);
                    r = command.ExecuteReader();
                    while (r.Read())
                    {
                        f++;
                        c = 1;

                        if (r["cd_empr"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_empr"].ToString();
                        c++;

                        if (r["cd_tp_tension"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_tp_tension"].ToString();
                        c++;

                        if (r["de_tp_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_tp_cli"].ToString();
                        c++;

                        if (r["cd_nif_cif_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_nif_cif_cli"].ToString();
                        c++;

                        if (r["tx_apell_cli"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["tx_apell_cli"].ToString();
                        c++;

                        if (r["fh_alta_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["fh_inicio_vers_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_inicio_vers_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["cups20"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cups20"].ToString();
                        c++;

                        if (r["id_instalacion"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["id_instalacion"].ToString();
                        c++;

                        if (r["cd_tarifa_c"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_tarifa_c"].ToString();
                        c++;

                        if (r["cd_crto_comercial"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_crto_comercial"].ToString();
                        c++;

                        if (r["mes"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToInt32(r["mes"]);
                            aniomes = Convert.ToInt32(r["mes"]);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);
                        }
                        c++;

                        if (r["de_empr_distdora_nombre"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_empr_distdora_nombre"].ToString();
                        c++;

                        if (r["de_estado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_estado"].ToString();
                        c++;

                        if (r["de_subestado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_subestado"].ToString();
                        c++;

                        //if (r["lg_multimedida"] != System.DBNull.Value)
                        //{
                        //    workSheet.Cells[f, c].Value = r["lg_multimedida"].ToString();

                        //}
                        //else
                        //{
                        //    workSheet.Cells[f, c].Value = "N";
                        //}

                        workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());
                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        if (r["TAM"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["TAM"]);
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                        }
                        c++;


                        if (r["mes"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = meses_pdtes;
                            workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        }
                        c++;


                        if (r["mes"] != System.DBNull.Value && r["TAM"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["tam"]) * meses_pdtes;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; c++;
                        }
                        else
                        {
                            c++;
                        }

                        if (r["agora"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["agora"].ToString();

                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                        {
                            subestadosKronos.GetEstadoKEE(pendienteWeb_B2B.GetCups(r["cups20"].ToString(),
                                Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"])));

                            if (subestadosKronos.existe)
                            {
                                workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                workSheet.Cells[f, c].Value = subestadosKronos.descripcion_estado; c++;
                            }
                        }

                    }
                    db.CloseConnection();


                    allCells = workSheet.Cells[1, 1, f, c];
                    allCells.AutoFitColumns();
                    #endregion 



                    excelPackage.SaveAs(fileInfo);


                    if (automatico && param.GetValue("mail_enviar_mail_psat_tam") == "S")
                    {
                        ss_pp.Update_Fecha_Fin("Facturación", "Informe Pendiente KRONOS SAP BI", "Informe Pendiente KRONOS SAP BI");
                        EnvioCorreo_PdteWeb_BI(ruta_salida_archivo, fecha_informe);
                    }

                    if (automatico)
                        ss_pp.Update_Fecha_Fin("Facturación", "Informe Pendiente KRONOS SAP BI", "Informe Pendiente KRONOS SAP BI");

                }
                else if (automatico)
                {
                    ss_pp.Update_Comentario("Facturación", "Informe Pendiente KRONOS SAP BI", "Informe Pendiente KRONOS SAP BI",
                        "La fecha de actualización en BI es: " + UltimaActualizacionMySQL().Date.ToString("dd/MM/yyyy"));
                }
            }

            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);

            }
        }

        private int Total_Pendiente(bool agora, DateTime fecha, List<string> lista_empresas, List<string> lista_segmentos, string estado, string subestado)
        {
            int total = 0;

            List<EndesaEntity.medida.Pendiente> o;

            if (lista_segmentos == null)
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int i = 0; i < o.Count; i++)
                        {
                            if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora &&
                                (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                total = total + 1;

                        }
                }
            }
            else
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int z = 0; z < lista_segmentos.Count; z++)
                            for (int i = 0; i < o.Count; i++)
                            {
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]
                                    && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                    total = total + 1;

                            }
                }
            }

            return total;

        }

        private double Total_Pendiente_TAM(bool agora, DateTime fecha, List<string> lista_empresas, List<string> lista_segmentos, string estado, string subestado)
        {
            double total = 0;

            List<EndesaEntity.medida.Pendiente> o;

            if (lista_segmentos == null)
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int i = 0; i < o.Count; i++)
                        {
                            if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora &&
                                (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                total = total + o[i].tam;

                        }


                }
            }
            else
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int z = 0; z < lista_segmentos.Count; z++)
                            for (int i = 0; i < o.Count; i++)
                            {
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]
                                        && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                    total = total + o[i].tam;

                            }


                }
            }

            return total;

        }

        private string DetalleExcel(DateTime fecha_informe, List<string> lista_empresas, List<string> lista_tension)
        {
            string strSql = "";
            bool firstOnly = true;


            

            strSql = "SELECT ps.cd_empr, ps.cd_tp_tension, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, p.cd_cups as cups20, p.id_instalacion, ps.cd_tarifa_c,"
                + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre, p.lg_multimedida, p.fh_desde, p.fh_hasta, p.cd_subestado,"
                + " concat(p.cd_estado,' ',de.de_estado) as de_estado, concat(p.cd_subestado,' ',if (ds.de_subestado is null,'', ds.de_subestado)) as de_subestado, p.fh_periodo as mes, p.agora, p.TAM"
                + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p";

            if (lista_empresas[0].Contains("PT"))
                strSql += " LEFT OUTER JOIN cont.t_ed_h_ps_pt ps ON";
            else
                strSql += " LEFT OUTER JOIN cont.t_ed_h_ps ps ON";

            strSql += " ps.cups20 = p.cd_cups"
                + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                + " de.cd_estado = p.cd_estado"
                + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                + " ds.cd_subestado = p.cd_subestado"
                + " where p.fh_envio = '" + fecha_informe.Date.ToString("yyyy-MM-dd") + "' and"
                + " p.cd_empr_titular in (";

            foreach (string p in lista_empresas)
            {
                if (firstOnly)
                {
                    strSql += "'" + p + "'";
                    firstOnly = false;
                }
                else
                    strSql += ",'" + p + "'";

            }

            strSql += ")";

            if (lista_tension != null)
            {
                firstOnly = true;
                strSql += " and ps.cd_tp_tension in (";
                foreach (string p in lista_tension)
                {
                    if (firstOnly)
                    {
                        strSql += "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";

                }
                strSql += ")";
            }

            return strSql;

        }
        private void EnvioCorreo_PdteWeb_BI(string archivo, DateTime fecha_informe)
        {
            FileInfo fileInfo = new FileInfo(archivo);
            StringBuilder textBody = new StringBuilder();

            try
            {
                string from = param.GetValue("mail_from_psat_tam");
                string to = param.GetValue("mail_to_psat_tam");
                string cc = param.GetValue("mail_cc_psat_tam");
                string subject = param.GetValue("mail_subject_psat_tam") + " a " + fecha_informe.ToString("dd/MM/yyyy");

                textBody.Append(System.Environment.NewLine);
                textBody.Append(DateTime.Now.Hour < 14 ? "Buenos días:" : "Buenas tardes:");
                textBody.Append(System.Environment.NewLine);
                textBody.Append("  Se adjunta el archivo ").Append(fileInfo.Name).Append(".");
                textBody.Append(System.Environment.NewLine);
                textBody.Append("Un saludo.");

                //EndesaBusiness.mail.MailExchangeServer mes = new EndesaBusiness.mail.MailExchangeServer("RSIOPEGMA001");
                EndesaBusiness.office365.OAuth_Mail mes = new EndesaBusiness.office365.OAuth_Mail();

                if (param.GetValue("mail_enviar_mail_psat_tam") == "S")
                    mes.SendMail(from, to, cc, subject, utilidades.FuncionesTexto.TextToHtml(textBody.ToString()), archivo);

                else
                    mes.SaveMail(from, to, cc, subject, utilidades.FuncionesTexto.TextToHtml(textBody.ToString()), archivo);

                ficheroLog.Add("Correo enviado desde: " + param.GetValue("mail_from"));
            }
            catch (Exception e)
            {
                ficheroLog.AddError("EnvioCorreo: " + e.Message);
            }
        }

        private DateTime CalculaFechaDesdeinforme()
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            DateTime date = DateTime.Now;

            strSql = "SELECT c.fh_envio"
                + " FROM t_ed_h_sap_pendiente_facturar_agrupado c"
                + " GROUP BY c.fh_envio desc"
                + " LIMIT 5";

            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
            {
                if (r["fh_envio"] != System.DBNull.Value)
                    date = Convert.ToDateTime(r["fh_envio"]);
            }
            db.CloseConnection();

            return date;

        }

        private DateTime CalculaFechaDetalle()
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            DateTime date = DateTime.Now;

            strSql = "SELECT max(c.fh_envio) as max_fecha"
                + " FROM t_ed_h_sap_pendiente_facturar_agrupado c";


            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
            {
                if (r["max_fecha"] != System.DBNull.Value)
                    date = Convert.ToDateTime(r["max_fecha"]);
            }
            db.CloseConnection();

            return date;

        }

        private Dictionary<string, DateTime> CargaDiasEstado()
        {
            Dictionary<string, DateTime> d = new Dictionary<string, DateTime>();

            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            string cups = "";
            DateTime primera_fecha = DateTime.Now;

            strSql = "SELECT p.cd_cups, p.fh_periodo, MIN(p.fh_envio) AS primera_fecha, p.cd_subestado"
                + " FROM t_ed_h_sap_pendiente_facturar_agrupado p"
                + " WHERE p.fh_periodo >= " + DateTime.Now.AddYears(-1).ToString("yyyyMM")
                + " GROUP BY p.cd_cups, p.fh_periodo, p.cd_subestado"
                + " ORDER BY p.fh_envio DESC";


            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
            {
                cups = r["cd_cups"].ToString();
                primera_fecha = Convert.ToDateTime(r["primera_fecha"]);

                DateTime o;
                if (!d.TryGetValue(cups, out o))
                    d.Add(cups, primera_fecha);

            }
            db.CloseConnection();
            return d;

        }

        private int GetDiasEstado(string cups)
        {
            int dias = 1;
            DateTime o;
            if (dic_dias_estado.TryGetValue(cups, out o))
            {
                dias = (DateTime.Now.Date - o.Date).Days + 1;
            }



            return dias;
        }
    }
}
