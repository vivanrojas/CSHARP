using EndesaBusiness.utilidades;
using MySql.Data.MySqlClient;
using OfficeOpenXml.Style;
using OfficeOpenXml;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using EndesaBusiness.servidores;
using System.Drawing;
using System.Data.Odbc;
using System.Diagnostics;
using System.Windows.Forms;
using Microsoft.Office.Interop.Excel;
using Excel = Microsoft.Office.Interop.Excel;
using Aspose.Cells;
using Workbook = Aspose.Cells.Workbook;
using Worksheet = Aspose.Cells.Worksheet;

///using Worksheet = Aspose.Cells.Worksheet;
using System.Data;
using DataTable = System.Data.DataTable;
using Style = Aspose.Cells.Style;
using Range = Aspose.Cells.Range;

namespace EndesaBusiness.facturacion.redshift
{
    public class Pendiente_Facturacion_Medida_B2B
    {
        utilidades.Param param;
        utilidades.Seguimiento_Procesos ss_pp;
        logs.Log ficheroLog;

        Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> dic_pendiente_hist_fecha;
        Dictionary<string, DateTime> dic_dias_estado;

        EndesaBusiness.facturacion.redshift.Pendiente_Subestados subestados_sap;
        EndesaBusiness.medida.pendiente.PendienteWeb_B2B pendienteWeb_B2B;
        EndesaBusiness.medida.pendiente.PendienteWeb_B2B pendienteWeb_B2BBTN;
        EndesaBusiness.medida.EstadosSubestadosKronos subestadosKronos;
        EndesaBusiness.medida.EstadosSubestadosKronos subestadosKronosBTN;
        EndesaBusiness.medida.pendiente.PendienteFacturadoSAPKEE pendienteSAPKEE;
        EndesaBusiness.medida.pendiente.SegmentosPortugal_KEE SegmentosPortugal_KEE;
        EndesaBusiness.medida.pendiente.PendienteWeb_B2B RelacionIncidencias;
        EndesaEntity.medida.Relacion_Incidencias_SAP RelacionIncidenciasSAP;
        //EndesaBusiness.facturacion.redshift.Relacion_Incidencias_SAP RelacionIncidenciasSAP;
        EndesaBusiness.medida.pendiente.PendienteWeb_B2B FechaBajaSap;
        EndesaBusiness.medida.pendiente.PendienteWeb_B2B RelacionIncidenciasCUPS;

        string SubestadosNoEncontrados = "";

        public void Kill(bool entireProcessTree) { }

        public Pendiente_Facturacion_Medida_B2B()
        {
    
            param = new utilidades.Param("t_ed_h_pendiente_sap_kronos_param", servidores.MySQLDB.Esquemas.FAC);
            ss_pp = new utilidades.Seguimiento_Procesos();
            ficheroLog = new logs.Log(Environment.CurrentDirectory, "logs", "FAC_MED_Pendiente_Facturacion_Medida_B2B");

            string FechaPdteWebB2B_fhact;
            FechaPdteWebB2B_fhact = CalculaFechaMaxPdteWebB2B().ToString(); //fec_act

            if (Convert.ToDateTime(FechaPdteWebB2B_fhact).ToString("yyyy-MM-dd") != DateTime.Now.ToString("yyyy-MM-dd"))
            {
                ss_pp.Update_Comentario("Facturación", "Informe Pendiente BI", "Informe SAP - KRONOS", "No está actualizada la tabla ed_owner.t_ed_h_pdtweb_pm_b2b");
                //System.Windows.Forms.MessageBox.Show("No está actualizada la tabla ed_owner.t_ed_h_pdtweb_pm_b2b");
                ficheroLog.Add("No está actualizada la tabla ed_owner.t_ed_h_pdtweb_pm_b2");
                Kill(true);
            }
            else {

                subestados_sap = new Pendiente_Subestados();
                RelacionIncidenciasSAP = new EndesaEntity.medida.Relacion_Incidencias_SAP();
                //RelacionIncidenciasSAP = new facturacion.redshift.Relacion_Incidencias_SAP();
                subestadosKronos = new medida.EstadosSubestadosKronos();
                subestadosKronosBTN = new medida.EstadosSubestadosKronos("BTN");
                pendienteWeb_B2B = new medida.pendiente.PendienteWeb_B2B();
                pendienteWeb_B2BBTN = new medida.pendiente.PendienteWeb_B2B("BTN");
                FechaBajaSap= new medida.pendiente.PendienteWeb_B2B(1);
                //////RelacionIncidenciasCUPS= new medida.pendiente.PendienteWeb_B2B(2); // es de Mysql la carga (la carga en la biblioteca está hecha y funciona), no lo sigo desarrollando en el código, mysql no penaliza
            }

            ///RelacionIncidencias = new medida.pendiente.PendienteWeb_B2B(true);
            //////SegmentosPortugal_KEE = new medida.pendiente.SegmentosPortugal_KEE();

        }

        private DateTime UltimaActualizacionMySQL()
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            DateTime fecha = new DateTime(2022, 01, 01);

            strSql = "SELECT max(fh_envio) AS fh_envio FROM t_ed_h_sap_pendiente_facturar";
            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
                if (r["fh_envio"] != System.DBNull.Value)
                    fecha = Convert.ToDateTime(r["fh_envio"]);
            db.CloseConnection();
            Console.WriteLine("Última fecha de copiado MySQL: " + fecha.ToString("dd/MM/yyyy"));
            ficheroLog.Add("Última fecha de copiado MySQL: " + fecha.ToString("dd/MM/yyyy"));

            return fecha;
        }

        public void GeneraInformePendSAP(bool automatico)
        {
            FileInfo file;
            string ruta_salida_archivo = "";

            string FechaPdteWebB2B_fhact;
            FechaPdteWebB2B_fhact = CalculaFechaMaxPdteWebB2B().ToString(); //fec_act

            
            ficheroLog.Add("Ejecutando Informe SAP-KRONOS: GeneraInformePendSAP()");

            if (Convert.ToDateTime(FechaPdteWebB2B_fhact).ToString("yyyy-MM-dd") != DateTime.Now.ToString("yyyy-MM-dd"))
            {
                ss_pp.Update_Comentario("Facturación", "Informe Pendiente BI", "Informe SAP - KRONOS", "No está actualizada la tabla ed_owner.t_ed_h_pdtweb_pm_b2b");
                ficheroLog.Add("Fin ejecución Informe SAP-KRONOS: No está actualizada la tabla ed_owner.t_ed_h_pdtweb_pm_b2");
                //System.Windows.Forms.MessageBox.Show("No está actualizada la tabla ed_owner.t_ed_h_pdtweb_pm_b2b");
                Kill(true);
            }
            else
            {
                ss_pp.Update_Fecha_Inicio("Facturación", "Informe Pendiente BI", "Informe SAP-KRONOS");
                

                string[] listaArchivos = System.IO.Directory.GetFiles(automatico ? param.GetValue("ruta_salida_informe") : @"c:\Temp\",
                        param.GetValue("prefijo_informe") + "*.xlsx");

                for (int i = 0; i < listaArchivos.Length; i++)
                {
                    file = new FileInfo(listaArchivos[i]);
                    file.Delete();
                }

                if (automatico)
                    ruta_salida_archivo = param.GetValue("ruta_salida_informe")
                        + param.GetValue("prefijo_informe")
                        + DateTime.Now.ToString("yyyyMMdd")
                        + param.GetValue("sufijo_informe");
                else
                    ruta_salida_archivo = @"c:\Temp\"
                       + param.GetValue("prefijo_informe")
                       + DateTime.Now.ToString("yyyyMMdd")
                       + param.GetValue("sufijo_informe");

                InformePendiente_BI_Facturacion(ruta_salida_archivo, automatico);
                
                ss_pp.Update_Fecha_Fin("Facturación", "Informe Pendiente BI", "Informe SAP-KRONOS");
                ficheroLog.Add("Fin ejecución Informe SAP-KRONOS: OK");
            }

        }

        private Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> CargaPendienteHist_DesdeFecha(DateTime f, List<string> lista_empresas)
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";

            Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> d
                = new Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>>();

            DateTime fecha_actual = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            DateTime fecha_registro = new DateTime();
            int meses_pdtes = 0;
            int aniomes = 0;
            int num_dias_informe = 0;
            bool firstOnly = true;
            string multipunto;
            bool blnRecalculoEstado;
            string areaincidencia;
            string subestado_incidencia;

            MySQLDB dbIncidencia;
            MySqlDataReader inci;
            bool ExisteIncidencia;
            string Auxiliar;

            try
            {

                //sof.Contruye_Sofisticados();
                //agoraManual = CargaAgoraManual(DateTime.Now, DateTime.Now);
                //agoraPortugal = new contratacion.Agora_Portugal();

                /*strSql = " SELECT fecha_informe, pend.empresa_titular AS EMPRESA,"
                    + " pend.cups13, "
                    + " pend.mes as aaaammPdte, pend.estado, pend.subestado, pend.tam"
                    + " FROM fact. pend where "
                    + " fecha_informe >= '" + f.ToString("yyyy-MM-dd") + "'"
                    + " ORDER BY pend.fecha_informe, pend.empresa_titular, "
                    + " pend.cups13, pend.mes ASC";
                */

                strSql = "SELECT p.cd_empr_titular, ps.cd_empr, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                        //+ " ps.fh_alta_crto, ps.fh_inicio_vers_crto, ps.cups20, ps.cd_tarifa_c,"
                        + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, p.cd_cups as cups20, ps.cd_tarifa_c,"
                        + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre, p.cd_estado, p.cd_subestado,"
                        + " de.de_estado, ds.de_subestado, p.fh_periodo, p.agora, p.TAM,"
                        + " p.lg_multimedida, p.fec_act, p.fh_desde, p.fh_hasta, ps.fh_prev_fin_crto, ps.fh_baja_crto"
                        + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p"
                        + " LEFT OUTER JOIN cont.t_ed_h_ps ps ON"
                        + " ps.cups20 = p.cd_cups"
                        + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                        + " de.cd_estado = p.cd_estado"
                        + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                        + " ds.cd_subestado = p.cd_subestado"

                    ////+ " where p.fec_act >= '" + DateTime.Now.AddDays(-10).ToString("yyyy-MM-dd") + "'"
                    //Paco 04/04/2024
                    //Hay problema de sincronización entre SAP y KEE, KEE se ejecuta todos los días y SAP no tiene pases los fines de semana/¿Festivos?
                    //los lunes puede esta más avanzado KEE que SAP, lanzamos con f menos 10 (f es las máxima fh_envio de sap_pendiente_facturar_agrupado)
                    + " where p.fec_act >= '" + f.AddDays(-10).ToString("yyyy-MM-dd") + "'"
                //+ " and p.fec_act <= '" + f.ToString("yyyy-MM-dd") + "'";
                //////+" and p.cd_cups in ('ES0031300684756001VX')";
                ///

                //Hay que quitar (porque así se decidió en la Negociación de este reporte) que no pueden aparecer registros con el mes pendiente = al mes en curso !!!!!!!!!!!
                + " and p.fh_periodo <> '" + DateTime.Now.ToString("yyyyMM") + "'";
                //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11


                foreach (string p in lista_empresas)
                {
                    if (firstOnly)
                    {
                        strSql += " and cd_empr_titular in ("
                            + "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";
                }

                strSql += ") ORDER BY p.fec_act desc, ps.cd_empr, "
                    //+ " ps.cups20, p.fh_periodo ASC";
                    +" p.cd_cups, p.fh_periodo ASC";


                Console.WriteLine(strSql);
                ficheroLog.Add(strSql);
                db = new MySQLDB(MySQLDB.Esquemas.GBL);
                command = new MySqlCommand(strSql, db.con);

                r = command.ExecuteReader();
                while (r.Read())
                {

                    EndesaEntity.medida.Pendiente c = new EndesaEntity.medida.Pendiente();
                    c.cod_empresaTitular = r["cd_empr_titular"].ToString();
                    c.empresaTitular = r["cd_empr"].ToString();
                    c.cups20 = r["cups20"].ToString();
      
                    c.aaaammPdte = Convert.ToInt32(r["fh_periodo"]);
                    c.cod_estado = r["cd_estado"].ToString();
                    c.cod_subestado = r["cd_subestado"].ToString();
                    c.estado = r["de_estado"].ToString();
                    c.subsEstado = r["de_subestado"].ToString();
                    c.fecha_informe = Convert.ToDateTime(r["fec_act"]).Date;
                    if (r["fh_prev_fin_crto"] != System.DBNull.Value)
                    {
                        c.fh_prev_fin_crto = Convert.ToDateTime(r["fh_prev_fin_crto"]).Date;
                    }
                    if (r["fh_baja_crto"] != System.DBNull.Value)
                    {
                        c.fh_baja_crto = Convert.ToDateTime(r["fh_baja_crto"]).Date;
                    }

                    c.fh_desde = Convert.ToDateTime(r["fh_desde"]).Date;
                    c.fh_hasta = Convert.ToDateTime(r["fh_hasta"]).Date;

                    c.fh_act = Convert.ToDateTime(r["fec_act"]).Date;

                    if (r["tam"] != System.DBNull.Value)
                    {
                        if (c.aaaammPdte != 0)
                        {
                            aniomes = Convert.ToInt32(c.aaaammPdte);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);

                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12)
                                + fecha_actual.Month - fecha_registro.Month;
                            c.tam = Convert.ToDouble(r["tam"]) * meses_pdtes;
                        }
                        else
                            c.tam = Convert.ToDouble(r["tam"]);

                    }

                    if (r["agora"] != System.DBNull.Value)
                        if (r["agora"].ToString() != "N")
                            c.agora = true;
                        else
                            c.agora = false;
                    else
                        c.agora = false;

                    if (r["lg_multimedida"] != System.DBNull.Value)
                        c.multimedida = r["lg_multimedida"].ToString() == "S";
                    else
                        c.multimedida = false;



                    multipunto = "";

                    //Vemos si es o no multipunto
                    List<string> Multipuntos = new List<string>();
                    Multipuntos = pendienteWeb_B2B.GetCupsMultipunto(r["cups20"].ToString());
                    if (Multipuntos.Count > 0)
                    {
                        if (Multipuntos[0] == "False")
                        {
                            multipunto = "N";
                        }
                        else
                        {
                            multipunto = "S";
                        }

                    }
                    else
                    {
                        multipunto = "N";
                    }


                    //if (r["cups20"].ToString() == "ES0021000001531208ZA") {

                    //    System.Windows.Forms.MessageBox.Show("");
                    //};

                    //AÑADIMOS las etiquetas de SAP
                    if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                    {
                        subestadosKronos.existe = false;
                        //he cambiado GetEstadoKEE  por GetEstadoKEEDetalle

                        //subestadosKronos.descripcion_subestado = "";
                        //subestadosKronos.temporal = "";
                        //c.cod_subestado = "";
                        //////c.cod_subestado_SAP = "";

                        //IMPORTANTE!!!! Limpiamos el temporal
                        subestadosKronos.temporal = "";

                        if (multipunto == "S")
                        {
                            subestadosKronos.GetEstadoKEEDetalleMultipunto(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                                Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));
                        }
                        else
                        {
                            subestadosKronos.GetEstadoKEEDetalle(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                                Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));
                        }

                        //////subestadosKronos.GetEstadoKEEDetalle(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                        //////    Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));

                        if (subestadosKronos.existe)
                        {
                            //ORIGINAL
                            //////c.subestado_SAP =  subestadosKronos.descripcion_subestado;

                            ////////workSheet.Cells[f, c].Value = subestadosKronos.descripcion_estado; c++;
                            //////c.cod_subestado_SAP = subestadosKronos.descripcion_subestado.Substring(0, subestadosKronos.descripcion_subestado.IndexOf(" "));
                            // FIN ORIGINAL



                            if (subestadosKronos.temporal == "" || subestadosKronos.temporal == null)
                            {

                                if (subestadosKronos.descripcion_estado.IndexOf("No existe el cups en el informe del pendiente de KEE") >= 0)
                                {
                                    c.subestado_SAP = "01.B07 Error Sistemas KEE - SAP - Pdte SAP - No existe en KEE";
                                    c.cod_subestado_SAP = "01.B07";
                                }
                                else
                                {
                                    if (subestadosKronos.descripcion_estado.IndexOf("No existen fechas en el informe pendiente de KEE para el periodo") >= 0)
                                    {
                                        c.subestado_SAP = "01.B06 Error Sistemas KEE-SAP - Pdte SAP-No pdte K";
                                        c.cod_subestado_SAP = "01.B06";
                                    }
                                    else
                                    {
                                        c.subestado_SAP = subestadosKronos.descripcion_subestado;
                                        c.cod_subestado_SAP = subestadosKronos.descripcion_subestado.Substring(0, subestadosKronos.descripcion_subestado.IndexOf(" "));
                                    }
                                }

                                //////if (subestadosKronos.descripcion_estado == "Discrepancia: No existe el cups en el informe del pendiente de KEE")
                                //////{
                                //////    c.subestado_SAP = null;
                                //////    c.cod_subestado_SAP = null;
                                //////}
                                //////else
                                //////{
                                //////    c.subestado_SAP = subestadosKronos.descripcion_subestado;
                                //////    c.cod_subestado_SAP = subestadosKronos.descripcion_subestado.Substring(0, subestadosKronos.descripcion_subestado.IndexOf(" "));
                                //////}
                            }
                            else
                            {
                                c.subestado_SAP = subestadosKronos.temporal;
                                c.cod_subestado_SAP = subestadosKronos.temporal.Substring(0, subestadosKronos.temporal.IndexOf(" "));
                            }


                            ///Paco 14/05/2024 - Control de incidencias /////////////////////////////////////////////////
                            //Existe KEE, evaluo area de incidencia con area de KEE

                            if (aniomes > 0) {
                                strSql = " select area from Relacion_INC_CUPS"
                                 + " where cups='" + r["cups20"].ToString() + "' and Mes_pendiente='" + aniomes.ToString() + "'"
                                 + " order by Fecha_apertura asc";

                                dbIncidencia = new MySQLDB(MySQLDB.Esquemas.MED);
                                command = new MySqlCommand(strSql, dbIncidencia.con);
                                inci = command.ExecuteReader();

                                ////ExisteIncidencia = false;

                                while (inci.Read())
                                {
                                    Auxiliar = Reincidente(inci["area"].ToString(), subestadosKronos.area_responsable);
                                    if (Auxiliar != "")
                                    {
                                        c.subestado_SAP = Auxiliar;
                                        c.cod_subestado_SAP = Auxiliar.Substring(0, 6);
                                    }
                                } // Fin  while (inci.Read())

                                dbIncidencia.CloseConnection();
                            } 
                            ////////////////////////////////////////////////////////////////////////////////////////////////
                       

                        }
                    }

                    // Sólo necesitamos los últimos 5 días para el informe                    
                    List <EndesaEntity.medida.Pendiente> o;
                    if (!d.TryGetValue(c.fecha_informe, out o))
                    {
                        
                        o = new List<EndesaEntity.medida.Pendiente>();
                        o.Add(c);
                        d.Add(c.fecha_informe, o);
                    }
                    else
                        o.Add(c);
                    System.Diagnostics.Debug.WriteLine(c.cups20 + "-" + c.fh_act + "-" + c.cod_subestado + "-" + c.cod_subestado + "-" + c.cod_subestado_SAP + "-" + c.cod_subestado_SAP);
                }
                db.CloseConnection();

                return d;
            }
            catch (Exception e)
            {
                ficheroLog.addError("CargaPendiente: " + e.Message);
                return null;
            }
        }
        private Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> CargaPendienteHist_PT_DesdeFecha(DateTime f, List<string> lista_empresas, List<string> lista_segmentos)
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";

            Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> d
                = new Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>>();

            DateTime fecha_actual = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            DateTime fecha_registro = new DateTime();
            int meses_pdtes = 0;
            int aniomes = 0;
            int num_dias_informe = 0;
            bool firstOnly = true;


            MySQLDB dbIncidencia;
            MySqlDataReader inci;
            bool ExisteIncidencia;
            string Auxiliar;

            try
            {
                //sof.Contruye_Sofisticados();
                //agoraManual = CargaAgoraManual(DateTime.Now, DateTime.Now);
                //agoraPortugal = new contratacion.Agora_Portugal();


                strSql = "SELECT p.cd_empr_titular, ps.cd_empr, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                        + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, p.cd_cups, ps.cd_tarifa_c, p.cd_segmento_ptg,"
                        + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre, p.cd_estado, p.cd_subestado,"
                        + " de.de_estado, ds.de_subestado, p.fh_periodo, p.agora, p.TAM,"
                        + " p.lg_multimedida, p.fec_act, p.fh_desde, p.fh_hasta"
                        + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p"
                        + " LEFT OUTER JOIN cont.t_ed_h_ps_pt ps ON"
                        + " ps.cups20 = p.cd_cups"
                        + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                        + " de.cd_estado = p.cd_estado"
                        + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                        + " ds.cd_subestado = p.cd_subestado"
                ////+ " where p.fec_act >= '" + DateTime.Now.AddDays(-10).ToString("yyyy-MM-dd") + "'";
                //+ " and ps.cups20 in ('ES0021000001531208ZA')"; 

                //Hay problema de sincronización entre SAP y KEE, KEE se ejecuta todos los días y SAP no tiene pases los fines de semana/¿Festivos?
                //los lunes puede esta más avanzado KEE que SAP, lanzamos con f menos 10 (f es las máxima fh_envio de sap_pendiente_facturar_agrupado)
                + " where p.fec_act >= '" + f.AddDays(-10).ToString("yyyy-MM-dd") + "'"
                //+ " and p.fec_act <= '" + f.ToString("yyyy-MM-dd") + "'";

                //Hay que quitar (porque así se decidió en la Negociación de este reporte) que no pueden aparecer registros con el mes pendiente = al mes en curso !!!!!!!!!!!
                +" and p.fh_periodo <> '" + DateTime.Now.ToString("yyyyMM") + "'";
                //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11

                foreach (string p in lista_empresas)
                {
                    if (firstOnly)
                    {
                        strSql += " and cd_empr_titular in ("
                            + "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";
                }

                firstOnly = true;
                foreach (string p in lista_segmentos)
                {
                    if (firstOnly)
                    {
                        strSql += ") and cd_segmento_ptg in ("
                            + "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";
                }



                strSql += ") ORDER BY p.fec_act desc, ps.cd_empr, "
                     + " ps.cups20, p.fh_periodo ASC";


                Console.WriteLine(strSql);
                ficheroLog.Add(strSql);
                db = new MySQLDB(MySQLDB.Esquemas.GBL);
                command = new MySqlCommand(strSql, db.con);
                r = command.ExecuteReader();
                while (r.Read())
                {
                    EndesaEntity.medida.Pendiente c = new EndesaEntity.medida.Pendiente();
                    c.cod_empresaTitular = r["cd_empr_titular"].ToString();
                    c.empresaTitular = r["cd_empr"].ToString();
                    c.cups20 = r["cd_cups"].ToString();
                    c.aaaammPdte = Convert.ToInt32(r["fh_periodo"]);
                    c.cod_estado = r["cd_estado"].ToString();
                    c.cod_subestado = r["cd_subestado"].ToString();
                    c.estado = r["de_estado"].ToString();
                    c.subsEstado = r["de_subestado"].ToString();
                    c.fecha_informe = Convert.ToDateTime(r["fec_act"]).Date;

                    c.fh_desde = Convert.ToDateTime(r["fh_desde"]).Date;
                    c.fh_hasta = Convert.ToDateTime(r["fh_hasta"]).Date;

                    if (r["cd_segmento_ptg"] != System.DBNull.Value)
                        c.segmento = r["cd_segmento_ptg"].ToString();


                    if (r["tam"] != System.DBNull.Value)
                    {
                        if (c.aaaammPdte != 0)
                        {
                            aniomes = Convert.ToInt32(c.aaaammPdte);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);

                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12)
                                + fecha_actual.Month - fecha_registro.Month;
                            c.tam = Convert.ToDouble(r["tam"]) * meses_pdtes;
                        }
                        else
                            c.tam = Convert.ToDouble(r["tam"]);

                    }

                    if (r["agora"] != System.DBNull.Value)
                        if (r["agora"].ToString() != "N")
                            c.agora = true;
                        else
                            c.agora = false;
                    else
                        c.agora = false;

                    //if (r["lg_multimedida"] != System.DBNull.Value)
                    //    c.multimedida = r["lg_multimedida"].ToString() == "S";
                    //else
                    //    c.multimedida = false;


                    //AÑADIMOS las etiquetas de SAP
                    if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                    {
                        //OLD
                        //////subestadosKronos.GetEstadoKEE(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                        //////    Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));
                        //FIN OLD

                        //IMPORTANTE!!!! Limpiamos el temporal
                        subestadosKronos.temporal = "";

                        subestadosKronos.GetEstadoKEEDetalle(pendienteWeb_B2B.GetCupsDetalle(r["cd_cups"].ToString(),
                            Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));


                        //OLD
                        //////if (subestadosKronos.existe)
                        //////{
                        //////    c.subestado_SAP = subestadosKronos.descripcion_subestado;
                        //////    c.cod_subestado_SAP = subestadosKronos.descripcion_subestado.Substring(0, subestadosKronos.descripcion_subestado.IndexOf(" "));
                        //////}
                        //OLD
                        if (subestadosKronos.existe)
                        {

                            if (subestadosKronos.temporal == "" || subestadosKronos.temporal == null)
                            {

                                if (subestadosKronos.descripcion_estado == "Discrepancia: No existe el cups en el informe del pendiente de KEE")
                                {
                                    c.subestado_SAP = "01.B07 Error Sistemas KEE - SAP - Pdte SAP - No existe en KEE";
                                    c.cod_subestado_SAP = "01.B07";
                                }
                                else
                                {
                                    if (subestadosKronos.descripcion_estado.IndexOf("No existen fechas en el informe pendiente de KEE para el periodo") >= 0)
                                    {
                                        c.subestado_SAP = "01.B06 Error Sistemas KEE-SAP - Pdte SAP-No pdte K";
                                        c.cod_subestado_SAP = "01.B06";
                                    }
                                    else
                                    {
                                        c.subestado_SAP = subestadosKronos.descripcion_subestado;
                                        c.cod_subestado_SAP = subestadosKronos.descripcion_subestado.Substring(0, subestadosKronos.descripcion_subestado.IndexOf(" "));
                                    }
                                }
                            }
                            else
                            {
                                c.subestado_SAP = subestadosKronos.temporal;
                                c.cod_subestado_SAP = subestadosKronos.temporal.Substring(0, subestadosKronos.temporal.IndexOf(" "));
                            }


                            ///Paco 14/05/2024 - Control de incidencias /////////////////////////////////////////////////
                            //Existe KEE, evaluo area de incidencia con area de KEE
                            if (aniomes > 0)
                            {
                                strSql = " select area from Relacion_INC_CUPS"
                                 + " where cups='" + r["cd_cups"].ToString() + "' and Mes_pendiente='" + aniomes.ToString() + "'"
                                 + " order by Fecha_apertura asc";

                                dbIncidencia = new MySQLDB(MySQLDB.Esquemas.MED);
                                command = new MySqlCommand(strSql, dbIncidencia.con);
                                inci = command.ExecuteReader();

                                ////ExisteIncidencia = false;

                                while (inci.Read())
                                {
                                    Auxiliar = Reincidente(inci["area"].ToString(), subestadosKronos.area_responsable);
                                    if (Auxiliar != "")
                                    {
                                        c.subestado_SAP = Auxiliar;
                                        c.cod_subestado_SAP = Auxiliar.Substring(0, 6);
                                    }
                                } // Fin  while (inci.Read())

                                dbIncidencia.CloseConnection();
                            }

                        }

                    }

                    // Sólo necesitamos los últimos 5 días para el informe                    
                    List<EndesaEntity.medida.Pendiente> o;
                    if (!d.TryGetValue(c.fecha_informe, out o))
                    {

                        o = new List<EndesaEntity.medida.Pendiente>();
                        o.Add(c);
                        d.Add(c.fecha_informe, o);
                    }
                    else
                        o.Add(c);
                }
                db.CloseConnection();

                return d;
            }
            catch (Exception e)
            {
                ficheroLog.addError("CargaPendiente: " + e.Message);
                return null;
            }
        }




        private Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> CargaPendienteHist_PT_DesdeFecha_BTN(DateTime f, List<string> lista_empresas, List<string> lista_segmentos)
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";

            Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>> d
                = new Dictionary<DateTime, List<EndesaEntity.medida.Pendiente>>();

            DateTime fecha_actual = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            DateTime fecha_registro = new DateTime();
            int meses_pdtes = 0;
            int aniomes = 0;
            int num_dias_informe = 0;
            bool firstOnly = true;
            int NumeroDias;
            DateTime fecha_calculada = new DateTime();

            try
            {
                //sof.Contruye_Sofisticados();
                //agoraManual = CargaAgoraManual(DateTime.Now, DateTime.Now);
                //agoraPortugal = new contratacion.Agora_Portugal();


                strSql = "SELECT p.cd_empr_titular, ps.cd_empr, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                        + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, p.cd_cups, ps.cd_tarifa_c, p.cd_segmento_ptg,"
                        + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre, p.cd_estado, p.cd_subestado,"
                        + " de.de_estado, ds.de_subestado, p.fh_periodo, p.agora, p.TAM,"
                        + " p.lg_multimedida, p.fec_act, p.fh_desde, p.fh_hasta"
                        + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p"
                        + " LEFT OUTER JOIN cont.t_ed_h_ps_pt ps ON"
                        + " ps.cups20 = p.cd_cups"
                        + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                        + " de.cd_estado = p.cd_estado"
                        + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                        + " ds.cd_subestado = p.cd_subestado"
                ////+ " where p.fec_act >= '" + DateTime.Now.AddDays(-10).ToString("yyyy-MM-dd") + "'";
                //+ " and ps.cups20 in ('ES0021000001531208ZA')"; 

                //Hay problema de sincronización entre SAP y KEE, KEE se ejecuta todos los días y SAP no tiene pases los fines de semana/¿Festivos?
                //los lunes puede esta más avanzado KEE que SAP, lanzamos con f menos 10 (f es las máxima fh_envio de sap_pendiente_facturar_agrupado)
                + " where p.fec_act >= '" + f.AddDays(-10).ToString("yyyy-MM-dd") + "'"
                //+ " and p.fec_act <= '" + f.ToString("yyyy-MM-dd") + "'";

                //Hay que quitar (porque así se decidió en la Negociación de este reporte) que no pueden aparecer registros con el mes pendiente = al mes en curso !!!!!!!!!!!
                + " and p.fh_periodo <> '" + DateTime.Now.ToString("yyyyMM") + "'";
                //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11

                foreach (string p in lista_empresas)
                {
                    if (firstOnly)
                    {
                        strSql += " and cd_empr_titular in ("
                            + "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";
                }

                firstOnly = true;
                foreach (string p in lista_segmentos)
                {
                    if (firstOnly)
                    {
                        strSql += ") and cd_segmento_ptg in ("
                            + "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";
                }



                strSql += ") ORDER BY p.fec_act desc, ps.cd_empr, "
                     + " p.cd_cups, p.fh_periodo ASC";


                Console.WriteLine(strSql);
                ficheroLog.Add(strSql);
                db = new MySQLDB(MySQLDB.Esquemas.GBL);
                command = new MySqlCommand(strSql, db.con);
                r = command.ExecuteReader();
                while (r.Read())
                {
                    EndesaEntity.medida.Pendiente c = new EndesaEntity.medida.Pendiente();
                    c.cod_empresaTitular = r["cd_empr_titular"].ToString();
                    c.empresaTitular = r["cd_empr"].ToString();
                    c.cups20 = r["cd_cups"].ToString();
                    c.aaaammPdte = Convert.ToInt32(r["fh_periodo"]);
                    c.cod_estado = r["cd_estado"].ToString();
                    c.cod_subestado = r["cd_subestado"].ToString();
                    c.estado = r["de_estado"].ToString();
                    c.subsEstado =  r["de_subestado"].ToString();
                    c.fecha_informe = Convert.ToDateTime(r["fec_act"]).Date;

                    c.fh_desde = Convert.ToDateTime(r["fh_desde"]).Date;
                    c.fh_hasta = Convert.ToDateTime(r["fh_hasta"]).Date;

                    if (r["cd_segmento_ptg"] != System.DBNull.Value)
                        c.segmento = r["cd_segmento_ptg"].ToString();


                    if (r["tam"] != System.DBNull.Value)
                    {
                        if (c.aaaammPdte != 0)
                        {
                            aniomes = Convert.ToInt32(c.aaaammPdte);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);

                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12)
                                + fecha_actual.Month - fecha_registro.Month;
                            c.tam = Convert.ToDouble(r["tam"]) * meses_pdtes;
                        }
                        else
                            c.tam = Convert.ToDouble(r["tam"]);

                    }

                    if (r["agora"] != System.DBNull.Value)
                        if (r["agora"].ToString() != "N")
                            c.agora = true;
                        else
                            c.agora = false;
                    else
                        c.agora = false;

                    //if (r["lg_multimedida"] != System.DBNull.Value)
                    //    c.multimedida = r["lg_multimedida"].ToString() == "S";
                    //else
                    //    c.multimedida = false;


                    //AÑADIMOS las etiquetas de SAP
                    if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                    {
                        //OLD
                        //////subestadosKronos.GetEstadoKEE(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                        //////    Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));
                        //FIN OLD

                        /// 
                        //IMPORTANTE!!!! Limpiamos el temporal
                        subestadosKronosBTN.temporal = "";

                        subestadosKronosBTN.GetEstadoKEEDetalleBTN(pendienteWeb_B2BBTN.GetCupsDetalle_BTN(r["cd_cups"].ToString(),
                            Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));

                        if (subestadosKronosBTN.existe)
                        {

                            if (subestadosKronosBTN.temporal == "" || subestadosKronosBTN.temporal == null)
                            {

                                if (subestadosKronosBTN.descripcion_estado == "Discrepancia: No existe el cups en el informe del pendiente de KEE")
                                {
                                    c.subestado_SAP = "01.B07 Error Sistemas KEE - SAP - Pdte SAP - No existe en KEE";
                                    c.cod_subestado_SAP = "01.B07";
                                }
                                else
                                {
                                    if (subestadosKronosBTN.descripcion_estado.IndexOf("No existen fechas en el informe pendiente de KEE para el periodo") >= 0)
                                    {

                                        NumeroDias = 0;

                                        string[] cadena = subestadosKronosBTN.descripcion_estado.Split(';');
                                        string[] cadenaAux = cadena[1].Split('/');
                                        //cadenaAux[0].Substring(1, 8).Substring(6, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(4, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(0, 4); c++;

                                        //////802 Facturada DISTRIBUIDORA       Pendiente KEE   01.C25  Pendiente Medida KEE - En ciclo de Medida           01_DISTRIBUIDORA      01_DISTRIBUIDORA
                                        //////802 Facturada MEDIDA              Pendiente KEE   01.C25  Pendiente Sistemas KEE - Pte ejecución algoritmo    02_INCIDENCIA_MEDIDA  02_INCIDENCIA

                                        fecha_calculada = Convert.ToDateTime(cadenaAux[0].Substring(1, 8).Substring(6, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(4, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(0, 4));
                                        fecha_calculada = fecha_calculada.AddDays(-1);
                                        NumeroDias = (DateTime.Now - fecha_calculada).Days;

                                        //Controlo si la fecha desde -1 hasta el día de hoy supera los 90 días
                                        if (NumeroDias > 90)
                                        {
                                            c.subestado_SAP = "01.C25 Pendiente Sistemas KEE - Pte ejecución algoritmo";
                                            c.cod_subestado_SAP = "01.C25";
                                        }
                                        else
                                        {
                                            c.subestado_SAP = "01.C25 Pendiente Medida KEE - En ciclo de Medida";
                                            c.cod_subestado_SAP = "01.C25";
                                        }
                                    }
                                    else
                                    {
                                        ////////Control del algoritmo
                                        //////if (subestadosKronosBTN.cod_estado == "802")
                                        //////{
                                        //////    if ((DateTime.Now - subestadosKronosBTN.fh_hasta).Days > 90)
                                        //////    {
                                        //////        c.subestado_SAP =  "01.C25 Pendiente Sistemas KEE - Pte ejecución algoritmo"; 
                                        //////    }
                                        //////    else
                                        //////    {
                                        //////        c.subestado_SAP = subestadosKronosBTN.descripcion_subestado;
                                        //////    }
                                        //////}
                                        //////else
                                        //////{
                                        c.subestado_SAP = subestadosKronosBTN.descripcion_subestado;
                                        //////}
                                        //////c.subestado_SAP = subestadosKronosBTN.descripcion_subestado;
                                        c.cod_subestado_SAP = subestadosKronosBTN.descripcion_subestado.Substring(0, subestadosKronosBTN.descripcion_subestado.IndexOf(" "));
                                    }
                                }
                            }
                            else
                            {
                                c.subestado_SAP = subestadosKronosBTN.temporal;
                                c.cod_subestado_SAP = subestadosKronosBTN.temporal.Substring(0, subestadosKronosBTN.temporal.IndexOf(" "));
                            }
                        }
                    }

                    // Sólo necesitamos los últimos 5 días para el informe                    
                    List<EndesaEntity.medida.Pendiente> o;
                    if (!d.TryGetValue(c.fecha_informe, out o))
                    {

                        o = new List<EndesaEntity.medida.Pendiente>();
                        o.Add(c);
                        d.Add(c.fecha_informe, o);
                    }
                    else
                        o.Add(c);
                }
                db.CloseConnection();

                return d;
            }
            catch (Exception e)
            {
                ficheroLog.addError("CargaPendiente: " + e.Message);
                return null;
            }
        }


        private void InformePendiente_BI_Facturacion(string ruta_salida_archivo, bool automatico)
        {

            MySQLDB db;
            MySQLDB dbIncidencia;
            MySQLDB dbReporte;
            MySqlCommand command;
            MySqlDataReader r;
            MySqlDataReader inci;
            MySqlDataReader reporte;
            string strSql = "";

            //Paco, para controlar el detalle, cuando no hay datos en t_ed_h_ps y hay que buscar en el histórico
            MySQLDB dbAux;
            MySqlCommand commandAux;
            MySqlDataReader rAux;
            string empresa;;
            string nif;
            string cliente;
            string apellido;
            DateTime? FechaAlta;
            DateTime? FechaInicio;
            string Tarifa;
            string contrato;
            string Distribuidora;
            string CadenaAuxiliar;
            //////////////////////////////////////////////////
         

            servidores.RedShiftServer dbRS;
            OdbcCommand commandRS;
            OdbcDataReader rRS;

            int c = 1;
            int f = 1;
            SubestadosNoEncontrados = "";

            DateTime fecha_actual = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            DateTime fecha_registro = new DateTime();
            int meses_pdtes = 0;
            int aniomes = 0;

            bool tiene_complemento_a01 = false;
            bool sacar_portugal = true;

            DateTime fd = new DateTime();
            DateTime fd_tam = new DateTime();
            DateTime udh = new DateTime();

            //MIO
            bool Pinto = true;
            string RangoInterno;
            string RangoPintoGris;
            int tamaño;
            string tamañoanterior = "";
            string cups20;
            string BuscaCadena ;

            //Paco 08/02/2024
            int PosicionBajaSap;
            int PosicionBajaKEE;
            int Cuenta;
            string agora;
            int PosicionSubEstadoSAP;
            int PosicionSubEstadoKEE;
            int PosicionSubEstadoGlobal;

            //Paco 13/03/2024 (para comprobación con tabla Relacion_INC_CUPS
            string areaincidencia;
            string incidencia;
            string estado_incidencia;
            string fecha_apertura;
            string prioridad_negocio;
            string titulo;
            string e_s_estado;
            string subestado_incidencia;
            string reincidente;
            Boolean ExisteIncidencia;
            Boolean EstadosReporte;
            string multipunto;
            DateTime fecha_calculada = new DateTime();

            utilidades.Fechas utilfecha = new Fechas();

            string Auxiliar;
            int DiasExistenciaKEE = 0;

            Boolean blnLanzarDiasKEE;
            MySQLDB dbDiasKEE;
            MySqlDataReader DiasKEE;
            MySQLDB dbDiasKEEMax;
            MySqlDataReader DiasKEEMax;

            int DiasExistenciaKEEGlobal = 0;
            MySQLDB dbDiasKEEGlobal;
            MySqlDataReader DiasKEEGobal;
            MySQLDB dbDiasKEEMaxGlobal;
            MySqlDataReader DiasKEEMaxGlobal;

            string FechaSapPendienteFacturar_fhenvio;
            string FechaPdteWebB2B_fhact;
            string FechaPdteWebB2B_fhInforme;
            int intColumna=0;
            string IncidenciaFacturacion = "";
            string Estado_FAC_SE = "";
            string Titulo_FAC = "";

            string PintarDinamico = "";
            ExcelRange Etiqueta;
            int TotalPruebaES;
            int TotalPruebaMTBTE;
            int TotalPruebaBTN;
            int Dimension;

            int CuadroInicio;
            int CuadroFin;
            String BordeCuadro;
            int TotalParcial;
            int TotalCuadro;
            Boolean ExistenDatosCuadro;
            int TotalGeneral;
            string PintarEstado = "";
            string PintarSubestado = "";
            string Piloto = "";
            String EtiquetaEstado = "";

            try
            {

                if (!automatico || (UltimaActualizacionMySQL().Date >
                    ss_pp.GetFecha_FinProceso("Facturación", "Informe Pendiente BI", "Informe Pendiente BI").Date))
                {

                    if (automatico)
                        ss_pp.Update_Fecha_Inicio("Facturación", "Informe Pendiente BI", "Informe Pendiente BI");


                    /*
                    FileInfo plantillaExcel =  new FileInfo(System.Environment.CurrentDirectory +  param.GetValue("plantilla_informe_pendiente"));

                    FileInfo fileInfo = new FileInfo(ruta_salida_archivo);
                    ExcelPackage.LicenseContext = OfficeOpenXml.LicenseContext.Commercial;
                    ExcelPackage excelPackage = new ExcelPackage(plantillaExcel);

                    var workSheet = excelPackage.Workbook.Worksheets["Resumen ES"];
                    */

                    // *****************************************

                    // Crea un fichero excel dinamicamente
                    //ruta_salida_archivo = "c:\\temp\\DetallePendFact_SAP_20231128_Inventarios_ES_PT_TAM.xlsx";
                    FileInfo fileInfo = new FileInfo(ruta_salida_archivo);
                    ExcelPackage.LicenseContext = OfficeOpenXml.LicenseContext.Commercial;
                    ExcelPackage excelPackage = new ExcelPackage(fileInfo);
                    //Creo la primera hoja
                    var workSheet = excelPackage.Workbook.Worksheets.Add("Resumen ES");
                    var headerCells = workSheet.Cells[1, 1, 1, 17];
                    var headerFont = headerCells.Style.Font;

                    List<string> lista_empresas_ES = new List<string>();
                    lista_empresas_ES.Add("ES21");
                    lista_empresas_ES.Add("ES22");

                    List<string> lista_empresas_PT = new List<string>();
                    lista_empresas_PT.Add("PT1Q");

                    List<string> lista_segmentos_MT_BTE = new List<string>();
                    lista_segmentos_MT_BTE.Add("MT");
                    lista_segmentos_MT_BTE.Add("BTE");

                    List<string> lista_segmentos_BTN = new List<string>();
                    lista_segmentos_BTN.Add("BTN");

                    // Tomamos lo últimos 5 días hábiles
                    // Si se lanza el listado en día fin de semana
                    // hay que quitar un día más porque el viernes todavía no se ha procesado

                    FechaSapPendienteFacturar_fhenvio = "";
                    FechaPdteWebB2B_fhact = "";
                    FechaPdteWebB2B_fhInforme = "";
                    FechaSapPendienteFacturar_fhenvio = CalculaFechaDesdeinformeMaxPendiente().ToString(); //fh_envio
                    FechaPdteWebB2B_fhact=CalculaFechaMaxPdteWebB2B().ToString(); //fec_act
                    FechaPdteWebB2B_fhInforme = CalculaFechaMaxPdteWebB2B_fhinforme(CalculaFechaDesdeinformeMaxPendiente()).ToString();

                   

                    if (!utilfecha.EsLaborable())
                    {
                        fd = utilfecha.UltimoDiaHabilAnterior(
                               utilfecha.UltimoDiaHabilAnterior(
                                   utilfecha.UltimoDiaHabilAnterior(
                                       utilfecha.UltimoDiaHabilAnterior(
                                           utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil())))));

                        udh = utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil());
                    }
                    else
                    {
                        fd = utilfecha.UltimoDiaHabilAnterior(
                                utilfecha.UltimoDiaHabilAnterior(
                                    utilfecha.UltimoDiaHabilAnterior(
                                        utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil()))));

                        udh = utilfecha.UltimoDiaHabil();
                    }

                    /*
                    //dic_pendiente_hist_fecha = CargaPendienteHist_DesdeFecha(CalculaFechaDesdeinforme(),lista_empresas_ES);

                    fd_tam = utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil());
                    */
                    int totales_dia = 0;
                    double totales_dia_tam = 0;

                    bool noAgora = false;
                    bool siAgora = true;

                    // Nuevos Totales

                    int totales_noagora_01 = 0;
                    double totales_noagora_tam_01 = 0;

                    int totales_noagora_02 = 0;
                    double totales_noagora_tam_02 = 0;

                    int totales_noagora_03 = 0;
                    double totales_noagora_tam_03 = 0;

                    int totales_noagora_04 = 0;
                    double totales_noagora_tam_04 = 0;

                    int totales_noagora_05 = 0;
                    double totales_noagora_tam_05 = 0;

                    int totales_agora_01 = 0;
                    double totales_agora_tam_01 = 0;

                    int totales_agora_02 = 0;
                    double totales_agora_tam_02 = 0;

                    int totales_agora_03 = 0;
                    double totales_agora_tam_03 = 0;

                    int totales_agora_04 = 0;
                    double totales_agora_tam_04 = 0;

                    int totales_agora_05 = 0;
                    double totales_agora_tam_05 = 0;

                    Dictionary<DateTime, int> dic_Totales_cups = new Dictionary<DateTime, int>();
                    Dictionary<DateTime, double> dic_Totales_tam = new Dictionary<DateTime, double>();

                    dic_dias_estado = CargaDiasEstado();

                    int dia = 0;
                    int dia_tam = 0;
                    int fila;
                    int columna;
                    int PosicionPegarSubEstadoGlobal;
                    int NumeroDias;
                    int PosicionReincidente;
                    int PosicionDiasEstadoKEE;
                    int NumeroDiasKEE = 0;
                    Boolean ExisteIncidenciaBTN = false;

                    int intConteoES = 0;
                    int intConteoMTBTE = 0;
                    int intConteoBTN = 0;
                    int intConteoESDetalle = 0;
                    int intConteoMTBTEDetalle = 0;
                    int intConteoBTNDetalle = 0;

                    ///dic_pendiente_hist_fecha = CargaPendienteHist_DesdeFecha(CalculaFechaDesdeinforme(), lista_empresas_ES);

                    fd_tam = utilfecha.UltimoDiaHabilAnterior(utilfecha.UltimoDiaHabil());

                    //********************************************************************************************************************
                    //MIO*****************************************************************************************************************
                    //********************************************************************************************************************

                    int InicioRango;
                    int pintoetiqueta;
                    bool blnPintoEtiqueta;
                    bool blnRecalculoEstado;

                    blnPintoEtiqueta = true;
                    int Hoja;
                    List<string> listaEmpresas = new List<string>();
                    List<string> listaSegmentos = new List<string>();
                    List<string> listaAltaKEE = new List<string>();
                    List<string> fhBajaSap = new List<string>();
                    List<string> listaIncidenciasSAP = new List<string>();

                    var allCells = workSheet.Cells[1, 1, 50, 50];
                    Color colorDeCeldaTitulo = ColorTranslator.FromHtml("#b3e3af");
                    Color colorDeCeldaCabecera = ColorTranslator.FromHtml("#c1dce6");
                    Color colorDeCeldaTotales = ColorTranslator.FromHtml("#e0f5c6");
                    Color colorDeCeldaGris = ColorTranslator.FromHtml("#e8eced");
                    ///ExcelRange Etiqueta;

                    //////pendienteWeb_B2B = new medida.pendiente.PendienteWeb_B2B();

                    for (Hoja = 1; Hoja < 4; Hoja++)
                    {

                        if (Hoja == 1)
                        { //RESUMEN_ES

                            listaEmpresas = lista_empresas_ES;
                            listaSegmentos = null;
                            //dic_pendiente_hist_fecha = CargaPendienteHist_DesdeFecha(CalculaFechaDesdeinforme(), lista_empresas_ES);
                            dic_pendiente_hist_fecha = CargaPendienteHist_DesdeFecha(CalculaFechaDesdeinformeMaxPendiente(), listaEmpresas);
                            //Numero de registros para ES
                            intConteoES = dic_pendiente_hist_fecha.Values.First().Count;
                        }
                        if (Hoja == 2)
                        {
                            blnPintoEtiqueta = true;
                            Pinto = true;
                            dic_Totales_cups.Clear();
                            dic_Totales_tam.Clear();
                            listaEmpresas = lista_empresas_PT;
                            listaSegmentos = lista_segmentos_MT_BTE;
                            ///dic_pendiente_hist_fecha = CargaPendienteHist_PT_DesdeFecha(CalculaFechaDesdeinforme(), listaEmpresas, listaSegmentos);
                            dic_pendiente_hist_fecha = CargaPendienteHist_PT_DesdeFecha(CalculaFechaDesdeinformeMaxPendiente(), listaEmpresas, listaSegmentos);

                            //Numero de registros para MTBTE
                            intConteoMTBTE = dic_pendiente_hist_fecha.Values.First().Count;

                            dia = 0;
                            dia_tam = 0;
                            //CREO LA HOJA
                            workSheet = excelPackage.Workbook.Worksheets.Add("Resumen POR MT-BTE");
                            headerCells = workSheet.Cells[1, 1, 1, 17];
                            headerFont = headerCells.Style.Font;
                        }


                        if (Hoja == 3)
                        {

                            blnPintoEtiqueta = true;
                            Pinto = true;
                            dic_Totales_cups.Clear();
                            dic_Totales_tam.Clear();
                            listaEmpresas = lista_empresas_PT;
                            listaSegmentos = lista_segmentos_BTN;

                            ///dic_pendiente_hist_fecha = CargaPendienteHist_PT_DesdeFecha(CalculaFechaDesdeinforme(), lista_empresas_PT, lista_segmentos_BTN);
                            dic_pendiente_hist_fecha = CargaPendienteHist_PT_DesdeFecha_BTN(CalculaFechaDesdeinformeMaxPendiente(), lista_empresas_PT, lista_segmentos_BTN);

                            //Numero de registros para BTN
                            intConteoBTN = dic_pendiente_hist_fecha.Values.First().Count;


                            dia = 0;
                            dia_tam = 0;

                            //CREO LA HOJA
                            workSheet = excelPackage.Workbook.Worksheets.Add("Resumen POR BTN");
                            headerCells = workSheet.Cells[1, 1, 1, 17];
                            headerFont = headerCells.Style.Font;
                        }

                        c = 9;
                        // PARTE NO ÁGORA ES ***************************************************
                        //Veo que etiquetas tengo en los dias
                        string[] Guardar;
                        string[] Backup;
                        Guardar = new string[100000];
                        Backup = new string[100000];
                        int m;
                        m = 0;

                        Cuenta = 0;
                        StringBuilder bk = new StringBuilder();
                        foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                        {
                            dia++;
                            if (dia < 6)
                            {
                                int v = p.Value.Count;
                                for (int i = 0; i < v; i++)
                                {

                                    if (Cuenta == 0)
                                    {
                                        bk.Append("REPLACE INTO sap_KEE_CuadroDiario(fh_informe,cups, fh_desde,fh_hasta,cod_estado, cod_subestado, agora, subsEstado, FH_CARGA) values ('");
                                    }
                                    else {
                                        bk.Append(",('");
                                    }

                                    if (p.Value[i].agora == true)
                                    {
                                        agora = "S";
                                    }
                                    else{
                                        agora = "N";
                                    }


                                    if (p.Value[i].subestado_SAP is null)
                                    {
                                        Guardar[m] = p.Value[i].cod_estado + "_" + p.Value[i].cod_subestado + "_" + p.Value[i].agora + "_" + p.Value[i].subsEstado + "_N";
                                        bk.Append(Convert.ToDateTime(p.Value[i].fecha_informe).ToString("yyyy-MM-dd") + "','" +  p.Value[i].cups20 + "','" + Convert.ToDateTime(p.Value[i].fh_desde).ToString("yyyy-MM-dd") + "','" + Convert.ToDateTime(p.Value[i].fh_hasta).ToString("yyyy-MM-dd") + "','" +    p.Value[i].cod_estado + "','" + p.Value[i].cod_subestado + "','" + agora + "','" + p.Value[i].subsEstado  + "','" + DateTime.Now.ToString("yyyy-MM-dd") +"')");
                                 
                                    }
                                    else
                                    {
                                        Guardar[m] = p.Value[i].cod_estado + "_" + p.Value[i].subestado_SAP.Substring(0, p.Value[i].subestado_SAP.IndexOf(" ")) + "_" + p.Value[i].agora + "_" + p.Value[i].subestado_SAP.Substring(p.Value[i].subestado_SAP.IndexOf(" ") + 1, p.Value[i].subestado_SAP.Length - p.Value[i].subestado_SAP.IndexOf(" ") - 1) + "_S";
                                        bk.Append(Convert.ToDateTime(p.Value[i].fecha_informe).ToString("yyyy-MM-dd") + "','" +  p.Value[i].cups20 + "','" + Convert.ToDateTime(p.Value[i].fh_desde).ToString("yyyy-MM-dd") + "','" + Convert.ToDateTime(p.Value[i].fh_hasta).ToString("yyyy-MM-dd") + "','" +  p.Value[i].cod_estado + "','" + p.Value[i].subestado_SAP.Substring(0, p.Value[i].subestado_SAP.IndexOf(" ")) + "','" + agora + "','" + p.Value[i].subestado_SAP.Substring(p.Value[i].subestado_SAP.IndexOf(" ") + 1, p.Value[i].subestado_SAP.Length - p.Value[i].subestado_SAP.IndexOf(" ") - 1)  + "','" + DateTime.Now.ToString("yyyy-MM-dd") + "')");

                                    }

                                    Cuenta = Cuenta + 1;
                                    if (Cuenta == 50) {
                                        Cuenta = 0;
                                        db = new MySQLDB(MySQLDB.Esquemas.FAC);
                                        command = new MySqlCommand(bk.ToString(), db.con);
                                        command.ExecuteNonQuery();
                                        bk = null;
                                        bk = new StringBuilder();
                                        db.CloseConnection();

                                    }
                                    m++;
                                }
                            }
                        }
                        string[] B = Guardar.Distinct().ToArray(); //Aquí ya tengo todas las etiquetas de los días

                        if (Cuenta >0)
                        {
                            Cuenta = 0;
                            db = new MySQLDB(MySQLDB.Esquemas.FAC);
                            command = new MySqlCommand(bk.ToString(), db.con);
                            command.ExecuteNonQuery();
                            bk = null;
                            bk = new StringBuilder();
                            db.CloseConnection();
                        }
                        Array.Sort(B); //Ordeno Alfabeticamente

                        dia = 0;
                        //Pego etiquetas
                        workSheet.Cells[1, 1].Value = "INFORME SEGUIMIENTO PENDIENTE FACTURACION TOTAL";
                        workSheet.Cells[1, 1].Style.Font.Bold = true;
                        workSheet.Cells["A1:D1"].Style.Fill.PatternType = ExcelFillStyle.Solid;


                        workSheet.Cells["A1:D1"].Style.Fill.BackgroundColor.SetColor(colorDeCeldaTitulo);
                        workSheet.Cells["A1:D1"].Merge = true;
                        workSheet.Cells["A1:D1"].Style.WrapText = true;

                        workSheet.Cells[3, 1].Value = "ÁGORA (SÍ/NO)";
                        workSheet.Cells[3, 1].Style.Font.Bold = true;
                        workSheet.Cells["A3:A4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                        workSheet.Cells["A3:A4"].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                        workSheet.Cells["A3:A4"].Style.Fill.BackgroundColor.SetColor(colorDeCeldaCabecera);
                        workSheet.Cells["A3:A4"].Merge = true;
                        workSheet.Cells["A3:A4"].Style.WrapText = true;
                        //workSheet.Cells["A3:A4"].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                        workSheet.Cells["A3:A4"].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                        //OfficeOpenXml.Style.ExcelHorizontalAlignement

                        workSheet.Cells[3, 2].Value = "RESPONSABLE";
                        workSheet.Cells[3, 2].Style.Font.Bold = true;
                        workSheet.Cells["B3:B4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                        workSheet.Cells["B3:B4"].Style.Fill.BackgroundColor.SetColor(colorDeCeldaCabecera);
                        workSheet.Cells["B3:B4"].Merge = true;
                        workSheet.Cells["B3:B4"].Style.WrapText = true;
                        workSheet.Cells["B3:B4"].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                        workSheet.Cells["B3:B4"].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                        workSheet.Cells[3, 3].Value = "SUBESTADO";
                        workSheet.Cells[3, 3].Style.Font.Bold = true;
                        workSheet.Cells["C3:C4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                        workSheet.Cells["C3:C4"].Style.Fill.BackgroundColor.SetColor(colorDeCeldaCabecera);
                        workSheet.Cells["C3:C4"].Merge = true;
                        workSheet.Cells["C3:C4"].Style.WrapText = true;
                        workSheet.Cells["C3:C4"].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                        workSheet.Cells["C3:C4"].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                        workSheet.Cells[3, 4].Value = "Pendiente PS";
                        workSheet.Cells[3, 4].Style.Font.Bold = true;
                        workSheet.Cells["D3:H3"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                        workSheet.Cells["D3:H3"].Style.Fill.BackgroundColor.SetColor(colorDeCeldaCabecera);
                        workSheet.Cells["D3:H3"].Merge = true;
                        workSheet.Cells["D3:H3"].Style.WrapText = true;
                        workSheet.Cells["D3:H3"].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                        workSheet.Cells["D3:H3"].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                        foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                        {
                            dia++;
                            if (dia < 6)
                            {
                                Console.WriteLine("Totales ES noAgora dia: " + p.Key.ToString("dd/MM/yyyy"));

                                f = 4;
                                c--;

                                workSheet.Cells[f, c].Value = p.Key;
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                workSheet.Cells[f, c].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                //colorDeCelda = ColorTranslator.FromHtml("#e6faf5");
                                workSheet.Cells[f, c].Style.Fill.BackgroundColor.SetColor(colorDeCeldaCabecera);
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "01" & cadena[2] == "False") //cadena[2] == "False" ES NO AGORA
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];
                                        if (cadena[4] == "S")
                                        {
                                            Etiqueta = workSheet.Cells[f, 3];
                                            Etiqueta.Style.Font.Color.SetColor(System.Drawing.Color.Red);
                                        }
                                        workSheet.Cells[f, 3].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        ///workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        //System.Windows.Forms.MessageBox.Show(cadena[0] + "-" + cadena[1] + "-" + cadena[2] + "-" +cadena[3]);

                                        //if (Hoja == 1) {
                                        //    workSheet.Cells[f, c].Value = Total_PendienteUno(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1], cadena[4]);
                                        //}
                                        //else
                                        //{
                                        //workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        //}
                                        if (cadena[1] == "01.C25")
                                        {
                                            workSheet.Cells[f, c].Value = Total_Pendiente_25(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1], cadena[3]);
                                        }

                                        else
                                        {
                                            workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        }

                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= 5) //empieza en fila 5
                                    {
                                        RangoInterno = "B5:B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "Pendiente medida";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                    }

                                }

                                workSheet.Cells[f, 3].Value = "TotalPendiente medida";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);

                                /*
                                if (Pinto == true)
                                {
                                    colorDeCelda = ColorTranslator.FromHtml("#f0f4f5"); //Color GRIS
                                    RangoInterno = "B" + f.ToString() + ":M" + f.ToString();
                                    workSheet.Cells[RangoInterno].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                    workSheet.Cells[RangoInterno].Style.Fill.BackgroundColor.SetColor(colorDeCelda);
                                }
                                */
                                totales_noagora_01 = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, "01", null);
                                workSheet.Cells[f, c].Value = totales_noagora_01;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                f++;
                                tamañoanterior = f.ToString();

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "02" & cadena[2] == "False")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];

                                        workSheet.Cells[f, 3].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    RangoInterno = "B" + tamañoanterior;
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= Int32.Parse(tamañoanterior))
                                    {
                                        RangoInterno = RangoInterno + ":B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "Orden de Cálculo Calculable";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "Total Orden de Cálculo Calculable";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);

                                totales_noagora_02 = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, "02", null);
                                workSheet.Cells[f, c].Value = totales_noagora_02;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;
                                tamañoanterior = f.ToString();

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "03" & cadena[2] == "False")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];

                                        workSheet.Cells[f, 3].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    RangoInterno = "B" + tamañoanterior;
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= Int32.Parse(tamañoanterior))
                                    {
                                        RangoInterno = RangoInterno + ":B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "DC Generado sin DI";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "Total DC Generado sin DI";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);
                                totales_noagora_03 = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, "03", null);
                                workSheet.Cells[f, c].Value = totales_noagora_03;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;
                                tamañoanterior = f.ToString();

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "04" & cadena[2] == "False")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];

                                        workSheet.Cells[f, 3].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    RangoInterno = "B" + tamañoanterior;
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= Int32.Parse(tamañoanterior))
                                    {
                                        RangoInterno = RangoInterno + ":B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "Doc. Impresión Apartado";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "Total Doc. Impresión Apartado";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);
                                totales_noagora_04 = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, "04", null);
                                workSheet.Cells[f, c].Value = totales_noagora_04;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;


                                //PARTE 05
                                //f++;
                                tamañoanterior = f.ToString();

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "05" & cadena[2] == "False")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];

                                        workSheet.Cells[f, 3].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        workSheet.Cells[f, c].Value = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    RangoInterno = "B" + tamañoanterior;
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= Int32.Parse(tamañoanterior))
                                    {
                                        RangoInterno = RangoInterno + ":B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "DC no generado MDS";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "Total DC no generado MDS";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);
                                totales_noagora_05 = Total_Pendiente(noAgora, p.Key, listaEmpresas, listaSegmentos, "05", null);
                                workSheet.Cells[f, c].Value = totales_noagora_05;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                workSheet.Cells[f, 3].Value = "Total No Ágora";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Value = totales_noagora_01 + totales_noagora_02 + totales_noagora_03 + totales_noagora_04 + totales_noagora_05;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                if (Pinto == true)
                                {

                                    RangoInterno = "A" + f.ToString() + ":M" + f.ToString();
                                    workSheet.Cells[RangoInterno].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                    workSheet.Cells[RangoInterno].Style.Fill.BackgroundColor.SetColor(colorDeCeldaTotales);
                                    workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                }

                                f++;

                                // FIN PARTE 5

                                //f++;
                                tamañoanterior = f.ToString();
                                Pinto = false;

                                int o;
                                if (!dic_Totales_cups.TryGetValue(p.Key, out o))
                                    dic_Totales_cups.Add(p.Key, totales_noagora_01 + totales_noagora_02 + totales_noagora_03 + totales_noagora_04 + totales_noagora_05);

                            } //Fin if (dia < 6)
                        }

                        c = 14;

                        workSheet.Cells[3, 9].Value = "Pendiente Económico (€)";
                        workSheet.Cells[3, 9].Style.Font.Bold = true;
                        workSheet.Cells["I3:M3"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                        //colorDeCelda = ColorTranslator.FromHtml("#c1dce6");          
                        workSheet.Cells["I3:M3"].Style.Fill.BackgroundColor.SetColor(colorDeCeldaCabecera);
                        workSheet.Cells["I3:M3"].Merge = true;
                        workSheet.Cells["I3:M3"].Style.WrapText = true;
                        workSheet.Cells["I3:M3"].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                        workSheet.Cells["I3:M3"].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                        // NO ÁGORA TAM ES PARTE ECONÓMICO*************************************
                        foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                        {
                            Console.WriteLine("Totales TAM ES noAgora dia: " + p.Key.ToString("dd/MM/yyyy"));
                            dia_tam++;

                            if (dia_tam < 6)
                            {
                                f = 4;
                                c--;

                                workSheet.Cells[f, c].Value = p.Key;
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                workSheet.Cells[f, c].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                //colorDeCelda = ColorTranslator.FromHtml("#5facad");
                                workSheet.Cells[f, c].Style.Fill.BackgroundColor.SetColor(colorDeCeldaCabecera);
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "01" & cadena[2] == "False")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        //workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        if (cadena[1] == "01.C25")
                                        {
                                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM_25(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1], cadena[3]);
                                        }

                                        else
                                        {
                                            workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        }
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }
                                totales_noagora_tam_01 = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, "01", null);

                                workSheet.Cells[f, c].Value = totales_noagora_tam_01;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "02" & cadena[2] == "False")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                totales_noagora_tam_02 = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, "02", null);

                                workSheet.Cells[f, c].Value = totales_noagora_tam_02;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "03" & cadena[2] == "False")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                totales_noagora_tam_03 = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, "03", null);

                                workSheet.Cells[f, c].Value = totales_noagora_tam_03;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "04" & cadena[2] == "False")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }
                                totales_noagora_tam_04 = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, "04", null);

                                workSheet.Cells[f, c].Value = totales_noagora_tam_04;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);


                                /*
                                if (blnPintoEtiqueta == true)
                                {
                                    // pego la etíqueta NO ÁGORA
                                    RangoInterno = "A5:A" + f.ToString();

                                    workSheet.Cells[RangoInterno].Value = "NO ÁGORA";
                                    workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                    workSheet.Cells[RangoInterno].Merge = true;
                                    workSheet.Cells[RangoInterno].Style.WrapText = true;
                                    workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                    blnPintoEtiqueta = false;
                                }

                                */

                                f++;

                                //PARTE 5
                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "05" & cadena[2] == "False")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }
                                totales_noagora_tam_05 = Total_Pendiente_TAM(noAgora, p.Key, listaEmpresas, listaSegmentos, "05", null);

                                workSheet.Cells[f, c].Value = totales_noagora_tam_05;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                if (blnPintoEtiqueta == true)
                                {
                                    // pego la etíqueta NO ÁGORA
                                    RangoInterno = "A5:A" + f.ToString();

                                    workSheet.Cells[RangoInterno].Value = "NO ÁGORA";
                                    workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                    workSheet.Cells[RangoInterno].Merge = true;
                                    workSheet.Cells[RangoInterno].Style.WrapText = true;
                                    workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                    workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    blnPintoEtiqueta = false;
                                }

                                f++;

                                //

                                workSheet.Cells[f, c].Value = totales_noagora_tam_01 + totales_noagora_tam_02 + totales_noagora_tam_03 + totales_noagora_tam_04 + totales_noagora_tam_05;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                double o;
                                if (!dic_Totales_tam.TryGetValue(p.Key, out o))
                                    dic_Totales_tam.Add(p.Key, totales_noagora_tam_01 + totales_noagora_tam_02 + totales_noagora_tam_03 + totales_noagora_tam_04 + totales_noagora_tam_05);

                            }
                        }

                        c = 9;
                        dia = 0;
                        f--;
                        InicioRango = f--;

                        int tamañoprimerbloque;
                        tamañoprimerbloque = InicioRango;
                        Pinto = true;
                        blnPintoEtiqueta = true;

                        // ÁGORA ES  BLOQUE PENDIENTE **********************************************
                        foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                        {

                            dia++;

                            if (dia < 6)
                            {

                                f = InicioRango;
                                c--;
                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "01" & cadena[2] == "True")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];
                                        if (cadena[4] == "S")
                                        {
                                            Etiqueta = workSheet.Cells[f, 3];
                                            Etiqueta.Style.Font.Color.SetColor(System.Drawing.Color.Red);
                                        }
                                        workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    tamaño = f;
                                    tamaño = tamaño - 1;
                                    tamañoprimerbloque++;
                                    if (tamaño >= tamañoprimerbloque)
                                    {
                                        RangoInterno = "B" + tamañoprimerbloque.ToString() + ":B" + tamaño.ToString();
                                        if (tamaño >= 1) //TOCADO
                                        {
                                            workSheet.Cells[RangoInterno].Value = "Pendiente medida";
                                            workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                            workSheet.Cells[RangoInterno].Merge = true;
                                            workSheet.Cells[RangoInterno].Style.WrapText = true;
                                            workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                            workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        }
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "TotalPendiente medida";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);

                                /*
                                if (Pinto == true)
                                {
                                    colorDeCelda = ColorTranslator.FromHtml("#f0f4f5"); //Color GRIS
                                    RangoInterno = "B" + f.ToString() + ":M" + f.ToString();
                                    workSheet.Cells[RangoInterno].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                    workSheet.Cells[RangoInterno].Style.Fill.BackgroundColor.SetColor(colorDeCelda);
                                }
                                */
                                totales_agora_01 = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, "01", null);
                                workSheet.Cells[f, c].Value = totales_agora_01;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                f++;
                                tamañoanterior = f.ToString();

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "02" & cadena[2] == "True")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];
                                        workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    RangoInterno = "B" + tamañoanterior;
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= Int32.Parse(tamañoanterior))
                                    {
                                        RangoInterno = RangoInterno + ":B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "Orden de Cálculo Calculable";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "Total Orden de Cálculo Calculable";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);

                                totales_agora_02 = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, "02", null);
                                workSheet.Cells[f, c].Value = totales_agora_02;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;
                                tamañoanterior = f.ToString();

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "03" & cadena[2] == "True")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];
                                        workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    RangoInterno = "B" + tamañoanterior;
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= Int32.Parse(tamañoanterior))
                                    {
                                        RangoInterno = RangoInterno + ":B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "DC Generado sin DI";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "Total DC Generado sin DI";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);

                                totales_agora_03 = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, "03", null);
                                workSheet.Cells[f, c].Value = totales_agora_03;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;
                                tamañoanterior = f.ToString();

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "04" & cadena[2] == "True")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];
                                        workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    RangoInterno = "B" + tamañoanterior;
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= Int32.Parse(tamañoanterior))
                                    {
                                        RangoInterno = RangoInterno + ":B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "Doc. Impresión Apartado";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "Total Doc. Impresión Apartado";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);
                                totales_agora_04 = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, "04", null);
                                workSheet.Cells[f, c].Value = totales_agora_04;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                //PARTE 5
                                tamañoanterior = f.ToString();

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "05" & cadena[2] == "True")
                                    {
                                        workSheet.Cells[f, 3].Value = cadena[1] + " " + cadena[3];
                                        workSheet.Cells[f, c].Value = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                if (Pinto == true)
                                {
                                    RangoInterno = "B" + tamañoanterior;
                                    tamaño = f;
                                    tamaño = tamaño - 1;

                                    if (tamaño >= Int32.Parse(tamañoanterior))
                                    {
                                        RangoInterno = RangoInterno + ":B" + tamaño.ToString();
                                        workSheet.Cells[RangoInterno].Value = "Total DC no generado MDS";
                                        workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                        workSheet.Cells[RangoInterno].Merge = true;
                                        workSheet.Cells[RangoInterno].Style.WrapText = true;
                                        workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    }
                                }

                                workSheet.Cells[f, 3].Value = "Total DC no generado MDS";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                RangoPintoGris = "B" + f.ToString() + ":C" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                RangoPintoGris = "B" + f.ToString() + ":M" + f.ToString();
                                workSheet.Cells[RangoPintoGris].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                workSheet.Cells[RangoPintoGris].Style.Fill.BackgroundColor.SetColor(colorDeCeldaGris);
                                totales_agora_05 = Total_Pendiente(siAgora, p.Key, listaEmpresas, listaSegmentos, "05", null);
                                workSheet.Cells[f, c].Value = totales_agora_05;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                //FIN PARTE 5

                                workSheet.Cells[f, 3].Value = "Total Si Ágora";
                                workSheet.Cells[f, 3].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Value = totales_agora_01 + totales_agora_02 + totales_agora_03 + totales_agora_04 + totales_agora_05;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                if (Pinto == true)
                                {
                                    //colorDeCelda = ColorTranslator.FromHtml("#e0f5c6"); //Color verde claro
                                    RangoInterno = "A" + f.ToString() + ":M" + f.ToString();
                                    workSheet.Cells[RangoInterno].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                    workSheet.Cells[RangoInterno].Style.Fill.BackgroundColor.SetColor(colorDeCeldaTotales);
                                    workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                }

                                f++;

                                workSheet.Cells[f, 3].Value = "Total General";

                                if (Pinto == true)
                                {
                                    //colorDeCelda = ColorTranslator.FromHtml("#c1dce6"); //Color azul claro
                                    RangoInterno = "A" + f.ToString() + ":M" + f.ToString();
                                    workSheet.Cells[RangoInterno].Style.Fill.PatternType = ExcelFillStyle.Solid;
                                    workSheet.Cells[RangoInterno].Style.Fill.BackgroundColor.SetColor(colorDeCeldaCabecera);
                                    workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                }

                                //f++;

                                tamañoanterior = f.ToString();
                                Pinto = false;

                                int o;
                                if (dic_Totales_cups.TryGetValue(p.Key, out o))
                                {
                                    workSheet.Cells[f, c].Value = o + totales_agora_01 + totales_agora_02 + totales_agora_03 + totales_agora_04 + totales_agora_05;
                                    workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                    workSheet.Cells[f, c].Style.Font.Bold = true;
                                    workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                }
                            }
                        }

                        c = 14;
                        dia_tam = 0;
                        pintoetiqueta = InicioRango;
                        pintoetiqueta++;

                        // ÁGORA TAM ES PARTE ECONÓMICA ************************************
                        foreach (KeyValuePair<DateTime, List<EndesaEntity.medida.Pendiente>> p in dic_pendiente_hist_fecha)
                        {

                            Console.WriteLine("Totales TAM ES siAgora dia: " + p.Key.ToString("dd/MM/yyyy"));

                            dia_tam++;

                            if (dia_tam < 6)
                            {
                                f = InicioRango;
                                c--;
                                f++;
                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "01" & cadena[2] == "True")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }
                                totales_agora_tam_01 = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, "01", null);

                                workSheet.Cells[f, c].Value = totales_agora_tam_01;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "02" & cadena[2] == "True")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                totales_agora_tam_02 = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, "02", null);

                                workSheet.Cells[f, c].Value = totales_agora_tam_02;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "03" & cadena[2] == "True")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }

                                totales_agora_tam_03 = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, "03", null);

                                workSheet.Cells[f, c].Value = totales_agora_tam_03;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "04" & cadena[2] == "True")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }
                                totales_agora_tam_04 = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, "04", null);

                                workSheet.Cells[f, c].Value = totales_agora_tam_04;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                f++;

                                //PARTE 5
                                for (int i = 1; i < B.Length; i++) //Quito i=0  ya que en el primer item están los nulos que no he rellenado al poner limite 5000
                                {
                                    string[] cadena = B[i].Split('_');
                                    if (cadena[0] == "05" & cadena[2] == "True")
                                    {
                                        //workSheet.Cells[f, 3].Value = cadena[1];
                                        workSheet.Cells[f, c].Value = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, cadena[0], cadena[1]);
                                        workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0";
                                        workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        f++;
                                    }
                                }
                                totales_agora_tam_05 = Total_Pendiente_TAM(siAgora, p.Key, listaEmpresas, listaSegmentos, "05", null);

                                workSheet.Cells[f, c].Value = totales_agora_tam_05;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                                // FIN PARTE 5

                                if (blnPintoEtiqueta == true)
                                {
                                    // pego la etíqueta SI ÁGORA
                                    RangoInterno = "A" + pintoetiqueta.ToString() + ":A" + f.ToString();

                                    workSheet.Cells[RangoInterno].Value = "SI ÁGORA";
                                    workSheet.Cells[RangoInterno].Style.Font.Bold = true;
                                    workSheet.Cells[RangoInterno].Merge = true;
                                    workSheet.Cells[RangoInterno].Style.WrapText = true;
                                    workSheet.Cells[RangoInterno].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                    workSheet.Cells[RangoInterno].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                    blnPintoEtiqueta = false;

                                }

                                f++;

                                workSheet.Cells[f, c].Value = totales_agora_tam_01 + totales_agora_tam_02 + totales_agora_tam_03 + totales_agora_tam_04 + totales_agora_tam_05;
                                workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                workSheet.Cells[f, c].Style.Font.Bold = true;
                                workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                f++;

                                double o;
                                if (dic_Totales_tam.TryGetValue(p.Key, out o))
                                {
                                    workSheet.Cells[f, c].Value = o + totales_agora_tam_01 + totales_agora_tam_02 + totales_agora_tam_03 + totales_agora_tam_04 + totales_agora_tam_05;
                                    workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                                    workSheet.Cells[f, c].Style.Font.Bold = true;
                                    workSheet.Cells[f, c].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                }

                                RangoInterno = "A1" + ":M" + f.ToString();
                                workSheet.Cells[RangoInterno].AutoFitColumns();
                                //El autofit parece no funcionar bien en las dos primeras columnas, las que están combinadas celdas, fuerzo el ancho
                                workSheet.Column(1).Width = 15;
                                workSheet.Column(2).Width = 20;
                            }

                            //allCells = workSheet.Cells[1, 1, f, 13];
                            //allCells.AutoFitColumns();

                        }

                        //excelPackage.SaveAs(fileInfo);

                    } //Bucle HOJA

                    //********************************************************************************************************************
                    //FIN MIO ************************************************************************************************************
                    //********************************************************************************************************************
                    DateTime fecha_informe = CalculaFechaDetalle();
                    subestadosKronos = new medida.EstadosSubestadosKronos();
                    subestados_sap = new Pendiente_Subestados();
                    pendienteWeb_B2B = new medida.pendiente.PendienteWeb_B2B();
                    pendienteSAPKEE = new medida.pendiente.PendienteFacturadoSAPKEE();
                    //////RelacionIncidenciasSAP = new facturacion.redshift.Relacion_Incidencias_SAP();
                    //////RelacionIncidencias = new medida.pendiente.PendienteWeb_B2B(true);

                    blnLanzarDiasKEE = false;
                    strSql = "select max(FH_ACTUALIZACION) as FHMAX from kee_Dias";
                    dbDiasKEEMax = new MySQLDB(MySQLDB.Esquemas.MED);
                    command = new MySqlCommand(strSql, dbDiasKEEMax.con);
                    DiasKEEMax = command.ExecuteReader();
                    while (DiasKEEMax.Read())
                    {
                        if (Convert.ToDateTime(DiasKEEMax["FHMAX"]).ToString("yyyy-MM-dd")== DateTime.Now.ToString("yyyy-MM-dd"))
                        {
                            blnLanzarDiasKEE = false;
                        }
                        else
                        {

                            blnLanzarDiasKEE = true;
                        }
                    }
                    dbDiasKEEMax.CloseConnection();
                    //Convert.ToDateTime(r["fh_desde"]).Date;
                    f = 1;
                   
                    #region Detalle ES

                    f = 1;
                    c = 1;
                    
                    workSheet = excelPackage.Workbook.Worksheets.Add("Detalle ES");
                    headerCells = workSheet.Cells[1, 1, 1, 17];
                    headerFont = headerCells.Style.Font;

                    headerCells = workSheet.Cells[1, 1, 1, 43];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;

                    workSheet.View.FreezePanes(2, 1);

                    headerFont.Bold = true;
                    workSheet.Cells[f, c].Value = "CUPS20"; c++;
                    workSheet.Cells[f, c].Value = "PERIODO"; c++;
                    workSheet.Cells[f, c].Value = "MES"; c++;
                    workSheet.Cells[f, c].Value = "FH_DESDE"; c++;
                    workSheet.Cells[f, c].Value = "FH_HASTA"; c++;
                    PosicionPegarSubEstadoGlobal = c;
                    workSheet.Cells[f, c].Value = "IMPORTE PDTE FACTURAR"; c++;
                    workSheet.Cells[f, c].Value = "MESES PDTES FACTURAR"; c++;
                    workSheet.Cells[f, c].Value = "ÁGORA"; c++;
                    workSheet.Cells[f, c].Value = "CLIENTE"; c++;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_SAP"; c++;
                    PosicionDiasEstadoKEE = c;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_KEE"; c++;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_GLOBAL"; c++;
                    workSheet.Cells[f, c].Value = "Incidencia Facturacion"; c++;
                    workSheet.Cells[f, c].Value = "Estado_Fac_SE"; c++;
                    workSheet.Cells[f, c].Value = "Titulo_Fac"; c++;
                    workSheet.Cells[f, c].Value = "Incidencia Medida"; c++;
                    PosicionReincidente = c;
                    workSheet.Cells[f, c].Value = "Reincidente"; c++;
                    workSheet.Cells[f, c].Value = "Estado incidencia"; c++;
                    workSheet.Cells[f, c].Value = "Fecha_Apertura"; c++;
                    workSheet.Cells[f, c].Value = "Prioridad"; c++;
                    workSheet.Cells[f, c].Value = "Titulo"; c++;
                    workSheet.Cells[f, c].Value = "E_S_Estado"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_SALESFORCE"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_SAP"; c++; //FH_ALTA_SAP
                    workSheet.Cells[f, c].Value = "FH_BAJA_SALESFORCE"; c++;
                    PosicionBajaSap = c;
                    workSheet.Cells[f, c].Value = "FH_BAJA_SAP"; c++;
                    workSheet.Cells[f, c].Value = "EMPRESA"; c++;
                    workSheet.Cells[f, c].Value = "TIPO CLIENTE"; c++;
                    workSheet.Cells[f, c].Value = "NIF"; c++;
                    workSheet.Cells[f, c].Value = "FPSERCON"; c++;
                    workSheet.Cells[f, c].Value = "Nº INSTALACIÓN"; c++;
                    workSheet.Cells[f, c].Value = "TARIFA"; c++;
                    workSheet.Cells[f, c].Value = "CONTRATO"; c++;  
                    workSheet.Cells[f, c].Value = "DISTRIBUIDORA"; c++;
                    workSheet.Cells[f, c].Value = "ESTADO"; c++;
                    PosicionSubEstadoSAP = c;
                    workSheet.Cells[f, c].Value = "SUBESTADO"; c++;
                    ///workSheet.Cells[f, c].Value = "DIAS_ESTADO"; c++;
                    workSheet.Cells[f, c].Value = "TAM"; c++;
                    
                    workSheet.Cells[f, c].Value = "ULT FH DESDE FACTURADA"; c++;
                    workSheet.Cells[f, c].Value = "ULT FH HASTA FACTURADA"; c++; 
                    workSheet.Cells[f, c].Value = "Estado periodo KEE"; c++;
                    workSheet.Cells[f, c].Value = "Área responsable KEE"; c++;
                    PosicionSubEstadoKEE = c;
                    workSheet.Cells[f, c].Value = "Subestado KEE"; c++;
                    workSheet.Cells[f, c].Value = "Estado KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_DESDE_KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_HASTA_KEE"; c++;
                    workSheet.Cells[f, c].Value = "Fecha BAJA KEE"; c++;
                    PosicionBajaKEE = c;
                    workSheet.Cells[f, c].Value = "Discrepancias"; c++;
                    PosicionSubEstadoGlobal = c;
                    workSheet.Cells[f, c].Value = "Subestado global"; c++;  
                    workSheet.Cells[f, c].Value = "ESTADO GLOBAL"; c++;
                    workSheet.Cells[f, c].Value = "ESTADO GLOBAL A REPORTAR"; c++;
                    workSheet.Cells[f, c].Value = "AREA ESTADO"; c++;
                    workSheet.Cells[f, c].Value = "multipunto"; c++;

                    //////workSheet.Cells[f, c].Value = "Nº DÍAS ESTADO KEE"; c++;

                    //for (int i = 1; i <= c; i++)
                    //{
                    //    workSheet.Cells[f, i].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    //    workSheet.Cells[f, i].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                    //}


                    int FhAltaSap;//Para quedarme con la posición de FH_ALTA_SAP
                    FhAltaSap = 0;
                    int intCliente;//Para quedarme con la posición de Cliente (nombre y apellidos)
                    intCliente =0;
                 
                    strSql = DetalleExcel(fecha_informe, lista_empresas_ES, null);

                    Boolean Existetedhps; //Para buscar los que vienen en blanco

                    db = new MySQLDB(MySQLDB.Esquemas.GBL);
                    command = new MySqlCommand(strSql, db.con);
                    r = command.ExecuteReader();
                    while (r.Read())
                    {
                        f++;
                        Debug.WriteLine(f);
                        c = 1;

                        empresa = ""; ;
                        nif = "";
                        cliente = "";
                        apellido = "";
                        FechaAlta = null;
                        FechaInicio = null;
                        Tarifa = "";
                        contrato = "";
                        Distribuidora = "";
                        cups20 = "";

                        multipunto = "";
                        NumeroDiasKEE = 0;
                    
                        List<string> Multipuntos = new List<string>();
                        Multipuntos = pendienteWeb_B2B.GetCupsMultipunto(r["cups20"].ToString());
                        if (Multipuntos.Count > 0)
                        {
                            if (Multipuntos[0] == "False")
                            {
                                multipunto = "N";
                            }
                            else
                            {
                                multipunto = "S";
                            }

                        }
                        else {
                             multipunto = "N";
                        }

                        if (r["cups20"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = r["cups20"].ToString();
                            cups20 = r["cups20"].ToString();
                        }
                        c++;

                        // Periodo
                        workSheet.Cells[f, c].Value = ""; c++;

                        if (r["mes"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToInt32(r["mes"]);
                            aniomes = Convert.ToInt32(r["mes"]);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);
                        }
                        c++;

                        if (r["fh_desde"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_desde"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["fh_hasta"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_hasta"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        // importe pdte facturar
                        if (r["mes"] != System.DBNull.Value && r["TAM"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["tam"]) * meses_pdtes;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                            c++;
                        }
                        else
                        {
                            c++;
                        }

                       

                        // meses pdte facturar
                        if (r["mes"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = meses_pdtes;
                            workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        }
                        c++;

                        if (meses_pdtes > 1)
                        {
                            workSheet.Cells[f, 2].Value = ">1P";
                        }
                        else
                        {
                            workSheet.Cells[f, 2].Value = "1P";
                        }

                        if (r["agora"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["agora"].ToString();

                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        //Cliente -- me quedo con la posición, para pintarlo más abajo
                        workSheet.Cells[f, c].Value = "";
                        intCliente = c;
                        c++ ;

                        ///DIAS_ESTADO_SAP
                        if (r["cups20"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());
                            workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        }
                        c++;

                        //DIAS_ESTADO_KEE-- lo dejo sin rellenar, se pinta al final
                        workSheet.Cells[f, c].Value = "";
                        c++;

                        //DIAS_ESTADO_GLOBAL-- lo dejo sin rellenar, se pinta al final
                        workSheet.Cells[f, c].Value = "";
                        c++;


                        //Recuperar Incidencia Facturacion
                        listaIncidenciasSAP = RelacionIncidenciasSAP.GetCups(r["cups20"].ToString() + aniomes);

                        if (listaIncidenciasSAP.Count == 0)
                        {
                            IncidenciaFacturacion = "";
                            Estado_FAC_SE = "";
                            Titulo_FAC = "";
                        }
                        else
                        {
                            foreach (var mm in listaIncidenciasSAP)
                            {
                                string[] cadena = mm.Split(';');
                                IncidenciaFacturacion = cadena[0];
                                Estado_FAC_SE = cadena[1];
                                Titulo_FAC = cadena[2];
                                break;
                            }
                        }
                        //Fin recuperar incidencia facturacion
                        
                        // Comprobamos con la tabla Relacion_INC_CUPS
                        ////// 1.Se relaciona el detalle del informe obtenido(campos cups20 y mes) con la tabla "Relacion_INC_CUPS"(campos cups y mes).Si para un cups se encuentra en esa relación una incidencia que afeca al mismo mes que está pendiente se deberá desechar el estado que tuviera el informe y actualizarlo por uno nuevo.
                        ////// 2.El estado a actualizar dependerá del campo "area" de la tabla "Relacion_INC_CUPS", pudiendo existir 3 opciones:
                        ////// --01.B09 Incidencia_Contratacion: se informará con este estado cuando encuentre para ese mes una incidencia en el area de contratacion, independientemente de que también haya otras para ese mismo mes en otras areas.
                        //////-- 01.B10 Incidencia_Medida: no estando en el caso anterior, se informará con este estado cuando encuentre para ese mes una incidencia en el area de medida, independientemente de que también haya otras para ese mismo mes en el area de facturacion.
                        ////// --01.B11 Incidencia_Facturacion: no estando en ninguno de los dos casos anteriores, se informará con este estado cuando encuentre para ese mes una incidencia en el area de Facturacion.
                        strSql = " select area, incidencia, estado_incidencia, fecha_apertura, prioridad_negocio, titulo, e_s_estado,Reincidente from Relacion_INC_CUPS"
                                 + " where cups='" + r["cups20"].ToString() + "' and Mes_pendiente='" + aniomes + "'"
                                 + " order by Fecha_apertura asc";


                        areaincidencia = "";
                        incidencia = "";
                        estado_incidencia = "";
                        fecha_apertura = "";
                        prioridad_negocio = "";
                        titulo = "";
                        e_s_estado = "";
                        subestado_incidencia = "";
                        reincidente = "";
                        ExisteIncidencia = false;

                        dbIncidencia = new MySQLDB(MySQLDB.Esquemas.MED);
                        command = new MySqlCommand(strSql, dbIncidencia.con);
                        inci = command.ExecuteReader();

                        while (inci.Read())
                        {
                            ExisteIncidencia = true;
                            if (areaincidencia == "")
                            {
                                areaincidencia = inci["area"].ToString();

                                if (areaincidencia == "Contratacion")
                                    subestado_incidencia = "01.B09 Incidencia_Contratacion";
                                if (areaincidencia == "Medida")
                                    subestado_incidencia = "01.B10 Incidencia_Medida";
                                if (areaincidencia == "Facturacion")
                                    subestado_incidencia = "01.B11 Incidencia_Facturacion";

                                incidencia = inci["incidencia"].ToString();
                                estado_incidencia = inci["estado_incidencia"].ToString();
                                fecha_apertura = inci["fecha_apertura"].ToString();
                                prioridad_negocio = inci["prioridad_negocio"].ToString();
                                titulo = inci["titulo"].ToString();
                                e_s_estado = inci["e_s_estado"].ToString();
                                reincidente = inci["Reincidente"].ToString();
                            }
                            else
                            {
                                if (areaincidencia != inci["area"].ToString())
                                {
                                    areaincidencia = inci["area"].ToString();

                                    if (areaincidencia == "Contratacion")
                                        subestado_incidencia = subestado_incidencia + " - 01.B09 Incidencia_Contratacion";
                                    if (areaincidencia == "Medida")
                                        subestado_incidencia = subestado_incidencia + " - 01.B10 Incidencia_Medida";
                                    if (areaincidencia == "Facturacion")
                                        subestado_incidencia = subestado_incidencia + " - 01.B11 Incidencia_Facturacion";

                                    incidencia = incidencia + " - " + inci["incidencia"].ToString();
                                    estado_incidencia = estado_incidencia + " - " + inci["estado_incidencia"].ToString();
                                    fecha_apertura = fecha_apertura + " - " + inci["fecha_apertura"].ToString();
                                    prioridad_negocio = prioridad_negocio + " - " + inci["prioridad_negocio"].ToString();
                                    titulo = titulo + " - " + inci["titulo"].ToString();
                                    e_s_estado = e_s_estado + " - " + inci["e_s_estado"].ToString();
                                }
                            }
                        } // Fin  while (inci.Read())

                        dbIncidencia.CloseConnection();
                        if (ExisteIncidencia == true)
                        {
                            c--;
                            workSheet.Cells[f, c].Value = subestado_incidencia; c++;
                            workSheet.Cells[f, c].Value = IncidenciaFacturacion; c++;
                            workSheet.Cells[f, c].Value = Estado_FAC_SE; c++;
                            workSheet.Cells[f, c].Value = Titulo_FAC; c++;

                            workSheet.Cells[f, c].Value = incidencia; c++;
                            //REINCIDENTE
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = estado_incidencia; c++;
                            workSheet.Cells[f, c].Value = fecha_apertura; c++;
                            workSheet.Cells[f, c].Value = prioridad_negocio; c++;
                            workSheet.Cells[f, c].Value = titulo; c++;
                            workSheet.Cells[f, c].Value = e_s_estado; c++;
                        }
                        else
                        {
                         
                            workSheet.Cells[f, c].Value = IncidenciaFacturacion; c++;
                            workSheet.Cells[f, c].Value = Estado_FAC_SE; c++;
                            workSheet.Cells[f, c].Value = Titulo_FAC; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        /////////////////////////////////////////////////////////////////////
                 
                        //FH_ALTA_SALESFORCE
                        ////workSheet.Cells[f, c].Value = ""; c++;

                        if (r["fh_alta_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        else
                        {

                        }
                        c++;
                        // FIN FH_ALTA_SALESFORCE


                        //FECHA_ALTA_KEE*****************************************************
                        listaAltaKEE = pendienteWeb_B2B.GetCupsFechaAltaKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));

                        if (listaAltaKEE.Count == 0)
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        else
                        {
                            if (listaAltaKEE[0] == "01/01/0001 0:00:00")
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {

                                foreach (var mm in listaAltaKEE)
                                {
                                    workSheet.Cells[f, c].Value = mm; c++;
                                    break;
                                }
                                //////workSheet.Cells[f, c].Value = lista; c++;
                            }
                        }

                        //FIN FH_ALTA_KEE*****************************************************

                        //FH_ALTA_SAP (de momento lo pongo en blanco y me quedo con la posición para rellenar más adelante
                        workSheet.Cells[f, c].Value = "";
                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        FhAltaSap = c;
                        c++;

                        //FH_BAJA_SALESFORCE
                        if (r["fh_baja_crto"] != System.DBNull.Value) 
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_baja_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        else
                        {

                        }
                        c++;
                        // FIN  FH_BAJA_SALESFORCE

                        //Paco, buscamos la fecha de Baja de SAP ******************************************
                        CadenaAuxiliar = r["id_crto_ext"].ToString();
                        CadenaAuxiliar = CadenaAuxiliar.PadLeft(12, '0'); //Relleno con ceros a la izquierda hasta 12

                        fhBajaSap = FechaBajaSap.GetCupsFechaBajaSAP(CadenaAuxiliar);

                        if (fhBajaSap.Count == 0)
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        else
                        {
                                foreach (var mm in fhBajaSap)
                                {
                                    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                    workSheet.Cells[f, c].Value = mm; c++; 
                                    break;
                                }
                        }


                        //////strSql = "SELECT  max(cd_sec_crto), fh_baja from ed_owner.t_ed_h_sap_crto_front "
                        //////+ " WHERE id_crto_ext = '" + CadenaAuxiliar + "'"
                        //////+ " group by  fh_baja"
                        //////+ " order by  max(cd_sec_crto) desc";

                        //////dbRS = new servidores.RedShiftServer(RedShiftServer.Entornos.PROD);
                        //////commandRS = new OdbcCommand(strSql, dbRS.con);
                        //////rRS = commandRS.ExecuteReader();
                        //////while (rRS.Read())
                        //////{
                        //////    if (rRS["fh_baja"] != System.DBNull.Value)
                        //////        workSheet.Cells[f, c].Value = Convert.ToDateTime(rRS["fh_baja"]).Date;
                        //////    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        //////    break;
                        //////}
                        //////dbRS.CloseConnection();
                        //////c++;



                        //Fin - Fh_baja de SAP ***************************************************

                        if (r["cd_empr"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = r["cd_empr"].ToString();
                            Existetedhps = true;
                        }
                        else
                        {
                            Existetedhps = false;

                            strSql = "SELECT cd_empr,  cd_nif_cif_cli, de_tp_cli, tx_apell_cli, fh_alta_crto, fh_inicio_vers_crto"
                            + " ,ps.cd_tarifa_c, ps.cd_crto_comercial, ps.de_empr_distdora_nombre"
                            + " FROM cont.t_ed_h_ps_hist ps"
                            + " WHERE cups20 = '" + r["cups20"].ToString() + "'"
                            + " AND created_date = (SELECT MAX(created_date) FROM cont.t_ed_h_ps_hist"
                            + " WHERE cups20 = '" + r["cups20"].ToString() + "')";

                            dbAux = new MySQLDB(MySQLDB.Esquemas.GBL);
                            commandAux = new MySqlCommand(strSql, dbAux.con);
                            rAux = commandAux.ExecuteReader();
                            while (rAux.Read())
                            {
                                if (rAux["cd_empr"] != System.DBNull.Value)
                                    empresa = rAux["cd_empr"].ToString();
                                if (rAux["de_tp_cli"] != System.DBNull.Value)
                                    cliente = rAux["de_tp_cli"].ToString();
                                if (rAux["cd_nif_cif_cli"] != System.DBNull.Value)
                                    nif = rAux["cd_nif_cif_cli"].ToString();
                                if (rAux["tx_apell_cli"] != System.DBNull.Value)
                                    apellido = rAux["tx_apell_cli"].ToString();
                                if (rAux["fh_alta_crto"] != System.DBNull.Value)
                                    FechaAlta = Convert.ToDateTime(rAux["fh_alta_crto"]).Date;
                                if (rAux["fh_inicio_vers_crto"] != System.DBNull.Value)
                                    FechaInicio = Convert.ToDateTime(rAux["fh_inicio_vers_crto"]).Date;
                                if (rAux["cd_tarifa_c"] != System.DBNull.Value)
                                    Tarifa = rAux["cd_tarifa_c"].ToString();
                                if (rAux["cd_crto_comercial"] != System.DBNull.Value)
                                    contrato = rAux["cd_crto_comercial"].ToString();
                                if (rAux["de_empr_distdora_nombre"] != System.DBNull.Value)
                                    Distribuidora = rAux["de_empr_distdora_nombre"].ToString();
                            }
                            dbAux.CloseConnection();
                            workSheet.Cells[f, c].Value = empresa;
                        }
                        c++;

                        if (Existetedhps == false) //TIPO_CLIENTE
                        {
                            workSheet.Cells[f, c].Value = cliente;
                        }
                        else
                        {
                            if (r["de_tp_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["de_tp_cli"].ToString();
                        }
                        c++;

                        if (Existetedhps == false) //NIF
                        {
                            workSheet.Cells[f, c].Value = nif;
                        }
                        else
                        {
                            if (r["cd_nif_cif_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_nif_cif_cli"].ToString();
                        }
                        c++;

                        if (Existetedhps == false) //Es la fh_alta_sap que me he guardado la posición, se pinta más arriba
                        {
                            if (FechaAlta != null)
                            {
                                workSheet.Cells[f, FhAltaSap].Value = Convert.ToDateTime(FechaAlta).Date;
                                workSheet.Cells[f, FhAltaSap].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            }
                        }
                        else
                        {
                            if (r["fh_alta_crto"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, FhAltaSap].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                                workSheet.Cells[f, FhAltaSap].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            }
                        }

                        //c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, intCliente].Value = apellido;
                        }
                        else
                        {
                            if (r["tx_apell_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, intCliente].Value = r["tx_apell_cli"].ToString();
                        }
                        //c++;


                        if (Existetedhps == false) //FPSERCON
                        {
                            if (FechaInicio != null)
                            {
                                workSheet.Cells[f, c].Value = Convert.ToDateTime(FechaInicio).Date;
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            }
                        }
                        else
                        {
                            if (r["fh_inicio_vers_crto"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_inicio_vers_crto"]).Date;
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            }
                        }
                        c++;

                        if (r["id_instalacion"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["id_instalacion"].ToString();
                        c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Tarifa;
                        }
                        else
                        {
                            if (r["cd_tarifa_c"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_tarifa_c"].ToString();
                        }
                        c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = contrato;
                        }
                        else
                        {
                            if (r["cd_crto_comercial"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_crto_comercial"].ToString();
                        }
                        c++;
                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Distribuidora;
                        }
                        else
                        {
                            if (r["de_empr_distdora_nombre"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["de_empr_distdora_nombre"].ToString();
                        }
                        c++;

                        if (r["de_estado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_estado"].ToString();
                        c++;

                        if (r["de_subestado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_subestado"].ToString();
                        c++;

                        ///PACO PRUEBA
                        //////if (r["cups20"] != System.DBNull.Value)
                        //////{
                        //////    workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());
                        //////    workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        //////}
                        //////c++;

                        if (r["TAM"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["TAM"]);
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                        }
                        c++;

                        System.Diagnostics.Debug.WriteLine(r["cups20"].ToString());
                        // Paco - añadimos la ultima fecha desde y hasta facturada t_ed_h_sap_facts
                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        List<string> listaInicio = new List<string>();
                        listaInicio = pendienteSAPKEE.GetCupsInicioUltimaFacturada(r["cups20"].ToString());
                        if (listaInicio != null)
                        {
                            if (listaInicio.Count == 0)
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaInicio[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaInicio)
                                    {
                                        workSheet.Cells[f, c].Value = mm; c++;
                                        break;
                                    }
                                    ////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }
                        }
                        else {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }

                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        List<string> listaFin = new List<string>();
                        listaFin = pendienteSAPKEE.GetCupsFinalUltimaFacturada(r["cups20"].ToString());

                        if (listaFin != null)
                        {
                            if (listaFin.Count == 0 )
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaFin[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaFin)
                                    {
                                        workSheet.Cells[f, c].Value = mm; c++;
                                        break;
                                    }
                                    //////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }
                        }
                        else {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }

                        System.Diagnostics.Debug.WriteLine(f);

                        subestadosKronos.existe = false;

                        if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                        {

                            subestadosKronos.existe = false;

                            //Paco -- He duplicado funciones para marcar los casos que no hay datos en kronos para la fecha GetEstadoKEEDetalle y GetCupsDetalle
                            //Faltaria controlar los casos en los que vienen segmentos, es decir, para el mes que se mira de Sap vienen dos segmentos
                            //en Kronos, habria que quedarse con el de fecha más antigua, he puesto codigo sin probar para este caso en GetCupsDetalle
                            //Lo que hago es crear a pelo un estado "Discrepancia: ..... " que es la etiqueta que pongo y que no está en la tabla parametrica estados_kee_param 

                            if (multipunto == "N")
                            {
                                subestadosKronos.GetEstadoKEEDetalle(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                                    Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));
                            }
                            else
                            {
                                subestadosKronos.GetEstadoKEEDetalleMultipunto(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                                    Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));
                            }

                            //////subestadosKronos.GetEstadoKEEDetalle(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                            //////    Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));

                            if (subestadosKronos.existe)
                            {
                                BuscaCadena = subestadosKronos.descripcion_estado;
                                List<string> lista = new List<string>();

                                if (BuscaCadena.IndexOf("Discrepancia") >= 0)
                                {
                                    if (BuscaCadena.IndexOf("Periodo SAP encontrado parcialmente en el informe pendiente de KEE") >= 0 )
                                    {
                                        workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                        workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                        workSheet.Cells[f, c].Value = "01.B05 Error Sistemas KEE - SAP - Incoherencia periodos KEE-SAP"; c++;
                                        // Como estoy forzando y pongo a pelo la descripcion subestado y tengo la variable ocupada, el estado de KEE lo he guardado en descripcion_subestado
                                        //en lugar de en descripcion_estado
                                        workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                        string[] cadena = subestadosKronos.descripcion_estado.Split(';');
                                        string[] cadenaAux = cadena[2].Split('/');
                                        workSheet.Cells[f, c].Value = cadenaAux[0].Substring(1, 8).Substring(6, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(4, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(0, 4); c++;
                                        workSheet.Cells[f, c].Value = cadenaAux[1].Substring(0, 8).Substring(6, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(4, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(0, 4); c++;
                                    }
                                    //|| BuscaCadena.IndexOf("Periodos del pendiente de KEE contenidos en las fechas de SAP") >= 0 || BuscaCadena.IndexOf("Periodo SAP contenido dentro de un informe pendiente de KEE") >= 0
                                    else
                                    {
                                        if (BuscaCadena.IndexOf("Periodos del pendiente de KEE contenidos en las fechas de SAP") >= 0 || BuscaCadena.IndexOf("Periodo SAP contenido dentro de un informe pendiente de KEE") >= 0)
                                        {
                                            workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                            workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                            // Como estoy forzando y pongo a pelo la descripcion subestado y tengo la variable ocupada, el subestado de KEE lo he guardado en temporal de momento
                                            workSheet.Cells[f, c].Value = subestadosKronos.temporal; c++;
                                            // Como estoy forzando y pongo a pelo la descripcion subestado y tengo la variable ocupada, el estado de KEE lo he guardado en descripcion_subestado
                                            //en lugar de en descripcion_estado
                                            workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                            string[] cadena = subestadosKronos.descripcion_estado.Split(';');
                                            string[] cadenaAux = cadena[2].Split('/');
                                            workSheet.Cells[f, c].Value = cadenaAux[0].Substring(1, 8).Substring(6, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(4, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(0, 4); c++;
                                            workSheet.Cells[f, c].Value = cadenaAux[1].Substring(0, 8).Substring(6, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(4, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(0, 4); c++;
                                        }
                                        else
                                        {
                                            //si no está el CUPS en la tabla "ed_owner.T_ED_H_GEST_DIAR_PS_B2B" he obtenido: "Discrepancia: No existe el cups en el informe del pendiente de KEE"
                                            // el cups está en la tabla, pero dentro de los periodos que hay no no hay ningún periodo que coincida ni total ni parcialmente
                                            //      Marcado: "Discrepancia: No existen fechas en el informe pendiente de KEE para el periodo;(" + Convert.ToString(fecha_desde.ToString("yyyyMMdd")) + "/" + Convert.ToString(fecha_hasta.ToString("yyyyMMdd")) + ")")

                                            if (BuscaCadena.IndexOf("No existe el cups en el informe del pendiente de KEE") >= 0)
                                            {
                                                workSheet.Cells[f, c].Value = ""; c++;
                                                workSheet.Cells[f, c].Value = ""; c++;
                                                workSheet.Cells[f, c].Value = "01.B07 Error Sistemas KEE-SAP - Pdte SAP-No existe en KEE"; c++;
                                                workSheet.Cells[f, c].Value = ""; c++;
                                                workSheet.Cells[f, c].Value = ""; c++;
                                                workSheet.Cells[f, c].Value = ""; c++;

                                            }
                                            else {

                                                if (BuscaCadena.IndexOf("No existen fechas en el informe pendiente de KEE para el periodo") >= 0)
                                                {
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = "01.B06 Error Sistemas KEE-SAP - Pdte SAP-No pdte KEE"; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                }
                                                else
                                                {
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                }

                                            } //Fin  if (BuscaCadena.IndexOf("No existe el cups en el informe del pendiente de KEE") >= 0)

                                        } // fin  if (BuscaCadena.IndexOf("Periodos del pendiente de KEE contenidos en las fechas de SAP") >= 0 || BuscaCadena.IndexOf("Periodo SAP contenido dentro de un informe pendiente de KEE") >= 0)

                                    } // Fin  if (BuscaCadena.IndexOf("Periodo SAP encontrado parcialmente en el informe pendiente de KEE") >= 0 )

                                    ///lista = pendienteWeb_B2B.GetCupsFinKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]));
                                    lista = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));

                                    if (lista.Count == 0)
                                    {
                                        workSheet.Cells[f, c].Value = ""; c++;
                                    }
                                    else
                                    {
                                        if (lista[0] == "01/01/0001 0:00:00")
                                        {
                                            workSheet.Cells[f, c].Value = ""; c++;
                                        }
                                        else
                                        {

                                            foreach (var mm in lista)
                                            {
                                                workSheet.Cells[f, c].Value = mm; c++;
                                                break;
                                            }
                                            //////workSheet.Cells[f, c].Value = lista; c++;
                                        }
                                    }
                                    workSheet.Cells[f, c].Value = subestadosKronos.descripcion_estado; c++;
                                    //Subestado Global
                                    if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value;c++;
                                    }
                                    else {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                    }
                                }
                                else
                                {
                                    workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                    workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                    workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                    workSheet.Cells[f, c].Value = subestadosKronos.descripcion_estado; c++;
                                    //Paco 22/03/2024 fecha_desde_kee y fecha_hasta_kee
                                    if (r["fh_desde"] != System.DBNull.Value)
                                    {
                                        workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_desde"]).Date;
                                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                    }
                                    c++;

                                    if (r["fh_hasta"] != System.DBNull.Value)
                                    {
                                        workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_hasta"]).Date;
                                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                    }
                                    c++;
                                    ///lista = pendienteWeb_B2B.GetCupsFinKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]));
                                    lista = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));
                                    if (lista.Count == 0)
                                    {
                                        workSheet.Cells[f, c].Value = ""; c++;
                                    }
                                    else
                                    {
                                        if (lista[0] == "01/01/0001 0:00:00")
                                        {
                                            workSheet.Cells[f, c].Value = ""; c++;
                                        }
                                        else
                                        {

                                            foreach (var mm in lista)
                                            {
                                                workSheet.Cells[f, c].Value = mm; c++;
                                                break;
                                            }
                                            //////workSheet.Cells[f, c].Value = lista; c++;
                                        }
                                    }

                                    //////workSheet.Cells[f, c].Value = ""; c++;
                                    //////workSheet.Cells[f, c].Value = ""; c++;
                                    workSheet.Cells[f, c].Value = ""; c++;

                                    //Subestado Global
                                    if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                    }
                                    else
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                    }
                                    //Fin Subestado Global
                                }

                                //Paco 21/05/2024 Calculo del numero dias KEE en Kronos ********************
                                if (blnLanzarDiasKEE == true)
                                {
                                    //////DiasExistenciaKEE = "";
                                    //Primero, busco si ya está el registro en la tabla
                                    //////if (BuscaCadena.IndexOf("Discrepancia") >= 0)
                                    //////{
                                    //////    DiasExistenciaKEE = FuncionDiasKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.descripcion_subestado);
                                    //////}
                                    //////else
                                    //////{
                                    //////    DiasExistenciaKEE = FuncionDiasKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.descripcion_estado);
                                    DiasExistenciaKEE = FuncionDiasKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.estado_periodo);
                                    //////}
                                }
                                else
                                {
                                    /// Para que recupere los dias en ejecuciones sucesivas el mismo día.
                                    //////if (BuscaCadena.IndexOf("Discrepancia") >= 0)
                                    //////{
                                    //////    DiasExistenciaKEE = FuncionDiasKEERecuperarDiasTabla(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.descripcion_subestado);
                                    //////}
                                    //////else
                                    //////{
                                    //////    DiasExistenciaKEE = FuncionDiasKEERecuperarDiasTabla(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.descripcion_estado);
                                    //////}    
                                    DiasExistenciaKEE = FuncionDiasKEERecuperarDiasTabla(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.estado_periodo);
                                }

                                //Fin Calculo del numero dias KEE en Kronos  ***************
                            }
                            else
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                //Subestado Global
                                if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                {
                                    workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                }
                                else
                                {
                                    workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                }
                                //Fin Subestado Global
                            }

                        }
                        else
                        {
                            //System.Diagnostics.Debug.WriteLine(r["cups20"].ToString() + "-" + r["de_subestado"].ToString() + "-" + subestadosKronos.descripcion_subestado + "-" + subestadosKronos.descripcion_estado);
                            //Para que llegue hasta la última columna aunque no exista en Kronos
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            // Fecha fin KEE (se pinta aunque no sea uno de los estados marcados como KEE
                            // workSheet.Cells[f, c].Value = ""; c++;
                            List<string> listaAux = new List<string>();
                            listaAux = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));
                            if (listaAux.Count == 0)
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaAux[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaAux)
                                    {
                                        workSheet.Cells[f, c].Value = mm; c++;
                                        break;
                                    }
                                    //////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }
                            workSheet.Cells[f, c].Value = ""; c++;

                            //Subestado Global
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;  
                            }
                            else
                            {
                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++; 
                            } 

                        } // Fin  if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))



                        //Calculo DIAS ESTADO GLOBAL *************************
                        if (blnLanzarDiasKEE == true) // Sólo se actualizan los datos en la tabla la primera vez, por si hay ejecuciones sucesivas
                        {
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEEGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoKEE].Value.ToString());
                            }
                            else
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEEGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoSAP].Value.ToString());
                            }
                        }
                        else
                        {
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEERecuperarDiasTablaGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoKEE].Value.ToString());
                            }
                            else
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEERecuperarDiasTablaGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoSAP].Value.ToString());
                            }
                        } 
                        //FIN DIAS ESTADO GLOBAL*******************************

                       
                        if (areaincidencia != "" & subestadosKronos.existe == true)
                        {
                            Auxiliar = Reincidente(areaincidencia, subestadosKronos.area_responsable);
                            if (Auxiliar != "")
                            {
                                ////c--;
                                workSheet.Cells[f, PosicionSubEstadoGlobal].Value = Auxiliar;
                                workSheet.Cells[f, PosicionReincidente].Value = reincidente;
                            }
                        }
                        //Fin Paco 09/05/2024***********************************************************************************************

                        ///14/05/2024 New EStados Global***********************************************

                        Auxiliar = "";
                        Auxiliar = EstadosAreas(workSheet.Cells[f, PosicionSubEstadoGlobal].Value.ToString(), cups20, aniomes.ToString(), 1,0, false);

                        if (Auxiliar != "")
                        {
                            string[] CadenaEstados = Auxiliar.Split(';');
                            workSheet.Cells[f, c].Value = CadenaEstados[0]; c++;
                            workSheet.Cells[f, c].Value = CadenaEstados[1]; c++;
                            workSheet.Cells[f, c].Value = CadenaEstados[2]; c++;
                        }
                        else
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;

                            if (SubestadosNoEncontrados == "")
                            {
                                SubestadosNoEncontrados = "Hoja ES: "+ cups20 + " - " + Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd") + " - " + Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd") + " - " + r["de_estado"].ToString() + " -" + r["de_subestado"].ToString() + "- No existe el subestado en la tabla paramétrica";
                             
                            }
                            else
                            {
                                SubestadosNoEncontrados = SubestadosNoEncontrados + ";Hoja ES: " + cups20 + " - " + Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd") + " - " + Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd") + " - " + r["de_estado"].ToString() + " -" + r["de_subestado"].ToString() + "- No existe el subestado en la tabla paramétrica";
                            }
                        }

                        ////////Fin New EStados Global*******************************************************

                        //// Tratamiento multipuntos
                        workSheet.Cells[f, c].Value =multipunto; c++;

                        // "Nº DÍAS ESTADO KEE"
                        if (subestadosKronos.existe == true)
                        {
                            workSheet.Cells[f, PosicionDiasEstadoKEE].Value = DiasExistenciaKEE; c++;
                        }

                        // Pego Nº DIAS ESTADO GLOBAL, va a continuación de DIAS ESTADO KEE
                        workSheet.Cells[f, PosicionDiasEstadoKEE+1].Value = DiasExistenciaKEEGlobal; c++;


                    } //Fin bucle principal     while (r.Read())


                    intConteoESDetalle = f-1;
                    db.CloseConnection();

                    headerCells = workSheet.Cells[1, 1, 1, c];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;

                    //08/02/2024 Paco, mover columna de fecha baja de Kronos despues de fecha de baja de SAP
                    workSheet.InsertColumn(PosicionBajaSap, 1); //Inserta en la posicion 12 una columna en blanco(detrás de FH_BAJA_SAP)
                    workSheet.Cells[1, PosicionBajaKEE, f, PosicionBajaKEE].Copy(workSheet.Cells[1, PosicionBajaSap, f, PosicionBajaSap]); //Copia la columna 31 (Fecha BAJA KEE) en la posición creada anteriormente
                    workSheet.DeleteColumn(PosicionBajaKEE); //Borra la columna 31 Fecha BAJA KEE

                    //Pegamos AREA, Subestadoglobal, estado_global y estado global a reportar despues de FH_HASTA *** (!!!OJO, he metido ya por medio FECHA BAJA KEE (Sumo una más)!!)****

                    //Pegamos Subestadoglobal, estado_global y estado global a reportar despues de FH_HASTA *** (!!!OJO, he metido ya por medio FECHA BAJA KEE (Sumo una más)!!)****
                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal, 1); //Inserta en la posicion 5 una columna en blanco(detrás de FH_HASTA)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 1, f, PosicionSubEstadoGlobal + 1].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal, f, PosicionPegarSubEstadoGlobal]);

                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal + 1, 1); //inserto en posición 6 (ya he pegado subestadoglobal)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 3, f, PosicionSubEstadoGlobal + 3].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal + 1, f, PosicionPegarSubEstadoGlobal + 1]);

                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal + 2, 1); //inserto en posición 7 (ya he pegado subestadoglobal)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 5, f, PosicionSubEstadoGlobal + 5].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal + 2, f, PosicionPegarSubEstadoGlobal + 2]);

                    // borro las originales (tres a la derecha, he insertado cuatro columnas)
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal+3);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal+3);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal+3);
                   

                    //Pongo multipunto  antes de discrepancias
                    //////workSheet.Cells[f, c].Value = "Fecha BAJA KEE"; c++;
                    //////PosicionBajaKEE = c;
                    //////workSheet.Cells[f, c].Value = "Discrepancias"; c++;
                    //////PosicionSubEstadoGlobal = c;
                    //////workSheet.Cells[f, c].Value = "Subestado global"; c++;
                    //////workSheet.Cells[f, c].Value = "ESTADO GLOBAL"; c++;
                    //////workSheet.Cells[f, c].Value = "ESTADO GLOBAL A REPORTAR"; c++;
                    //////workSheet.Cells[f, c].Value = "multipunto";
                    
                    // He quitado  lo que hay entre discrepancias y multipuntos, las posiciones me valen, ahora he metido los globales por delante
                    workSheet.InsertColumn(PosicionBajaKEE + 3, 1);
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 4, f, PosicionSubEstadoGlobal + 4].Copy(workSheet.Cells[1, PosicionBajaKEE + 3, f, PosicionBajaKEE + 3]); //Copia la columna 31 (Fecha BAJA KEE) en la posición creada anteriormente
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 4);

                    //workSheet.Cells[1,5,100,5].Copy(workSheet.Cells[1,2,100,2]);
                    //Copia la columna 5 en la columna 2 Básicamente Source.Copy(Destino) Esto solo copiaría las primeras 100 filas.


                    //La columna area la pongo detrás de fh_hasta
                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal, 1);
                    // Ya he quitado lo que originalmente estaba detras de posiciónSubEstado Global, sólo queda el area en esa poscion
                    workSheet.Cells[1, PosicionSubEstadoGlobal +3, f, PosicionSubEstadoGlobal+3 ].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal, f, PosicionPegarSubEstadoGlobal]);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 3);

                    //El final es discrepancias seguido de multipuntos, los tengo que cambiar de orden --> discrepancia=48 y multipunto=49 después de las inserciones de columna
                    //no lo puedo hacer durante el proceso y poner multipuntos antes, ya que las discrepancias es un proceso aparte y separado
                    //Busco donde ha quedado discrepancias
                    intColumna = 1;
                    while (workSheet.Cells[1, intColumna].Value != "" & workSheet.Cells[1, intColumna].Value != "Discrepancias")
                    {
                        intColumna = intColumna + 1;
                    }
                    workSheet.InsertColumn(intColumna, 1); //Inserta  columna en blanco delante de discrepancias
                    workSheet.Cells[1, intColumna+2, f, intColumna + 2].Copy(workSheet.Cells[1, intColumna, f, intColumna]); //copio multipunto en la columna que he insertado
                    workSheet.DeleteColumn(intColumna + 2); //Borra la columna original de multipunto

                    allCells = workSheet.Cells[1, 1, f, c+7]; //Pongo +7 para las columnas de incidencias
                    allCells.AutoFitColumns();

                    //workSheet.View.FreezePanes(2, 1);
                    //workSheet.Cells["A1:S1"].AutoFilter = true;
                    //allCells.AutoFitColumns();

                    f = 1;

                    #endregion

                    #region Detalle POR MT-BTE
                    f = 1;
                    c = 1;

                    workSheet = excelPackage.Workbook.Worksheets.Add("Detalle POR MT-BTE");
                  


                    headerCells = workSheet.Cells[1, 1, 1, 32];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;
                    allCells = workSheet.Cells[1, 1, 50, 50];

                    //for (int i = 1; i <= c; i++)
                    //{
                    //    workSheet.Cells[f, i].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    //    workSheet.Cells[f, i].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                    //}


                    //Ponemos columnas directamente
                    f = 1;
                    c = 1;

                    workSheet.Cells[f, c].Value = "CUPS20"; c++;
                    workSheet.Cells[f, c].Value = "PERIODO"; c++;
                    workSheet.Cells[f, c].Value = "MES"; c++;
                    workSheet.Cells[f, c].Value = "FH_DESDE"; c++;
                    workSheet.Cells[f, c].Value = "FH_HASTA"; c++;
                    PosicionPegarSubEstadoGlobal = c;
                    workSheet.Cells[f, c].Value = "IMPORTE PDTE FACTURAR"; c++;
                    workSheet.Cells[f, c].Value = "MESES PDTES FACTURAR"; c++;
                    workSheet.Cells[f, c].Value = "ÁGORA"; c++;
                    workSheet.Cells[f, c].Value = "CLIENTE"; c++;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_SAP"; c++;
                    PosicionDiasEstadoKEE = c;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_KEE"; c++;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_GLOBAL"; c++;
                    workSheet.Cells[f, c].Value = "Incidencia Facturacion"; c++;
                    workSheet.Cells[f, c].Value = "Estado_Fac_SE"; c++;
                    workSheet.Cells[f, c].Value = "Titulo_Fac"; c++;
                    workSheet.Cells[f, c].Value = "Incidencia Medida"; c++;
                    PosicionReincidente = c;
                    workSheet.Cells[f, c].Value = "Reincidente"; c++;
                    workSheet.Cells[f, c].Value = "Estado incidencia"; c++;
                    workSheet.Cells[f, c].Value = "Fecha_Apertura"; c++;
                    workSheet.Cells[f, c].Value = "Prioridad"; c++;
                    workSheet.Cells[f, c].Value = "Titulo"; c++;
                    workSheet.Cells[f, c].Value = "E_S_Estado"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_SALESFORCE"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_SAP"; c++;
                    workSheet.Cells[f, c].Value = "FH_BAJA_SALESFORCE"; c++;
                    PosicionBajaSap = c;
                    workSheet.Cells[f, c].Value = "FH_BAJA_SAP"; c++;
                    workSheet.Cells[f, c].Value = "EMPRESA"; c++;
                    workSheet.Cells[f, c].Value = "SEGMENTO"; c++;
                    workSheet.Cells[f, c].Value = "TIPO CLIENTE"; c++;
                    workSheet.Cells[f, c].Value = "NIF"; c++;
                    workSheet.Cells[f, c].Value = "FPSERCON"; c++;
                    workSheet.Cells[f, c].Value = "Nº INSTALACIÓN"; c++;
                    workSheet.Cells[f, c].Value = "TARIFA"; c++;
                    workSheet.Cells[f, c].Value = "CONTRATO"; c++;
                    
                    workSheet.Cells[f, c].Value = "DISTRIBUIDORA"; c++;
                    workSheet.Cells[f, c].Value = "ESTADO"; c++;
                    PosicionSubEstadoSAP = c;
                    workSheet.Cells[f, c].Value = "SUBESTADO"; c++;
                    //////workSheet.Cells[f, c].Value = "DIAS_ESTADO"; c++;
                    workSheet.Cells[f, c].Value = "TAM"; c++;
                   
                    workSheet.Cells[f, c].Value = "ULT FH DESDE FACTURADA"; c++;
                    workSheet.Cells[f, c].Value = "ULT FH HASTA FACTURADA"; c++;

                    workSheet.Cells[f, c].Value = "Estado periodo KEE"; c++;
                    workSheet.Cells[f, c].Value = "Área responsable KEE"; c++;
                    PosicionSubEstadoKEE = c;
                    workSheet.Cells[f, c].Value = "Subestado KEE"; c++;
                    workSheet.Cells[f, c].Value = "Estado KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_DESDE_KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_HASTA_KEE"; c++;
                    workSheet.Cells[f, c].Value = "Fecha BAJA KEE"; c++;
                    PosicionBajaKEE = c;
                    workSheet.Cells[f, c].Value = "Discrepancias"; c++;
                    PosicionSubEstadoGlobal = c;
                    workSheet.Cells[f, c].Value = "Subestado global"; c++;
                    workSheet.Cells[f, c].Value = "ESTADO GLOBAL"; c++;
                    workSheet.Cells[f, c].Value = "ESTADO GLOBAL A REPORTAR"; c++;
                    workSheet.Cells[f, c].Value = "AREA ESTADO"; c++;
                    workSheet.Cells[f, c].Value = "multipunto";

                    strSql = DetalleExcel(fecha_informe, lista_empresas_PT, lista_segmentos_MT_BTE);

                    db = new MySQLDB(MySQLDB.Esquemas.GBL);
                    command = new MySqlCommand(strSql, db.con);
                    r = command.ExecuteReader();
                    while (r.Read())
                    {
                        f++;
                        c = 1;

                        empresa = ""; 
                        nif = "";
                        cliente = "";
                        apellido = "";
                        FechaAlta = null;
                        FechaInicio = null;
                        Tarifa = "";
                        contrato = "";
                        Distribuidora = "";
                        multipunto = "";
                        cups20 = "";

                        //Vemos si es o no multipunto
                        List<string> Multipuntos = new List<string>();
                        Multipuntos = pendienteWeb_B2B.GetCupsMultipunto(r["cups20"].ToString());
                        if (Multipuntos.Count > 0)
                        {
                            if (Multipuntos[0] == "False")
                            {
                                multipunto = "N";
                            }
                            else
                            {
                                multipunto = "S";
                            }

                        }
                        else
                        {
                            multipunto = "N";
                        }

                        if (r["cups20"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = r["cups20"].ToString();
                            cups20 = r["cups20"].ToString();
                        }   
                        c++;
                        ///PERIODO
                        workSheet.Cells[f, c].Value = ""; c++;

                        if (r["mes"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToInt32(r["mes"]);
                            aniomes = Convert.ToInt32(r["mes"]);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);
                        }
                        c++;

                        if (r["fh_desde"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_desde"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["fh_hasta"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_hasta"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        //Para controlar los blancos, miramos en t_ed_h_ps_hist
                        if (r["cd_empr"] != System.DBNull.Value)
                        {   
                            Existetedhps = true;
                        }
                        else
                        {
                            Existetedhps = false;

                            strSql = "SELECT cd_empr,  cd_nif_cif_cli, de_tp_cli, tx_apell_cli, fh_alta_crto, fh_inicio_vers_crto"
                            + " ,ps.cd_tarifa_c, ps.cd_crto_comercial, ps.de_empr_distdora_nombre"
                            + " FROM cont.t_ed_h_ps_pt_hist ps"
                            + " WHERE cups20 = '" + r["cups20"].ToString() + "'"
                            + " AND created_date = (SELECT MAX(created_date) FROM cont.t_ed_h_ps_pt_hist"
                            + " WHERE cups20 = '" + r["cups20"].ToString() + "')";

                            dbAux = new MySQLDB(MySQLDB.Esquemas.GBL);
                            commandAux = new MySqlCommand(strSql, dbAux.con);
                            rAux = commandAux.ExecuteReader();
                            while (rAux.Read())
                            {
                                if (rAux["cd_empr"] != System.DBNull.Value)
                                    empresa = rAux["cd_empr"].ToString();
                                if (rAux["de_tp_cli"] != System.DBNull.Value)
                                    cliente = rAux["de_tp_cli"].ToString();
                                if (rAux["cd_nif_cif_cli"] != System.DBNull.Value)
                                    nif = rAux["cd_nif_cif_cli"].ToString();
                                if (rAux["tx_apell_cli"] != System.DBNull.Value)
                                    apellido = rAux["tx_apell_cli"].ToString();
                                if (rAux["fh_alta_crto"] != System.DBNull.Value)
                                    FechaAlta = Convert.ToDateTime(rAux["fh_alta_crto"]).Date;
                                if (rAux["fh_inicio_vers_crto"] != System.DBNull.Value)
                                    FechaInicio = Convert.ToDateTime(rAux["fh_inicio_vers_crto"]).Date;
                                if (rAux["cd_tarifa_c"] != System.DBNull.Value)
                                    Tarifa = rAux["cd_tarifa_c"].ToString();
                                if (rAux["cd_crto_comercial"] != System.DBNull.Value)
                                    contrato = rAux["cd_crto_comercial"].ToString();
                                if (rAux["de_empr_distdora_nombre"] != System.DBNull.Value)
                                    Distribuidora = rAux["de_empr_distdora_nombre"].ToString();
                            }
                            dbAux.CloseConnection();
                        }
                        //// Fin mirar en el historico

                        //Importe PDTE facturar
                        if (r["mes"] != System.DBNull.Value && r["TAM"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["tam"]) * meses_pdtes;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; c++;
                        }
                        else
                        {
                            c++;
                        }

                       

                        if (r["mes"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = meses_pdtes;
                            workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        }
                        c++;

                        if (meses_pdtes > 1)
                        {
                            workSheet.Cells[f, 2].Value = ">1P";
                        }
                        else
                        {
                            workSheet.Cells[f, 2].Value = "1P";
                        }

                        if (r["agora"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["agora"].ToString();

                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        //////if (r["tx_apell_cli"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["tx_apell_cli"].ToString();
                        //////c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = apellido;
                        }
                        else
                        {
                            if (r["tx_apell_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["tx_apell_cli"].ToString();
                        }
                        c++;

                        //DIAS_ESTADO_SAP
                        workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());
                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        //DIAS_ESTADO_KEE
                        workSheet.Cells[f, c].Value = "";c++;

                        //DIAS_ESTADO_GLOBAL
                        workSheet.Cells[f, c].Value = ""; c++;

                        //Recuperar Incidencia Facturacion
                        listaIncidenciasSAP = RelacionIncidenciasSAP.GetCups(r["cups20"].ToString() + aniomes);

                        if (listaIncidenciasSAP.Count == 0)
                        {
                            IncidenciaFacturacion = "";
                            Estado_FAC_SE = "";
                            Titulo_FAC = "";
                        }
                        else
                        {
                            foreach (var mm in listaIncidenciasSAP)
                            {
                                string[] cadena = mm.Split(';');
                                IncidenciaFacturacion = cadena[0];
                                Estado_FAC_SE = cadena[1];
                                Titulo_FAC = cadena[2];
                                break;
                            }
                        }
                        //Fin recuperar incidencia facturacion


                        // Comprobamos con la tabla Relacion_INC_CUPS
                        ////// 1.Se relaciona el detalle del informe obtenido(campos cups20 y mes) con la tabla "Relacion_INC_CUPS"(campos cups y mes).Si para un cups se encuentra en esa relación una incidencia que afeca al mismo mes que está pendiente se deberá desechar el estado que tuviera el informe y actualizarlo por uno nuevo.
                        ////// 2.El estado a actualizar dependerá del campo "area" de la tabla "Relacion_INC_CUPS", pudiendo existir 3 opciones:
                        ////// --01.B09 Incidencia_Contratacion: se informará con este estado cuando encuentre para ese mes una incidencia en el area de contratacion, independientemente de que también haya otras para ese mismo mes en otras areas.
                        //////-- 01.B10 Incidencia_Medida: no estando en el caso anterior, se informará con este estado cuando encuentre para ese mes una incidencia en el area de medida, independientemente de que también haya otras para ese mismo mes en el area de facturacion.
                        ////// --01.B11 Incidencia_Facturacion: no estando en ninguno de los dos casos anteriores, se informará con este estado cuando encuentre para ese mes una incidencia en el area de Facturacion.
                        strSql = " select area, incidencia, estado_incidencia, fecha_apertura, prioridad_negocio, titulo, e_s_estado, Reincidente from Relacion_INC_CUPS"
                                 + " where cups='" + r["cups20"].ToString() + "' and Mes_pendiente='" + aniomes + "'"
                                 + " order by Fecha_apertura asc";

                        dbIncidencia = new MySQLDB(MySQLDB.Esquemas.MED);
                        command = new MySqlCommand(strSql, dbIncidencia.con);
                        inci = command.ExecuteReader();

                        areaincidencia = "";
                        incidencia = "";
                        estado_incidencia = "";
                        fecha_apertura = "";
                        prioridad_negocio = "";
                        titulo = "";
                        e_s_estado = "";
                        subestado_incidencia = "";
                        reincidente = "";
                        ExisteIncidencia = false;

                        while (inci.Read())
                        {
                            ExisteIncidencia = true;
                            if (areaincidencia == "")
                            {
                                areaincidencia = inci["area"].ToString();

                                if (areaincidencia == "Contratacion")
                                    subestado_incidencia = "01.B09 Incidencia_Contratacion";
                                if (areaincidencia == "Medida")
                                    subestado_incidencia = "01.B10 Incidencia_Medida";
                                if (areaincidencia == "Facturacion")
                                    subestado_incidencia = "01.B11 Incidencia_Facturacion";

                                incidencia = inci["incidencia"].ToString();
                                estado_incidencia = inci["estado_incidencia"].ToString();
                                fecha_apertura = inci["fecha_apertura"].ToString();
                                prioridad_negocio = inci["prioridad_negocio"].ToString();
                                titulo = inci["titulo"].ToString();
                                e_s_estado = inci["e_s_estado"].ToString();
                                reincidente = inci["Reincidente"].ToString();
                            }
                            else
                            {
                                if (areaincidencia != inci["area"].ToString())
                                {
                                    areaincidencia = inci["area"].ToString();

                                    if (areaincidencia == "Contratacion")
                                        subestado_incidencia = subestado_incidencia + " - 01.B09 Incidencia_Contratacion";
                                    if (areaincidencia == "Medida")
                                        subestado_incidencia = subestado_incidencia + " - 01.B10 Incidencia_Medida";
                                    if (areaincidencia == "Facturacion")
                                        subestado_incidencia = subestado_incidencia + " - 01.B11 Incidencia_Facturacion";

                                    incidencia = incidencia + " - " + inci["incidencia"].ToString();
                                    estado_incidencia = estado_incidencia + " - " + inci["estado_incidencia"].ToString();
                                    fecha_apertura = fecha_apertura + " - " + inci["fecha_apertura"].ToString();
                                    prioridad_negocio = prioridad_negocio + " - " + inci["prioridad_negocio"].ToString();
                                    titulo = titulo + " - " + inci["titulo"].ToString();
                                    e_s_estado = e_s_estado + " - " + inci["e_s_estado"].ToString();
                                }
                            }
                        } // Fin  while (inci.Read())

                        dbIncidencia.CloseConnection();
                        if (ExisteIncidencia == true)
                        {
                            //////c--;
                            //////workSheet.Cells[f, c].Value = subestado_incidencia; c++;
                            ///
                            workSheet.Cells[f, c].Value = IncidenciaFacturacion;c++;
                            workSheet.Cells[f, c].Value = Estado_FAC_SE; c++;
                            workSheet.Cells[f, c].Value = Titulo_FAC; c++;
                            workSheet.Cells[f, c].Value = incidencia; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = estado_incidencia; c++;
                            workSheet.Cells[f, c].Value = fecha_apertura; c++;
                            workSheet.Cells[f, c].Value = prioridad_negocio; c++;
                            workSheet.Cells[f, c].Value = titulo; c++;
                            workSheet.Cells[f, c].Value = e_s_estado; c++;
                        }
                        else
                        {
                            workSheet.Cells[f, c].Value = IncidenciaFacturacion; c++;
                            workSheet.Cells[f, c].Value = Estado_FAC_SE; c++;
                            workSheet.Cells[f, c].Value = Titulo_FAC; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        ////////////////////////////////////////////////////////////////////////////////////////////////


                        //FH_ALTA_SALESFORCE
                        ////workSheet.Cells[f, c].Value = ""; c++;

                        if (r["fh_alta_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        else
                        {

                        }
                        c++;
                        // FIN FH_ALTA_SALESFORCE

                        //FECHA_ALTA_KEE*****************************************************
                        listaAltaKEE = pendienteWeb_B2B.GetCupsFechaAltaKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));

                        if (listaAltaKEE.Count == 0)
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        else
                        {
                            if (listaAltaKEE[0] == "01/01/0001 0:00:00")
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {

                                foreach (var mm in listaAltaKEE)
                                {
                                    workSheet.Cells[f, c].Value = mm; c++;
                                    break;
                                }
                                //////workSheet.Cells[f, c].Value = lista; c++;
                            }
                        }

                        //FIN FH_ALTA_KEE*****************************************************

                        //////if (r["fh_alta_crto"] != System.DBNull.Value)
                        //////{
                        //////    workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                        //////    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        //////}
                        //////c++;


                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(FechaAlta).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        else
                        {
                            if (r["fh_alta_crto"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            }
                        }
                        c++;


                        if (r["fh_baja_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_baja_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        }
                        else
                        {
                            ////////if (r["fh_prev_fin_crto"] != System.DBNull.Value)
                            ////////{
                            ////////    workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_prev_fin_crto"]).Date;
                            ////////    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                            ////////}
                        }
                        c++;

                        //Paco, buscamos la fecha de Baja de SAP ******************************************
                        CadenaAuxiliar = r["id_crto_ext"].ToString();
                        CadenaAuxiliar = CadenaAuxiliar.PadLeft(12, '0'); //Relleno con ceros a la izquierda hasta 12


                        fhBajaSap = FechaBajaSap.GetCupsFechaBajaSAP(CadenaAuxiliar);

                        if (fhBajaSap.Count == 0)
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        else
                        {
                            foreach (var mm in fhBajaSap)
                            {
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                workSheet.Cells[f, c].Value = mm; c++;   
                                break;
                            }
                        }


                        //////strSql = "SELECT  max(cd_sec_crto), fh_baja from ed_owner.t_ed_h_sap_crto_front "
                        //////+ " WHERE id_crto_ext = '" + CadenaAuxiliar + "'"
                        //////+ " group by  fh_baja"
                        //////+ " order by  max(cd_sec_crto) desc";

                        //////dbRS = new servidores.RedShiftServer(RedShiftServer.Entornos.PROD);
                        //////commandRS = new OdbcCommand(strSql, dbRS.con);
                        //////rRS = commandRS.ExecuteReader();
                        //////while (rRS.Read())
                        //////{
                        //////    if (rRS["fh_baja"] != System.DBNull.Value)
                        //////        workSheet.Cells[f, c].Value = Convert.ToDateTime(rRS["fh_baja"]).Date;
                        //////    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        //////    break;
                        //////}
                        //////dbRS.CloseConnection();
                        //////c++;

                        //Fin - Fh_baja de SAP ***************************************************


                        //////if (r["cd_empr"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["cd_empr"].ToString();
                        //////c++;


                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = empresa;
                        }
                        else
                        {
                            if (r["cd_empr"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_empr"].ToString();
                        }
                        c++;

                        if (r["cd_segmento_ptg"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["cd_segmento_ptg"].ToString();
                        c++;

                        //////if (r["de_tp_cli"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["de_tp_cli"].ToString();
                        //////c++;


                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = cliente;
                        }
                        else
                        {
                            if (r["de_tp_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["de_tp_cli"].ToString();
                        }
                        c++;

                        //////if (r["cd_nif_cif_cli"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["cd_nif_cif_cli"].ToString();
                        //////c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = nif;
                        }
                        else
                        {
                            if (r["cd_nif_cif_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_nif_cif_cli"].ToString();
                        }
                        c++;

                        //////if (r["fh_inicio_vers_crto"] != System.DBNull.Value)
                        //////{
                        //////    workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_inicio_vers_crto"]).Date;
                        //////    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        //////}
                        //////c++;


                        if (Existetedhps == false)
                        {     
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(FechaInicio).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        else
                        {
                            if (r["fh_inicio_vers_crto"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_inicio_vers_crto"]).Date;
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            }
                        }
                        c++;

                        if (r["id_instalacion"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["id_instalacion"].ToString();
                        c++;

                        //////if (r["cd_tarifa_c"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["cd_tarifa_c"].ToString();
                        //////c++;


                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Tarifa;
                        }
                        else
                        {
                            if (r["cd_tarifa_c"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_tarifa_c"].ToString();
                        }
                        c++;

                        //////if (r["cd_crto_comercial"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["cd_crto_comercial"].ToString();
                        //////c++;


                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = contrato;
                        }
                        else
                        {
                            if (r["cd_crto_comercial"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_crto_comercial"].ToString();
                        }
                        c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Distribuidora;
                        }
                        else
                        {
                            if (r["de_empr_distdora_nombre"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["de_empr_distdora_nombre"].ToString();
                        }
                        c++;

                        if (r["de_estado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_estado"].ToString();
                        c++;

                        if (r["de_subestado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_subestado"].ToString();
                        c++;

                        //if (r["lg_multimedida"] != System.DBNull.Value)
                        //{
                        //    workSheet.Cells[f, c].Value = r["lg_multimedida"].ToString();

                        //}
                        //else
                        //{
                        //    workSheet.Cells[f, c].Value = "N";
                        //}


                        //PRIUEBA
                        //////workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());

                        //////workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        //////c++;

                        if (r["TAM"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["TAM"]);
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                        }
                        c++;



                        // Paco - añadimos la ultima fecha desde y hasta facturada t_ed_h_sap_facts
                        //workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        //////if (pendienteSAPKEE.GetCupsInicioUltimaFacturada(r["cups20"].ToString()) is null)
                        //////{
                        //////    workSheet.Cells[f, c].Value = "";
                        //////}
                        //////else
                        //////{
                        //////    foreach (var mm in pendienteSAPKEE.GetCupsInicioUltimaFacturada(r["cups20"].ToString()))
                        //////    {
                        //////        workSheet.Cells[f, c].Value = mm;
                        //////    }
                        //////    //////workSheet.Cells[f, c].Value = pendienteSAPKEE.GetCupsInicioUltimaFacturada(r["cups20"].ToString());
                        //////}


                        // Paco - añadimos la ultima fecha desde y hasta facturada t_ed_h_sap_facts
                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        List<string> listaInicio = new List<string>();
                        listaInicio = pendienteSAPKEE.GetCupsInicioUltimaFacturada(r["cups20"].ToString());
                        if (listaInicio != null)
                        {
                            if (listaInicio.Count == 0)
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaInicio[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaInicio)
                                    {
                                        workSheet.Cells[f, c].Value = mm; c++;
                                        break;
                                    }
                                    ////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }
                        }
                        else
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }

                        //////if (workSheet.Cells[f, c].Value == null)
                        //////{
                        //////    workSheet.Cells[f, c].Value = "";
                        //////}
                        //////c++;
                        //workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        // Paco - añadimos la ultima fecha desde y hasta facturada t_ed_h_sap_facts
                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        List<string> listaFin = new List<string>();
                        listaFin = pendienteSAPKEE.GetCupsFinalUltimaFacturada(r["cups20"].ToString());
                        if (listaFin != null)
                        {
                            if (listaFin.Count == 0)
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaFin[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaFin)
                                    {
                                        workSheet.Cells[f, c].Value = mm; c++;
                                        break;
                                    }
                                    ////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }
                        }
                        else
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }

                        subestadosKronos.existe = false;
                        if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                        {

                            subestadosKronos.existe = false;


                            if (multipunto == "N")
                            {
                                subestadosKronos.GetEstadoKEEDetalle(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                                    Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));
                            }
                            else
                            {
                                subestadosKronos.GetEstadoKEEDetalleMultipunto(pendienteWeb_B2B.GetCupsDetalle(r["cups20"].ToString(),
                                    Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));
                            }


                            if (subestadosKronos.existe)
                            {
                                BuscaCadena = subestadosKronos.descripcion_estado;
                                List<string> lista = new List<string>();

                                if (BuscaCadena.IndexOf("Discrepancia") >= 0)
                                {
                                    if (BuscaCadena.IndexOf("Periodo SAP encontrado parcialmente en el informe pendiente de KEE") >= 0)
                                    {
                                        workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                        workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                        workSheet.Cells[f, c].Value = "01.B05 Error Sistemas KEE - SAP - Incoherencia periodos KEE-SAP"; c++;
                                        // Como estoy forzando y pongo a pelo la descripcion subestado y tengo la variable ocupada, el estado de KEE lo he guardado en descripcion_subestado
                                        //en lugar de en descripcion_estado
                                        workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                        string[] cadena = subestadosKronos.descripcion_estado.Split(';');
                                        string[] cadenaAux = cadena[2].Split('/');
                                        workSheet.Cells[f, c].Value = cadenaAux[0].Substring(1, 8).Substring(6, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(4, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(0, 4); c++;
                                        workSheet.Cells[f, c].Value = cadenaAux[1].Substring(0, 8).Substring(6, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(4, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(0, 4); c++;
                                    }
                                    //|| BuscaCadena.IndexOf("Periodos del pendiente de KEE contenidos en las fechas de SAP") >= 0 || BuscaCadena.IndexOf("Periodo SAP contenido dentro de un informe pendiente de KEE") >= 0
                                    else
                                    {
                                        if (BuscaCadena.IndexOf("Periodos del pendiente de KEE contenidos en las fechas de SAP") >= 0 || BuscaCadena.IndexOf("Periodo SAP contenido dentro de un informe pendiente de KEE") >= 0)
                                        {
                                            workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                            workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                            // Como estoy forzando y pongo a pelo la descripcion subestado y tengo la variable ocupada, el subestado de KEE lo he guardado en temporal de momento
                                            workSheet.Cells[f, c].Value = subestadosKronos.temporal; c++;
                                            // Como estoy forzando y pongo a pelo la descripcion subestado y tengo la variable ocupada, el estado de KEE lo he guardado en descripcion_subestado
                                            //en lugar de en descripcion_estado
                                            workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                            string[] cadena = subestadosKronos.descripcion_estado.Split(';');
                                            string[] cadenaAux = cadena[2].Split('/');
                                            workSheet.Cells[f, c].Value = cadenaAux[0].Substring(1, 8).Substring(6, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(4, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(0, 4); c++;
                                            workSheet.Cells[f, c].Value = cadenaAux[1].Substring(0, 8).Substring(6, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(4, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(0, 4); c++;

                                        }
                                        else
                                        {
                                            //si no está el CUPS en la tabla "ed_owner.T_ED_H_GEST_DIAR_PS_B2B" he obtenido: "Discrepancia: No existe el cups en el informe del pendiente de KEE"
                                            // el cups está en la tabla, pero dentro de los periodos que hay no no hay ningún periodo que coincida ni total ni parcialmente
                                            //      Marcado: "Discrepancia: No existen fechas en el informe pendiente de KEE para el periodo;(" + Convert.ToString(fecha_desde.ToString("yyyyMMdd")) + "/" + Convert.ToString(fecha_hasta.ToString("yyyyMMdd")) + ")")

                                            if (BuscaCadena.IndexOf("No existe el cups en el informe del pendiente de KEE") >= 0)
                                            {
                                                workSheet.Cells[f, c].Value = ""; c++;
                                                workSheet.Cells[f, c].Value = ""; c++;
                                                workSheet.Cells[f, c].Value = "01.B07 Error Sistemas KEE-SAP - Pdte SAP-No existe en KEE"; c++;
                                                workSheet.Cells[f, c].Value = ""; c++;
                                                workSheet.Cells[f, c].Value = ""; c++;
                                                workSheet.Cells[f, c].Value = ""; c++;

                                            }
                                            else
                                            {

                                                if (BuscaCadena.IndexOf("No existen fechas en el informe pendiente de KEE para el periodo") >= 0)
                                                {
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = "01.B06 Error Sistemas KEE-SAP - Pdte SAP-No pdte KEE"; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;

                                                }
                                                else
                                                {
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                }

                                            } //Fin  if (BuscaCadena.IndexOf("No existe el cups en el informe del pendiente de KEE") >= 0)

                                        } // fin  if (BuscaCadena.IndexOf("Periodos del pendiente de KEE contenidos en las fechas de SAP") >= 0 || BuscaCadena.IndexOf("Periodo SAP contenido dentro de un informe pendiente de KEE") >= 0)

                                    } // Fin  if (BuscaCadena.IndexOf("Periodo SAP encontrado parcialmente en el informe pendiente de KEE") >= 0 )

                                    //////lista = pendienteWeb_B2B.GetCupsFinKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]));
                                    lista = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));

                                    if (lista.Count == 0)
                                    {
                                        workSheet.Cells[f, c].Value = ""; c++;
                                    }
                                    else
                                    {
                                        if (lista[0] == "01/01/0001 0:00:00")
                                        {
                                            workSheet.Cells[f, c].Value = ""; c++;
                                        }
                                        else
                                        {

                                            foreach (var mm in lista)
                                            {
                                                workSheet.Cells[f, c].Value = mm; c++;
                                                break;
                                            }
                                            //////workSheet.Cells[f, c].Value = lista; c++;
                                        }
                                    }
                                    workSheet.Cells[f, c].Value = subestadosKronos.descripcion_estado; c++;
                                    //Subestado Global
                                    if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                    }
                                    else
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                    }

                                    //
                                }
                                else
                                {
                                    workSheet.Cells[f, c].Value = subestadosKronos.estado_periodo; c++;
                                    workSheet.Cells[f, c].Value = subestadosKronos.area_responsable; c++;
                                    workSheet.Cells[f, c].Value = subestadosKronos.descripcion_subestado; c++;
                                    workSheet.Cells[f, c].Value = subestadosKronos.descripcion_estado; c++;
                                    // fh_desde_kee y fh_hasta_kee coincide con fecha desde y hasta de sap, equivalencia de fechas
                                    if (r["fh_desde"] != System.DBNull.Value)
                                    {
                                        workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_desde"]).Date;
                                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                    }
                                    c++;

                                    if (r["fh_hasta"] != System.DBNull.Value)
                                    {
                                        workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_hasta"]).Date;
                                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                    }
                                    c++;
                                    //////lista = pendienteWeb_B2B.GetCupsFinKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]));
                                    lista = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));
                                    if (lista.Count == 0)
                                    {
                                        workSheet.Cells[f, c].Value = ""; c++;
                                    }
                                    else
                                    {
                                        if (lista[0] == "01/01/0001 0:00:00")
                                        {
                                            workSheet.Cells[f, c].Value = ""; c++;
                                        }
                                        else
                                        {

                                            foreach (var mm in lista)
                                            {
                                                workSheet.Cells[f, c].Value = mm; c++;
                                                break;
                                            }
                                            //////workSheet.Cells[f, c].Value = lista; c++;
                                        }
                                    }
                   
                                    workSheet.Cells[f, c].Value = ""; c++;

                                    //Subestado Global
                                    if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                    }
                                    else
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                    }
                                    //Fin Subestado Global
                                }

                                //Paco 21/05/2024 Calculo del numero dias KEE en Kronos ********************
                                if (blnLanzarDiasKEE == true)
                                {
                                    //////if (BuscaCadena.IndexOf("Discrepancia") >= 0)
                                    //////{
                                    //////    DiasExistenciaKEE = FuncionDiasKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.descripcion_subestado);
                                    //////}
                                    //////else
                                    //////{
                                    //////    DiasExistenciaKEE = FuncionDiasKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.descripcion_estado);
                                    //////}
                                    ///
                                    DiasExistenciaKEE = FuncionDiasKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.estado_periodo);
                                }

                                else
                                {
                                    /// Para que recupere los dias en ejecuciones sucesivas el mismo día.
                                    //////if (BuscaCadena.IndexOf("Discrepancia") >= 0)
                                    //////{
                                    //////    DiasExistenciaKEE = FuncionDiasKEERecuperarDiasTabla(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.descripcion_subestado);
                                    //////}
                                    //////else
                                    //////{

                                    //////    DiasExistenciaKEE = FuncionDiasKEERecuperarDiasTabla(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.descripcion_estado);

                                    //////}
                                    ///
                                    DiasExistenciaKEE = FuncionDiasKEERecuperarDiasTabla(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), subestadosKronos.estado_periodo);

                                }
                                //Fin Calculo del numero dias KEE en Kronos  ***************


                            }
                            else
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                workSheet.Cells[f, c].Value = ""; c++;
                                //Subestado Global
                                if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                {
                                    workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                }
                                else
                                {
                                    workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                }
                                //Fin Subestado Global
                            } //Fin if (subestadosKronos.existe)
                        }


                        else
                        {
                            //System.Diagnostics.Debug.WriteLine(r["cups20"].ToString() + "-" + r["de_subestado"].ToString() + "-" + subestadosKronos.descripcion_subestado + "-" + subestadosKronos.descripcion_estado);
                            //Para que llegue hasta la última columna aunque no exista en Kronos
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            // Fecha fin KEE (se pinta aunque no sea uno de los estados marcados como KEE
                            // workSheet.Cells[f, c].Value = ""; c++;
                            List<string> listaAux = new List<string>();
                            listaAux = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));
                            if (listaAux.Count == 0)
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaAux[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaAux)
                                    {
                                        workSheet.Cells[f, c].Value = mm; c++;
                                        break;
                                    }
                                    //////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }
                            workSheet.Cells[f, c].Value = ""; c++;


                            //Subestado Global
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                            }
                            else
                            {
                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                            }

                        } // Fin  if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))

                        //Calculo DIAS ESTADO GLOBAL *************************
                        if (blnLanzarDiasKEE == true) // Sólo se actualizan los datos en la tabla la primera vez, por si hay ejecuciones sucesivas
                        {
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEEGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoKEE].Value.ToString());
                            }
                            else
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEEGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoSAP].Value.ToString());
                            }
                        }
                        else
                        {
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEERecuperarDiasTablaGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoKEE].Value.ToString());
                            }
                            else
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEERecuperarDiasTablaGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoSAP].Value.ToString());
                            }
                        }
                        //FIN DIAS ESTADO GLOBAL*******************************


                        if (areaincidencia != "" & subestadosKronos.existe == true)
                        {
                            Auxiliar = Reincidente(areaincidencia, subestadosKronos.area_responsable);
                            if (Auxiliar != "")
                            {
                                ////c--;
                                workSheet.Cells[f, PosicionSubEstadoGlobal].Value = Auxiliar;
                                workSheet.Cells[f, PosicionReincidente].Value = reincidente;
                            }
                        }

                        //Fin Paco 09/05/2024***********************************************************************************************


                        Auxiliar = "";
                        Auxiliar = EstadosAreas(workSheet.Cells[f, PosicionSubEstadoGlobal].Value.ToString(), cups20, aniomes.ToString(), 1,0, false);

                        if (Auxiliar != "")
                        {
                            string[] CadenaEstados = Auxiliar.Split(';');
                            workSheet.Cells[f, c].Value = CadenaEstados[0]; c++;
                            workSheet.Cells[f, c].Value = CadenaEstados[1]; c++;
                            workSheet.Cells[f, c].Value = CadenaEstados[2]; c++;
                        }
                        else
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;

                            if (SubestadosNoEncontrados == "")
                            {
                                SubestadosNoEncontrados = "Hoja MT-BTE: " + cups20 + " - " + Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd") + " - " + Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd") + " - " + r["de_estado"].ToString() + " -" + r["de_subestado"].ToString() + "- No existe el subestado en la tabla paramétrica";

                            }
                            else
                            {
                                SubestadosNoEncontrados = SubestadosNoEncontrados + ";Hoja MT-BTE: " + cups20 + " - " + Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd") + " - " + Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd") + " - " + r["de_estado"].ToString() + " -" + r["de_subestado"].ToString() + "- No existe el subestado en la tabla paramétrica";
                            }
                        }

                        //// Tratamiento multipuntos
                        workSheet.Cells[f, c].Value = multipunto; c++;

                        // "Nº DÍAS ESTADO KEE"
                        if (subestadosKronos.existe == true)
                        {
                            workSheet.Cells[f, PosicionDiasEstadoKEE].Value = DiasExistenciaKEE; c++;
                        }

                        // Pego Nº DIAS ESTADO GLOBAL, va a continuación de DIAS ESTADO KEE
                        workSheet.Cells[f, PosicionDiasEstadoKEE + 1].Value = DiasExistenciaKEEGlobal; c++;

                    }
                    db.CloseConnection();

                    intConteoMTBTEDetalle = f-1;

                    if (blnLanzarDiasKEE == true) {
                        ///todos los que están activos y  no se ha marcado PROCESADO_DIARIO = 'S', son puntos que se cierran, actualizo la FH_CIERRE
                        strSql = "update kee_Dias  set"
                                   + " FH_CIERRE = '" + DateTime.Now.ToString("yyyy-MM-dd") + "',"
                                   + " FH_ACTUALIZACION = '" + DateTime.Now.ToString("yyyy-MM-dd") + "',"
                                   + " ACTIVO= False"
                                   + " WHERE  Activo = true"
                                   + " AND FH_ACTUALIZACION < '" + DateTime.Now.ToString("yyyy-MM-dd") + "'";

                        db = new MySQLDB(MySQLDB.Esquemas.MED);
                        command = new MySqlCommand(strSql, db.con);
                        command.ExecuteNonQuery();
                        db.CloseConnection();

                    }

                    ////////13/02/2024 Paco, mover columna de fecha baja de Kronos despues de fecha de baja de SAP
                    //////workSheet.InsertColumn(PosicionBajaSap, 1); //Inserta en la posicion 12 una columna en blanco(detrás de FH_BAJA_SAP)
                    //////workSheet.Cells[1, PosicionBajaKEE, f, PosicionBajaKEE].Copy(workSheet.Cells[1, PosicionBajaSap, f, PosicionBajaSap]); //Copia la columna 31 (Fecha BAJA KEE) en la posición creada anteriormente
                    //////workSheet.DeleteColumn(PosicionBajaKEE); //Borra la columna 31 Fecha BAJA KEE

                    //////allCells = workSheet.Cells[1, 1, f, c];
                    //////allCells.AutoFitColumns();

                    headerCells = workSheet.Cells[1, 1, 1, c];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;

                    //08/02/2024 Paco, mover columna de fecha baja de Kronos despues de fecha de baja de SAP
                    workSheet.InsertColumn(PosicionBajaSap, 1); //Inserta en la posicion 12 una columna en blanco(detrás de FH_BAJA_SAP)
                    workSheet.Cells[1, PosicionBajaKEE, f, PosicionBajaKEE].Copy(workSheet.Cells[1, PosicionBajaSap, f, PosicionBajaSap]); //Copia la columna 31 (Fecha BAJA KEE) en la posición creada anteriormente
                    workSheet.DeleteColumn(PosicionBajaKEE); //Borra la columna 31 Fecha BAJA KEE

                    //Pegamos Subestadoglobal, estado_global y estado global a reportar despues de FH_HASTA *** (!!!OJO, he metido ya por medio FECHA BAJA KEE (Sumo una más)!!)****
                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal, 1); //Inserta en la posicion 5 una columna en blanco(detrás de FH_HASTA)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 1, f, PosicionSubEstadoGlobal + 1].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal, f, PosicionPegarSubEstadoGlobal]);

                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal + 1, 1); //inserto en posición 6 (ya he pegado subestadoglobal)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 3, f, PosicionSubEstadoGlobal + 3].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal + 1, f, PosicionPegarSubEstadoGlobal + 1]);

                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal + 2, 1); //inserto en posición 7 (ya he pegado subestadoglobal)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 5, f, PosicionSubEstadoGlobal + 5].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal + 2, f, PosicionPegarSubEstadoGlobal + 2]);

                    // borro las originales (tres a la derecha, he insertado tres columnas)
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 3);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 3);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 3);


                    // He quitado  lo que hay entre discrepancias y multipuntos, las posiciones me valen, ahora he metido los globales por delante
                    workSheet.InsertColumn(PosicionBajaKEE + 3, 1);
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 4, f, PosicionSubEstadoGlobal + 4].Copy(workSheet.Cells[1, PosicionBajaKEE + 3, f, PosicionBajaKEE + 3]); //Copia la columna 31 (Fecha BAJA KEE) en la posición creada anteriormente
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 4);

                    //La columna AREA la pongo detrás de fh_hasta
                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal, 1);
                    // Ya he quitado lo que originalmente estaba detras de posiciónSubEstado Global, sólo queda el area en esa poscion
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 3, f, PosicionSubEstadoGlobal + 3].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal, f, PosicionPegarSubEstadoGlobal]);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 3);

                    //El final es discrepancias seguido de multipuntos, los tengo que cambiar de orden --> discrepancia=48 y multipunto=49 después de las inserciones de columna
                    //no lo puedo hacer durante el proceso y poner multipuntos antes, ya que las discrepancias es un proceso aparte y separado
                    //Busco donde ha quedado discrepancias
                    intColumna = 1;
                    while (workSheet.Cells[1, intColumna].Value != "" & workSheet.Cells[1, intColumna].Value != "Discrepancias")
                    {
                        intColumna = intColumna + 1;
                    }
                    workSheet.InsertColumn(intColumna, 1); //Inserta  columna en blanco delante de discrepancias
                    workSheet.Cells[1, intColumna + 2, f, intColumna + 2].Copy(workSheet.Cells[1, intColumna, f, intColumna]); //copio multipunto en la columna que he insertado
                    workSheet.DeleteColumn(intColumna + 2); //Borra la columna original de multipunto


                    //workSheet.Cells[1,5,100,5].Copy(workSheet.Cells[1,2,100,2]);
                    //Copia la columna 5 en la columna 2 Básicamente Source.Copy(Destino) Esto solo copiaría las primeras 100 filas.

                    allCells = workSheet.Cells[1, 1, f, c + 7]; //Pongo +7 para las columnas de incidencias
                    allCells.AutoFitColumns();

                    #endregion

                    #region Detalle POR BTN

                    f = 1;
                    c = 1;

                    workSheet = excelPackage.Workbook.Worksheets.Add("Detalle POR BTN");

                    headerCells = workSheet.Cells[1, 1, 1, 32];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;
                    allCells = workSheet.Cells[1, 1, 50, 50];


                    //Ponemos columnas directamente
                    workSheet.Cells[f, c].Value = "CUPS20"; c++;
                    workSheet.Cells[f, c].Value = "PERIODO"; c++;
                    workSheet.Cells[f, c].Value = "MES"; c++;
                    workSheet.Cells[f, c].Value = "FH_DESDE"; c++;
                    workSheet.Cells[f, c].Value = "FH_HASTA"; c++;
                    PosicionPegarSubEstadoGlobal = c;
                    workSheet.Cells[f, c].Value = "IMPORTE PDTE FACTURAR"; c++;
                    workSheet.Cells[f, c].Value = "MESES PDTES FACTURAR"; c++;
                    workSheet.Cells[f, c].Value = "ÁGORA"; c++;
                    workSheet.Cells[f, c].Value = "CLIENTE"; c++;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_SAP"; c++;
                    PosicionDiasEstadoKEE = c;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_KEE"; c++;
                    workSheet.Cells[f, c].Value = "DIAS_ESTADO_GLOBAL"; c++;
                    workSheet.Cells[f, c].Value = "Incidencia Facturacion"; c++;
                    workSheet.Cells[f, c].Value = "Estado_Fac_SE"; c++;
                    workSheet.Cells[f, c].Value = "Titulo_Fac"; c++;
                    workSheet.Cells[f, c].Value = "Incidencia Medida"; c++;
                    PosicionReincidente = c;
                    workSheet.Cells[f, c].Value = "Reincidente"; c++;
                    workSheet.Cells[f, c].Value = "Estado incidencia"; c++;
                    workSheet.Cells[f, c].Value = "Fecha_Apertura"; c++;
                    workSheet.Cells[f, c].Value = "Prioridad"; c++;
                    workSheet.Cells[f, c].Value = "Titulo"; c++;
                    workSheet.Cells[f, c].Value = "E_S_Estado"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_SALESFORCE"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_ALTA_SAP"; c++;
                    workSheet.Cells[f, c].Value = "FH_BAJA_SALESFORCE"; c++;
                    PosicionBajaSap = c;
                    workSheet.Cells[f, c].Value = "FH_BAJA_SAP"; c++;
                    workSheet.Cells[f, c].Value = "EMPRESA"; c++;
                    workSheet.Cells[f, c].Value = "SEGMENTO"; c++;
                    workSheet.Cells[f, c].Value = "TIPO CLIENTE"; c++;
                    workSheet.Cells[f, c].Value = "NIF"; c++;
                    workSheet.Cells[f, c].Value = "FPSERCON"; c++;
                    workSheet.Cells[f, c].Value = "Nº INSTALACIÓN"; c++;
                    workSheet.Cells[f, c].Value = "TARIFA"; c++;
                    workSheet.Cells[f, c].Value = "CONTRATO"; c++;
                    workSheet.Cells[f, c].Value = "DISTRIBUIDORA"; c++;
                    workSheet.Cells[f, c].Value = "ESTADO"; c++;
                    PosicionSubEstadoSAP = c;
                    workSheet.Cells[f, c].Value = "SUBESTADO"; c++;
                    //////workSheet.Cells[f, c].Value = "DIAS_ESTADO"; c++;
                    workSheet.Cells[f, c].Value = "TAM"; c++;
                    workSheet.Cells[f, c].Value = "ULT FH DESDE FACTURADA"; c++;
                    workSheet.Cells[f, c].Value = "ULT FH HASTA FACTURADA"; c++;
                    workSheet.Cells[f, c].Value = "Estado periodo KEE"; c++;
                    workSheet.Cells[f, c].Value = "Área responsable KEE"; c++;
                    PosicionSubEstadoKEE = c;
                    workSheet.Cells[f, c].Value = "Subestado KEE"; c++;
                    workSheet.Cells[f, c].Value = "Estado KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_DESDE_KEE"; c++;
                    workSheet.Cells[f, c].Value = "FH_HASTA_KEE"; c++;
                    workSheet.Cells[f, c].Value = "Fecha BAJA KEE"; c++;
                    PosicionBajaKEE = c;
                    workSheet.Cells[f, c].Value = "Discrepancias"; c++;
                    PosicionSubEstadoGlobal = c;
                    workSheet.Cells[f, c].Value = "Subestado global"; c++;
                    workSheet.Cells[f, c].Value = "ESTADO GLOBAL"; c++;
                    workSheet.Cells[f, c].Value = "ESTADO GLOBAL A REPORTAR"; c++;
                    workSheet.Cells[f, c].Value = "AREA ESTADO"; c++;

                    //////workSheet.Cells[f, c].Value = "Nº DÍAS ESTADO KEE"; c++;
                    workSheet.Cells[f, c].Value = "Nº DÍAS PTE KEE"; c++;

                    strSql = DetalleExcel(fecha_informe, lista_empresas_PT, lista_segmentos_BTN);

                    db = new MySQLDB(MySQLDB.Esquemas.GBL);
                    command = new MySqlCommand(strSql, db.con);
                    r = command.ExecuteReader();
                    while (r.Read())
                    {
                        f++;
                        c = 1;

                        empresa = "";
                        nif = "";
                        cliente = "";
                        apellido = "";
                        FechaAlta = null;
                        FechaInicio = null;
                        Tarifa = "";
                        contrato = "";
                        Distribuidora = "";
                        cups20 = "";
                        NumeroDiasKEE = 0;
                        meses_pdtes = 0;

                        if (r["cups20"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = r["cups20"].ToString();
                            cups20= r["cups20"].ToString();
                        }
                        c++;

                        ///
                        workSheet.Cells[f, c].Value = "";c++;

                        if (r["mes"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToInt32(r["mes"]);
                            aniomes = Convert.ToInt32(r["mes"]);
                            fecha_registro = new DateTime(Convert.ToInt32(aniomes.ToString().Substring(0, 4)),
                                Convert.ToInt32(aniomes.ToString().Substring(4, 2)), 1);
                        }
                        c++;

                        if (r["fh_desde"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_desde"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["fh_hasta"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_hasta"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        c++;

                        if (r["mes"] != System.DBNull.Value && r["TAM"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["tam"]) * meses_pdtes;
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00"; c++;
                        }
                        else
                        {
                            c++;
                        }

                        if (r["mes"] != System.DBNull.Value)
                        {
                            //int meses_pdtes = mes_actual - Convert.ToInt32(r["mes"]);
                            meses_pdtes = ((fecha_actual.Year - fecha_registro.Year) * 12) + fecha_actual.Month - fecha_registro.Month;
                            workSheet.Cells[f, c].Value = meses_pdtes;
                            workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        }
                        c++;

                        if (meses_pdtes > 1)
                        {
                            workSheet.Cells[f, 2].Value = ">1P";
                        }
                        else
                        {
                            workSheet.Cells[f, 2].Value = "1P";
                        }

                        if (r["agora"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["agora"].ToString();

                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;


                        //Para controlar los blancos, miramos en t_ed_h_ps_hist
                        if (r["cd_empr"] != System.DBNull.Value)
                        {
                            Existetedhps = true;
                        }
                        else
                        {
                            Existetedhps = false;

                            strSql = "SELECT cd_empr,  cd_nif_cif_cli, de_tp_cli, tx_apell_cli, fh_alta_crto, fh_inicio_vers_crto"
                            + " ,ps.cd_tarifa_c, ps.cd_crto_comercial, ps.de_empr_distdora_nombre"
                            + " FROM cont.t_ed_h_ps_pt_hist ps"
                            + " WHERE cups20 = '" + r["cups20"].ToString() + "'"
                            + " AND created_date = (SELECT MAX(created_date) FROM cont.t_ed_h_ps_pt_hist"
                            + " WHERE cups20 = '" + r["cups20"].ToString() + "')";

                            dbAux = new MySQLDB(MySQLDB.Esquemas.GBL);
                            commandAux = new MySqlCommand(strSql, dbAux.con);
                            rAux = commandAux.ExecuteReader();
                            while (rAux.Read())
                            {
                                if (rAux["cd_empr"] != System.DBNull.Value)
                                    empresa = rAux["cd_empr"].ToString();
                                if (rAux["de_tp_cli"] != System.DBNull.Value)
                                    cliente = rAux["de_tp_cli"].ToString();
                                if (rAux["cd_nif_cif_cli"] != System.DBNull.Value)
                                    nif = rAux["cd_nif_cif_cli"].ToString();
                                if (rAux["tx_apell_cli"] != System.DBNull.Value)
                                    apellido = rAux["tx_apell_cli"].ToString();
                                if (rAux["fh_alta_crto"] != System.DBNull.Value)
                                    FechaAlta = Convert.ToDateTime(rAux["fh_alta_crto"]).Date;
                                if (rAux["fh_inicio_vers_crto"] != System.DBNull.Value)
                                    FechaInicio = Convert.ToDateTime(rAux["fh_inicio_vers_crto"]).Date;
                                if (rAux["cd_tarifa_c"] != System.DBNull.Value)
                                    Tarifa = rAux["cd_tarifa_c"].ToString();
                                if (rAux["cd_crto_comercial"] != System.DBNull.Value)
                                    contrato = rAux["cd_crto_comercial"].ToString();
                                if (rAux["de_empr_distdora_nombre"] != System.DBNull.Value)
                                    Distribuidora = rAux["de_empr_distdora_nombre"].ToString();
                            }
                            dbAux.CloseConnection();
                        }
                        //// Fin mirar en el historico

                        //////if (r["tx_apell_cli"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["tx_apell_cli"].ToString();
                        //////c++;
                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = apellido;
                        }
                        else
                        {
                            if (r["tx_apell_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["tx_apell_cli"].ToString();
                        }
                        c++;


                        //DIAS_ESTADO_SAP
                        workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());
                        workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        c++;

                        //DIAS_ESTADO_KEE
                        workSheet.Cells[f, c].Value = "";c++;

                        //DIAS_ESTADO_GLOBAL
                        workSheet.Cells[f, c].Value = ""; c++;

                        //Recuperar Incidencia Facturacion
                        listaIncidenciasSAP = RelacionIncidenciasSAP.GetCups(r["cups20"].ToString() + aniomes);

                        if (listaIncidenciasSAP.Count == 0)
                        {
                            IncidenciaFacturacion = "";
                            Estado_FAC_SE = "";
                            Titulo_FAC = "";
                        }
                        else
                        {
                            foreach (var mm in listaIncidenciasSAP)
                            {
                                string[] cadena = mm.Split(';');
                                IncidenciaFacturacion = cadena[0];
                                Estado_FAC_SE = cadena[1];
                                Titulo_FAC = cadena[2];
                                break;
                            }
                        }
                        //Fin recuperar incidencia facturacion

                        // Comprobamos con la tabla Relacion_INC_CUPS
                        ////// 1.Se relaciona el detalle del informe obtenido(campos cups20 y mes) con la tabla "Relacion_INC_CUPS"(campos cups y mes).Si para un cups se encuentra en esa relación una incidencia que afeca al mismo mes que está pendiente se deberá desechar el estado que tuviera el informe y actualizarlo por uno nuevo.
                        ////// 2.El estado a actualizar dependerá del campo "area" de la tabla "Relacion_INC_CUPS", pudiendo existir 3 opciones:
                        ////// --01.B09 Incidencia_Contratacion: se informará con este estado cuando encuentre para ese mes una incidencia en el area de contratacion, independientemente de que también haya otras para ese mismo mes en otras areas.
                        //////-- 01.B10 Incidencia_Medida: no estando en el caso anterior, se informará con este estado cuando encuentre para ese mes una incidencia en el area de medida, independientemente de que también haya otras para ese mismo mes en el area de facturacion.
                        ////// --01.B11 Incidencia_Facturacion: no estando en ninguno de los dos casos anteriores, se informará con este estado cuando encuentre para ese mes una incidencia en el area de Facturacion.
                        strSql = " select area, incidencia, estado_incidencia, fecha_apertura, prioridad_negocio, titulo, e_s_estado, Reincidente from Relacion_INC_CUPS"
                                 + " where cups='" + r["cups20"].ToString() + "' and Mes_pendiente='" + aniomes + "'"
                                 + " order by Fecha_apertura asc";

                        dbIncidencia = new MySQLDB(MySQLDB.Esquemas.MED);
                        command = new MySqlCommand(strSql, dbIncidencia.con);
                        inci = command.ExecuteReader();

                        areaincidencia = "";
                        incidencia = "";
                        estado_incidencia = "";
                        fecha_apertura = "";
                        prioridad_negocio = "";
                        titulo = "";
                        e_s_estado = "";
                        subestado_incidencia = "";
                        reincidente = "";
                        ExisteIncidencia = false;

                        while (inci.Read())
                        {
                            ExisteIncidencia = true;
                            if (areaincidencia == "")
                            {
                                areaincidencia = inci["area"].ToString();

                                if (areaincidencia == "Contratacion")
                                    subestado_incidencia = "01.B09 Incidencia_Contratacion";
                                if (areaincidencia == "Medida")
                                    subestado_incidencia = "01.B10 Incidencia_Medida";
                                if (areaincidencia == "Facturacion")
                                    subestado_incidencia = "01.B11 Incidencia_Facturacion";

                                incidencia = inci["incidencia"].ToString();
                                estado_incidencia = inci["estado_incidencia"].ToString();
                                fecha_apertura = inci["fecha_apertura"].ToString();
                                prioridad_negocio = inci["prioridad_negocio"].ToString();
                                titulo = inci["titulo"].ToString();
                                e_s_estado = inci["e_s_estado"].ToString();
                                reincidente = inci["Reincidente"].ToString();
                            }
                            else
                            {
                                if (areaincidencia != inci["area"].ToString())
                                {
                                    areaincidencia = inci["area"].ToString();

                                    if (areaincidencia == "Contratacion")
                                        subestado_incidencia = subestado_incidencia + " - 01.B09 Incidencia_Contratacion";
                                    if (areaincidencia == "Medida")
                                        subestado_incidencia = subestado_incidencia + " - 01.B10 Incidencia_Medida";
                                    if (areaincidencia == "Facturacion")
                                        subestado_incidencia = subestado_incidencia + " - 01.B11 Incidencia_Facturacion";

                                    incidencia = incidencia + " - " + inci["incidencia"].ToString();
                                    estado_incidencia = estado_incidencia + " - " + inci["estado_incidencia"].ToString();
                                    fecha_apertura = fecha_apertura + " - " + inci["fecha_apertura"].ToString();
                                    prioridad_negocio = prioridad_negocio + " - " + inci["prioridad_negocio"].ToString();
                                    titulo = titulo + " - " + inci["titulo"].ToString();
                                    e_s_estado = e_s_estado + " - " + inci["e_s_estado"].ToString();
                                }
                            }
                        } // Fin  while (inci.Read())

                        dbIncidencia.CloseConnection();
                        if (ExisteIncidencia == true)
                        {

                            workSheet.Cells[f, c].Value = IncidenciaFacturacion; c++;
                            //////workSheet.Cells[f, c].Value = subestado_incidencia; c++;

                            workSheet.Cells[f, c].Value = Estado_FAC_SE; c++;
                            workSheet.Cells[f, c].Value = Titulo_FAC; c++;
                            workSheet.Cells[f, c].Value = incidencia; c++;
                            workSheet.Cells[f, c].Value = "";c++;
                            workSheet.Cells[f, c].Value = estado_incidencia; c++;
                            workSheet.Cells[f, c].Value = fecha_apertura; c++;
                            workSheet.Cells[f, c].Value = prioridad_negocio; c++;
                            workSheet.Cells[f, c].Value = titulo; c++;
                            workSheet.Cells[f, c].Value = e_s_estado; c++;
                        }
                        else
                        {
                            workSheet.Cells[f, c].Value = IncidenciaFacturacion; c++;
                            workSheet.Cells[f, c].Value = Estado_FAC_SE; c++;
                            workSheet.Cells[f, c].Value = Titulo_FAC; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                         
                        }
                        ////////////////////////////////////////////////////////////////////////////////////////////////

                        ///FH_ALTA_SALESFORCE
                        //////workSheet.Cells[f, c].Value = ""; c++;

                        if (r["fh_alta_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        else
                        {

                        }
                        c++;
                        // FIN FH_ALTA_SALESFORCE

                        //FECHA_ALTA_KEE*****************************************************
                        listaAltaKEE = pendienteWeb_B2B.GetCupsFechaAltaKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));

                        if (listaAltaKEE.Count == 0)
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        else
                        {
                            if (listaAltaKEE[0] == "01/01/0001 0:00:00")
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {

                                foreach (var mm in listaAltaKEE)
                                {
                                    workSheet.Cells[f, c].Value = mm; c++;
                                    break;
                                }
                                //////workSheet.Cells[f, c].Value = lista; c++;
                            }
                        }

                        //FIN FH_ALTA_KEE*****************************************************

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(FechaAlta).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        else
                        {
                            if (r["fh_alta_crto"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_alta_crto"]).Date;
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            }
                        }
                        c++;



                        if (r["fh_baja_crto"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_baja_crto"]).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        }
                        else
                        {
                            ////////if (r["fh_prev_fin_crto"] != System.DBNull.Value)
                            ////////{
                            ////////    workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_prev_fin_crto"]).Date;
                            ////////    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                            ////////}
                        }
                        c++;

                        //Paco, buscamos la fecha de Baja de SAP ******************************************
                        CadenaAuxiliar = r["id_crto_ext"].ToString();
                        CadenaAuxiliar = CadenaAuxiliar.PadLeft(12, '0'); //Relleno con ceros a la izquierda hasta 12


                        fhBajaSap = FechaBajaSap.GetCupsFechaBajaSAP(CadenaAuxiliar);

                        if (fhBajaSap.Count == 0)
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        else
                        {
                            foreach (var mm in fhBajaSap)
                            {
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                workSheet.Cells[f, c].Value = mm; c++; 
                                break;
                            }
                        }

                        //////strSql = "SELECT  max(cd_sec_crto), fh_baja from ed_owner.t_ed_h_sap_crto_front "
                        //////+ " WHERE id_crto_ext = '" + CadenaAuxiliar + "'"
                        //////+ " group by  fh_baja"
                        //////+ " order by  max(cd_sec_crto) desc";

                        //////dbRS = new servidores.RedShiftServer(RedShiftServer.Entornos.PROD);
                        //////commandRS = new OdbcCommand(strSql, dbRS.con);
                        //////rRS = commandRS.ExecuteReader();
                        //////while (rRS.Read())
                        //////{
                        //////    if (rRS["fh_baja"] != System.DBNull.Value )
                        //////    {
                        //////        if (rRS["fh_baja"].ToString() != "01/01/1400 0:00:00")
                        //////        {
                        //////            workSheet.Cells[f, c].Value = Convert.ToDateTime(rRS["fh_baja"]).Date;
                        //////            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        //////        }
                        //////    }
                        //////    break;
                        //////}
                        //////dbRS.CloseConnection();
                        ///
                        //////c++;

                        //Fin - Fh_baja de SAP ***************************************************

                        //////if (r["cd_empr"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["cd_empr"].ToString();
                        //////c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = empresa;
                        }
                        else
                        {
                            if (r["cd_empr"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_empr"].ToString();
                        }
                        c++;

                        if (r["cd_segmento_ptg"] != System.DBNull.Value) //SEGMENTO
                            workSheet.Cells[f, c].Value = r["cd_segmento_ptg"].ToString();
                        c++;

                        //////if (r["de_tp_cli"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["de_tp_cli"].ToString();
                        //////c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = cliente;
                        }
                        else
                        {
                            if (r["de_tp_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["de_tp_cli"].ToString();
                        }
                        c++;

                        //////if (r["cd_nif_cif_cli"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["cd_nif_cif_cli"].ToString();
                        //////c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = nif;
                        }
                        else
                        {
                            if (r["cd_nif_cif_cli"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_nif_cif_cli"].ToString();
                        }
                        c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDateTime(FechaInicio).Date;
                            workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        }
                        else
                        {
                            if (r["fh_inicio_vers_crto"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["fh_inicio_vers_crto"]).Date;
                                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                            }
                        }
                        c++;

                        if (r["id_instalacion"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["id_instalacion"].ToString();
                        c++;
                        //////if (r["cd_tarifa_c"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["cd_tarifa_c"].ToString();
                        //////c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Tarifa;
                        }
                        else
                        {
                            if (r["cd_tarifa_c"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_tarifa_c"].ToString();
                        }
                        c++;

                        //////if (r["cd_crto_comercial"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["cd_crto_comercial"].ToString();
                        //////c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = contrato;
                        }
                        else
                        {
                            if (r["cd_crto_comercial"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["cd_crto_comercial"].ToString();
                        }
                        c++;

                        //////if (r["de_empr_distdora_nombre"] != System.DBNull.Value)
                        //////    workSheet.Cells[f, c].Value = r["de_empr_distdora_nombre"].ToString();
                        //////c++;

                        if (Existetedhps == false)
                        {
                            workSheet.Cells[f, c].Value = Distribuidora;
                        }
                        else
                        {
                            if (r["de_empr_distdora_nombre"] != System.DBNull.Value)
                                workSheet.Cells[f, c].Value = r["de_empr_distdora_nombre"].ToString();
                        }
                        c++;

                        if (r["de_estado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_estado"].ToString();
                        c++;
                        if (r["de_subestado"] != System.DBNull.Value)
                            workSheet.Cells[f, c].Value = r["de_subestado"].ToString();
                        c++;

                        //if (r["lg_multimedida"] != System.DBNull.Value)
                        //{
                        //    workSheet.Cells[f, c].Value = r["lg_multimedida"].ToString();

                        //}
                        //else
                        //{
                        //    workSheet.Cells[f, c].Value = "N";
                        //}

                        //////workSheet.Cells[f, c].Value = GetDiasEstado(r["cups20"].ToString());
                        //////workSheet.Cells[f, c].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        //////c++;

                        if (r["TAM"] != System.DBNull.Value)
                        {
                            workSheet.Cells[f, c].Value = Convert.ToDouble(r["TAM"]);
                            workSheet.Cells[f, c].Style.Numberformat.Format = "#,##0.00";
                        }
                        c++;

                        // Paco - añadimos la ultima fecha desde y hasta facturada t_ed_h_sap_facts
                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        List<string> listaInicio = new List<string>();
                        listaInicio = pendienteSAPKEE.GetCupsInicioUltimaFacturada(r["cups20"].ToString());
                        if (listaInicio != null)
                        {
                            if (listaInicio.Count == 0)
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaInicio[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaInicio)
                                    {
                                        workSheet.Cells[f, c].Value = mm; c++;
                                        break;
                                    }
                                    ////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }
                        }
                        else
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }

                        // Paco - añadimos la ultima fecha desde y hasta facturada t_ed_h_sap_facts
                        workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;

                        List<string> listaFin = new List<string>();
                        listaFin = pendienteSAPKEE.GetCupsFinalUltimaFacturada(r["cups20"].ToString());
                        if (listaFin != null)
                        {
                            if (listaFin.Count == 0)
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaFin[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaFin)
                                    {
                                        workSheet.Cells[f, c].Value = mm; c++;
                                        break;
                                    }
                                    ////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }
                        }
                        else
                        {
                            workSheet.Cells[f, c].Value = ""; c++;
                        }


                        subestadosKronosBTN.existe = false;

                        if (subestados_sap.AreaResponsableMedida(r["cd_subestado"].ToString()))
                        {
                            subestadosKronosBTN.existe = false;

                            //Paco -- He duplicado funciones para marcar los casos que no hay datos en kronos para la fecha GetEstadoKEEDetalle y GetCupsDetalle
                            //Faltaria controlar los casos en los que vienen segmentos, es decir, para el mes que se mira de Sap vienen dos segmentos
                            //en Kronos, habria que quedarse con el de fecha más antigua, he puesto codigo sin probar para este caso en GetCupsDetalle
                            //Lo que hago es crear a pelo un estado "Discrepancia: ..... " que es la etiqueta que pongo y que no está en la tabla parametrica estados_kee_param 
                            subestadosKronosBTN.GetEstadoKEEDetalleBTN(pendienteWeb_B2BBTN.GetCupsDetalle_BTN(r["cups20"].ToString(),
                                Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]), Convert.ToDateTime(r["fec_act"])));

                            //////if (subestadosKronos.multimedida == true)
                            //////{
                            //////    Debug.Print(r["cups20"].ToString());
                            //////}
                            
                            if (subestadosKronosBTN.existe)
                            {
                                BuscaCadena = subestadosKronosBTN.descripcion_estado;
                                List<string> lista = new List<string>();

                                if (BuscaCadena.IndexOf("Discrepancia") >= 0)
                                {
                                    if (BuscaCadena.IndexOf("No existe el cups en el informe del pendiente de KEE") >= 0)
                                    {
                                        //Paco 30/05/2024 Se trata de manera diferente a ES-MTBTE, son puntos migrados el pasado fin de semana que no tienen todavía medidas gestionadas 
                                        //directamente en KEE. Como las medidas migradas no se cargan en BI, no localizas lecturas. 
                                        NumeroDias = 0;
                                        NumeroDias = (DateTime.Now - Convert.ToDateTime(r["fh_desde"])).Days;

                                        //Controlo si la fecha desde -1 hasta el día de hoy supera los 90 días
                                        if (NumeroDias > 90)
                                        {
                                            workSheet.Cells[f, c].Value = "Pendiente KEE"; c++;
                                            workSheet.Cells[f, c].Value = "MEDIDA"; c++;
                                            workSheet.Cells[f, c].Value = "01.C25 Pendiente Sistemas KEE - Pte ejecución algoritmo"; c++;
                                            workSheet.Cells[f, c].Value = "Pendiente Sistemas KEE - Pte ejecución algoritmo"; c++;
                                        }
                                        else
                                        {
                                            workSheet.Cells[f, c].Value = "Pendiente KEE"; c++;
                                            workSheet.Cells[f, c].Value = "DISTRIBUIDORA"; c++;
                                            workSheet.Cells[f, c].Value = "01.C25 Pendiente Medida KEE - En ciclo de Medida"; c++;
                                            workSheet.Cells[f, c].Value = "Pendiente Medida KEE - En ciclo de Medida"; c++;
                                        }

                                        //Fin /Paco 30/05/2024

                                        //OLD
                                        //////workSheet.Cells[f, c].Value = ""; c++;
                                        //////workSheet.Cells[f, c].Value = ""; c++;
                                        //////workSheet.Cells[f, c].Value = "01.B07 Error Sistemas KEE-SAP - Pdte SAP-No existe en KEE"; c++;
                                        //////workSheet.Cells[f, c].Value = ""; c++;
                                        //FIN OLD

                                        workSheet.Cells[f, c].Value = ""; c++; //FH_DESDE_KEE
                                        workSheet.Cells[f, c].Value = ""; c++; //FH_HASTA_KEE
                                        workSheet.Cells[f, c].Value = ""; c++;
                                        workSheet.Cells[f, c].Value = subestadosKronosBTN.descripcion_estado; ; c++;

                                        //Subestado Global
                                        if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                        {
                                            workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                        }
                                        else
                                        {
                                            workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                        }
                                        //Fin Subestado Global


                                        //Paco 30/05/2024 
                                        if (NumeroDias > 90)
                                        {
                                            workSheet.Cells[f, c].Value = "02_INCIDENCIA_MEDIDA"; c++;
                                            workSheet.Cells[f, c].Value = "02_INCIDENCIA"; c++;
                                        }
                                        else
                                        {
                                            workSheet.Cells[f, c].Value = "01_DISTRIBUIDORA"; c++;
                                            workSheet.Cells[f, c].Value = "01_DISTRIBUIDORA"; c++;
                                        }
                                        //Fin Paco 30/05/2024 

                                        //////workSheet.Cells[f, c].Value = ""; c++;
                                        //////workSheet.Cells[f, c].Value = ""; c++;
                                        ///

                                        //AREA
                                        workSheet.Cells[f, c].Value = ""; c++;
                                        //•	Nº DÍAS ESTADO KEE y •	Nº DÍAS PTE KEE
                                        workSheet.Cells[f, PosicionDiasEstadoKEE].Value = ""; 
                                        workSheet.Cells[f, c].Value = ""; c++;
                                    }
                                    else
                                    {
                                        ///Discrepancia: No existen fechas en el informe pendiente de KEE para el periodo
                                        if (BuscaCadena.IndexOf("No existen fechas en el informe pendiente de KEE para el periodo") >= 0)
                                        {
                                            NumeroDias = 0;

                                            string[] cadena = subestadosKronosBTN.descripcion_estado.Split(';');
                                            string[] cadenaAux = cadena[1].Split('/');

                                            //////802 Facturada DISTRIBUIDORA       Pendiente KEE   01.C25  Pendiente Medida KEE - En ciclo de Medida           01_DISTRIBUIDORA      01_DISTRIBUIDORA
                                            //////802 Facturada MEDIDA              Pendiente KEE   01.C25  Pendiente Sistemas KEE - Pte ejecución algoritmo    02_INCIDENCIA_MEDIDA  02_INCIDENCIA

                                            fecha_calculada = Convert.ToDateTime( cadenaAux[0].Substring(1, 8).Substring(6, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(4, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(0, 4));
                                            fecha_calculada = fecha_calculada.AddDays(-1);
                                            NumeroDias =(DateTime.Now - fecha_calculada).Days;

                                            //Controlo si la fecha desde -1 hasta el día de hoy supera los 90 días
                                            if (NumeroDias > 90)
                                            {
                                                workSheet.Cells[f, c].Value = "Pendiente KEE"; c++;
                                                workSheet.Cells[f, c].Value = "MEDIDA"; c++;
                                                workSheet.Cells[f, c].Value = "01.C25 Pendiente Sistemas KEE - Pte ejecución algoritmo"; c++;
                                                workSheet.Cells[f, c].Value = "Pendiente Sistemas KEE - Pte ejecución algoritmo"; c++;
                                            }
                                            else
                                            {
                                                workSheet.Cells[f, c].Value = "Pendiente KEE"; c++;
                                                workSheet.Cells[f, c].Value = "DISTRIBUIDORA"; c++;
                                                workSheet.Cells[f, c].Value = "01.C25 Pendiente Medida KEE - En ciclo de Medida"; c++;
                                                workSheet.Cells[f, c].Value = "Pendiente Medida KEE - En ciclo de Medida"; c++;
                                            }

                                            workSheet.Cells[f, c].Value = ""; c++; //FH_DESDE_KEE
                                            workSheet.Cells[f, c].Value = ""; c++; //FH_HASTA_KEE
                                            workSheet.Cells[f, c].Value = ""; c++;
                                            workSheet.Cells[f, c].Value = "Nº días en ciclo de medida: " + NumeroDias.ToString (); c++;

                                            //Subestado Global
                                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                            {
                                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                            }
                                            else
                                            {
                                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                            }
                                            //Fin Subestado Global

                                            if (NumeroDias > 90)
                                            {
                                                workSheet.Cells[f, c].Value = "02_INCIDENCIA_MEDIDA"; c++;
                                                workSheet.Cells[f, c].Value = "02_INCIDENCIA"; c++;
                                            }
                                            else
                                            {
                                                workSheet.Cells[f, c].Value = "01_DISTRIBUIDORA"; c++;
                                                workSheet.Cells[f, c].Value = "01_DISTRIBUIDORA"; c++;
                                            }

                                            //AREA
                                            workSheet.Cells[f, c].Value = ""; c++;
                                            //•	Nº DÍAS ESTADO KEE y •	Nº DÍAS PTE KEE
                                            workSheet.Cells[f, PosicionDiasEstadoKEE].Value = ""; 
                                            workSheet.Cells[f, c].Value = ""; c++;

                                        }
                                        else
                                        {
                                            workSheet.Cells[f, c].Value = ""; c++;
                                            workSheet.Cells[f, c].Value = ""; c++;
                                            workSheet.Cells[f, c].Value = ""; c++;
                                            workSheet.Cells[f, c].Value = ""; c++;

                                            //////string[] cadena = subestadosKronosBTN.descripcion_estado.Split(';');
                                            //////string[] cadenaAux = cadena[1].Split('/');
                                            //////workSheet.Cells[f, c].Value = cadenaAux[0].Substring(1, 8).Substring(6, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(4, 2) + "/" + cadenaAux[0].Substring(1, 8).Substring(0, 4); c++;
                                            //////workSheet.Cells[f, c].Value = cadenaAux[1].Substring(0, 8).Substring(6, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(4, 2) + "/" + cadenaAux[1].Substring(0, 8).Substring(0, 4); c++;

                                            workSheet.Cells[f, c].Value = ""; c++;
                                            workSheet.Cells[f, c].Value = ""; c++;

                                            ///lista = pendienteWeb_B2B.GetCupsFinKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]));
                                            lista = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));

                                            if (lista.Count == 0)
                                            {
                                                workSheet.Cells[f, c].Value = ""; c++;
                                            }
                                            else
                                            {
                                                if (lista[0] == "01/01/0001 0:00:00")
                                                {
                                                    workSheet.Cells[f, c].Value = ""; c++;
                                                }
                                                else
                                                {

                                                    foreach (var mm in lista)
                                                    {
                                                        //Lo quito hasta que diga Adriana
                                                        workSheet.Cells[f, c].Value = mm;
                                                        c++;
                                                        break;
                                                    }
                                                    //////workSheet.Cells[f, c].Value = lista; c++;
                                                }
                                            }
                                            //Lo quito hasta que diga Adriana, es la discrepancia
                                            workSheet.Cells[f, c].Value = subestadosKronosBTN.descripcion_estado;
                                            c++;

                                            //Subestado Global
                                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                            {
                                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                            }
                                            else
                                            {
                                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                            }

                                            workSheet.Cells[f, c].Value = ""; c++;
                                            workSheet.Cells[f, c].Value = ""; c++;
                                            workSheet.Cells[f, c].Value = ""; c++;
                                            //•	Nº DÍAS ESTADO KEE y •	Nº DÍAS PTE KEE
                                            workSheet.Cells[f, PosicionDiasEstadoKEE].Value = ""; 
                                            workSheet.Cells[f, c].Value = ""; c++;
                                        }
                                    }
                                }
                                else
                                {
                                    //Lo quito hasta que diga Adriana
                                    workSheet.Cells[f, c].Value = subestadosKronosBTN.estado_periodo; c++;

                                    ////////Control del algoritmo para el estado 802
                                    //////if (subestadosKronosBTN.cod_estado == "802")
                                    //////{
                                    //////    if ((DateTime.Now - subestadosKronosBTN.fh_hasta).Days > 90)
                                    //////    {
                                    //////        workSheet.Cells[f, c].Value = "MEDIDA"; c++;
                                    //////        workSheet.Cells[f, c].Value = "01.C25 Pendiente Sistemas KEE - Pte ejecución algoritmo"; c++;
                                    //////    }
                                    //////    else
                                    //////    {
                                    //////        workSheet.Cells[f, c].Value = subestadosKronosBTN.area_responsable; c++;
                                    //////        workSheet.Cells[f, c].Value = subestadosKronosBTN.descripcion_subestado; c++;
                                    //////    }
                                    //////}
                                    //////else
                                    //////{
                                        workSheet.Cells[f, c].Value = subestadosKronosBTN.area_responsable; c++;
                                        workSheet.Cells[f, c].Value = subestadosKronosBTN.descripcion_subestado; c++;
                                    //////}

                                    workSheet.Cells[f, c].Value = subestadosKronosBTN.descripcion_estado; c++;
                              
                                    // fecha_desde_kee y fecha_hasta_kee
                                    workSheet.Cells[f, c].Value = subestadosKronosBTN.fh_desde;
                                    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                    c++;
                                    workSheet.Cells[f, c].Value = subestadosKronosBTN.fh_hasta;
                                    workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                                    c++;
                                    //////lista = pendienteWeb_B2B.GetCupsFinKEE(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]), Convert.ToDateTime(r["fh_hasta"]));
                                    lista = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));

                                    if (lista.Count == 0)
                                    {
                                        workSheet.Cells[f, c].Value = ""; c++;
                                    }
                                    else
                                    {
                                        if (lista[0] == "01/01/0001 0:00:00")
                                        {
                                            workSheet.Cells[f, c].Value = ""; c++;
                                        }
                                        else
                                        {

                                            foreach (var mm in lista)
                                            {
                                                workSheet.Cells[f, c].Value = mm; c++;
                                                break;
                                            }
                                            //////workSheet.Cells[f, c].Value = lista; c++;
                                        }
                                    }

                                    workSheet.Cells[f, c].Value = ""; c++;

                                    //Subestado Global
                                    if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                                    }
                                    else
                                    {
                                        workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                                    }

                                    ////////Control del algoritmo para el estado 802
                                    //////if (subestadosKronosBTN.cod_estado == "802")
                                    //////{
                                    //////    if ((DateTime.Now - subestadosKronosBTN.fh_hasta).Days > 90) {
                                    //////        workSheet.Cells[f, c].Value = "02_INCIDENCIA_MEDIDA"; c++;
                                    //////        workSheet.Cells[f, c].Value = "02_INCIDENCIA"; c++;
                                    //////    }
                                    //////    else {
                                    //////        workSheet.Cells[f, c].Value = subestadosKronosBTN.ESTADO_GLOBAL; c++;
                                    //////        workSheet.Cells[f, c].Value = subestadosKronosBTN.ESTADO_GLOBAL_A_REPORTAR; c++;
                                    //////    }
                                    //////}
                                    //////else
                                    //////{
                                        workSheet.Cells[f, c].Value = subestadosKronosBTN.ESTADO_GLOBAL; c++;
                                        workSheet.Cells[f, c].Value = subestadosKronosBTN.ESTADO_GLOBAL_A_REPORTAR; c++;
                                    //'AREA'
                                        workSheet.Cells[f, c].Value = ""; c++;
                                    //////}

                                    //////workSheet.Cells[f, c].Value= subestadosKronosBTN.ESTADO_GLOBAL; c++;
                                    //////workSheet.Cells[f, c].Value = subestadosKronosBTN.ESTADO_GLOBAL_A_REPORTAR; c++;


                                    //•	Nº DÍAS ESTADO KEE y •	Nº DÍAS PTE KEE
                                    if (subestadosKronosBTN.fecha_modificacion.ToString() == "01/01/0001 0:00:00") {
                                        workSheet.Cells[f, PosicionDiasEstadoKEE].Value = 1; 
                                        NumeroDiasKEE = 1;
                                    }
                                    else {
                                        workSheet.Cells[f, PosicionDiasEstadoKEE].Value = (DateTime.Now - subestadosKronosBTN.fecha_modificacion).Days; 
                                        NumeroDiasKEE = (DateTime.Now - subestadosKronosBTN.fecha_modificacion).Days;
                                    }
                                    workSheet.Cells[f, c].Value = (DateTime.Now - subestadosKronosBTN.fh_hasta).Days; c++;
                                }
                            }   // Fin If existe
                        }

                        else
                        {
                            //Para que llegue hasta la última columna aunque no exista en Kronos
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            //////workSheet.Cells[f, c].Value = ""; c++;
                            ///
                            List<string> listaAux = new List<string>();
                            listaAux = pendienteWeb_B2B.GetCupsFinKEENew(r["cups20"].ToString(), Convert.ToDateTime(r["fec_act"]));

                            if (listaAux.Count == 0)
                            {
                                workSheet.Cells[f, c].Value = ""; c++;
                            }
                            else
                            {
                                if (listaAux[0] == "01/01/0001 0:00:00")
                                {
                                    workSheet.Cells[f, c].Value = ""; c++;
                                }
                                else
                                {

                                    foreach (var mm in listaAux)
                                    {
                                        //Lo quito hasta que diga Adriana
                                        workSheet.Cells[f, c].Value = mm;
                                        c++;
                                        break;
                                    }
                                    //////workSheet.Cells[f, c].Value = lista; c++;
                                }
                            }

                            //Este es la discrepancia
                            workSheet.Cells[f, c].Value = ""; c++;

                            //Subestado Global
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoKEE].Value; c++;
                            }
                            else
                            {
                                workSheet.Cells[f, c].Value = workSheet.Cells[f, PosicionSubEstadoSAP].Value; c++;
                            }
                            //ESTADO GLOBAL Y ESTADO GLOBAL A REPORTAR
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            workSheet.Cells[f, c].Value = ""; c++;
                            //•	Nº DÍAS ESTADO KEE y •	Nº DÍAS PTE KEE
                            workSheet.Cells[f, PosicionDiasEstadoKEE].Value = ""; 
                            workSheet.Cells[f, c].Value = ""; c++;
                        }
                        System.Diagnostics.Debug.WriteLine(r["cups20"].ToString() + "-" + r["de_subestado"].ToString() + "-" + subestadosKronos.descripcion_subestado + "-" + subestadosKronos.descripcion_estado);

                        //Paco 09/05/2024 **************************************************************************************
                        //Si se ha encontrado una  incidencia en Relacion_INC_CUPS (Tiene un AREA MARCADA) --> Si la incidencia tiene la misma AREA que la que aparece en la tabla ESTADOS_KEE_PARAM (subestadosKronos.area_responsable)
                        // areaincidencia=  subestadosKronos.area_responsable
                        // EN BTN SITENGO INCIDENCIA actualizo EL ESTADO GLOBAL Y EL ESTADO GLOBAL A REPORTAR , PERO NO CAMBIO SUBESTADOGLOBal

                        ExisteIncidenciaBTN = false;
                        if (areaincidencia != "" & subestadosKronosBTN.existe==true)
                        {
                            Auxiliar = Reincidente(areaincidencia, subestadosKronosBTN.area_responsable);
                            if (Auxiliar != "")
                            {
                                if (Auxiliar == "01.B09 Incidencia_Contratacion") {
                                    workSheet.Cells[f, PosicionSubEstadoGlobal + 1].Value = "02_INCIDENCIA_CONTRATACION";
                                    workSheet.Cells[f, PosicionSubEstadoGlobal + 2].Value = "02_INCIDENCIA";
                                    workSheet.Cells[f, PosicionReincidente].Value = reincidente;
                                    ExisteIncidenciaBTN = true;
                                }
                                if (Auxiliar == "01.B10 Incidencia_Medida") {
                                    workSheet.Cells[f, PosicionSubEstadoGlobal + 1].Value = "02_INCIDENCIA_MEDIDA";
                                    workSheet.Cells[f, PosicionSubEstadoGlobal + 2].Value = "02_INCIDENCIA";
                                    workSheet.Cells[f, PosicionReincidente].Value = reincidente;
                                    ExisteIncidenciaBTN = true;
                                }
                                if (Auxiliar == "01.B11 Incidencia_Facturacion") {
                                    workSheet.Cells[f, PosicionSubEstadoGlobal + 1].Value = "02_INCIDENCIA_FACTURACION";
                                    workSheet.Cells[f, PosicionSubEstadoGlobal + 2].Value = "02_INCIDENCIA";
                                    workSheet.Cells[f, PosicionReincidente].Value = reincidente;
                                    ExisteIncidenciaBTN = true;
                                }
                            }
                        }

                        //Calculo DIAS ESTADO GLOBAL *************************
                        if (blnLanzarDiasKEE == true) // Sólo se actualizan los datos en la tabla la primera vez, por si hay ejecuciones sucesivas
                        {
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEEGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoKEE].Value.ToString());
                            }
                            else
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEEGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoSAP].Value.ToString());
                            }
                        }
                        else
                        {
                            if (workSheet.Cells[f, PosicionSubEstadoKEE].Value != "")
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEERecuperarDiasTablaGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoKEE].Value.ToString());
                            }
                            else
                            {
                                DiasExistenciaKEEGlobal = FuncionDiasKEERecuperarDiasTablaGlobal(r["cups20"].ToString(), Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd"), Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd"), workSheet.Cells[f, PosicionSubEstadoSAP].Value.ToString());
                            }
                        }
                        //FIN DIAS ESTADO GLOBAL*******************************


                        // Pego Nº DIAS ESTADO GLOBAL, va a continuación de DIAS ESTADO KEE
                        workSheet.Cells[f, PosicionDiasEstadoKEE + 1].Value = DiasExistenciaKEEGlobal; 

                        //////if (ExisteIncidenciaBTN == true)
                        //////{
                        //////    //No miro el area, ya tengo asignados los estados
                        //////    Auxiliar = "";

                        //////}
                        //////else
                        //////{

                            Auxiliar = "";
                            Auxiliar = EstadosAreas(workSheet.Cells[f, PosicionSubEstadoGlobal].Value.ToString(), cups20, aniomes.ToString(), 3, NumeroDiasKEE, ExisteIncidenciaBTN);

                            if (Auxiliar != "")
                            {
                                string[] CadenaEstados = Auxiliar.Split(';');
                                workSheet.Cells[f, PosicionSubEstadoGlobal + 1].Value = CadenaEstados[0];
                                workSheet.Cells[f, PosicionSubEstadoGlobal + 2].Value = CadenaEstados[1];
                                workSheet.Cells[f, PosicionSubEstadoGlobal + 3].Value = CadenaEstados[2];
                            }
                            else
                            {
                                workSheet.Cells[f, PosicionSubEstadoGlobal + 1].Value = ""; c++;
                                workSheet.Cells[f, PosicionSubEstadoGlobal + 2].Value = ""; c++;
                                workSheet.Cells[f, PosicionSubEstadoGlobal + 3].Value = ""; c++;

                                if (SubestadosNoEncontrados == "")
                                {
                                    SubestadosNoEncontrados = "Hoja BTN: " + cups20 + " - " + Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd") + " - " + Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd") + " - " + r["de_estado"].ToString() + " -" + r["de_subestado"].ToString() + "- No existe el subestado en la tabla paramétrica";

                                }
                                else
                                {
                                    SubestadosNoEncontrados = SubestadosNoEncontrados + ";Hoja BTN: " + cups20 + " - " + Convert.ToDateTime(r["fh_desde"]).Date.ToString("yyyy-MM-dd") + " - " + Convert.ToDateTime(r["fh_hasta"]).Date.ToString("yyyy-MM-dd") + " - " + r["de_estado"].ToString() + " -" + r["de_subestado"].ToString() + "- No existe el subestado en la tabla paramétrica";
                                }
                            }
                        //////}
     
                    }
                    db.CloseConnection();

                    intConteoBTNDetalle = f-1;

                    headerCells = workSheet.Cells[1, 1, 1, c];
                    headerFont = headerCells.Style.Font;
                    headerFont.Bold = true;

                    //08/02/2024 Paco, mover columna de fecha baja de Kronos antes de fecha de baja de SAP
                    workSheet.InsertColumn(PosicionBajaSap, 1); //Inserta en la posicion 12 una columna en blanco(detrás de FH_BAJA_SAP)
                    workSheet.Cells[1, PosicionBajaKEE, f, PosicionBajaKEE].Copy(workSheet.Cells[1, PosicionBajaSap, f, PosicionBajaSap]); //Copia la columna 31 (Fecha BAJA KEE) en la posición creada anteriormente
                    workSheet.DeleteColumn(PosicionBajaKEE); //Borra la columna 31 Fecha BAJA KEE

                    //Pegamos Subestadoglobal, estado_global y estado global a reportar despues de FH_HASTA *** (!!!OJO, he metido ya por medio FECHA BAJA KEE (Sumo una más)!!)****
                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal, 1); //Inserta en la posicion 5 una columna en blanco(detrás de FH_HASTA)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 1, f, PosicionSubEstadoGlobal + 1].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal, f, PosicionPegarSubEstadoGlobal]);

                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal + 1, 1); //inserto en posición 6 (ya he pegado subestadoglobal)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 3, f, PosicionSubEstadoGlobal + 3].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal + 1, f, PosicionPegarSubEstadoGlobal + 1]);

                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal + 2, 1); //inserto en posición 7 (ya he pegado subestadoglobal)
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 5, f, PosicionSubEstadoGlobal + 5].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal + 2, f, PosicionPegarSubEstadoGlobal + 2]);

                    ///borro las originales (tres a la derecha, he insertado tres columnas)
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 3);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 3);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 3);

                    //La columna area la pongo detrás de fh_hasta
                    workSheet.InsertColumn(PosicionPegarSubEstadoGlobal, 1);
                    // Ya he quitado lo que originalmente estaba detras de posiciónSubEstado Global, sólo queda el area en esa poscion
                    workSheet.Cells[1, PosicionSubEstadoGlobal + 4, f, PosicionSubEstadoGlobal + 4].Copy(workSheet.Cells[1, PosicionPegarSubEstadoGlobal, f, PosicionPegarSubEstadoGlobal]);
                    workSheet.DeleteColumn(PosicionSubEstadoGlobal + 4);


                    // He quitado  lo que hay entre discrepancias y multipuntos, las posiciones me valen, ahora he metido los globales por delante
                    //////workSheet.InsertColumn(PosicionBajaKEE + 3, 1);
                    //////workSheet.Cells[1, PosicionSubEstadoGlobal + 4, f, PosicionSubEstadoGlobal + 4].Copy(workSheet.Cells[1, PosicionBajaKEE + 3, f, PosicionBajaKEE + 3]); //Copia la columna 31 (Fecha BAJA KEE) en la posición creada anteriormente
                    //////workSheet.DeleteColumn(PosicionSubEstadoGlobal + 4);

                    //workSheet.Cells[1, 5, 100, 5].Copy(workSheet.Cells[1, 2, 100, 2]);
                    //Copia la columna 5 en la columna 2 Básicamente Source.Copy(Destino) Esto solo copiaría las primeras 100 filas.


                    ////////El final es discrepancias seguido de multipuntos, los tengo que cambiar de orden --> discrepancia=48 y multipunto=49 después de las inserciones de columna
                    ////////no lo puedo hacer durante el proceso y poner multipuntos antes, ya que las discrepancias es un proceso aparte y separado
                    ////////Busco donde ha quedado discrepancias
                    //////intColumna = 1;
                    //////while (workSheet.Cells[1, intColumna].Value != "" & workSheet.Cells[1, intColumna].Value != "Discrepancias")
                    //////{
                    //////    intColumna = intColumna + 1;
                    //////}
                    //////workSheet.InsertColumn(intColumna, 1); //Inserta  columna en blanco delante de discrepancias
                    //////workSheet.Cells[1, intColumna + 2, f, intColumna + 2].Copy(workSheet.Cells[1, intColumna, f, intColumna]); //copio multipunto en la columna que he insertado
                    //////workSheet.DeleteColumn(intColumna + 2); //Borra la columna original de multipunto

                    ///////
                    allCells = workSheet.Cells[1, 1, f, c];
                    allCells.AutoFitColumns();
                    #endregion

                    //Muevo hoja cuatro después de la hoja uno
                    excelPackage.Workbook.Worksheets.MoveAfter(excelPackage.Workbook.Worksheets[3].Name, excelPackage.Workbook.Worksheets[0].Name);
                    //Muevo hoja cinco después de la hoja tres
                    excelPackage.Workbook.Worksheets.MoveAfter(excelPackage.Workbook.Worksheets[4].Name, excelPackage.Workbook.Worksheets[2].Name);

                    if (blnLanzarDiasKEE == true)  //Cierro kee_Dias_Global
                    {
                        ///todos los que están activos y  no se ha marcado PROCESADO_DIARIO = 'S', son puntos que se cierran, actualizo la FH_CIERRE
                        strSql = "update kee_Dias_Global  set"
                                   + " FH_CIERRE = '" + DateTime.Now.ToString("yyyy-MM-dd") + "',"
                                   + " FH_ACTUALIZACION = '" + DateTime.Now.ToString("yyyy-MM-dd") + "',"
                                   + " ACTIVO= False"
                                   + " WHERE  Activo = true"
                                   + " AND FH_ACTUALIZACION < '" + DateTime.Now.ToString("yyyy-MM-dd") + "'";

                        db = new MySQLDB(MySQLDB.Esquemas.MED);
                        command = new MySqlCommand(strSql, db.con);
                        command.ExecuteNonQuery();
                        db.CloseConnection();
                    }

                    //Paco 12/02/2024  Guardamos la hoja de "DETALLE ES" y la hoja "Detalle POR MT-BTE"  en una tabla de MySql
                    //Creamos dos nuevas hojas donde mostramos este histórico "RESUMEN ES" y "RESUMEN POR MT-BTE" 
                    int ContadorReplace;
                    StringBuilder sb = new StringBuilder();
                    int intFila = 1;
                    //////int intColumna = 1;
                    string Fecha;
                    int Resumen;
                    string NombreHojaResumen;
                    string nombreColumna;
                    int CuentaColumna;
                    NombreHojaResumen = "";

                    for (Resumen = 1; Resumen < 4; Resumen++){

                        intFila = 1;
                        intColumna = 1;

                        if (Resumen == 1) {
                            NombreHojaResumen = "Detalle ES";
                        }
                        if (Resumen == 2)
                        {
                            NombreHojaResumen = "Detalle POR MT-BTE";
                        }
                        if (Resumen == 3)
                        {
                            NombreHojaResumen = "Detalle POR BTN";
                        }
                       
                        var hojaActual = excelPackage.Workbook.Worksheets[NombreHojaResumen];
                        while (hojaActual.Cells[1, intColumna].Value != "" & hojaActual.Cells[1, intColumna].Value != null)
                        {
                            intColumna = intColumna + 1;
                        }
                        intColumna = intColumna - 1;
                        //31
                        while (hojaActual.Cells[intFila, 1].Value != "" & hojaActual.Cells[intFila, 1].Value != null & hojaActual.Cells[intFila, 2].Value != "" & hojaActual.Cells[intFila, 2].Value != null)
                        {
                            intFila = intFila + 1;
                        }
                        intFila = intFila - 1;

                        //OJO!! Esto funciona para columna con más de una letra
                        if (hojaActual.Cells[1, intColumna].Address.Length > 2 )
                            nombreColumna = hojaActual.Cells[1, intColumna].Address.Substring(0, 2);
                        else
                            nombreColumna = hojaActual.Cells[1, intColumna].Address.Substring(0, 1);

                        //////if (Resumen == 1)
                        //////{
                        //////    nombreColumna = String.Concat("A2:AQ", intFila.ToString());
                        //////}
                        //////else {
                        //////    if (Resumen == 2)
                        //////        nombreColumna = String.Concat("A2:AR", intFila.ToString());
                        //////    else
                        //////        nombreColumna = String.Concat("A2:AF", intFila.ToString());
                        //////}
                        nombreColumna = String.Concat("A2:" , nombreColumna, intFila.ToString());
                        var rango= hojaActual.Cells[nombreColumna];

                        ContadorReplace = 0;
                        for (
                            int i = 2; i <= intFila; i++)
                        {
                            CuentaColumna = 1;
                            if (ContadorReplace == 0)
                            {

                                if (Resumen == 1 || Resumen == 2)
                                {
                                    if (Resumen == 1)
                                    {
                                        sb.Append("REPLACE INTO sap_KEE_Resumen_ES_POR_MT_BTE_New( CUPS20,PERIODO, mes,FH_DESDE,FH_HASTA, AREA_ESTADO, Subestado_global, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR,IMPORTE_PDTE_FACTURAR,MESES_PDTES_FACTURAR,Agora,cliente, DIAS_ESTADO_SAP, DIAS_ESTADO_KEE, DIAS_ESTADO_GLOBAL, Incidencia_Facturacion, Estado_FAC_SE, Titulo_FAC, Incidencia_Medida, Reincidente, Estado_incidencia, Fecha_Apertura, Prioridad, Titulo, E_S_Estado,FH_ALTA_SALESFORCE, Fecha_Alta_KEE, FH_ALTA_SAP, FH_BAJA_SALESFORCE,Fecha_BAJA_KEE,FH_BAJA_SAP"
                                         + ",Empresa, tipo_cliente,nif,FPSERCON,N_INSTALACION,tarifa,contrato,Distribuidora,Estado,Subestado,Tam,ULT_FH_DESDE_FACTURADA, ULT_FH_HASTA_FACTURADA,Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,FH_DESDE_KEE,FH_HASTA_KEE,Multipunto,Discrepancia, FH_CARGA) values ('");
                                    }

                                    else
                                    {
                                        sb.Append("REPLACE INTO sap_KEE_Resumen_ES_POR_MT_BTE_New( CUPS20,PERIODO, mes,FH_DESDE,FH_HASTA, AREA_ESTADO, Subestado_global, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR,IMPORTE_PDTE_FACTURAR,MESES_PDTES_FACTURAR,Agora,cliente, DIAS_ESTADO_SAP, DIAS_ESTADO_KEE, DIAS_ESTADO_GLOBAL, Incidencia_Facturacion, Estado_FAC_SE, Titulo_FAC,Incidencia_Medida, Reincidente, Estado_incidencia, Fecha_Apertura, Prioridad, Titulo, E_S_Estado,FH_ALTA_SALESFORCE,Fecha_Alta_KEE,FH_ALTA_SAP, FH_BAJA_SALESFORCE,Fecha_BAJA_KEE,FH_BAJA_SAP"
                                        + ",Empresa,segmento, tipo_cliente,nif,FPSERCON,N_INSTALACION,tarifa,contrato,Distribuidora,Estado,Subestado,Tam,ULT_FH_DESDE_FACTURADA, ULT_FH_HASTA_FACTURADA,Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,FH_DESDE_KEE,FH_HASTA_KEE,Multipunto, Discrepancia,FH_CARGA) values ('");
                                    }
                                }
                                else {
                                  //////  sb.Append("REPLACE INTO sap_KEE_Resumen_ES_POR_MT_BTE(Empresa,segmento, tipo_cliente,nif,cliente,FALTACONT,FPSERCON,CUPS20,FH_DESDE,FH_HASTA,FH_BAJA_SALESFORCE,FH_BAJA_SAP,Fecha_BAJA_KEE,"
                                  //////+ " N_INSTALACION,tarifa,contrato,mes,Distribuidora,Estado,Subestado,DIAS_ESTADO,Tam,MESES_PDTES_FACTURAR,ULT_FH_DESDE_FACTURADA,"
                                  //////+ " ULT_FH_HASTA_FACTURADA,IMPORTE_PDTE_FACTURAR,Agora,Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,FH_DESDE_KEE,FH_HASTA_KEE,Discrepancia, Subestado_global, Incidencia, Estado_incidencia, Fecha_Apertura, Prioridad, Titulo, E_S_Estado, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR, Multipunto,FH_CARGA) values ('");

                                    sb.Append("REPLACE INTO sap_KEE_Resumen_ES_POR_MT_BTE_New( CUPS20,PERIODO, mes,FH_DESDE,FH_HASTA, AREA_ESTADO,Subestado_global, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR,IMPORTE_PDTE_FACTURAR,MESES_PDTES_FACTURAR,Agora,cliente, DIAS_ESTADO_SAP, DIAS_ESTADO_KEE, DIAS_ESTADO_GLOBAL, Incidencia_Facturacion, Estado_FAC_SE, Titulo_FAC,Incidencia_Medida, Reincidente, Estado_incidencia, Fecha_Apertura, Prioridad, Titulo, E_S_Estado,FH_ALTA_SALESFORCE,Fecha_Alta_KEE,FH_ALTA_SAP, FH_BAJA_SALESFORCE,Fecha_BAJA_KEE,FH_BAJA_SAP"
                                  + ",Empresa,segmento, tipo_cliente,nif,FPSERCON,N_INSTALACION,tarifa,contrato,Distribuidora,Estado,Subestado,Tam,ULT_FH_DESDE_FACTURADA, ULT_FH_HASTA_FACTURADA,Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,FH_DESDE_KEE,FH_HASTA_KEE, Discrepancia, NDIAS_PTE_KEE,FH_CARGA) values ('");
                                }

                                //////if (Resumen == 1 || Resumen == 2)
                                //////{
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //CUPS20
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //PERIODO
                                    sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //MES
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_DESDE
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_HASTA
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                    else
                                        sb.Append("null,'");
                                    CuentaColumna++;
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //AREA_ESTADO
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Subestado global
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //ESTADO GLOBAL
                                    sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //ESTADO GLOBAL A REPORTAR
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //IMPORTE PDTE FACTURAR
                                        sb.Append(Convert.ToString(rango[i, CuentaColumna].Value).Replace(",", ".")).Append(",");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;
                                    sb.Append(rango[i, CuentaColumna].Value).Append(",'"); CuentaColumna++; //MESES PDTES FACTURAR
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //AGORA
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //CLIENTE

                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //DIAS_ESTADO_SAP
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //DIAS_ESTADO_KEE
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //DIAS_ESTADO_GLOBAL
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Incidencia_Facturacion
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Estado_FAC_SE
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Titulo_FAC
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Incidencia_Medida
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Reincidente
                                    sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //Estado Incidencia
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_APERTURA
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                    else
                                        sb.Append("null,'");
                                    CuentaColumna++;

                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Prioridad
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Titulo
                                    sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //ES_Estado

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //Fecha_ALTA_SALESFORCE
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //Fecha_ALTA_KEE
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_ALTA_SAP
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_BAJA_SALESFORCE
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_BAJA KEE
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_BAJA SAP
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                    else
                                        sb.Append("null,'");
                                    CuentaColumna++;

                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Empresa
                                    if (Resumen != 1) {//SEGMENTO   
                                        //////sb.Append("','");   
                                        sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++;
                                    }

                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Tipo Cliente
                                    sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //NIF

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FPSERCON
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                    else
                                        sb.Append("null,'");
                                    CuentaColumna++;
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Nº INSTALACION
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //TARIFA
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //contrato
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //distribuidora
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Estado
                                    sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //SubEstado
                                    

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //TAM
                                        sb.Append(Convert.ToString(rango[i, CuentaColumna].Value).Replace(",", ".")).Append(",");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //ULT FH DESDE FACTURADA
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //ULT FH HASTA FACTURADA
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                    else
                                        sb.Append("null,'");
                                    CuentaColumna++;
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Estado Periodo KEE
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Area Responsable KEE
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Subestado KEE
                                    sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //Estado KEE
                                    //FH_DESDE_KEE y FH_HASTA_KEE
                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "")
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "")
                                        sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                    else
                                        sb.Append("null,'");
                                    CuentaColumna++;


                                    if (Resumen == 1 || Resumen == 2)
                                    {
                                        sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Multipunto
                                    }

                                    sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //Discrepancias
                                                                                                            


                                    if (Resumen == 3)
                                    //NDIAS_ESTADO_KEE y NDIAS_PTE_KEE
                              
                                    {
                                    //////if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "")
                                    //////    sb.Append(rango[i, CuentaColumna].Value).Append(",");
                                    //////else
                                    //////    sb.Append("null,");

                                    //////CuentaColumna++;

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "")
                                            sb.Append(rango[i, CuentaColumna].Value).Append(",");
                                        else
                                            sb.Append("null,");
                                        CuentaColumna++;
                                    }
                                    sb.Append("'").Append(DateTime.Now.ToString("yyyy-MM-dd")).Append("')");

                            }
                            else
                            {


                                sb.Append(",('");
                                //////if (Resumen == 1 || Resumen == 2)
                                //////{
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //CUPS20
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //PERIODO
                                sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //MES
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_DESDE
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_HASTA
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                else
                                    sb.Append("null,'");
                                CuentaColumna++;
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //AREA_ESTADO
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Subestado global
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //ESTADO GLOBAL
                                sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //ESTADO GLOBAL A REPORTAR
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //IMPORTE PDTE FACTURAR
                                    sb.Append(Convert.ToString(rango[i, CuentaColumna].Value).Replace(",", ".")).Append(",");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;
                                sb.Append(rango[i, CuentaColumna].Value).Append(",'"); CuentaColumna++; //MESES PDTES FACTURAR
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //AGORA
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //CLIENTE

                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //DIAS_ESTADO_SAP
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //DIAS_ESTADO_KEE
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //DIAS_ESTADO_GLOBAL
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Incidencia_Facturacion
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Estado_FAC_SE
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Titulo_FAC
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Incidencia_Medida
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Reincidente
                                sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //Estado Incidencia
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_APERTURA
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                else
                                    sb.Append("null,'");
                                CuentaColumna++;

                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Prioridad
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Titulo
                                sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //ES_Estado

                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //Fecha_ALTA_SALESFORCE
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;

                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //Fecha_ALTA_KEE
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;

                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_ALTA_SAP
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_BAJA_SALESFORCE
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_BAJA KEE
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FH_BAJA SAP
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                else
                                    sb.Append("null,'");
                                CuentaColumna++;

                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Empresa
                                if (Resumen != 1)
                                {//SEGMENTO   
                                 //////sb.Append("','");   
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++;
                                }

                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Tipo Cliente
                                sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //NIF

                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //FPSERCON
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                else
                                    sb.Append("null,'");
                                CuentaColumna++;
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Nº INSTALACION
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //TARIFA
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //contrato
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //distribuidora
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Estado
                                sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //SubEstado
                                //////sb.Append(rango[i, CuentaColumna].Value).Append(","); CuentaColumna++; //Dias_Estado

                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //TAM
                                    sb.Append(Convert.ToString(rango[i, CuentaColumna].Value).Replace(",", ".")).Append(",");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;

                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //ULT FH DESDE FACTURADA
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "") //ULT FH HASTA FACTURADA
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                else
                                    sb.Append("null,'");
                                CuentaColumna++;
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Estado Periodo KEE
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Area Responsable KEE
                                sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Subestado KEE
                                sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //Estado KEE
                                                                                                        //FH_DESDE_KEE y FH_HASTA_KEE
                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "")
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("',");
                                else
                                    sb.Append("null,");
                                CuentaColumna++;

                                if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "")
                                    sb.Append("'").Append(Convert.ToDateTime(rango[i, CuentaColumna].Value).ToString("yyyy-MM-dd")).Append("','");
                                else
                                    sb.Append("null,'");
                                CuentaColumna++;

                                if (Resumen == 1 || Resumen == 2)
                                {
                                    sb.Append(rango[i, CuentaColumna].Value).Append("','"); CuentaColumna++; //Multipunto
                                }

                                sb.Append(rango[i, CuentaColumna].Value).Append("',"); CuentaColumna++; //Discrepancias


                                if (Resumen == 3)
                                //NDIAS_ESTADO_KEE y NDIAS_PTE_KEE

                                {
                                    //////if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "")
                                    //////    sb.Append(rango[i, CuentaColumna].Value).Append(",");
                                    //////else
                                    //////    sb.Append("null,");

                                    //////CuentaColumna++;

                                    if (rango[i, CuentaColumna].Value != null & rango[i, CuentaColumna].Value != "")
                                        sb.Append(rango[i, CuentaColumna].Value).Append(",");
                                    else
                                        sb.Append("null,");
                                    CuentaColumna++;
                                }
                                sb.Append("'").Append(DateTime.Now.ToString("yyyy-MM-dd")).Append("')");

                            }
                            ContadorReplace = ContadorReplace + 1;
                            if (ContadorReplace == 50)
                            {
                                db = new MySQLDB(MySQLDB.Esquemas.FAC);
                                command = new MySqlCommand(sb.ToString(), db.con);
                                command.ExecuteNonQuery();
                                sb = null;
                                sb = new StringBuilder();
                                ContadorReplace = 0;
                                db.CloseConnection();
                            }
                        }

                        if (ContadorReplace >0)
                        {
                            db = new MySQLDB(MySQLDB.Esquemas.FAC);
                            command = new MySqlCommand(sb.ToString(), db.con);
                            command.ExecuteNonQuery();
                            sb = null;
                            sb = new StringBuilder();
                            ContadorReplace = 0;
                            db.CloseConnection();
                        }

                    }

                    //CREAMOS LAS  HOJAS RESUMEN
                    //////for (int p = 1; p < 4; p++)
                    //////{
                    //////    if (p == 1) {
                    //////        workSheet = excelPackage.Workbook.Worksheets.Add("HISTORICO ES");
                    //////    }
                    //////    if (p == 2)
                    //////    {
                    //////        workSheet = excelPackage.Workbook.Worksheets.Add("HISTORICO POR MT-BTE");
                    //////    }
                    //////    if (p == 3)
                    //////    {
                    //////        workSheet = excelPackage.Workbook.Worksheets.Add("HISTORICO POR BTN");
                    //////    }

                    //////    headerCells = workSheet.Cells[1, 1, 1, 32];
                    //////    headerFont = headerCells.Style.Font;
                    //////    //Ponemos columnas directamente
                    //////    f = 1;
                    //////    c = 1;

                    //////    workSheet.Cells[f, c].Value = "CUPS20"; c++;
                    //////    workSheet.Cells[f, c].Value = "PERIODO"; c++;
                    //////    workSheet.Cells[f, c].Value = "MES"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_DESDE"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_HASTA"; c++;
                    //////    workSheet.Cells[f, c].Value = "AREA_ESTADO"; c++;
                    //////    workSheet.Cells[f, c].Value = "Subestado global"; c++;
                    //////    workSheet.Cells[f, c].Value = "ESTADO GLOBAL"; c++;
                    //////    workSheet.Cells[f, c].Value = "ESTADO GLOBAL A REPORTAR"; c++;
                    //////    workSheet.Cells[f, c].Value = "IMPORTE PDTE FACTURAR"; c++;
                    //////    workSheet.Cells[f, c].Value = "MESES PDTES FACTURAR"; c++;
                    //////    workSheet.Cells[f, c].Value = "ÁGORA"; c++;
                    //////    workSheet.Cells[f, c].Value = "CLIENTE"; c++;
                    //////    workSheet.Cells[f, c].Value = "DIAS_ESTADO_SAP"; c++;
                    //////    workSheet.Cells[f, c].Value = "DIAS_ESTADO_KEE"; c++;
                    //////    workSheet.Cells[f, c].Value = "DIAS_ESTADO_GLOBAL"; c++;
                    //////    workSheet.Cells[f, c].Value = "Incidencia_Facturacion"; c++;
                    //////    workSheet.Cells[f, c].Value = "Estado_FAC_SE"; c++;
                    //////    workSheet.Cells[f, c].Value = "Titulo_FAC"; c++;
                    //////    workSheet.Cells[f, c].Value = "Incidencia_Medida"; c++;
                    //////    workSheet.Cells[f, c].Value = "Reincidente"; c++;
                    //////    workSheet.Cells[f, c].Value = "Estado incidencia"; c++;
                    //////    workSheet.Cells[f, c].Value = "Fecha_Apertura"; c++;
                    //////    workSheet.Cells[f, c].Value = "Prioridad"; c++;
                    //////    workSheet.Cells[f, c].Value = "Titulo"; c++;
                    //////    workSheet.Cells[f, c].Value = "E_S_Estado"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_ALTA_SALESFORCE"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_ALTA_KEE"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_ALTA_SAP"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_BAJA_SALESFORCE"; c++;
                    //////    workSheet.Cells[f, c].Value = "Fecha BAJA KEE"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_BAJA_SAP"; c++;
                    //////    workSheet.Cells[f, c].Value = "EMPRESA"; c++;
                    //////    if (p != 1)
                    //////    {
                    //////        workSheet.Cells[f, c].Value = "SEGMENTO"; c++;
                    //////    }
                    //////    workSheet.Cells[f, c].Value = "TIPO CLIENTE"; c++;
                    //////    workSheet.Cells[f, c].Value = "NIF"; c++;
                    //////    workSheet.Cells[f, c].Value = "FPSERCON"; c++;
                    //////    workSheet.Cells[f, c].Value = "Nº INSTALACIÓN"; c++;
                    //////    workSheet.Cells[f, c].Value = "TARIFA"; c++;
                    //////    workSheet.Cells[f, c].Value = "CONTRATO"; c++;  
                    //////    workSheet.Cells[f, c].Value = "DISTRIBUIDORA"; c++;
                    //////    workSheet.Cells[f, c].Value = "ESTADO"; c++;
                    //////    workSheet.Cells[f, c].Value = "SUBESTADO"; c++;
                    //////    ////workSheet.Cells[f, c].Value = "DIAS_ESTADO"; c++;
                    //////    workSheet.Cells[f, c].Value = "TAM"; c++;    
                    //////    workSheet.Cells[f, c].Value = "ULT FH DESDE FACTURADA"; c++;
                    //////    workSheet.Cells[f, c].Value = "ULT FH HASTA FACTURADA"; c++;
                    //////    workSheet.Cells[f, c].Value = "Estado periodo KEE"; c++;
                    //////    workSheet.Cells[f, c].Value = "Área responsable KEE"; c++;
                    //////    workSheet.Cells[f, c].Value = "Subestado KEE"; c++;
                    //////    workSheet.Cells[f, c].Value = "Estado_KEE"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_DESDE_KEE"; c++;
                    //////    workSheet.Cells[f, c].Value = "FH_HASTA_KEE"; c++;
                    //////    if (p != 3)
                    //////    {
                    //////        workSheet.Cells[f, c].Value = "Multipunto"; c++;
                    //////    }
                    //////    workSheet.Cells[f, c].Value = "Discrepancias"; c++;
                    
                    //////    if (p == 3)
                    //////    {
                    //////        //////workSheet.Cells[f, c].Value = "Nº DÍAS ESTADO KEE"; c++;
                    //////        workSheet.Cells[f, c].Value = "Nº Días PTE KEE"; c++;
                    //////    }
                    //////    workSheet.Cells[f, c].Value = "FH_CARGA";

           
                    //////    headerCells = workSheet.Cells[1, 1, 1, c];
                    //////    headerFont = headerCells.Style.Font;
                    //////    headerFont.Bold = true;

                    //////    //////headerCells = workSheet.Cells[1, 1, 1, 30];
                    //////    //////headerFont = headerCells.Style.Font;
                    //////    //////headerFont.Bold = true;
                    //////    //////allCells = workSheet.Cells[1, 1, 50, 50];

                    //////    if (p==1)
                    //////    {
                    //////        strSql = " SELECT CUPS20, PERIODO, MES, if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE,if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA,AREA_ESTADO,"
                    //////          + "Subestado_global, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR,IMPORTE_PDTE_FACTURAR,MESES_PDTES_FACTURAR,Agora, Cliente,DIAS_ESTADO_SAP,DIAS_ESTADO_KEE,DIAS_ESTADO_GLOBAL," 
                    //////          + "Incidencia_Facturacion,Estado_FAC_SE, Titulo_FAC, Incidencia_Medida, Reincidente, Estado_incidencia, Fecha_Apertura,Prioridad, Titulo, E_S_Estado,FH_ALTA_SALESFORCE,Fecha_ALTA_KEE,FH_ALTA_SAP,FH_BAJA_SALESFORCE,Fecha_BAJA_KEE,FH_BAJA_SAP," 
                    //////          + "Empresa,  tipo_cliente,nif, FPSERCON,N_INSTALACION,"
                    //////          + " tarifa,contrato,Distribuidora,Estado,Subestado,Tam,ULT_FH_DESDE_FACTURADA,ULT_FH_HASTA_FACTURADA,"
                    //////          + " Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,if(FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE) as FH_DESDE_KEE, if(FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE) as FH_HASTA_KEE, Multipunto,Discrepancia,  FH_CARGA"
                    //////          + " FROM sap_KEE_Resumen_ES_POR_MT_BTE_New "
                    //////          + " Where (segmento='' or segmento IS NULL)"
                    //////          + " AND FH_CARGA >= ("
                    //////          + "   SELECT MIN(A.FH_CARGA) FROM"
                    //////          + "   ("
                    //////          + "       SELECT distinct FH_CARGA"
                    //////          + "       FROM sap_KEE_Resumen_ES_POR_MT_BTE_New"
                    //////          + "       Where (segmento = '' or segmento is null)"
                    //////          + "      ORDER BY FH_CARGA DESC"
                    //////          + "       LIMIT 5"
                    //////          + "   ) AS A"
                    //////          + ")"
                    //////          + " order by FH_CARGA desc";
                    //////    }

                    //////    if (p == 2)
                    //////    {
                    //////        //////strSql = " SELECT Empresa, PERIODO, AREA_ESTADO, FH_ALTA_SALESFORCE,segmento, tipo_cliente,nif,cliente,FH_ALTA_SAP,FPSERCON,CUPS20,if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE,if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA,FH_BAJA_SALESFORCE,FH_BAJA_SAP,Fecha_BAJA_KEE,"
                    //////        //////  + " N_INSTALACION,tarifa,contrato,mes,Distribuidora,Estado,Subestado,DIAS_ESTADO_SAP, DIAS_ESTADO_KEE, DIAS_ESTADO_GLOBAL,Tam,MESES_PDTES_FACTURAR,ULT_FH_DESDE_FACTURADA,Fecha_ALTA_KEE,"
                    //////        //////  + " ULT_FH_HASTA_FACTURADA,IMPORTE_PDTE_FACTURAR,Agora,Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,if(FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE) as FH_DESDE_KEE, if(FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE) as FH_HASTA_KEE,Discrepancia, Subestado_global, Incidencia, Estado_incidencia, Fecha_Apertura,Prioridad, Titulo, E_S_Estado, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR, Multipunto, FH_CARGA"

                    //////          strSql = " SELECT CUPS20, PERIODO, MES, if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE,if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA,AREA_ESTADO,"
                    //////          + "Subestado_global, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR,IMPORTE_PDTE_FACTURAR,MESES_PDTES_FACTURAR,Agora, Cliente,DIAS_ESTADO_SAP,DIAS_ESTADO_KEE,DIAS_ESTADO_GLOBAL,"
                    //////          + "Incidencia_Facturacion,Estado_FAC_SE, Titulo_FAC,Incidencia_Medida, Reincidente, Estado_incidencia, Fecha_Apertura,Prioridad, Titulo, E_S_Estado,FH_ALTA_SALESFORCE,Fecha_ALTA_KEE,FH_ALTA_SAP,FH_BAJA_SALESFORCE,Fecha_BAJA_KEE,FH_BAJA_SAP,"
                    //////          + "Empresa,  SEGMENTO,tipo_cliente,nif, FPSERCON,N_INSTALACION,"
                    //////          + " tarifa,contrato,Distribuidora,Estado,Subestado,Tam,ULT_FH_DESDE_FACTURADA,ULT_FH_HASTA_FACTURADA,"
                    //////          + " Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,if(FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE) as FH_DESDE_KEE, if(FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE) as FH_HASTA_KEE, Multipunto,Discrepancia,  FH_CARGA"
                    //////          + " FROM sap_KEE_Resumen_ES_POR_MT_BTE_New "
                    //////          + " Where segmento in ('MT', 'BTE') "
                    //////          + " AND FH_CARGA >= ("
                    //////          + "   SELECT MIN(A.FH_CARGA) FROM"
                    //////          + "   ("
                    //////          + "       SELECT distinct FH_CARGA"
                    //////          + "       FROM sap_KEE_Resumen_ES_POR_MT_BTE_New"
                    //////          + "       Where segmento in ('MT', 'BTE')"
                    //////          + "      ORDER BY FH_CARGA DESC"
                    //////          + "       LIMIT 5"
                    //////          + "   ) AS A"
                    //////          + ")"
                    //////          + " order by FH_CARGA desc";
                    //////    }

                    //////    if (p == 3)
                    //////    {
                    //////        //////    strSql = " SELECT Empresa,segmento, tipo_cliente,nif,cliente,FALTACONT,FPSERCON,CUPS20,if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE,if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA,FH_BAJA_SALESFORCE,FH_BAJA_SAP,Fecha_BAJA_KEE,"
                    //////        //////    + " N_INSTALACION,tarifa,contrato,mes,Distribuidora,Estado,Subestado,DIAS_ESTADO,Tam,MESES_PDTES_FACTURAR,ULT_FH_DESDE_FACTURADA,"
                    //////        //////    + " ULT_FH_HASTA_FACTURADA,IMPORTE_PDTE_FACTURAR,Agora,Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,Discrepancia, FH_CARGA"
                    //////        //////    + " FROM sap_KEE_Resumen_ES_POR_MT_BTE "
                    //////        //////    + " Where segmento ='BTN' "
                    //////        //////    + " AND FH_CARGA >= ("
                    //////        //////    + "   SELECT MIN(A.FH_CARGA) FROM"
                    //////        //////    + "   ("
                    //////        //////    + "       SELECT distinct FH_CARGA"
                    //////        //////    + "       FROM sap_KEE_Resumen_ES_POR_MT_BTE"
                    //////        //////    + "       Where segmento='BTN'"
                    //////        //////    + "       ORDER BY FH_CARGA DESC"
                    //////        //////    + "       LIMIT 5"
                    //////        //////    + "   ) AS A"
                    //////        //////    + ")"
                    //////        //////    + " order by FH_CARGA desc";
                    //////        ///

                    //////        //////strSql = " SELECT Empresa, PERIODO, AREA_ESTADO, FH_ALTA_SALESFORCE,segmento, tipo_cliente,nif,cliente,FH_ALTA_SAP,FPSERCON,CUPS20,if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE,if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA,FH_BAJA_SALESFORCE,FH_BAJA_SAP,Fecha_BAJA_KEE,"
                    //////        //////    + " N_INSTALACION,tarifa,contrato,mes,Distribuidora,Estado,Subestado,DIAS_ESTADO_SAP, DIAS_ESTADO_KEE, DIAS_ESTADO_GLOBAL,Tam,MESES_PDTES_FACTURAR,ULT_FH_DESDE_FACTURADA,Fecha_ALTA_KEE,"
                    //////        //////    + " ULT_FH_HASTA_FACTURADA,IMPORTE_PDTE_FACTURAR,Agora,Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,if(FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE) as FH_DESDE_KEE, if(FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE) as FH_HASTA_KEE,Discrepancia, Subestado_global, Incidencia, Estado_incidencia, Fecha_Apertura,Prioridad, Titulo, E_S_Estado, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR,  

                    //////          strSql = " SELECT CUPS20, PERIODO, MES, if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE,if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA,AREA_ESTADO,"
                    //////          + "Subestado_global, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR,IMPORTE_PDTE_FACTURAR,MESES_PDTES_FACTURAR,Agora, Cliente,DIAS_ESTADO_SAP,DIAS_ESTADO_KEE,DIAS_ESTADO_GLOBAL,"
                    //////          + "Incidencia_Facturacion,Estado_FAC_SE, Titulo_FAC,Incidencia_Medida, Reincidente, Estado_incidencia, Fecha_Apertura,Prioridad, Titulo, E_S_Estado,FH_ALTA_SALESFORCE,Fecha_ALTA_KEE,FH_ALTA_SAP,FH_BAJA_SALESFORCE,Fecha_BAJA_KEE,FH_BAJA_SAP,"
                    //////          + "Empresa,  SEGMENTO,tipo_cliente,nif, FPSERCON,N_INSTALACION,"
                    //////          + " tarifa,contrato,Distribuidora,Estado,Subestado,Tam,ULT_FH_DESDE_FACTURADA,ULT_FH_HASTA_FACTURADA,"
                    //////          + " Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,if(FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE) as FH_DESDE_KEE, if(FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE) as FH_HASTA_KEE, Multipunto,Discrepancia,   NDIAS_PTE_KEE,FH_CARGA"
                    //////            + " FROM sap_KEE_Resumen_ES_POR_MT_BTE_New "
                    //////            + " Where segmento ='BTN' "
                    //////            + " AND FH_CARGA >= ("
                    //////            + "   SELECT MIN(A.FH_CARGA) FROM"
                    //////            + "   ("
                    //////            + "       SELECT distinct FH_CARGA"
                    //////            + "       FROM sap_KEE_Resumen_ES_POR_MT_BTE_New"
                    //////            + "       Where segmento in ('MT', 'BTE')"
                    //////            + "      ORDER BY FH_CARGA DESC"
                    //////            + "       LIMIT 5"
                    //////            + "   ) AS A"
                    //////            + ")"
                    //////            + " order by FH_CARGA desc";
                    //////    }

                    //////    db = new MySQLDB(MySQLDB.Esquemas.FAC);
                    //////    command = new MySqlCommand(strSql, db.con);
                    //////    r = command.ExecuteReader();
                    //////    f = 1;
                    //////    while (r.Read())
                    //////    {
                    //////        f++;
                    //////        c = 1;

                    //////        //////if (p != 3)
                    //////        //////{
                    //////            if (r["CUPS20"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["CUPS20"].ToString();
                    //////            c++;
                    //////            if (r["PERIODO"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["PERIODO"].ToString();
                    //////            c++;

                    //////            if (r["mes"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["mes"].ToString();
                    //////            c++;
                    //////            if (r["FH_DESDE"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_DESDE"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["FH_HASTA"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_HASTA"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["AREA_ESTADO"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["AREA_ESTADO"].ToString();
                    //////            c++;
                    //////            if (r["Subestado_global"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Subestado_global"].ToString();
                    //////            c++;
                    //////            if (r["ESTADO_GLOBAL"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["ESTADO_GLOBAL"].ToString();
                    //////            c++;
                    //////            if (r["ESTADO_GLOBAL_A_REPORTAR"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["ESTADO_GLOBAL_A_REPORTAR"].ToString();
                    //////            c++;
                    //////            if (r["IMPORTE_PDTE_FACTURAR"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["IMPORTE_PDTE_FACTURAR"].ToString();
                    //////            c++;
                    //////            if (r["MESES_PDTES_FACTURAR"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["MESES_PDTES_FACTURAR"].ToString();
                    //////            c++;
                    //////            if (r["Agora"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Agora"].ToString();
                    //////            c++;
                    //////            if (r["cliente"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["cliente"].ToString();
                    //////            c++;

                    //////            if (r["DIAS_ESTADO_SAP"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["DIAS_ESTADO_SAP"].ToString();
                    //////            c++;
                    //////            if (r["DIAS_ESTADO_KEE"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["DIAS_ESTADO_KEE"].ToString();
                    //////            c++;
                    //////            if (r["DIAS_ESTADO_GLOBAL"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["DIAS_ESTADO_GLOBAL"].ToString();
                    //////            c++;
                    //////            if (r["Incidencia_Facturacion"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Incidencia_Facturacion"].ToString();
                    //////            c++;
                    //////            if (r["Estado_FAC_SE"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Estado_FAC_SE"].ToString();
                    //////            c++;
                    //////            if (r["Titulo_FAC"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Titulo_FAC"].ToString();
                    //////            c++;
                    //////            if (r["Incidencia_Medida"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Incidencia_Medida"].ToString();
                    //////            c++;
                    //////            if (r["Reincidente"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Incidencia_Medida"].ToString();
                    //////            c++;
                    //////            if (r["Estado_incidencia"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Estado_incidencia"].ToString();
                    //////            c++;
                    //////            if (r["Fecha_Apertura"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Fecha_Apertura"].ToString();
                    //////            c++;
                    //////            if (r["Prioridad"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Prioridad"].ToString();
                    //////            c++;
                    //////            if (r["Titulo"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Titulo"].ToString();
                    //////            c++;
                    //////            if (r["E_S_Estado"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["E_S_Estado"].ToString();
                    //////            c++;

                    //////            if (r["FH_ALTA_SALESFORCE"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_ALTA_SALESFORCE"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;

                    //////            if (r["Fecha_ALTA_KEE"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["Fecha_ALTA_KEE"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["FH_ALTA_SAP"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_ALTA_SAP"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["FH_BAJA_SALESFORCE"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_BAJA_SALESFORCE"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["Fecha_BAJA_KEE"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["Fecha_BAJA_KEE"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["FH_BAJA_SAP"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_BAJA_SAP"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["Empresa"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Empresa"].ToString();
                    //////            c++;
                    //////            if (p!= 1)
                    //////            {
                    //////                if (r["segmento"] != System.DBNull.Value)
                    //////                    workSheet.Cells[f, c].Value = r["segmento"].ToString();
                    //////                c++;
                    //////            }
                    //////            if (r["tipo_cliente"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["tipo_cliente"].ToString();
                    //////            c++;
                    //////            if (r["nif"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["nif"].ToString();
                    //////            c++;
                    //////            if (r["FPSERCON"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FPSERCON"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["N_INSTALACION"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["N_INSTALACION"].ToString();
                    //////            c++;
                    //////            if (r["tarifa"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["tarifa"].ToString();
                    //////            c++;
                    //////            if (r["contrato"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["contrato"].ToString();
                    //////            c++;
                    //////            if (r["Distribuidora"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Distribuidora"].ToString();
                    //////            c++;
                    //////            if (r["Estado"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Estado"].ToString();
                    //////            c++;
                    //////            if (r["Subestado"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Subestado"].ToString();
                    //////            c++;
                    //////            //////if (r["DIAS_ESTADO"] != System.DBNull.Value)
                    //////            //////    workSheet.Cells[f, c].Value = r["DIAS_ESTADO"].ToString();
                    //////            //////c++;
                    //////            if (r["Tam"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Tam"].ToString();
                    //////            c++;
                    //////            if (r["ULT_FH_DESDE_FACTURADA"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["ULT_FH_DESDE_FACTURADA"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["ULT_FH_HASTA_FACTURADA"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["ULT_FH_HASTA_FACTURADA"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["Estado_periodo_KEE"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Estado_periodo_KEE"].ToString();
                    //////            c++;
                    //////            if (r["Area_responsable_KEE"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Area_responsable_KEE"].ToString();
                    //////            c++;
                    //////            if (r["Subestado_KEE"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Subestado_KEE"].ToString();
                    //////            c++;
                    //////            if (r["Estado_KEE"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Estado_KEE"].ToString();
                    //////            c++;
                    //////            if (r["FH_DESDE_KEE"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_DESDE_KEE"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;
                    //////            if (r["FH_HASTA_KEE"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_HASTA_KEE"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }
                    //////            c++;

                    //////            if (p != 3)
                    //////            {
                    //////                if (r["Multipunto"] != System.DBNull.Value)
                    //////                    workSheet.Cells[f, c].Value = r["Multipunto"].ToString();
                    //////                c++;
                    //////            }

                    //////            if (r["Discrepancia"] != System.DBNull.Value)
                    //////                workSheet.Cells[f, c].Value = r["Discrepancia"].ToString();
                    //////            c++;

                    //////            if (p == 3)
                    //////            {
                    //////                //////if (r["NDIAS_ESTADO_KEE"] != System.DBNull.Value)
                    //////                //////    workSheet.Cells[f, c].Value = r["NDIAS_ESTADO_KEE"].ToString();
                    //////                //////c++;
                    //////                if (r["NDIAS_PTE_KEE"] != System.DBNull.Value)
                    //////                    workSheet.Cells[f, c].Value = r["NDIAS_PTE_KEE"].ToString();
                    //////                c++;
                    //////            }

                    //////            if (r["FH_CARGA"] != System.DBNull.Value)
                    //////            {
                    //////                workSheet.Cells[f, c].Value = Convert.ToDateTime(r["FH_CARGA"]).Date;
                    //////                workSheet.Cells[f, c].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    //////            }

                  

                    //////        allCells = workSheet.Cells[1, 1, f, c];
                    //////        allCells.AutoFitColumns();
                    //////    }
                    //////    db.CloseConnection();
                    //////}

                    ///29/08/2024 PRUEBA COLUMNAS
                    TotalPruebaES = 0;
                    TotalPruebaMTBTE = 0;
                    TotalPruebaBTN = 0;

                    for (int p = 1; p < 4; p++)
                    {
                        if (p == 1)
                        {
                            workSheet = excelPackage.Workbook.Worksheets.Add("HISTORICO ES");
                        }
                        if (p == 2)
                        {
                            workSheet = excelPackage.Workbook.Worksheets.Add("HISTORICO POR MT-BTE");
                        }
                        if (p == 3)
                        {
                            workSheet = excelPackage.Workbook.Worksheets.Add("HISTORICO POR BTN");
                        }

                        headerCells = workSheet.Cells[1, 1, 1, 32];
                        headerFont = headerCells.Style.Font;
                        //Ponemos columnas directamente
                        f = 1;
                        c = 1;

                        if (p == 1)
                        {
                            workSheet.Cells[f, c].Value = "CUPS20;PERIODO; MES;FH_DESDE;FH_HASTA;AREA_ESTADO;Subestado global;ESTADO GLOBAL;ESTADO GLOBAL A REPORTAR;IMPORTE PDTE FACTURAR;MESES PDTES FACTURAR;ÁGORA;CLIENTE;DIAS_ESTADO_SAP;DIAS_ESTADO_KEE;DIAS_ESTADO_GLOBAL;Incidencia_Facturacion;Estado_FAC_SE;Titulo_FAC;Incidencia_Medida;Reincidente;Estado incidencia;Fecha_Apertura;Prioridad;Titulo;E_S_Estado;FH_ALTA_SALESFORCE;FH_ALTA_KEE;FH_ALTA_SAP;FH_BAJA_SALESFORCE;Fecha BAJA KEE;FH_BAJA_SAP;EMPRESA;TIPO CLIENTE;NIF;FPSERCON;Nº INSTALACIÓN;TARIFA;CONTRATO;DISTRIBUIDORA;ESTADO;SUBESTADO;TAM;ULT FH DESDE FACTURADA;ULT FH HASTA FACTURADA;Estado periodo KEE;Área responsable KEE;Subestado KEE;Estado_KEE;FH_DESDE_KEE;FH_HASTA_KEE;Multipunto;Discrepancias;FH_CARGA";
                        }
                        if (p == 2)
                        {
                            workSheet.Cells[f, c].Value = "CUPS20;PERIODO; MES;FH_DESDE;FH_HASTA;AREA_ESTADO;Subestado global;ESTADO GLOBAL;ESTADO GLOBAL A REPORTAR;IMPORTE PDTE FACTURAR;MESES PDTES FACTURAR;ÁGORA;CLIENTE;DIAS_ESTADO_SAP;DIAS_ESTADO_KEE;DIAS_ESTADO_GLOBAL;Incidencia_Facturacion;Estado_FAC_SE;Titulo_FAC;Incidencia_Medida;Reincidente;Estado incidencia;Fecha_Apertura;Prioridad;Titulo;E_S_Estado;FH_ALTA_SALESFORCE;FH_ALTA_KEE;FH_ALTA_SAP;FH_BAJA_SALESFORCE;Fecha BAJA KEE;FH_BAJA_SAP;EMPRESA;SEGMENTO;TIPO CLIENTE;NIF;FPSERCON;Nº INSTALACIÓN;TARIFA;CONTRATO;DISTRIBUIDORA;ESTADO;SUBESTADO;TAM;ULT FH DESDE FACTURADA;ULT FH HASTA FACTURADA;Estado periodo KEE;Área responsable KEE;Subestado KEE;Estado_KEE;FH_DESDE_KEE;FH_HASTA_KEE;Multipunto;Discrepancias;FH_CARGA";
                        }
                        if (p == 3)
                        {
                            workSheet.Cells[f, c].Value = "CUPS20;PERIODO; MES;FH_DESDE;FH_HASTA;AREA_ESTADO;Subestado global;ESTADO GLOBAL;ESTADO GLOBAL A REPORTAR;IMPORTE PDTE FACTURAR;MESES PDTES FACTURAR;ÁGORA;CLIENTE;DIAS_ESTADO_SAP;DIAS_ESTADO_KEE;DIAS_ESTADO_GLOBAL;Incidencia_Facturacion;Estado_FAC_SE;Titulo_FAC;Incidencia_Medida;Reincidente;Estado incidencia;Fecha_Apertura;Prioridad;Titulo;E_S_Estado;FH_ALTA_SALESFORCE;FH_ALTA_KEE;FH_ALTA_SAP;FH_BAJA_SALESFORCE;Fecha BAJA KEE;FH_BAJA_SAP;EMPRESA;SEGMENTO;TIPO CLIENTE;NIF;FPSERCON;Nº INSTALACIÓN;TARIFA;CONTRATO;DISTRIBUIDORA;ESTADO;SUBESTADO;TAM;ULT FH DESDE FACTURADA;ULT FH HASTA FACTURADA;Estado periodo KEE;Área responsable KEE;Subestado KEE;Estado_KEE;FH_DESDE_KEE;FH_HASTA_KEE;Discrepancias;Nº Días PTE KEE;FH_CARGA";
                        }

                        headerCells = workSheet.Cells[1, 1, 1, c];
                        headerFont = headerCells.Style.Font;
                        headerFont.Bold = true;

                        if (p == 1)
                        {
                            //////strSql = " SELECT CUPS20 || ';' || PERIODO | ';' || MES || ';' || if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE || ';' || if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA || ';' ||AREA_ESTADO || ';' ||"
                            //////  + "Subestado_global || ';' || ESTADO_GLOBAL || ';' || ESTADO_GLOBAL_A_REPORTAR || ';' || IMPORTE_PDTE_FACTURAR || ';' || MESES_PDTES_FACTURAR || ';' || Agora || ';' || Cliente || ';' || DIAS_ESTADO_SAP || ';' || DIAS_ESTADO_KEE || ';' || DIAS_ESTADO_GLOBAL || ';' ||"
                            //////  + "Incidencia_Facturacion || ';' || Estado_FAC_SE || ';' || Titulo_FAC || ';' || Incidencia_Medida || ';' || Reincidente || ';' || Estado_incidencia || ';' || Fecha_Apertura || ';' || Prioridad || ';' || Titulo || ';' || E_S_Estado || ';' || FH_ALTA_SALESFORCE || ';' || Fecha_ALTA_KEE || ';' || FH_ALTA_SAP || ';' || FH_BAJA_SALESFORCE || ';' || Fecha_BAJA_KEE || ';' || FH_BAJA_SAP || ';' ||"
                            //////  + "Empresa || ';' ||  tipo_cliente || ';' || nif || ';' || FPSERCON || ';' || N_INSTALACION || ';' ||"
                            //////  + " tarifa || ';' || contrato || ';' || Distribuidora || ';' || Estado || ';' || Subestado || ';' || Tam || ';' || ULT_FH_DESDE_FACTURADA || ';' || ULT_FH_HASTA_FACTURADA || ';' ||"
                            //////  + " Estado_periodo_KEE || ';' || Area_responsable_KEE || ';' || Subestado_KEE || ';' || Estado_KEE || ';' || if(FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE) as FH_DESDE_KEE || ';' || if(FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE) as FH_HASTA_KEE || ';' || Multipunto || ';' || Discrepancia || ';' ||  FH_CARGA as Cadena"


                              strSql = "SELECT concat(CUPS20 ,';',PERIODO ,';',MES,';',if (FH_DESDE = '0000-00-00', null, FH_DESDE),';',if (FH_HASTA = '0000-00-00', null, FH_HASTA), ';' ,AREA_ESTADO, ';' ,Subestado_global , ';' , ESTADO_GLOBAL , ';' , ESTADO_GLOBAL_A_REPORTAR, ';' ,  IFNULL(replace(IMPORTE_PDTE_FACTURAR,'.',','), '')  , ';' , MESES_PDTES_FACTURAR, ';' , Agora , ';' , Cliente , ';' , DIAS_ESTADO_SAP, ';' , DIAS_ESTADO_GLOBAL , ';',Incidencia_Facturacion , ';', Estado_FAC_SE , ';', ';' , Titulo_FAC , ';' , Incidencia_Medida , ';', Reincidente , ';' , Estado_incidencia , ';', IFNULL(Fecha_Apertura, '') , ';' , Prioridad , ';' , Titulo , ';' , E_S_Estado , ';' , IFNULL(FH_ALTA_SALESFORCE, ''), ';', IFNULL(Fecha_ALTA_KEE, '') , ';' , ifnull(FH_ALTA_SAP, '') , ';' , IFNULL(FH_BAJA_SALESFORCE, '') , ';', IFNULL(Fecha_BAJA_KEE, '') , ';' , IFNULL(FH_BAJA_SAP, '') , ';' ,Empresa , ';' ,  tipo_cliente , ';' , nif , ';' , FPSERCON , ';' , N_INSTALACION , ';' , tarifa , ';' , contrato , ';' , Distribuidora , ';' ,   Estado , ';' , Subestado , ';' , IFNULL(replace(TAM,'.',','), '')  , ';' , IFNULL(ULT_FH_DESDE_FACTURADA,'') , ';', IFNULL(ULT_FH_HASTA_FACTURADA,'') , ';' , Estado_periodo_KEE , ';' , Area_responsable_KEE , ';' , Subestado_KEE , ';' , replace(Estado_KEE,';','-') , ';', ifnull(if (FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE),''), ';' , ifnull(if (FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE),''), ';' , Multipunto , ';' , replace(Discrepancia,';','-') , ';' ,  FH_CARGA  ) as Cadena "
                              + " FROM sap_KEE_Resumen_ES_POR_MT_BTE_New "
                              + " Where (segmento='' or segmento IS NULL)"
                              + " AND FH_CARGA >= ("
                              + "   SELECT MIN(A.FH_CARGA) FROM"
                              + "   ("
                              + "       SELECT distinct FH_CARGA"
                              + "       FROM sap_KEE_Resumen_ES_POR_MT_BTE_New"
                              + "       Where (segmento = '' or segmento is null)"
                              + "      ORDER BY FH_CARGA DESC"
                              + "       LIMIT 5"
                              + "   ) AS A"
                              + ")"
                              + " order by FH_CARGA desc";
                        }

                        if (p == 2)
                        {
                            //////strSql = " SELECT Empresa, PERIODO, AREA_ESTADO, FH_ALTA_SALESFORCE,segmento, tipo_cliente,nif,cliente,FH_ALTA_SAP,FPSERCON,CUPS20,if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE,if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA,FH_BAJA_SALESFORCE,FH_BAJA_SAP,Fecha_BAJA_KEE,"
                            //////  + " N_INSTALACION,tarifa,contrato,mes,Distribuidora,Estado,Subestado,DIAS_ESTADO_SAP, DIAS_ESTADO_KEE, DIAS_ESTADO_GLOBAL,Tam,MESES_PDTES_FACTURAR,ULT_FH_DESDE_FACTURADA,Fecha_ALTA_KEE,"
                            //////  + " ULT_FH_HASTA_FACTURADA,IMPORTE_PDTE_FACTURAR,Agora,Estado_periodo_KEE,Area_responsable_KEE,Subestado_KEE,Estado_KEE,if(FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE) as FH_DESDE_KEE, if(FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE) as FH_HASTA_KEE,Discrepancia, Subestado_global, Incidencia, Estado_incidencia, Fecha_Apertura,Prioridad, Titulo, E_S_Estado, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR, Multipunto, FH_CARGA"

                            strSql = "SELECT concat(CUPS20 ,';',PERIODO ,';',MES,';',if (FH_DESDE = '0000-00-00', null, FH_DESDE),';',if (FH_HASTA = '0000-00-00', null, FH_HASTA), ';' ,AREA_ESTADO, ';' ,Subestado_global , ';' , ESTADO_GLOBAL , ';' , ESTADO_GLOBAL_A_REPORTAR, ';' , IFNULL(replace(IMPORTE_PDTE_FACTURAR,'.',','), '')  , ';' , MESES_PDTES_FACTURAR, ';' , Agora , ';' , Cliente , ';' , DIAS_ESTADO_SAP, ';' , DIAS_ESTADO_KEE, ';', DIAS_ESTADO_GLOBAL , ';',Incidencia_Facturacion , ';', Estado_FAC_SE , ';',  Titulo_FAC , ';' , Incidencia_Medida , ';', Reincidente , ';' , Estado_incidencia , ';', IFNULL(Fecha_Apertura, '') , ';' , Prioridad , ';' , Titulo , ';' , E_S_Estado , ';' , IFNULL(FH_ALTA_SALESFORCE, ''), ';', IFNULL(Fecha_ALTA_KEE, '') , ';' , ifnull(FH_ALTA_SAP, '') , ';' , IFNULL(FH_BAJA_SALESFORCE, '') , ';', IFNULL(Fecha_BAJA_KEE, '') , ';' , IFNULL(FH_BAJA_SAP, '') , ';' ,Empresa , ';' , SEGMENTO, ';' ,  tipo_cliente , ';' , nif , ';' , FPSERCON , ';' , N_INSTALACION , ';' , tarifa , ';' , contrato , ';' , Distribuidora , ';' ,   Estado , ';' , Subestado , ';' , IFNULL(replace(TAM,'.',','), '')  , ';' , IFNULL(ULT_FH_DESDE_FACTURADA,''), ';',IFNULL(ULT_FH_HASTA_FACTURADA,'') , ';' , Estado_periodo_KEE , ';' , Area_responsable_KEE , ';' , Subestado_KEE , ';' , replace(Estado_KEE,';','-') , ';', ifnull(if (FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE),''), ';' , ifnull(if (FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE),''), ';' , Multipunto , ';' , replace(Discrepancia,';','-') , ';' ,  FH_CARGA  ) as Cadena "
                            + " FROM sap_KEE_Resumen_ES_POR_MT_BTE_New "
                            + " Where segmento in ('MT', 'BTE') "
                            + " AND FH_CARGA >= ("
                            + "   SELECT MIN(A.FH_CARGA) FROM"
                            + "   ("
                            + "       SELECT distinct FH_CARGA"
                            + "       FROM sap_KEE_Resumen_ES_POR_MT_BTE_New"
                            + "       Where segmento in ('MT', 'BTE')"
                            + "      ORDER BY FH_CARGA DESC"
                            + "       LIMIT 5"
                            + "   ) AS A"
                            + ")"
                            + " order by FH_CARGA desc";
                        }

                        if (p == 3)
                        {
                            //////strSql = " SELECT CUPS20, PERIODO, MES, if(FH_DESDE = '0000-00-00', null, FH_DESDE) AS FH_DESDE,if(FH_HASTA = '0000-00-00', null, FH_HASTA) AS FH_HASTA,AREA_ESTADO,Subestado_global, ESTADO_GLOBAL, ESTADO_GLOBAL_A_REPORTAR,IMPORTE_PDTE_FACTURAR,                                                    MESES_PDTES_FACTURAR,Agora, Cliente,DIAS_ESTADO_SAP,DIAS_ESTADO_KEE,DIAS_ESTADO_GLOBAL,                                             Incidencia_Facturacion,Estado_FAC_SE, Titulo_FAC,Incidencia_Medida, Reincidente, Estado_incidencia, Fecha_Apertura,                                                             Prioridad, Titulo, E_S_Estado,FH_ALTA_SALESFORCE,Fecha_ALTA_KEE,FH_ALTA_SAP,FH_BAJA_SALESFORCE,Fecha_BAJA_KEE,                                                                                                                                  FH_BAJA_SAP,Empresa,  SEGMENTO,tipo_cliente,nif, FPSERCON,N_INSTALACION,tarifa,contrato,                                                                      Distribuidora,Estado,Subestado,Tam,ULT_FH_DESDE_FACTURADA,ULT_FH_HASTA_FACTURADA,Estado_periodo_KEE,Area_responsable_KEE,                                                                  Subestado_KEE,Estado_KEE,if(FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE) as FH_DESDE_KEE, if(FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE) as FH_HASTA_KEE, Multipunto,Discrepancia,   NDIAS_PTE_KEE,FH_CARGA"

                            strSql = "SELECT concat(CUPS20 ,';',PERIODO ,';',MES,';',if (FH_DESDE = '0000-00-00', null, FH_DESDE),';',if (FH_HASTA = '0000-00-00', null, FH_HASTA), ';' ,AREA_ESTADO, ';' ,Subestado_global , ';' , ESTADO_GLOBAL , ';' , ESTADO_GLOBAL_A_REPORTAR, ';' , IFNULL(replace(IMPORTE_PDTE_FACTURAR,'.',','), '')  , ';' , MESES_PDTES_FACTURAR, ';' , Agora , ';' , Cliente , ';' , DIAS_ESTADO_SAP, ';' , DIAS_ESTADO_KEE, ';', DIAS_ESTADO_GLOBAL , ';',Incidencia_Facturacion , ';', Estado_FAC_SE , ';' , Titulo_FAC , ';' , Incidencia_Medida , ';', Reincidente , ';' , Estado_incidencia , ';', IFNULL(Fecha_Apertura, '') , ';' , Prioridad , ';' , Titulo , ';' , E_S_Estado , ';' , IFNULL(FH_ALTA_SALESFORCE, ''), ';', IFNULL(Fecha_ALTA_KEE, '') , ';' , ifnull(FH_ALTA_SAP, '') , ';' , IFNULL(FH_BAJA_SALESFORCE, '') , ';', IFNULL(Fecha_BAJA_KEE, '') , ';' , IFNULL(FH_BAJA_SAP, '') , ';' ,Empresa , ';' , SEGMENTO, ';' ,  tipo_cliente , ';' , nif , ';' , FPSERCON , ';' , N_INSTALACION , ';' , tarifa , ';' , contrato , ';' , Distribuidora , ';' ,   Estado , ';' , Subestado , ';' , IFNULL(replace(TAM,'.',','), '') , ';' , ifnull(ULT_FH_DESDE_FACTURADA,'') , ';',ifnull(ULT_FH_HASTA_FACTURADA,'') , ';' , Estado_periodo_KEE , ';' , Area_responsable_KEE , ';' , Subestado_KEE , ';' , replace(Estado_KEE,';','-') , ';', ifnull(if (FH_DESDE_KEE = '0000-00-00', null, FH_DESDE_KEE),''), ';' , ifnull(if (FH_HASTA_KEE = '0000-00-00', null, FH_HASTA_KEE),''), ';'  , replace(Discrepancia,';','-') , ';' , ifnull(NDIAS_PTE_KEE,''), ';', FH_CARGA  ) as Cadena "
                              + " FROM sap_KEE_Resumen_ES_POR_MT_BTE_New "
                              + " Where segmento ='BTN' "
                              + " AND FH_CARGA >= ("
                              + "   SELECT MIN(A.FH_CARGA) FROM"
                              + "   ("
                              + "       SELECT distinct FH_CARGA"
                              + "       FROM sap_KEE_Resumen_ES_POR_MT_BTE_New"
                              + "       Where segmento in ('BTN')"
                              + "      ORDER BY FH_CARGA DESC"
                              + "       LIMIT 5"
                              + "   ) AS A"
                              + ")"
                              + " order by FH_CARGA desc";
                        }

                        db = new MySQLDB(MySQLDB.Esquemas.FAC);
                        command = new MySqlCommand(strSql, db.con);
                        r = command.ExecuteReader();
                        f = 1;

                        List<string> lista_Prueba = new List<string>();

                        while (r.Read())
                        {
                            f++;
                            lista_Prueba.Add(ArreglaCadena(r["Cadena"].ToString()));
    
                        }

                        if (p == 1)
                        {
                            TotalPruebaES = f;
                        }
                        if (p == 2)
                        {
                            TotalPruebaMTBTE = f;
                        }
                        if (p == 3)
                        {
                            TotalPruebaBTN = f;
                        }

                        workSheet.Cells["A2"].LoadFromCollection(lista_Prueba);

                        db.CloseConnection();
                    }
                    /// Fin Prueba columnas2
                    /// 


                    //////CREAMOS LAS  HOJAS RESUMEN DE TABLAS DINAMICAS
                    ////////for (int p = 1; p < 4; p++)
                    ////////{
                    ////////    if (p == 1)
                    ////////    {
                    ////////        workSheet = excelPackage.Workbook.Worksheets.Add("TD_ESP_MT");
                    ////////        strSql = "SELECT estado_global,  subestado,Incidencia_Facturacion, sum(CASE WHEN periodo = '1P' then 1 ELSE '' END) AS 'P1', sum(CASE WHEN periodo = '>1P' then 1 ELSE '' END) AS '>1P', COUNT(subestado) AS Total"
                    ////////            + " from sap_KEE_Resumen_ES_POR_MT_BTE_New "
                    ////////            + " WHERE fh_carga = '" + DateTime.Now.ToString("yyyy-MM-dd") + "'"
                    ////////            + " AND segmento IS NULL"
                    ////////            + " GROUP BY   estado_global,   subestado, Incidencia_Facturacion"
                    ////////            + " ORDER BY ESTADO_GLOBAL, Incidencia_Facturacion, PERIODO";
                    ////////    }
                    ////////    if (p == 2)
                    ////////    {
                    ////////        workSheet = excelPackage.Workbook.Worksheets.Add("TD_PTG_MT+BTE");
                    ////////        strSql = "SELECT estado_global,  subestado,Incidencia_Facturacion, sum(CASE WHEN periodo = '1P' then 1 ELSE '' END) AS 'P1', sum(CASE WHEN periodo = '>1P' then 1 ELSE '' END) AS '>1P', COUNT(subestado) AS Total"
                    ////////            + " from sap_KEE_Resumen_ES_POR_MT_BTE_New "
                    ////////            + " WHERE fh_carga = '" + DateTime.Now.ToString("yyyy-MM-dd") + "'"
                    ////////            + " AND segmento IN ('MT','BTE')"
                    ////////            + " GROUP BY   estado_global,   subestado, Incidencia_Facturacion"
                    ////////            + " ORDER BY ESTADO_GLOBAL, Incidencia_Facturacion, PERIODO";
                    ////////    }
                    ////////    if (p == 3)
                    ////////    {
                    ////////        workSheet = excelPackage.Workbook.Worksheets.Add("TD_PTG_BTN");
                    ////////        strSql = "SELECT estado_global,  subestado,Incidencia_Facturacion, sum(CASE WHEN periodo = '1P' then 1 ELSE '' END) AS 'P1', sum(CASE WHEN periodo = '>1P' then 1 ELSE '' END) AS '>1P', COUNT(subestado) AS Total"
                    ////////            + " from sap_KEE_Resumen_ES_POR_MT_BTE_New "
                    ////////            + " WHERE fh_carga = '" + DateTime.Now.ToString("yyyy-MM-dd") + "'"
                    ////////            + " AND segmento IN ('BTN')"
                    ////////            + " GROUP BY   estado_global,   subestado, Incidencia_Facturacion"
                    ////////            + " ORDER BY ESTADO_GLOBAL, Incidencia_Facturacion, PERIODO";
                    ////////    }

                    ////////    headerCells = workSheet.Cells[1, 1, 1, 32];
                    ////////    headerFont = headerCells.Style.Font;

                    ////////    //Ponemos columnas directamente
                    ////////    f = 2;
                    ////////    c = 2;

                    ////////    workSheet.Cells[f, c].Value = "ESTADO_GLOBAL"; c++;
                    ////////    workSheet.Cells[f, c].Value = "SUBESTADO"; c++;
                    ////////    workSheet.Cells[f, c].Value = "INCIDENCIA_FACTURACION"; c++;
                    ////////    workSheet.Cells[f, c].Value = "P1"; c++;
                    ////////    workSheet.Cells[f, c].Value = ">P1"; c++;
                    ////////    workSheet.Cells[f, c].Value = "TOTAL"; c++;

                    ////////    headerCells = workSheet.Cells[1, 1, 1, c];
                    ////////    headerFont = headerCells.Style.Font;
                    ////////    headerFont.Bold = true;

                    ////////    db = new MySQLDB(MySQLDB.Esquemas.FAC);
                    ////////    command = new MySqlCommand(strSql, db.con);
                    ////////    r = command.ExecuteReader();
                    ////////    f = 3;
                    ////////    PintarDinamico = "";
                    ////////    while (r.Read())
                    ////////    {
                    ////////        f++;
                    ////////        c = 2;

                    ////////        if (r["estado_global"] != System.DBNull.Value)
                    ////////        {
                    ////////            if (PintarDinamico == "" || PintarDinamico != r["estado_global"].ToString())
                    ////////            {
                    ////////                workSheet.Cells[f, c].Value = r["estado_global"].ToString();
                    ////////            }
                    ////////            PintarDinamico = r["estado_global"].ToString();
                    ////////        }
                    ////////        c++;

                    ////////        if (r["subestado"] != System.DBNull.Value)
                    ////////            workSheet.Cells[f, c].Value = r["subestado"].ToString();
                    ////////            workSheet.Cells["B3:B4"].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                    ////////        c++;
                    ////////        if (r["Incidencia_Facturacion"] != System.DBNull.Value)
                    ////////            workSheet.Cells[f, c].Value = r["Incidencia_Facturacion"].ToString();
                    ////////        c++;
                    ////////        if (r["P1"] != System.DBNull.Value)
                    ////////            workSheet.Cells[f, c].Value = r["P1"].ToString();
                    ////////        c++;
                    ////////        if (r[">P1"] != System.DBNull.Value)
                    ////////            workSheet.Cells[f, c].Value = r[">P1"].ToString();
                    ////////        c++;
                    ////////        if (r["Total"] != System.DBNull.Value)
                    ////////            workSheet.Cells[f, c].Value = r["Total"].ToString();
                    ////////        c++;

                    ////////        allCells = workSheet.Cells[1, 1, f, c];
                    ////////        allCells.AutoFitColumns();
                    ////////    }
                    ////////    db.CloseConnection();

                    ////////} /// FIN  CREAMOS LAS  HOJAS RESUMEN DE TABLAS DINAMICAS

                    //Paco 16/02/2024
                    //Está grabado ya el detalle diario en las tablas de histórico, los puntos migrados los tenemos en las tablas t_ed_h_ps  y t_ed_h_ps_pt
                    //////select * from cont.t_ed_h_ps     where de_seg_mercado = 'SE'  and lg_migrado_sap = 'S';
                    //////SELECT * FROM t_ed_h_ps_pt where de_seg_mercado = 'GP'  and lg_migrado_sap = 'S'

                    //nombrecolumna = hojaActual.getCellByPosition(intColumna, 0).getColumns.getByIndex(0).getName;
                    ////nombrecolumna = Mid(hojaActual.Cells(1, intColumna).Address, 2, InStr(2, hojaActual.Cells(1, intColumna).Address, "$") - 2);
                    //////hojaActual.Cells["A1"].Value = "Esto funciona!";
                    //////var rangoDeCeldas = hojaActual.Cells["C1:C3"];
                    //////rangoDeCeldas = hojaActual.Cells["$C$1:$C$3"];

                    //////CREAMOS LAS  HOJAS RESUMEN DE TABLAS DINAMICAS *********************************************************************************
                    for (int k = 1; k < 4; k++)
                    {

                        TotalParcial = 0;
                        TotalCuadro = 0;
                        TotalGeneral = 0;
                        CuadroInicio = 0;
                        CuadroFin = 0;
                        ExistenDatosCuadro = false;

                        if (k == 1)
                        {
                            workSheet = excelPackage.Workbook.Worksheets.Add("TD_ESP_MT");
                        }
                        if (k == 2)
                        {
                            workSheet = excelPackage.Workbook.Worksheets.Add("TD_PTG_MT+BTE");
                        }
                        if (k == 3)
                        {
                            workSheet = excelPackage.Workbook.Worksheets.Add("TD_PTG_BTN");
                        }

                        //////headerCells = workSheet.Cells[1, 1, 1, 32];
                        //////headerFont = headerCells.Style.Font;

                        //////for (int t = 1; t < 3; t++)
                        //////{

                        PintarEstado = "";
                        PintarSubestado = "";
                        TotalParcial = 0;
                        TotalCuadro = 0;
                        TotalGeneral = 0;
                        CuadroFin = 0;

                        //////if (t == 1)
                        //////{
                        //////Piloto = "Ola 1";
                        //////workSheet.Cells[1, 1].Value = Piloto;
                        headerCells = workSheet.Cells[1, 1, 1, 1];
                        headerFont = headerCells.Style.Font;
                        headerFont.Bold = true;

                        f = 2;
                        c = 2;

                        workSheet.Cells[f, c].Value = "ESTADO_GLOBAL"; c++;
                        workSheet.Cells[f, c].Value = "SUBESTADO"; c++;
                        workSheet.Cells[f, c].Value = "INCIDENCIA_FACTURACION"; c++;
                        workSheet.Cells[f, c].Value = "INCIDENCIA_MEDIDA"; c++;
                        ////////    workSheet.Cells[f, c].Value = "P1"; c++;
                        ////////    workSheet.Cells[f, c].Value = ">P1"; c++;
                        workSheet.Cells[f, c].Value = "TOTAL"; c++;

                        headerCells = workSheet.Cells[f, 2, f, c];
                        headerFont = headerCells.Style.Font;
                        headerFont.Bold = true;
                        BordeCuadro = "B2:F2";
                        workSheet.Cells[BordeCuadro].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                        CuadroInicio = 3;
                        //////}
                        //////if (t == 2)
                        //////{
                        //////    //////if (ExistenDatosCuadro == false)
                        //////    //////{

                        //////    //////}
                        //////    //////else
                        //////    //////{

                        //////    //////}
                        //////    f++;
                        //////    f++;
                        //////    Piloto = "Piloto 1, 2 y 3";
                        //////    workSheet.Cells[f, 1].Value = Piloto;
                        //////    headerCells = workSheet.Cells[f, 1, f, 1];
                        //////    headerFont = headerCells.Style.Font;
                        //////    headerFont.Bold = true;
                        //////    CuadroInicio = f + 1;       
                        //////}

                        if (k == 1)
                        {
                            strSql = "SELECT estado_global,  subestado, Incidencia_Facturacion, Incidencia_Medida, sum(CASE WHEN periodo = '1P' then 1 ELSE '' END) AS 'P1', sum(CASE WHEN periodo = '>1P' then 1 ELSE '' END) AS '>1P', COUNT(subestado) AS Total"
                                + " from sap_KEE_Resumen_ES_POR_MT_BTE_New "
                                //////+ " INNER JOIN SAP_PILOTO "
                                //////+ " ON sap_KEE_Resumen_ES_POR_MT_BTE_New.CUPS20 = SAP_PILOTO.CD_CUPS "
                                + " WHERE fh_carga = '" + DateTime.Now.ToString("yyyy-MM-dd") + "'"
                                + " AND segmento IS NULL"
                                //////+ " AND Piloto='" + Piloto + "'"
                                + " GROUP BY   estado_global,   subestado, Incidencia_Facturacion, Incidencia_Medida"
                                + " ORDER BY ESTADO_GLOBAL, subestado, Incidencia_Facturacion, Incidencia_Medida, PERIODO";
                        }
                        if (k == 2)
                        {
                            strSql = "SELECT estado_global,  subestado,Incidencia_Facturacion,Incidencia_Medida,  sum(CASE WHEN periodo = '1P' then 1 ELSE '' END) AS 'P1', sum(CASE WHEN periodo = '>1P' then 1 ELSE '' END) AS '>1P', COUNT(subestado) AS Total"
                                + " from sap_KEE_Resumen_ES_POR_MT_BTE_New "
                                //////+ " INNER JOIN SAP_PILOTO "
                                //////+ " ON sap_KEE_Resumen_ES_POR_MT_BTE_New.CUPS20 = SAP_PILOTO.CD_CUPS "
                                + " WHERE fh_carga = '" + DateTime.Now.ToString("yyyy-MM-dd") + "'"
                                + " AND segmento IN ('MT','BTE')"
                                //////+ " AND Piloto='" + Piloto + "'"
                                + " GROUP BY   estado_global,   subestado, Incidencia_Facturacion, Incidencia_Medida"
                                + " ORDER BY ESTADO_GLOBAL, subestado, Incidencia_Facturacion, Incidencia_Medida, PERIODO";
                        }
                        if (k == 3)
                        {
                            strSql = "SELECT estado_global,  subestado, Incidencia_Facturacion, Incidencia_Medida, sum(CASE WHEN periodo = '1P' then 1 ELSE '' END) AS 'P1', sum(CASE WHEN periodo = '>1P' then 1 ELSE '' END) AS '>1P', COUNT(subestado) AS Total"
                                + " from sap_KEE_Resumen_ES_POR_MT_BTE_New "
                                //////+ " INNER JOIN SAP_PILOTO "
                                //////+ " ON sap_KEE_Resumen_ES_POR_MT_BTE_New.CUPS20 = SAP_PILOTO.CD_CUPS "
                                + " WHERE fh_carga = '" + DateTime.Now.ToString("yyyy-MM-dd") + "'"
                                + " AND segmento IN ('BTN')"
                                //////+ " AND Piloto='" + Piloto + "'"
                                + " GROUP BY   estado_global,   subestado, Incidencia_Facturacion, Incidencia_Medida"
                                + " ORDER BY ESTADO_GLOBAL, subestado, Incidencia_Facturacion, Incidencia_Medida, PERIODO";
                        }

                        db = new MySQLDB(MySQLDB.Esquemas.FAC);
                        command = new MySqlCommand(strSql, db.con);
                        r = command.ExecuteReader();

                        ExistenDatosCuadro = false;

                        while (r.Read())
                        {
                            ExistenDatosCuadro = true;
                            f++;
                            c = 2;

                            if (r["estado_global"] != System.DBNull.Value)
                            {
                                if (PintarEstado == "" || PintarEstado != r["estado_global"].ToString())
                                {
                                    ////workSheet.Cells[f, c].Value = r["estado_global"].ToString();
                                    if (PintarEstado != r["estado_global"].ToString() & PintarEstado != "")
                                    {
                                        //Paco 02/10/2024
                                        workSheet.Cells[CuadroInicio, 2].Value = PintarEstado;
                                        /////

                                        CuadroFin = f - 1;
                                        BordeCuadro = "B" + CuadroInicio.ToString() + ":F" + CuadroFin.ToString();

                                        ///Pinto Fila de Totales
                                        workSheet.Cells[f, 2].Value = " Total " + EtiquetaEstado;
                                        headerCells = workSheet.Cells[f, 2, f, 6];
                                        headerFont = headerCells.Style.Font;
                                        headerFont.Bold = true;
                                        workSheet.Cells[f, 6].Value = TotalParcial;
                                        TotalParcial = 0;
                                        f++;

                                        CuadroInicio = f;
                                        workSheet.Cells[BordeCuadro].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                                        PintarSubestado = "";
                                    }
                                }

                                PintarEstado = r["estado_global"].ToString();
                                EtiquetaEstado = PintarEstado;
                            }
                            c++;

                            if (r["subestado"] != System.DBNull.Value)
                            {
                                if (PintarSubestado == "" || PintarSubestado != r["subestado"].ToString())
                                {
                                    workSheet.Cells[f, c].Value = r["subestado"].ToString();
                                }
                                PintarSubestado = r["subestado"].ToString();
                            }

                            c++;
                            if (r["Incidencia_Facturacion"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, c].Value = r["Incidencia_Facturacion"].ToString();
                            }
                            c++;
                            if (r["Incidencia_Medida"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, c].Value = r["Incidencia_Medida"].ToString();
                            }
                            c++;
                            ////////if (r["P1"] != System.DBNull.Value)
                            ////////    workSheet.Cells[f, c].Value = r["P1"].ToString();
                            ////////c++;
                            ////////if (r[">P1"] != System.DBNull.Value)
                            ////////    workSheet.Cells[f, c].Value = r[">P1"].ToString();
                            ////////c++;
                            if (r["Total"] != System.DBNull.Value)
                            {
                                workSheet.Cells[f, c].Value = r["Total"];
                                TotalParcial = TotalParcial + Convert.ToInt32(r["Total"]);
                                TotalCuadro = TotalCuadro + Convert.ToInt32(r["Total"]);
                            }

                            c++;
                            allCells = workSheet.Cells[1, 1, f, c];
                            allCells.AutoFitColumns();
                        }
                        db.CloseConnection();

                        strSql = "";

                        if (ExistenDatosCuadro == true)
                        {
                            //Pinto el recuadro final
                            //Paco 02/10/2024
                            workSheet.Cells[CuadroInicio, 2].Value = PintarEstado;
                            /////
                            CuadroFin = f;
                            BordeCuadro = "B" + CuadroInicio.ToString() + ":F" + CuadroFin.ToString();
                            workSheet.Cells[BordeCuadro].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                            ///Pinto Fila de Estado
                            f++;
                            workSheet.Cells[f, 2].Value = " Total " + EtiquetaEstado;
                            workSheet.Cells[f, 6].Value = TotalParcial;
                            headerCells = workSheet.Cells[f, 2, f, 6];
                            headerFont = headerCells.Style.Font;
                            headerFont.Bold = true;
                            TotalParcial = 0;
                            f++;
                            workSheet.Cells[f, 1].Value = " Total " + Piloto;
                            workSheet.Cells[f, 6].Value = TotalCuadro;
                            headerCells = workSheet.Cells[f, 1, f, 6];
                            headerFont = headerCells.Style.Font;
                            headerFont.Bold = true;
                            TotalParcial = 0;
                            TotalCuadro = 0;

                            allCells = workSheet.Cells[1, 1, f, c];
                            allCells.AutoFitColumns();
                        }

                        //////} //// FIN for (int t = 1; t < 3; t++)
                    } //// for (int k = 1; k < 4; k++)
                    //// FIN  CREAMOS LAS  HOJAS RESUMEN DE TABLAS DINAMICAS *****************************************************************************


                    excelPackage.SaveAs(fileInfo);

                    //27/08/2024 Separar por columnas usando Aspose.Cells **************************
                    Workbook wb = new Workbook(ruta_salida_archivo);
   
                    TxtLoadOptions opts = new TxtLoadOptions();
                    opts.Separator = ';';

                    //Formateo de fechas
                    Style style = wb.CreateStyle();
                    style.Custom = "yyyy-mm-dd";

                    StyleFlag styleFlag = new StyleFlag();
                    styleFlag.NumberFormat = true;

                    for (int p = 1; p < 4; p++)
                    {
                        if (p == 1)
                        {
                            Worksheet sheet = wb.Worksheets["HISTORICO ES"];
                            sheet.Cells.TextToColumns(0, 0, TotalPruebaES, opts);
                            sheet.Cells.TextToColumns(0, 0, TotalPruebaES, opts);

                            Column column = sheet.Cells.Columns[3];
                            // Applying the style to the column
                            column.ApplyStyle(style, styleFlag);

                            column = sheet.Cells.Columns[4];
                            column.ApplyStyle(style, styleFlag);

                            for (int u = 26; u < 32; u++)
                            {
                                column = sheet.Cells.Columns[u];
                                column.ApplyStyle(style, styleFlag);
                            }
                            column = sheet.Cells.Columns[43];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet.Cells.Columns[44];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet.Cells.Columns[49];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet.Cells.Columns[50];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet.Cells.Columns[53];
                            column.ApplyStyle(style, styleFlag);

                            sheet.AutoFitColumns();

                        }
                        if (p == 2)
                        {
                            Worksheet sheet2 = wb.Worksheets["HISTORICO POR MT-BTE"];
                            sheet2.Cells.TextToColumns(0, 0, TotalPruebaMTBTE, opts);

                            Column column = sheet2.Cells.Columns[3];
                            // Applying the style to the column
                            column.ApplyStyle(style, styleFlag);

                            column = sheet2.Cells.Columns[4];
                            column.ApplyStyle(style, styleFlag);

                            for (int u = 26; u < 32; u++)
                            {
                                column = sheet2.Cells.Columns[u];
                                column.ApplyStyle(style, styleFlag);
                            }
;
                            column = sheet2.Cells.Columns[44];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet2.Cells.Columns[45];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet2.Cells.Columns[50];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet2.Cells.Columns[51];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet2.Cells.Columns[54];
                            column.ApplyStyle(style, styleFlag);
                            sheet2.AutoFitColumns();
                        }
                        if (p == 3)
                        {
                            Worksheet sheet3 = wb.Worksheets["HISTORICO POR BTN"];
                            sheet3.Cells.TextToColumns(0, 0, TotalPruebaBTN, opts);

                            Column column = sheet3.Cells.Columns[3];
                            // Applying the style to the column
                            column.ApplyStyle(style, styleFlag);
                            column = sheet3.Cells.Columns[4];
                            column.ApplyStyle(style, styleFlag);

                            for (int u = 26; u < 32; u++)
                            {
                                column = sheet3.Cells.Columns[u];
                                column.ApplyStyle(style, styleFlag);
                            }
                            column = sheet3.Cells.Columns[44];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet3.Cells.Columns[45];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet3.Cells.Columns[50];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet3.Cells.Columns[51];
                            column.ApplyStyle(style, styleFlag);
                            column = sheet3.Cells.Columns[54];
                            column.ApplyStyle(style, styleFlag);
                            sheet3.AutoFitColumns();
                        }
                    }

                    ////////wb.worksheet("Evaluation Warning").IsVisible = false;
                    wb.Save(ruta_salida_archivo);

                    //Fin 27/08/2024 Separar por columnas usando Aspose.Cells ************************************

                    //29/08/2024 Abro con Interop.EXcel para ocultar la hoja que crea el expose ******************
                    Microsoft.Office.Interop.Excel.Application excel = new Microsoft.Office.Interop.Excel.Application();
                    Microsoft.Office.Interop.Excel.Workbook librodetrabajo = excel.Workbooks.Open(ruta_salida_archivo);
                    ////Dimension = librodetrabajo.Worksheets.Count - 1;
                    //////librodetrabajo.Sheets["Evaluation Warning"].Remove();
                    //////librodetrabajo.Sheets["Evaluation Warning"].isVisible = false;
                    librodetrabajo.Sheets["Evaluation Warning"].Visible = Excel.XlSheetVisibility.xlSheetHidden;
                    ///librodetrabajo.Savechanged(ruta_salida_archivo);
                    librodetrabajo.Close(true);
                    excel.Quit();
                    //29/08/2024 Fin *****************************************************************************

                    if (param.GetValue("mail_enviar_mail_sap_kronos") == "S")
                    {
                        //Lanzamos ejecutable para subir a sharepoint el informe
                        utilidades.Fichero.EjecutaComando(param.GetValue("ruta_ejecutable_SubirSP_InformeSAPKEE"), null);
                        
                        EnvioCorreo_SAP_KEE(ruta_salida_archivo, fecha_informe, "Hoja ES (" + intConteoES.ToString() + "/" + intConteoESDetalle.ToString() + ") Procesados;Hoja MT-BTE (" + intConteoMTBTE.ToString() + "/" + intConteoMTBTEDetalle.ToString() + ") Procesados;Hoja BTN (" + intConteoBTN.ToString() + "/" + intConteoBTNDetalle.ToString() + ") Procesados", SubestadosNoEncontrados.ToString(), FechaSapPendienteFacturar_fhenvio, FechaPdteWebB2B_fhact, FechaPdteWebB2B_fhInforme);
                    }
                    //////MessageBox.Show("Hoja ES (" + intConteoES.ToString() + "/" + intConteoESDetalle.ToString() + "') Procesados");
                    //////MessageBox.Show("Hoja MT-BTE (" + intConteoMTBTE.ToString() + "/" + intConteoMTBTEDetalle.ToString() + "') Procesados");
                    //////MessageBox.Show("BTN (" + intConteoBTN.ToString() + "/" + intConteoBTNDetalle.ToString() + "') Procesados");
                    //////MessageBox.Show("Hoja Subestado " + SubestadosNoEncontrados.ToString() + " no existe en la tabla paramétrica");

                    if (automatico && param.GetValue("mail_enviar_mail_psat_tam") == "S")
                    {
                        ss_pp.Update_Fecha_Fin("Facturación", "Informe Pendiente KRONOS SAP BI", "Informe Pendiente KRONOS SAP BI");
                        EnvioCorreo_PdteWeb_BI(ruta_salida_archivo, fecha_informe);
                    }

                    if (automatico)
                        ss_pp.Update_Fecha_Fin("Facturación", "Informe Pendiente KRONOS SAP BI", "Informe Pendiente KRONOS SAP BI");

                }
                else if (automatico)
                {
                    ss_pp.Update_Comentario("Facturación", "Informe Pendiente KRONOS SAP BI", "Informe Pendiente KRONOS SAP BI",
                        "La fecha de actualización en BI es: " + UltimaActualizacionMySQL().Date.ToString("dd/MM/yyyy"));
                }
            }

            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);

            }
        }


        private static string ArreglaCadena(String t)
        {
            String salida;

            salida = t.Replace("\"", string.Empty); //string.Empty
            salida = salida.Replace("\\", string.Empty);
            salida = salida.Replace("\t", string.Empty);
            salida = salida.Replace("\n", string.Empty);
            salida = salida.Replace("\r", string.Empty);
            salida = salida.Replace("(\n|\r)", string.Empty);
            salida = salida.Replace("'", "´");
            salida = salida.Replace("Âª", string.Empty);
            salida = salida.Replace("_", "-");
            salida = salida.Trim();
            return salida;
        }

        private int FuncionDiasKEERecuperarDiasTabla(string Cups, string FechaDesde, string FechaHasta, string Estado)
        {
            Boolean blnLanzarDiasKEE;
            MySQLDB dbDiasKEE;
            MySqlDataReader DiasKEE;
            MySQLDB dbDiasKEEMax;
            MySqlDataReader DiasKEEMax;
            MySQLDB db;
            MySqlCommand command;
            string strSql = "";

            string BuscaCadena = "";
            int Dias = 1;

            strSql = "select Dias as Numero from kee_Dias"
                   + " WHERE cups = '" + Cups + "'"
                   + " AND fh_desde = '" + FechaDesde + "'"
                   + " AND fh_hasta = '" + FechaHasta + "'"
                   + " AND estadoKEE = '" + Estado + "'"
                   + " AND Activo = true";

            dbDiasKEE = new MySQLDB(MySQLDB.Esquemas.MED);
            command = new MySqlCommand(strSql, dbDiasKEE.con);
            DiasKEE = command.ExecuteReader();

            while (DiasKEE.Read())
            {
                Dias = Convert.ToInt32(DiasKEE["Numero"]) ;
            }

            dbDiasKEE.CloseConnection();
            return Dias;
        }

        private int FuncionDiasKEERecuperarDiasTablaGlobal(string Cups, string FechaDesde, string FechaHasta, string Estado)
        {
            Boolean blnLanzarDiasKEE;
            MySQLDB dbDiasKEE;
            MySqlDataReader DiasKEE;
            MySQLDB dbDiasKEEMax;
            MySqlDataReader DiasKEEMax;
            MySQLDB db;
            MySqlCommand command;
            string strSql = "";

            string BuscaCadena = "";
            int Dias = 1;

            strSql = "select Dias as Numero from kee_Dias_Global"
                   + " WHERE cups = '" + Cups + "'"
                   + " AND fh_desde = '" + FechaDesde + "'"
                   + " AND fh_hasta = '" + FechaHasta + "'"
                   + " AND EstadoGlobal = '" + Estado + "'"
                   + " AND Activo = true";

            dbDiasKEE = new MySQLDB(MySQLDB.Esquemas.MED);
            command = new MySqlCommand(strSql, dbDiasKEE.con);
            DiasKEE = command.ExecuteReader();

            while (DiasKEE.Read())
            {
                Dias = Convert.ToInt32(DiasKEE["Numero"]);
            }

            dbDiasKEE.CloseConnection();
            return Dias;
        }

        private int FuncionDiasKEE( string Cups, string FechaDesde, string FechaHasta, string Estado)
        {
            Boolean blnLanzarDiasKEE;
            MySQLDB dbDiasKEE;
            MySqlDataReader DiasKEE;
            MySQLDB dbDiasKEEMax;
            MySqlDataReader DiasKEEMax;
            MySQLDB db;
            MySqlCommand command;
            string strSql = "";

            string BuscaCadena="";
            int Dias=1;

            strSql = "select Dias as Numero from kee_Dias"
                   + " WHERE cups = '" + Cups + "'"
                   + " AND fh_desde = '" + FechaDesde + "'"
                   + " AND fh_hasta = '" + FechaHasta + "'"
                   + " AND estadoKEE = '" + Estado + "'"
                   + " AND Activo = true";

             dbDiasKEE = new MySQLDB(MySQLDB.Esquemas.MED);
             command = new MySqlCommand(strSql, dbDiasKEE.con);
             DiasKEE = command.ExecuteReader();

             while (DiasKEE.Read())
             {
                if (Convert.ToInt32(DiasKEE["Numero"]) == 0)
                {
                    strSql = "INSERT INTO kee_Dias (CUPS, FH_DESDE, FH_HASTA, estadoKEE, Activo, Dias, FH_ACTUALIZACION) values ('"
                           + Cups + "','"
                           + FechaDesde + "','"
                           + FechaHasta + "','"
                           + Estado + "',true,1,'" + DateTime.Now.ToString("yyyy-MM-dd") + "')";
         

                    db = new MySQLDB(MySQLDB.Esquemas.MED);
                    command = new MySqlCommand(strSql, db.con);
                    command.ExecuteNonQuery();
                    db.CloseConnection();

                    Dias = 1;
                }
                else
                {

                    //Existe el registro, actualizo el numero de dias a dias+1 y PROCESADO_DIARIO='S'
                    strSql = "update kee_Dias  set"
                    + " DIAS = DIAS +1,"
                    + " FH_ACTUALIZACION='" + DateTime.Now.ToString("yyyy-MM-dd") + "'"
                    + " WHERE cups = '" + Cups + "'"
                    + " AND fh_desde = '" + FechaDesde + "'"
                    + " AND fh_hasta = '" + FechaHasta + "'"
                    + " AND estadoKEE = '" + Estado + "'"
                    + " AND Activo = true";
        
                    db = new MySQLDB(MySQLDB.Esquemas.MED);
                    command = new MySqlCommand(strSql, db.con);
                    command.ExecuteNonQuery();
                    db.CloseConnection();

                    Dias = Convert.ToInt32(DiasKEE["Numero"]) +1;
                }
              }

              dbDiasKEE.CloseConnection();
              return Dias;
        }


        private int FuncionDiasKEEGlobal(string Cups, string FechaDesde, string FechaHasta, string Estado)
        {
            Boolean blnLanzarDiasKEE;
            MySQLDB dbDiasKEE;
            MySqlDataReader DiasKEE;
            MySQLDB dbDiasKEEMax;
            MySqlDataReader DiasKEEMax;
            MySQLDB db;
            MySqlCommand command;
            string strSql = "";

            string BuscaCadena = "";
            int Dias = 1;

            strSql = "select Dias as Numero from kee_Dias_Global"
                   + " WHERE cups = '" + Cups + "'"
                   + " AND fh_desde = '" + FechaDesde + "'"
                   + " AND fh_hasta = '" + FechaHasta + "'"
                   + " AND EstadoGlobal = '" + Estado + "'"
                   + " AND Activo = true";

            dbDiasKEE = new MySQLDB(MySQLDB.Esquemas.MED);
            command = new MySqlCommand(strSql, dbDiasKEE.con);
            DiasKEE = command.ExecuteReader();

            while (DiasKEE.Read())
            {
                if (Convert.ToInt32(DiasKEE["Numero"]) == 0)
                {
                    strSql = "INSERT INTO kee_Dias_Global (CUPS, FH_DESDE, FH_HASTA, EstadoGlobal, Activo, Dias, FH_ACTUALIZACION) values ('"
                           + Cups + "','"
                           + FechaDesde + "','"
                           + FechaHasta + "','"
                           + Estado + "',true,1,'" + DateTime.Now.ToString("yyyy-MM-dd") + "')";


                    db = new MySQLDB(MySQLDB.Esquemas.MED);
                    command = new MySqlCommand(strSql, db.con);
                    command.ExecuteNonQuery();
                    db.CloseConnection();

                    Dias = 1;
                }
                else
                {

                    //Existe el registro, actualizo el numero de dias a dias+1 y PROCESADO_DIARIO='S'
                    strSql = "update kee_Dias_Global  set"
                    + " DIAS = DIAS +1,"
                    + " FH_ACTUALIZACION='" + DateTime.Now.ToString("yyyy-MM-dd") + "'"
                    + " WHERE cups = '" + Cups + "'"
                    + " AND fh_desde = '" + FechaDesde + "'"
                    + " AND fh_hasta = '" + FechaHasta + "'"
                    + " AND  EstadoGlobal= '" + Estado + "'"
                    + " AND Activo = true";

                    db = new MySQLDB(MySQLDB.Esquemas.MED);
                    command = new MySqlCommand(strSql, db.con);
                    command.ExecuteNonQuery();
                    db.CloseConnection();

                    Dias = Convert.ToInt32(DiasKEE["Numero"]) + 1;
                }
            }

            dbDiasKEE.CloseConnection();
            return Dias;
        }

        private string EstadosAreas_old(string EstadoGlobal, string Cups, string Periodo, int HojaPintar, int NumeroDiasKEE, Boolean Incidencia)
        {

            MySQLDB dbReporte;
            MySqlCommand command;
            MySqlDataReader r;
            MySqlDataReader inci;
            MySqlDataReader reporte;
            string strSql = "";
            Boolean EstadosReporte;
            string cadena = "";
            string Auxiliar = "";

           
            if (HojaPintar < 3)
            {
                strSql = " select ESTADO_GLOBAL,ESTADO_GLOBAL_A_REPORTAR, SISTEMA  from estados_KEE_Param_EstadosReporte_New"
                       + " where Subestado='" + EstadoGlobal + "'"
                       + " and NivelTension <> 'BTN'";
            }
            else
            {
                strSql = " select ESTADO_GLOBAL,ESTADO_GLOBAL_A_REPORTAR, SISTEMA  from estados_KEE_Param_EstadosReporte_New"
                      + " where Subestado='" + EstadoGlobal + "'"
                      + " and NivelTension <> 'MT'";
            }
                                 

            dbReporte = new MySQLDB(MySQLDB.Esquemas.MED);
            command = new MySqlCommand(strSql, dbReporte.con);
            reporte = command.ExecuteReader();

            EstadosReporte = false;
            while (reporte.Read())
            {
                EstadosReporte = true;

                Auxiliar = reporte["ESTADO_GLOBAL"].ToString();

                // para controlar si hay incidencia los que en el ESTADO_GLOBAL viene la etíqueta "SIN CODIGO"
                if (Auxiliar.Contains("SIN CÓDIGO"))
                {
                    if (Auxiliar.Contains("MEDIDA"))
                    {
                        if (Incidencia == true)
                        {
                            Auxiliar = "INCIDENCIAMEDIDA";
                        }

                        if (Auxiliar.Contains("FACTURACIÓN"))
                        {
                            if (Incidencia == true)
                            {
                                Auxiliar = "INCIDENCIAFACTURACION";
                            }
                        }
                    }
                }

                switch (Auxiliar)
                {
                    case "FACTURACION":
                        // Si cruza,  los que estén en incidencia, los tiene que marcar como 02_INCIDENCIA FACTURACIÓN. Y en este caso, tendrán un código de incidencia. (02_INCIDENCIA FACTURACIÓN CON CÓDIGO - 02_INCIDENCIA )
                        // Si no cruza: MIRAR CAMPO DIAS_ESTADO  Si el periodo lleva en el mismo estado menos de 6 días "Estado transitorio, AVANZA" (05_AVANZA FACTURACIÓN - 05_AVANZA)
                        // Si el periodo lleva igual o más de 6 días "02_INCIDENCIA FACTURACIÓN".Y en este caso, no tendrán un código de incidencia. (021_INCIDENCIA FACTURACIÓN SIN CÓDIGO - 021_INCIDENCIA SIN COGIGO)

                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACIÓN CON CÓDIGO";
                            cadena= cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC"; 
                        }
                        else
                        {
                            if (GetDiasEstado(Cups) >= 6)
                            {
                                cadena = "021_INCIDENCIA FACTURACIÓN SIN CÓDIGO";
                                cadena = cadena + ";" + "021_INCIDENCIA SIN CÓDIGO";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                            else
                            {
                                cadena = "05_AVANZA SISTEMAS";
                                cadena = cadena + ";" + "05_AVANZA";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                        }
                        break;

                    case "02_INCIDENCIA_FACTURACION":

                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACIÓN CON CÓDIGO";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            if (GetDiasEstado(Cups) >= 6)
                            {
                                cadena = "021_INCIDENCIA FACTURACIÓN SIN CÓDIGO";
                                cadena = cadena + ";" + "021_INCIDENCIA SIN CÓDIGO";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                            else
                            {
                                cadena = "05_AVANZA FACTURACIÓN";
                                cadena = cadena + ";" + "05_AVANZA";
                                cadena = cadena + ";" + "FACTURACIÓN";
                            }
                        }
                        break;

                    case "FACTURACION_AUX":

                        //Si el CUPS y PERIODO del pendiente cruza con el CUPS y PERIODO de la incidencia del fichero de incidencias ,entonces, automaticamente, el suministro se asigna a "02_INCIDENCIA FACTURACIÓN-02_INCIDENCIA
                        //No cruza : "04_PENDIENTE DE NEGOCIO - 04_PENDIENTE NEGOCIO FACTURACION"
                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACIÓN";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            cadena = "04_PENDIENTE NEGOCIO FACTURACION"; 
                            cadena = cadena + ";" + "04_PENDIENTE NEGOCIO";
                            cadena = cadena + ";" + "FACTURACIÓN";
                        }
                        break;

                    case "FACTURACION_BIS":

                        //////Si el periodo lleva menos de 6 días ""Estado transitorio, AVANZA""
                        //////Si el periodo lleva igual o más de 6 días ""02_INCIDENCIA FACTURACIÓN"""

                        if (GetDiasEstado(Cups) >= 6)
                        {
                            cadena = "02_INCIDENCIA FACTURACIÓN";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            cadena = "05_AVANZA SISTEMAS";
                            cadena = cadena + ";" + "05_AVANZA";
                            cadena = cadena + ";" + "EN AVANCE";
                        }

                        break;

                    case "FACTURACION_DESCONOCIDO":

                        if (GetDiasEstado(Cups) >= 10)
                        {
                            cadena = "02_INCIDENCIA FACTURACIÓN";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else {
                            cadena = "03_GAP FUNCIONAL";
                            cadena = cadena + ";" + "03_GAP FUNCIONAL";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }

                        break;

                    case "MEDIDA":

                        //////•	Si nº Dias KEE< 5
                        //////         o ESTADO_GLOBAL: 05_AVANZA SISTEMAS
                        //////         o ESTADO_GLOBAL A REPORTAR: 05_AVANZA
                        //////        o  ÁREA_ESTADO: AVANZA
                        //////•	Si nº Dias KEE >= 5
                        //////         o ESTADO_GLOBAL: 021_INCIDENCIA_MEDIDA SIN CODIGO o 02_INCIDENCIA_MEDIDA
                        //////        o  ESTADO_GLOBAL A REPORTAR: 021_INCIDENCIA_MEDIDA SIN CODIGO o 02_INCIDENCIA_MEDIDA
                        //////        o  ÁREA_ESTADO: SISTEMAS
                        ///
                        if (NumeroDiasKEE < 5)
                        {
                            cadena = "05_AVANZA SISTEMAS";
                            cadena = cadena + ";" + "05_AVANZA";
                            cadena = cadena + ";" + "MEDIDA";
                        }
                        else
                        {
                            if (Incidencia == true)
                            {
                                cadena = "02_INCIDENCIA_MEDIDA";
                                cadena = cadena + ";" + "02_INCIDENCIA_MEDIDA";
                                cadena = cadena + ";" + "SISTEMAS MED";
                            }
                            else
                            {
                                cadena = "021_INCIDENCIA_MEDIDA SIN CÓDIGO";
                                cadena = cadena + ";" + "02_INCIDENCIA_MEDIDA SIN CÓDIGO";
                                cadena = cadena + ";" + "SISTEMAS MED";
                            } 
                        }
                        break;

                    case "INCIDENCIAMEDIDA":
                        cadena = "02_INCIDENCIA_MEDIDA";
                        cadena = cadena + ";" + "02_INCIDENCIA";
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                    case "INCIDENCIAFACTURACION":

                        cadena = "02_INCIDENCIA_FACTURACIÓN";
                        cadena = cadena + ";" + "02_INCIDENCIA";
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                    default:

                        cadena = reporte["ESTADO_GLOBAL"].ToString();
                        cadena = cadena + ";" + reporte["ESTADO_GLOBAL_A_REPORTAR"].ToString();
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                }
            } // Fin  while (reporte.Read())

            if (EstadosReporte == false)
            {
                cadena = "";
                //////if (SubestadosNoEncontrados == "") {
                //////    SubestadosNoEncontrados = EstadoGlobal;
                //////}
                //////else {
                //////    SubestadosNoEncontrados = SubestadosNoEncontrados + ";" + EstadoGlobal;
                //////} 
            }
            dbReporte.CloseConnection();
            return cadena;
        }
        private string EstadosAreas_old_20241009(string EstadoGlobal, string Cups, string Periodo, int HojaPintar, int NumeroDiasKEE, Boolean Incidencia)
        {

            MySQLDB dbReporte;
            MySqlCommand command;
            MySqlDataReader r;
            MySqlDataReader inci;
            MySqlDataReader reporte;
            string strSql = "";
            Boolean EstadosReporte;
            string cadena = "";
            string Auxiliar = "";


            if (HojaPintar < 3)
            {
                strSql = " select ESTADO_GLOBAL,ESTADO_GLOBAL_A_REPORTAR, SISTEMA  from estados_KEE_Param_EstadosReporte_New"
                       + " where Subestado='" + EstadoGlobal + "'"
                       + " and NivelTension <> 'BTN'";
            }
            else
            {
                strSql = " select ESTADO_GLOBAL,ESTADO_GLOBAL_A_REPORTAR, SISTEMA  from estados_KEE_Param_EstadosReporte_New"
                      + " where Subestado='" + EstadoGlobal + "'"
                      + " and NivelTension <> 'MT'";
            }


            dbReporte = new MySQLDB(MySQLDB.Esquemas.MED);
            command = new MySqlCommand(strSql, dbReporte.con);
            reporte = command.ExecuteReader();

            EstadosReporte = false;
            while (reporte.Read())
            {
                EstadosReporte = true;

                Auxiliar = reporte["ESTADO_GLOBAL"].ToString();

                // para controlar si hay incidencia los que en el ESTADO_GLOBAL viene la etíqueta "SIN CODIGO"
                //////if (Auxiliar.Contains("SIN CÓDIGO"))
                //////{
                //////    if (Auxiliar.Contains("MEDIDA"))
                //////    {
                //////        if (Incidencia == true)
                //////        {
                //////            Auxiliar = "INCIDENCIAMEDIDA";
                //////        }

                //////        if (Auxiliar.Contains("FACTURACION"))
                //////        {
                //////            if (Incidencia == true)
                //////            {
                //////                Auxiliar = "INCIDENCIAFACTURACION";
                //////            }
                //////        }
                //////    }
                //////}

                switch (Auxiliar)
                {
                    case "FACTURACION":
                        // Si cruza,  los que estén en incidencia, los tiene que marcar como 02_INCIDENCIA FACTURACIÓN. Y en este caso, tendrán un código de incidencia. (02_INCIDENCIA FACTURACIÓN CON CÓDIGO - 02_INCIDENCIA )
                        // Si no cruza: MIRAR CAMPO DIAS_ESTADO  Si el periodo lleva en el mismo estado menos de 6 días "Estado transitorio, AVANZA" (05_AVANZA FACTURACIÓN - 05_AVANZA)
                        // Si el periodo lleva igual o más de 6 días "02_INCIDENCIA FACTURACIÓN".Y en este caso, no tendrán un código de incidencia. (021_INCIDENCIA FACTURACIÓN SIN CÓDIGO - 021_INCIDENCIA SIN COGIGO)

                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACION CON CÓDIGO";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            if (GetDiasEstado(Cups) >= 6)
                            {
                                cadena = "021_INCIDENCIA FACTURACION";
                                cadena = cadena + ";" + "021_INCIDENCIA";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                            else
                            {
                                cadena = "05_AVANZA SISTEMAS";
                                cadena = cadena + ";" + "05_AVANZA";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                        }
                        break;

                    case "02_INCIDENCIA_FACTURACION":

                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACION CON CÓDIGO";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            if (GetDiasEstado(Cups) >= 6)
                            {
                                cadena = "021_INCIDENCIA FACTURACION";
                                cadena = cadena + ";" + "021_INCIDENCIA";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                            else
                            {
                                cadena = "05_AVANZA FACTURACION";
                                cadena = cadena + ";" + "05_AVANZA";
                                cadena = cadena + ";" + "FACTURACION";
                            }
                        }
                        break;

                    case "FACTURACION_AUX":

                        //Si el CUPS y PERIODO del pendiente cruza con el CUPS y PERIODO de la incidencia del fichero de incidencias ,entonces, automaticamente, el suministro se asigna a "02_INCIDENCIA FACTURACIÓN-02_INCIDENCIA
                        //No cruza : "04_PENDIENTE DE NEGOCIO - 04_PENDIENTE NEGOCIO FACTURACION"
                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACION";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            cadena = "04_PENDIENTE NEGOCIO FACTURACION";
                            cadena = cadena + ";" + "04_PENDIENTE NEGOCIO";
                            cadena = cadena + ";" + "FACTURACION";
                        }
                        break;

                    case "FACTURACION_BIS":

                        //////Si el periodo lleva menos de 6 días ""Estado transitorio, AVANZA""
                        //////Si el periodo lleva igual o más de 6 días ""02_INCIDENCIA FACTURACIÓN"""

                        if (GetDiasEstado(Cups) >= 6)
                        {
                            cadena = "02_INCIDENCIA FACTURACION";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            cadena = "05_AVANZA SISTEMAS";
                            cadena = cadena + ";" + "05_AVANZA";
                            cadena = cadena + ";" + "EN AVANCE";
                        }

                        break;

                    case "FACTURACION_DESCONOCIDO":

                        if (GetDiasEstado(Cups) >= 10)
                        {
                            cadena = "02_INCIDENCIA FACTURACION";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            cadena = "03_GAP FUNCIONAL";
                            cadena = cadena + ";" + "03_GAP FUNCIONAL";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }

                        break;

                    case "MEDIDA":

                        //////•            Si nº Dias KEE< 5
                        //////         o ESTADO_GLOBAL: 05_AVANZA SISTEMAS
                        //////         o ESTADO_GLOBAL A REPORTAR: 05_AVANZA
                        //////        o  ÁREA_ESTADO: AVANZA
                        //////•            Si nº Dias KEE >= 5
                        //////         o ESTADO_GLOBAL: 021_INCIDENCIA_MEDIDA SIN CODIGO o 02_INCIDENCIA_MEDIDA
                        //////        o  ESTADO_GLOBAL A REPORTAR: 021_INCIDENCIA_MEDIDA SIN CODIGO o 02_INCIDENCIA_MEDIDA
                        //////        o  ÁREA_ESTADO: SISTEMAS
                        ///
                        if (NumeroDiasKEE < 5)
                        {
                            cadena = "05_AVANZA SISTEMAS";
                            cadena = cadena + ";" + "05_AVANZA";
                            cadena = cadena + ";" + "MEDIDA";
                        }
                        else
                        {
                            if (Incidencia == true)
                            {
                                cadena = "02_INCIDENCIA_MEDIDA";
                                cadena = cadena + ";" + "02_INCIDENCIA_MEDIDA";
                                cadena = cadena + ";" + "SISTEMAS MED";
                            }
                            else
                            {
                                cadena = "021_INCIDENCIA_MEDIDA";
                                cadena = cadena + ";" + "02_INCIDENCIA_MEDIDA";
                                cadena = cadena + ";" + "SISTEMAS MED";
                            }
                        }
                        break;

                    case "021_INCIDENCIA_MEDIDA":
                        cadena = "02_INCIDENCIA_MEDIDA";
                        cadena = cadena + ";" + "02_INCIDENCIA";
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                    case "021_INCIDENCIA FACTURACION":

                        cadena = "02_INCIDENCIA_FACTURACION";
                        cadena = cadena + ";" + "02_INCIDENCIA";
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                    default:

                        cadena = reporte["ESTADO_GLOBAL"].ToString();
                        cadena = cadena + ";" + reporte["ESTADO_GLOBAL_A_REPORTAR"].ToString();
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                }
            } // Fin  while (reporte.Read())

            if (EstadosReporte == false)
            {
                cadena = "";
                //////if (SubestadosNoEncontrados == "") {
                //////    SubestadosNoEncontrados = EstadoGlobal;
                //////}
                //////else {
                //////    SubestadosNoEncontrados = SubestadosNoEncontrados + ";" + EstadoGlobal;
                //////} 
            }
            dbReporte.CloseConnection();
            return cadena;
        }
        private string EstadosAreas(string EstadoGlobal, string Cups, string Periodo, int HojaPintar, int NumeroDiasKEE, Boolean Incidencia)
        {

            MySQLDB dbReporte;
            MySqlCommand command;
            MySqlDataReader r;
            MySqlDataReader inci;
            MySqlDataReader reporte;
            string strSql = "";
            Boolean EstadosReporte;
            string cadena = "";
            string Auxiliar = "";


            if (HojaPintar < 3)
            {
                strSql = " select ESTADO_GLOBAL,ESTADO_GLOBAL_A_REPORTAR, SISTEMA  from estados_KEE_Param_EstadosReporte_New"
                       + " where Subestado='" + EstadoGlobal + "'"
                       + " and NivelTension <> 'BTN'";
            }
            else
            {
                strSql = " select ESTADO_GLOBAL,ESTADO_GLOBAL_A_REPORTAR, SISTEMA  from estados_KEE_Param_EstadosReporte_New"
                      + " where Subestado='" + EstadoGlobal + "'"
                      + " and NivelTension <> 'MT'";
            }


            dbReporte = new MySQLDB(MySQLDB.Esquemas.MED);
            command = new MySqlCommand(strSql, dbReporte.con);
            reporte = command.ExecuteReader();

            EstadosReporte = false;
            while (reporte.Read())
            {
                EstadosReporte = true;

                Auxiliar = reporte["ESTADO_GLOBAL"].ToString();

                // para controlar si hay incidencia los que en el ESTADO_GLOBAL viene la etíqueta "SIN CODIGO"
                //////if (Auxiliar.Contains("SIN CÓDIGO"))
                //////{
                //////    if (Auxiliar.Contains("MEDIDA"))
                //////    {
                //////        if (Incidencia == true)
                //////        {
                //////            Auxiliar = "INCIDENCIAMEDIDA";
                //////        }

                //////        if (Auxiliar.Contains("FACTURACION"))
                //////        {
                //////            if (Incidencia == true)
                //////            {
                //////                Auxiliar = "INCIDENCIAFACTURACION";
                //////            }
                //////        }
                //////    }
                //////}

                switch (Auxiliar)
                {
                    case "FACTURACION":
                        // Si cruza,  los que estén en incidencia, los tiene que marcar como 02_INCIDENCIA FACTURACIÓN. Y en este caso, tendrán un código de incidencia. (02_INCIDENCIA FACTURACIÓN CON CÓDIGO - 02_INCIDENCIA )
                        // Si no cruza: MIRAR CAMPO DIAS_ESTADO  Si el periodo lleva en el mismo estado menos de 6 días "Estado transitorio, AVANZA" (05_AVANZA FACTURACIÓN - 05_AVANZA)
                        // Si el periodo lleva igual o más de 6 días "02_INCIDENCIA FACTURACIÓN".Y en este caso, no tendrán un código de incidencia. (021_INCIDENCIA FACTURACIÓN SIN CÓDIGO - 021_INCIDENCIA SIN COGIGO)

                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACION";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            if (GetDiasEstado(Cups) >= 6)
                            {
                                cadena = "02_INCIDENCIA FACTURACION";
                                cadena = cadena + ";" + "02_INCIDENCIA";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                            else
                            {
                                cadena = "05_AVANZA SISTEMAS";
                                cadena = cadena + ";" + "05_AVANZA";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                        }
                        break;

                    case "02_INCIDENCIA_FACTURACION":

                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACION";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            if (GetDiasEstado(Cups) >= 6)
                            {
                                cadena = "02_INCIDENCIA FACTURACION";
                                cadena = cadena + ";" + "02_INCIDENCIA";
                                cadena = cadena + ";" + "SISTEMAS FAC";
                            }
                            else
                            {
                                cadena = "05_AVANZA FACTURACION";
                                cadena = cadena + ";" + "05_AVANZA";
                                cadena = cadena + ";" + "FACTURACION";
                            }
                        }
                        break;

                    case "FACTURACION_AUX":

                        //Si el CUPS y PERIODO del pendiente cruza con el CUPS y PERIODO de la incidencia del fichero de incidencias ,entonces, automaticamente, el suministro se asigna a "02_INCIDENCIA FACTURACIÓN-02_INCIDENCIA
                        //No cruza : "04_PENDIENTE DE NEGOCIO - 04_PENDIENTE NEGOCIO FACTURACION"
                        if (RelacionIncidenciasSAP.Cups(Cups + Periodo.ToString()))
                        {
                            cadena = "02_INCIDENCIA FACTURACION";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            cadena = "04_PENDIENTE NEGOCIO FACTURACION";
                            cadena = cadena + ";" + "04_PENDIENTE NEGOCIO";
                            cadena = cadena + ";" + "FACTURACION";
                        }
                        break;

                    case "FACTURACION_BIS":

                        //////Si el periodo lleva menos de 6 días ""Estado transitorio, AVANZA""
                        //////Si el periodo lleva igual o más de 6 días ""02_INCIDENCIA FACTURACIÓN"""

                        if (GetDiasEstado(Cups) >= 6)
                        {
                            cadena = "02_INCIDENCIA FACTURACION";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            cadena = "05_AVANZA SISTEMAS";
                            cadena = cadena + ";" + "05_AVANZA";
                            cadena = cadena + ";" + "EN AVANCE";
                        }

                        break;

                    case "FACTURACION_DESCONOCIDO":

                        if (GetDiasEstado(Cups) >= 10)
                        {
                            cadena = "02_INCIDENCIA FACTURACION";
                            cadena = cadena + ";" + "02_INCIDENCIA";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }
                        else
                        {
                            cadena = "03_GAP FUNCIONAL";
                            cadena = cadena + ";" + "03_GAP FUNCIONAL";
                            cadena = cadena + ";" + "SISTEMAS FAC";
                        }

                        break;

                    case "MEDIDA":

                        // Paco 29/11/2024, se cambia la lógica de evaluación
                        if (Incidencia == true)
                        {
                            cadena = "02_INCIDENCIA_MEDIDA";
                            cadena = cadena + ";" + "02_INCIDENCIA_MEDIDA";
                            cadena = cadena + ";" + "SISTEMAS MED";
                        }
                        else
                        {
                            if (NumeroDiasKEE < 5)
                            {
                                cadena = "05_AVANZA SISTEMAS";
                                cadena = cadena + ";" + "05_AVANZA";
                                cadena = cadena + ";" + "MEDIDA";
                            }
                            else
                            {
                                cadena = "021_INCIDENCIA_MEDIDA";
                                cadena = cadena + ";" + "02_INCIDENCIA_MEDIDA";
                                cadena = cadena + ";" + "SISTEMAS MED";
                            }
                        }
                        break;
                        //  Fin Paco 29/11/2024

                    case "021_INCIDENCIA_MEDIDA":
                        cadena = "02_INCIDENCIA_MEDIDA";
                        cadena = cadena + ";" + "02_INCIDENCIA";
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                    case "021_INCIDENCIA FACTURACION":

                        cadena = "02_INCIDENCIA FACTURACION";
                        cadena = cadena + ";" + "02_INCIDENCIA";
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                    default:

                        cadena = reporte["ESTADO_GLOBAL"].ToString();
                        cadena = cadena + ";" + reporte["ESTADO_GLOBAL_A_REPORTAR"].ToString();
                        cadena = cadena + ";" + reporte["SISTEMA"].ToString();
                        break;

                }
            } // Fin  while (reporte.Read())

            if (EstadosReporte == false)
            {
                cadena = "";
                //////if (SubestadosNoEncontrados == "") {
                //////    SubestadosNoEncontrados = EstadoGlobal;
                //////}
                //////else {
                //////    SubestadosNoEncontrados = SubestadosNoEncontrados + ";" + EstadoGlobal;
                //////} 
            }
            dbReporte.CloseConnection();
            return cadena;
        }

        private string Reincidente(string areaincidencia, string arearesponsable)
        {
            string Dato = "";

            if (arearesponsable != "" && arearesponsable != null) //He cruzado con KEE
            {
                if (areaincidencia.ToUpper() == arearesponsable.ToUpper())
                {
                    if (areaincidencia == "Contratacion")
                        Dato = "01.B09 Incidencia_Contratacion";
                    if (areaincidencia == "Medida")
                        Dato = "01.B10 Incidencia_Medida";
                    if (areaincidencia == "Facturacion")
                        Dato = "01.B11 Incidencia_Facturacion";
                }
            }
            else
            { // No cruza con KEE
                if (areaincidencia == "Facturacion")
                {
                    Dato = "01.B11 Incidencia_Facturacion"; 
                }
            } // Fin  if (subestadosKronos.area_responsable != "")

            return Dato;

        }

        private int Total_Pendiente(bool agora, DateTime fecha, List<string> lista_empresas, List<string> lista_segmentos, string estado, string subestado)
        {
            int total = 0;

            List<EndesaEntity.medida.Pendiente> o;

            if (lista_segmentos == null)
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int i = 0; i < o.Count; i++)
                        {
                            /*
                            if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora &&
                                (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null) ))
                                total = total + 1;
                            */

                            if (o[i].subestado_SAP is null) {
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                    total = total + 1;
                            }
                            else {
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && (o[i].cod_estado == estado && (o[i].cod_subestado_SAP == subestado || subestado == null)))
                                    total = total + 1;
                            }


                        }
                }
            }
            else
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int z = 0; z < lista_segmentos.Count; z++)
                            for (int i = 0; i < o.Count; i++)
                            {
                                /*
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]
                                    && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                    total = total + 1;
                                */

                                if (o[i].subestado_SAP == null)
                                {
                                    if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]  && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                        total = total + 1;
                                }
                                else
                                {

                                   if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]  && o[i].agora == agora &&
                                   (o[i].cod_estado == estado && (o[i].cod_subestado_SAP == subestado || subestado == null)))
                                        total = total + 1;

                                }

                            }
                }
            }

            return total;

        }

        private int Total_PendienteUno(bool agora, DateTime fecha, List<string> lista_empresas, List<string> lista_segmentos, string estado, string subestado, string SAP )
        {
            int total = 0;

            List<EndesaEntity.medida.Pendiente> o;

            if (lista_segmentos == null)
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int i = 0; i < o.Count; i++)
                        {
                            /*
                            if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora &&
                                (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null) ))
                                total = total + 1;
                            */

                            //if (dia.ToString("yyyy-MM-dd") == o[i].fecha_informe.ToString("yyyy-MM-dd")){ 

                                if (SAP == "N") {
                                    if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)) && (o[i].cod_subestado_SAP==null))
                                        total = total + 1;
                                }
                                else
                                {
                                    if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && (o[i].cod_estado == estado && (o[i].cod_subestado_SAP == subestado || subestado == null)) )
                                        total = total + 1;
                                }

                            //}
                        }
                }
            }
            else
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int z = 0; z < lista_segmentos.Count; z++)
                            for (int i = 0; i < o.Count; i++)
                            {
                                /*
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]
                                    && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                    total = total + 1;
                                */

                               /* if (o[i].subestado_SAP == null)
                                {
                                    if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z] && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                        total = total + 1;
                                }
                                else
                                {

                                    if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z] && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado_SAP == subestado || subestado == null)))
                                        total = total + 1;

                                }
                                */

                                    if (SAP == "N")
                                    {
                                        if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z] && o[i].agora == agora &&
                                        (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                            total = total + 1;
                                    }

                                    // if (o[i].subestado_SAP is null)
                                    //{
                                    //   if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                    //       total = total + 1;
                                    //}
                                    else
                                    {
                                        if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z] && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado_SAP == subestado || subestado == null)))
                                            total = total + 1;
                                    }


                            }
                }
            }

            return total;

        }

        private double Total_Pendiente_TAM(bool agora, DateTime fecha, List<string> lista_empresas, List<string> lista_segmentos, string estado, string subestado)
        {
            double total = 0;

            List<EndesaEntity.medida.Pendiente> o;

            if (lista_segmentos == null)
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int i = 0; i < o.Count; i++)
                        {

                            /*
                            if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora &&
                                (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                total = total + o[i].tam;
                            */

                            if (o[i].subestado_SAP == null)
                            {
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                    total = total + o[i].tam;
                            }
                            else
                            {
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && (o[i].cod_estado == estado && (o[i].cod_subestado_SAP == subestado || subestado == null)))
                                    total = total + o[i].tam;
                            }

                        }


                }
            }
            else
            {
                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))
                {
                    for (int j = 0; j < lista_empresas.Count; j++)
                        for (int z = 0; z < lista_segmentos.Count; z++)
                            for (int i = 0; i < o.Count; i++)
                            {
                                /*
                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]
                                        && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                    total = total + o[i].tam;
                                */

                                if (o[i].subestado_SAP == null)
                                {
                                    if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z] && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))
                                        total = total + o[i].tam;
                                }
                                else
                                {

                                    if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z] && o[i].agora == agora &&
                                    (o[i].cod_estado == estado && (o[i].cod_subestado_SAP == subestado || subestado == null)))
                                        total = total + o[i].tam;

                                }

                            }

                }
            }

            return total;

        }

        private string DetalleExcel(DateTime fecha_informe, List<string> lista_empresas, List<string> lista_tension)
        {
            string strSql = "";
            bool firstOnly = true;

            strSql = "SELECT ps.cd_empr, p.cd_segmento_ptg, ps.cd_nif_cif_cli, ps.de_tp_cli, ps.tx_apell_cli,"
                + " ps.fh_alta_crto, ps.fh_inicio_vers_crto, p.cd_cups as cups20, p.id_instalacion, ps.cd_tarifa_c,"
                + " ps.cd_crto_comercial, ps.de_empr_distdora_nombre, p.lg_multimedida, p.fh_desde, p.fh_hasta, p.cd_subestado,"
                + " concat(p.cd_estado,' ',de.de_estado) as de_estado, concat(p.cd_subestado,' ',if (ds.de_subestado is null,'', ds.de_subestado)) as de_subestado, p.fh_periodo as mes, p.agora, p.TAM , ps.fh_prev_fin_crto,  ps.fh_baja_crto, p.id_crto_ext,p.fec_act"
                + " FROM fact.t_ed_h_sap_pendiente_facturar_agrupado p";

            if (lista_empresas[0].Contains("PT"))
                strSql += " LEFT OUTER JOIN cont.t_ed_h_ps_pt ps ON";
            else
                strSql += " LEFT OUTER JOIN cont.t_ed_h_ps ps ON";

            strSql += " ps.cups20 = p.cd_cups"
                + " LEFT OUTER JOIN fact.t_ed_p_estado_sap_pendiente_facturar de on"
                + " de.cd_estado = p.cd_estado"
                + " LEFT OUTER JOIN fact.t_ed_p_subestado_sap_pendiente_facturar ds on"
                + " ds.cd_subestado = p.cd_subestado"
                + " where p.fh_envio = '" + fecha_informe.Date.ToString("yyyy-MM-dd") + "'"
                //////+ " and p.cd_cups in ('PT0002000005084445CE') "


                //Hay que quitar (porque así se decidió en la Negociación de este reporte) que no pueden aparecer registros con el mes pendiente = al mes en curso !!!!!!!!!!!
                + " and p.fh_periodo <> '" + DateTime.Now.ToString("yyyyMM") + "'"
                //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

                +" and p.cd_empr_titular in (";

                foreach (string p in lista_empresas)
                {
                    if (firstOnly)
                    {
                        strSql += "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";

                }

                strSql += ")";

                if (lista_tension != null)
                {
                firstOnly = true;
                strSql += " and p.cd_segmento_ptg in (";
                foreach (string p in lista_tension)
                {
                    if (firstOnly)
                    {
                        strSql += "'" + p + "'";
                        firstOnly = false;
                    }
                    else
                        strSql += ",'" + p + "'";

                }
                strSql += ")";
            }


            return strSql;

        }
        private void EnvioCorreo_PdteWeb_BI(string archivo, DateTime fecha_informe)
        {
            FileInfo fileInfo = new FileInfo(archivo);
            StringBuilder textBody = new StringBuilder();

            try
            {
                string from = param.GetValue("mail_from_psat_tam");
                string to = param.GetValue("mail_to_psat_tam");
                string cc = param.GetValue("mail_cc_psat_tam");
                string subject = param.GetValue("mail_subject_psat_tam") + " a " + fecha_informe.ToString("dd/MM/yyyy");

                textBody.Append(System.Environment.NewLine);
                textBody.Append(DateTime.Now.Hour < 14 ? "Buenos días:" : "Buenas tardes:");
                textBody.Append(System.Environment.NewLine);
                textBody.Append("  Se adjunta el archivo ").Append(fileInfo.Name).Append(".");
                textBody.Append(System.Environment.NewLine);
                textBody.Append("Un saludo.");

                //EndesaBusiness.mail.MailExchangeServer mes = new EndesaBusiness.mail.MailExchangeServer("RSIOPEGMA001");
                EndesaBusiness.office365.OAuth_Mail mes = new EndesaBusiness.office365.OAuth_Mail();

                if (param.GetValue("mail_enviar_mail_psat_tam") == "S")
                    mes.SendMail(from, to, cc, subject, utilidades.FuncionesTexto.TextToHtml(textBody.ToString()), archivo);

                else
                    mes.SaveMail(from, to, cc, subject, utilidades.FuncionesTexto.TextToHtml(textBody.ToString()), archivo);

                ficheroLog.Add("Correo enviado desde: " + param.GetValue("mail_from"));
            }
            catch (Exception e)
            {
                ficheroLog.AddError("EnvioCorreo: " + e.Message);
            }
        }


        private void EnvioCorreo_SAP_KEE(string archivo, DateTime fecha_informe, string Procesados, string Estados, string FechaSapPendienteFacturar, string FechaPdteWebB2B, string FechaPdteWebB2B_fhInforme)
        {
            FileInfo fileInfo = new FileInfo(archivo);
            StringBuilder textBody = new StringBuilder();

            try
            {
                string from = param.GetValue("mail_from_sap_kronos");
                string to = param.GetValue("mail_to_sap_kronos");
                string cc = param.GetValue("mail_cc_sap_kronos");
                string subject = param.GetValue("mail_subject_sap_kronos") + " - " + fecha_informe.ToString("dd/MM/yyyy");

                //to = "francisco.sanchezmartin@enel.com";
                //cc = "gbenavides@minsait.com";
                //cc = "eloy.fernandezg@enel.com;adriana.lopezl@enel.com;angel.diazm@enel.com;francisco.sanchezmartin@enel.com;scasati.rivera@servinform.es;lmauricio.carrasco@servinform.es;brodriguez.carmona@servinform.es;ajtinoco.sanchez@servinform.es;gbenavides@minsait.com;fenix_opm_facturacion@servinform.es;anamaria.alonso@enel.com";
                //subject = "Informe Pendiente Operaciones " + "-" + fecha_informe.ToString("dd/MM/yyyy");

                textBody.Append(System.Environment.NewLine);
                textBody.Append(DateTime.Now.Hour < 14 ? "Buenos días:" : "Buenas tardes:");
                textBody.Append(System.Environment.NewLine);
                textBody.Append(System.Environment.NewLine);
                textBody.Append("  Subido el fichero a Enel SPA\\Seguimiento Pendiente Fenix\\General ").Append(fileInfo.Name).Append(".");
                textBody.Append(System.Environment.NewLine);
                textBody.Append("  Disponible en ");
                textBody.Append("<a href=\"https://enelcom.sharepoint.com/sites/SEGUIMIENTOPENDIENTEFENIX/Shared%20Documents/General/").Append(fileInfo.Name).Append("\">Informe Pendiente Operaciones</a>");
                textBody.Append(System.Environment.NewLine);
                textBody.Append(System.Environment.NewLine);
                if (Procesados != "")
                {
                    string[] cadena = Procesados.Split(';');
                    textBody.Append("  - " + cadena[0]);
                    textBody.Append(System.Environment.NewLine);
                    textBody.Append("  - " + cadena[1]);
                    textBody.Append(System.Environment.NewLine);
                    textBody.Append("  - " + cadena[2]);
                    textBody.Append(System.Environment.NewLine);
                }
              
                if (Estados != "")
                {
                    string[] cadena = Estados.Split(';');
                    foreach (string a in cadena)
                        {
                        textBody.Append("  - " + a);
                        textBody.Append(System.Environment.NewLine);
                    }
                }

                textBody.Append(System.Environment.NewLine);
                textBody.Append(System.Environment.NewLine);
                textBody.Append("- fh_envio de la tabla t_ed_h_sap_pendiente_facturar: " + FechaSapPendienteFacturar);
                textBody.Append(System.Environment.NewLine);
                textBody.Append("- fec_act de la tabla t_ed_h_pdtweb_pm_b2b: " + FechaPdteWebB2B);
                textBody.Append(System.Environment.NewLine);
                textBody.Append("- fecha_informe de la tabla t_ed_h_pdtweb_pm_b2b: " + FechaPdteWebB2B_fhInforme);
                textBody.Append(System.Environment.NewLine);
                textBody.Append(System.Environment.NewLine);
                textBody.Append("Atencion!! Es necesario tener actualizado el Excel de INCIDENCIAS_FACTURACION para que el resultado sea el esperado.");
                textBody.Append(System.Environment.NewLine);
                textBody.Append("Por favor, informar OK/KO del informe para poder avanzar en el desarrollo del aplicativo");
                textBody.Append(System.Environment.NewLine);
                textBody.Append(System.Environment.NewLine);

                textBody.Append("Un saludo.");

                EndesaBusiness.office365.OAuth_Mail mes = new EndesaBusiness.office365.OAuth_Mail();

                //////if (param.GetValue("mail_enviar_mail_psat_tam") == "S")
                // GUS: Modificamos para no enviar adjunto - 18-09-2024
                //mes.SendMail(from, to, cc, subject, utilidades.FuncionesTexto.TextToHtml(textBody.ToString()), archivo);
                mes.SendMail(from, to, cc, subject, utilidades.FuncionesTexto.TextToHtml_href(textBody.ToString()), "");
                //////else
                //////    mes.SaveMail(from, to, cc, subject, utilidades.FuncionesTexto.TextToHtml(textBody.ToString()), archivo);

                //////ficheroLog.Add("Correo enviado desde: " + param.GetValue("mail_from"));
            }
            catch (Exception e)
            {
                ficheroLog.AddError("EnvioCorreo: " + e.Message);
            }
        }


        //////private static void ShowSBInfo(StringBuilder sb)

        //////{
        //////    foreach (var prop in sb.GetType().GetProperties()) {
        //////        if (prop.GetIndexParameters().Length == 0)
        //////           Console.Write ("{0}: {1:N0}     ", prop.Name, prop.GetValue(sb));
        //////    }
        //////}
        private DateTime CalculaFechaDesdeinforme()
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            DateTime date = DateTime.Now;

            strSql = "SELECT c.fh_envio"
                + " FROM t_ed_h_sap_pendiente_facturar_agrupado c"
                + " ORDER BY c.fh_envio desc"
                + " LIMIT 5";

            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
            {
                if (r["fh_envio"] != System.DBNull.Value)
                    date = Convert.ToDateTime(r["fh_envio"]);
            }
            db.CloseConnection();

            return date;

        }

        private DateTime CalculaFechaDesdeinformeMaxPendiente ()
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            DateTime date = DateTime.Now;

            strSql = "SELECT c.fh_envio"
                + " FROM t_ed_h_sap_pendiente_facturar_agrupado c"
                + " ORDER BY c.fh_envio desc"
                + " LIMIT 5";

            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
            {
                if (r["fh_envio"] != System.DBNull.Value)
                    date = Convert.ToDateTime(r["fh_envio"]);
                break;
            }
            db.CloseConnection();

            return date;

        }

        private DateTime CalculaFechaMaxPdteWebB2B()
        {
            servidores.RedShiftServer db;
            OdbcCommand command;
            OdbcDataReader r;
            string strSql = "";
            DateTime date = DateTime.Now;

            strSql = "SELECT max(fec_act) as fecha"
                + " FROM ed_owner.t_ed_h_pdtweb_pm_b2b";

            db = new servidores.RedShiftServer(RedShiftServer.Entornos.PROD);
            command = new OdbcCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())

            {
                if (r["fecha"] != System.DBNull.Value)
                    date = Convert.ToDateTime(r["fecha"]);
                break;
            }
            db.CloseConnection();

            return date;

        }

        private DateTime CalculaFechaMaxPdteWebB2B_fhinforme(DateTime fechaSAP)
        {
            servidores.RedShiftServer db;
            OdbcCommand command;
            OdbcDataReader r;
            string strSql = "";
            DateTime date = DateTime.Now;


            strSql = "SELECT max(fecha_informe) as fecha"
                + " FROM ed_owner.t_ed_h_pdtweb_pm_b2b"
                + " where fecha_informe<'" + fechaSAP.Date.ToString("yyyy-MM-dd") + "'";
          
            db = new servidores.RedShiftServer(RedShiftServer.Entornos.PROD);
            command = new OdbcCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())

            {
                if (r["fecha"] != System.DBNull.Value)
                    date = Convert.ToDateTime(r["fecha"]);
                break;
            }
            db.CloseConnection();

            return date;

        }

        private DateTime CalculaFechaDetalle()
        {
            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            DateTime date = DateTime.Now;

            strSql = "SELECT max(c.fh_envio) as max_fecha"
                + " FROM t_ed_h_sap_pendiente_facturar_agrupado c";


            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
            {
                if (r["max_fecha"] != System.DBNull.Value)
                    date = Convert.ToDateTime(r["max_fecha"]);
            }
            db.CloseConnection();

            return date;

        }

        private Dictionary<string, DateTime> CargaDiasEstado()
        {
            Dictionary<string, DateTime> d = new Dictionary<string, DateTime>();

            MySQLDB db;
            MySqlCommand command;
            MySqlDataReader r;
            string strSql = "";
            string cups = "";
            DateTime primera_fecha = DateTime.Now;

            strSql = "SELECT p.cd_cups, p.fh_periodo, MIN(p.fh_envio) AS primera_fecha, p.cd_subestado"
                + " FROM t_ed_h_sap_pendiente_facturar_agrupado p"
                + " WHERE p.fh_periodo >= " + DateTime.Now.AddYears(-1).ToString("yyyyMM")
                + " GROUP BY p.cd_cups, p.fh_periodo, p.cd_subestado"
                + " ORDER BY p.fh_envio DESC";


            db = new MySQLDB(MySQLDB.Esquemas.FAC);
            command = new MySqlCommand(strSql, db.con);
            r = command.ExecuteReader();
            while (r.Read())
            {
                cups = r["cd_cups"].ToString();
                primera_fecha = Convert.ToDateTime(r["primera_fecha"]);

                DateTime o;
                if (!d.TryGetValue(cups, out o))
                    d.Add(cups, primera_fecha);

            }
            db.CloseConnection();
            return d;

        }

        private int GetDiasEstado(string cups)
        {
            int dias = 1;
            DateTime o;
            if (dic_dias_estado.TryGetValue(cups, out o))
            {
                dias = (DateTime.Now.Date - o.Date).Days + 1;
            }



            return dias;
        }
        private int Total_Pendiente_25(bool agora, DateTime fecha, List<string> lista_empresas, List<string> lista_segmentos, string estado, string subestado, string Etiqueta)

        {

            int total = 0;

            List<EndesaEntity.medida.Pendiente> o;

            if (lista_segmentos == null)

            {

                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))

                {

                    for (int j = 0; j < lista_empresas.Count; j++)

                        for (int i = 0; i < o.Count; i++)

                        {

                            if (o[i].cod_subestado_SAP == "01.C25 Pendiente Medida KEE - En ciclo de Medida")
                            {

                                System.Diagnostics.Debug.WriteLine("");

                            }

                            //System.Diagnostics.Debug.WriteLine(c.cups20 +

                            if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null) && o[i].subestado_SAP == subestado + " " + Etiqueta)

                                total = total + 1;

                        }

                }

            }

            else

            {

                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))

                {

                    for (int j = 0; j < lista_empresas.Count; j++)

                        for (int z = 0; z < lista_segmentos.Count; z++)

                            for (int i = 0; i < o.Count; i++)

                            {

                                /*

                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]
&& o[i].agora == agora &&

                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))

                                    total = total + 1;

                                */

                                if (o[i].cod_subestado_SAP == "01.C25")

                                {

                                    System.Diagnostics.Debug.WriteLine("");

                                }

                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z] && o[i].agora == agora &&

                                    o[i].cod_estado == estado && (o[i].cod_subestado_SAP == subestado || subestado == null) && o[i].subestado_SAP == subestado + " " + Etiqueta)

                                    total = total + 1;



                            }

                }

            }

            return total;

        }

        private double Total_Pendiente_TAM_25(bool agora, DateTime fecha, List<string> lista_empresas, List<string> lista_segmentos, string estado, string subestado, string Etiqueta)

        {

            double total = 0;

            List<EndesaEntity.medida.Pendiente> o;

            if (lista_segmentos == null)

            {

                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))

                {

                    for (int j = 0; j < lista_empresas.Count; j++)

                        for (int i = 0; i < o.Count; i++)

                        {



                            if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].agora == agora && o[i].cod_estado == estado && o[i].cod_subestado_SAP == subestado && o[i].subestado_SAP == subestado + " " + Etiqueta)

                                total = total + o[i].tam;

                        }

                }

            }

            else

            {

                if (dic_pendiente_hist_fecha.TryGetValue(fecha, out o))

                {

                    for (int j = 0; j < lista_empresas.Count; j++)

                        for (int z = 0; z < lista_segmentos.Count; z++)

                            for (int i = 0; i < o.Count; i++)

                            {

                                /*

                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z]
&& o[i].agora == agora &&

                                    (o[i].cod_estado == estado && (o[i].cod_subestado == subestado || subestado == null)))

                                    total = total + o[i].tam;

                                */

                                if (o[i].cod_subestado_SAP == "01.C25")

                                {

                                    System.Diagnostics.Debug.WriteLine("");

                                }


                                if (o[i].cod_empresaTitular == lista_empresas[j] && o[i].segmento == lista_segmentos[z] && o[i].agora == agora &&

                                    o[i].cod_estado == estado && o[i].cod_subestado_SAP == subestado && o[i].subestado_SAP == subestado + " " + Etiqueta)

                                    total = total + o[i].tam;



                            }

                }

            }

            return total;

        }
    }
}